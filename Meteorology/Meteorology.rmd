---
title: "Meteorology"
author: "Sophie Breitbart"
date: "June 15, 2021"
output: html_document
---

# Set up notebook
## Load libraries
```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(here)
library(magrittr)
library(tidyverse)
```

## Set strings as factors to false
```{r}
options(stringsAsFactors = FALSE)
```

## Import data
```{r}
weather <-
  read.csv(here::here("./Meteorology/DailyData_OakvilleTwn_2018_2019.csv"),
           header=T,
           na.strings=c("","NA"))
```

## Remove irrelevant data & clean up column names
```{r}
weather %<>%
  dplyr::rename(.,
                "Lat" = 1,
                "Long" = 2,
                "Max.Temp_C" = 10,
                "Min.Temp_C" = 12,
                "Mean.Temp_C" = 14,
                "Total.Precip" = 24) %>%
  dplyr::select(c(1:3, 5:8, 10, 12, 14, 24 ))
```

# Quality control
## Check range of variables
```{r}
boxplot(weather[,8:11], las=2)
lines(c(0,15), c(0,0))
```

## Check for empty values
```{r}
sum(is.na(weather$Max.Temp_C)) # 1 day: 6/18/2018
sum(is.na(weather$Min.Temp_C)) # 1 day: 6/18/2018
sum(is.na(weather$Mean.Temp_C)) # 2 days: 6/18/2018 & 6/19/2018
sum(is.na(weather$Total.Precip)) # 1 day: 6/18/2018

# Since there's only 2 days without full data, remove those days from dataset
weather %<>%
  filter(is.na(weather$Mean.Temp_C) == F)

```

# Aggregate by month or quarter (season)
## Aggregate by month
```{r}
monthly_data <- weather %>% 
  group_by(Year, Month) %>% # group by the month column
  summarise(n=n(), 
            total_precip=sum(Total.Precip), 
            mean_temp=mean(Mean.Temp_C),
            mean_max_temp = mean(Max.Temp_C),
            mean_min_temp = mean(Min.Temp_C)) %T>%
  print(head())
```


##  Aggregate by quarter (season)
```{r}

weather %<>%
  mutate(Quarter = case_when(Year == 2018 & Month < 4 ~ 1, 
                             Year == 2018 & Month < 7 ~ 2,
                             Year == 2018 & Month < 10 ~ 3,
                             Year == 2018 & Month < 13 ~ 4,
                             Year == 2019 & Month < 4 ~ 5, 
                             Year == 2019 & Month < 7 ~ 6,
                             Year == 2019 & Month < 10 ~ 7,
                             Year == 2019 & Month < 13 ~ 8) )

quarterly_data <- weather %>% 
  group_by(Quarter) %>% # group by the quarter column
  summarise(n=n(), 
            total_precip=sum(Total.Precip), 
            mean_temp=mean(Mean.Temp_C),
            mean_max_temp = mean(Max.Temp_C),
            mean_min_temp = mean(Min.Temp_C)) %T>%
  print(head())
```


### Check for missing days

Missing full days:
- 8 days in March - May 2018
- This will affect total precipitation data more than other data where means are used

```{r}
matrix(monthly_data$n, 12, byrow=TRUE, dimnames=list(paste(c(2008:2019),c(2009:2020), sep="-"), c(10:12,1:9)))
```

Days with some or all records missing

- 2 days in Oct 2008
- 1 day in June 2014
- 2 days in Nov 2014
- 1 day in Sept 2015
- 1 day in March 2016
- 7 days in Jan - Sept 2017
- 37 days in Oct 2017 - Sept 2018
- 15 days in Oct 2018 - May 2019
- 18 days in Oct 2019 - Sept 2020

```{r}
matrix(monthly_data$n - monthly_data$n.incomplete, 12, byrow=TRUE,
       dimnames=list(paste(c(2008:2019),c(2009:2020), sep="-"), c(10:12,1:9)))
```




### d) Data coverage

How many days in each 12-month period?

```{r}
Start <- paste0(c(2008:2019), "1001")
End <- paste0(c(2009:2020), "1001")

Days <- sapply(c(1:length(Start)), function(i) interval(Start[i], End[i]) %/% days(1))
```

Coverage results:

- Until 2016-2017, all days recorded, with at least 98% of daily records being complete
- Use all years for temperature, humidity etc. (where means are used)
- Use only years 2008 - 2017 for precipitation data (where sum is used)

```{r}
Coverage <- data.frame(n=apply(matrix(monthly_data$n, 12, byrow=TRUE, dimnames=list(paste(c(2008:2019),c(2009:2020), sep="-"), c(10:12,1:9))), 1, sum),
           n.complete=apply(matrix(monthly_data$n - monthly_data$n.incomplete, 12, byrow=TRUE,
       dimnames=list(paste(c(2008:2019),c(2009:2020), sep="-"), c(10:12,1:9))), 1, sum))
Coverage$prop.records <- Coverage$n / Days
Coverage$prop.complete <- Coverage$n.complete / Days
round(Coverage, 3) 
```


## 6. Analyze by experimental period

### a) Quarterly mean precipitation data

```{r}
tmp <- quarterly_data %>% filter(quarter < "2017 Q4") %>% group_by(quarter_noYear) %>% summarize(mean_precip=mean(total_precip))
tmp <- tmp[c(4,1,2,3),]
Precipitation <- data.frame(
  rep(tmp$quarter_noYear, 2),
  unlist(rep(tmp[,2], 2)),
  quarterly_data %>% filter(quarter > "2011 Q3", quarter < "2013 Q4") %>% select(total_precip),
  quarterly_data %>% filter(quarter > "2013 Q3", quarter < "2015 Q4") %>% select(total_precip),
  quarterly_data %>% filter(quarter > "2015 Q3", quarter < "2017 Q4") %>% select(total_precip))

names(Precipitation) <- c("Quarter", "2008-2017","2011-2013","2013-2015", "2015-2017")
Precipitation$Season <- paste(c("Fall", "Winter", "Spring", "Summer"), rep(1:2, each=4), sep=" ")
```

```{r}
ts.plot(Precipitation[,-c(1,3)], ylim=c(0,1750), col=c(1,2,4), lwd=c(3,1,1))
```
```{r fig.height=3.5, fig.width=9}
library(dplyr)

Precipitation_long <- gather(Precipitation, key = "Period", value = "Precipitation",
        '2008-2017', '2013-2015', '2015-2017')
Precipitation_long$Season <- factor(Precipitation_long$Season, levels=paste(c("Fall", "Winter", "Spring", "Summer"), rep(1:2, each=4), sep=" "))

P.plot <- Precipitation_long %>%
  ggplot(aes(fill=Period, x = Season, y = Precipitation)) +
      geom_bar(position="dodge", stat = "identity") +
      scale_fill_manual(values=c("gray", "red", "blue")) +
      ylab("Total precipitation (mm)") +
      theme_light()

P.plot
```



### b) Quarterly mean temperature data

```{r}
tmp <- quarterly_data %>% group_by(quarter_noYear) %>% summarize(mean_temp=mean(mean_temp))
tmp <- tmp[c(4,1,2,3),]
Temperature <- data.frame(
  rep(tmp$quarter_noYear, 2),
  unlist(rep(tmp[,2], 2)),
  quarterly_data %>% filter(quarter > "2011 Q3", quarter < "2013 Q4") %>% select(mean_temp),
  quarterly_data %>% filter(quarter > "2013 Q3", quarter < "2015 Q4") %>% select(mean_temp),
  quarterly_data %>% filter(quarter > "2015 Q3", quarter < "2017 Q4") %>% select(mean_temp))

names(Temperature) <- c("Quarter", "2008-2020","2011-2013","2013-2015", "2015-2017")
Temperature$Season <- paste(c("Fall", "Winter", "Spring", "Summer"), rep(1:2, each=4), sep=" ")
```

```{r}
ts.plot(Temperature[,-1], ylim=c(15,25), col=c(1:4), lwd=c(3,1,1,1))
```

```{r fig.height=3.5, fig.width=9}
library(dplyr)

Temperature_long <- gather(Temperature, key = "Period", value = "Temperature",
        '2008-2020', '2013-2015', '2015-2017')
Temperature_long$Season <- factor(Temperature_long$Season, levels=paste(c("Fall", "Winter", "Spring", "Summer"), rep(1:2, each=4), sep=" "))

T.plot <- Temperature_long %>%
  ggplot(aes(fill=Period, x = Season, y = Temperature)) +
      geom_bar(position="dodge", stat = "identity") +
      scale_fill_manual(values=c("gray", "red", "blue")) +
      ylab("Mean temperature (C)") +
      theme_light()

T.plot
```

### c) Relative to reference period

- Oct 2008 - Sept 2017 for precipitation
- Oct 2008 - Sept 2020 for temperature

```{r}
Relative <- data.frame(Season=c(Temperature$Season, "Total"), 
                  P_2013_2015=c(Precipitation[,4]/Precipitation[,2], 
                                sum(Precipitation[,4]) / sum(Precipitation[,2])),
                  P_2015_2017=c(Precipitation[,5]/Precipitation[,2], 
                                sum(Precipitation[,5]) / sum(Precipitation[,2])),
                  T_2013_2015=c(Temperature[,4]/Temperature[,2], 
                                mean(Temperature[,4]) / mean(Temperature[,2])),
                  T_2015_2017=c(Temperature[,5]/Temperature[,2], 
                                mean(Temperature[,5]) / mean(Temperature[,2])))

                  
names(Relative) <- c("Season", "Prec (2013-2015)", "Prec (2015-2017)", "Temp (2013-2015)", "Temp (2015-2017)")

for(i in 2:5) {Relative[,i] = round(Relative[,i],3)}

Relative
```

### d) Export table and figures

Export table with relative values

```{r}
write.table(Relative, "Relative.txt", sep="\t", row.names=FALSE)
```


Export barcharts

```{r}
pdf(paste0(here::here(), "/Temperature.pdf"), width=8, height=4)
T.plot
dev.off()

pdf(paste0(here::here(), "/Precipitation.pdf"), width=8, height=4)
P.plot
dev.off()
```

