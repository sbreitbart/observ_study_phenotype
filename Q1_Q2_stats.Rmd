# Set up notebook
## Install, load packages
```{r message=FALSE, warning=FALSE}
library(broom.mixed) # Tidying Methods for Mixed Models
library(car) # Companion to Applied Regression
library(data.table) # Extension of `data.frame` # Extension of `data.frame`
# library(devtools)
library(DHARMa) # Residual Diagnostics for Hierarchical (Multi-Level / Mixed) Regression Models
library(dplyr) # A Grammar of Data Manipulation # A Grammar of Data Manipulation
library(e1071) # Misc Functions of the Department of Statistics, Probability Theory Group (Formerly: E1071), TU Wien
library(effects) 
# library(factoextra)
library(flextable) # Functions for Tabular Reporting
library(forcats) # Tools for Working with Categorical Variables (Factors)
library(geosphere) # Spherical Trigonometry
# library(ggbiplot)
library(ggeffects) # Create Tidy Data Frames of Marginal Effects for 'ggplot' from Model Outputs
library(ggiraphExtra) # Make Interactive 'ggplot2'. Extension to 'ggplot2' and 'ggiraph'
library(ggmap) # Spatial Visualization with ggplot2
library(ggpmisc)
library(ggpubr) # 'ggplot2' Based Publication Ready Plots
library(ggsn) # North Symbols and Scale Bars for Maps Created with 'ggplot2' or'ggmap'
library(ggspatial) # Spatial Data Framework for ggplot2
library(GISTools) # Some further GIS capabilities for R
library(glmmTMB) # Generalized Linear Mixed Models using Template Model Builder
library(gridExtra) # Miscellaneous Functions for "Grid" Graphics
library(here) # A Simpler Way to Find Your Files
library(Hmisc) # Harrell Miscellaneous
library(lme4) # Linear Mixed-Effects Models using 'Eigen' and S4
library(lmerTest) # Tests in Linear Mixed Effects Models
# library(lsmeans)
library(MASS) # Support Functions and Datasets for Venables and Ripley's MASS
library(magrittr) # A Forward-Pipe Operator for R
library(multcomp) # Simultaneous Inference in General Parametric Models
# library(MuMIn)
library(nlme) # Linear and Nonlinear Mixed Effects Models
library(officer) # Manipulation of Microsoft Word and PowerPoint Documents
library(patchwork) # The Composer of Plots
library(plyr) # Tools for Splitting, Applying and Combining Data
library(reshape) # Flexibly Reshape Data
library(reshape2) # Flexibly Reshape Data: A Reboot of the Reshape Package
library(Rmisc) # Rmisc: Ryan Miscellaneous
library(rpart) # Recursive Partitioning and Regression Trees
library(sjPlot) # Data Visualization for Statistics in Social Science 
library(tibble) # Simple Data Frames
library(tidyr) # Tidy Messy Data
library(tidyverse) # Easily Install and Load the 'Tidyverse'
library(vegan) # Community Ecology Package
library(viridis) # Colorblind-Friendly Color Maps for R
library(xlsx) # Read, Write, Format Excel 2007 and Excel 97/2000/XP/2003 Files
library(webshot)
require(ggiraph) # Make 'ggplot2' Graphics Interactive
require(ggiraphExtra) # Make Interactive 'ggplot2'. Extension to 'ggplot2' and 'ggiraph'
require(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
require(scales) # Scale Functions for Visualization

```

## Import data
```{r, import}
long_Transect_Data_18_19 <-
  read.csv(here::here("./clean_data/long_Transect_Data_18_19.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-c(1, 32:55))


fertile <-
  read.csv(here::here("./clean_data/fertile.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-c(1, 36:58))

AvgVars_notNA_Poll_18_19 <- read.csv(here::here("./clean_data/AvgVars_notNA_Poll_18_19.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1) %>%
    dplyr::mutate_at(vars(c("Patch_ID", "Year", "Transect_ID")), as.factor) %T>%
  str()

```

## Make sure classes are correct
```{r}
# long_Transect_Data_18_19-----
str(long_Transect_Data_18_19)

# Make columns numeric
long_Transect_Data_18_19$Inflor <- as.numeric(as.character(long_Transect_Data_18_19$Inflor))
long_Transect_Data_18_19$Pollinia_removed <- as.numeric(as.character(long_Transect_Data_18_19$Pollinia_removed))
long_Transect_Data_18_19$Flower <- as.numeric(as.character(long_Transect_Data_18_19$Flower))

# make patch ID, plant, year, and inflor cols factors
long_Transect_Data_18_19$Patch_ID <- as.factor(as.character(long_Transect_Data_18_19$Patch_ID))
long_Transect_Data_18_19$Plant_Num <- as.factor(as.character(long_Transect_Data_18_19$Plant_Num))
long_Transect_Data_18_19$Inflor <- as.factor(as.character(long_Transect_Data_18_19$Inflor))
long_Transect_Data_18_19$Year <- as.factor(as.character(long_Transect_Data_18_19$Year))

# make pollinia removed an integer
long_Transect_Data_18_19$Pollinia_removed <- as.integer(as.character(long_Transect_Data_18_19$Pollinia_removed))


# fertile-----
str(fertile)

# make patch ID, plant, year, and inflor cols factors
fertile$Patch_ID <- as.factor(as.character(fertile$Patch_ID))
fertile$Plant_Num <- as.factor(as.character(fertile$Plant_Num))
fertile$Year <- as.factor(as.character(fertile$Year))

str(fertile)
```

## Variable key

DATA FRAME: long_Transect_Data_18_19
RELEVANT VARIABLES: 

* Pollinia_removed
: Number of pollinia removed per flower (0-5). Was measured in July of 2018 and 2019.



DATA FRAME: fertile
RELEVANT VARIABLES: 

* Peduncles
: Number of peduncles per plant. Each peduncle is associated with one inflorescence.

* Viable_Pods
: Number of viable follicles per plant. These follicles were usually around 6-10 cm long, compared to aborted follicles, which were usually about 1 cm long and seemed to have stopped growing based on size and color (oftentimes brown/dried up).

* Height_Sept
: Height of sampled plant in September (when performing follicle, peduncle survey), in centimeters


BOTH DATA FRAMES

* City_dist
: Population's distance from urban center (Yonge & Dundas in Toronto), in kilometers.

* Transect_ID
: + Northern urban transect,
: + Southern urban transect (which follows green corridors including railroad tracks, trails, hydro lines, etc.), or
: + Rural transect.

    See [link](https://www.google.com/maps/d/u/0/edit?hl=en&mid=1T6o02xqdFY49LpaV5fgpNYcgUNfy6hWJ&ll=43.54856560494681%2C-79.7330821595105&z=10) for a map of the 3 transects.  
  

* Plants_present_2018
: Number of plants present at the sampling site in 2018. Populations were spaced at least 500 meters apart to ensure population distinction.

# Results
## Questions 1-2 (Milkweed data)
### Model Selection
#### Linear Models (lmer and glmer)
##### Peduncles
###### GLMER
####### City_dist, not urb_score
######## All sites: NO TRANSFORMATION NEEDED
```{r}
# OLD- BEFORE ZERO-INFLATED MODEL -----
# peds_glmer_gradient_01 <- glmer(Peduncles ~ (1|Patch_ID) +
# 
#                                   City_dist:Year +
#                                   City_dist +
#                                   Year,
# 
#                                 fertile,
#                                 family = "poisson",
#                                 glmerControl(optimizer="bobyqa",
#                                              optCtrl = list(maxfun = 100000))) # not converging, but I don't get error messages when I use glmmTMB yet I get nearly identical ANOVA results, so I'll stick with this
# 
# # # the glmmTMB anova, for reference:
# # glmmTMB::Anova.glmmTMB(glmmTMB::glmmTMB(Peduncles ~ (1|Patch_ID) + City_dist:Year +
# #                                   City_dist +
# #                                   Year,
# #                                 data = fertile,
# #                                 family = "poisson"), type = "II")
# 
# 
# # all main effects and secondary interactions
# peds_glmer_gradient_02 <- update(peds_glmer_gradient_01,
#                                  . ~ . -City_dist:Year)
# 
# peds_glmer_gradient_list <- list(peds_glmer_gradient_01,
#                                  peds_glmer_gradient_02)
# 
# formulas_peds <- data.frame(matrix(ncol = 0, nrow = 2))
# formulas_peds$Model <- NA
# formulas_peds$Formula <- NA
# formulas_peds$r.squaredGLMM_R2m <- NA
# formulas_peds$r.squaredGLMM_R2c <- NA
# 
# for (i in 1:length(peds_glmer_gradient_list)) {
#   formulas_peds[i, 1] <- toString(i)
#   formulas_peds[i, 2] <- toString(formula(peds_glmer_gradient_list[[i]]))
#   formulas_peds[i, 3] <- r.squaredGLMM(peds_glmer_gradient_list[[i]])[1,1] %>%
#     round(digits = 3)
#   formulas_peds[i, 4] <- r.squaredGLMM(peds_glmer_gradient_list[[i]])[1,2] %>%
#     round(digits = 3)
# }
# 
# glance_peds <- do.call(rbind,
#                        lapply(peds_glmer_gradient_list,
#                               broom.mixed::glance)) %>%
#   as.data.frame() %>%
#   mutate(BestModels = case_when(
#     AIC == min(AIC, na.rm=T) ~ "*",
#     AIC <= 2 + min(AIC, na.rm=T) ~ "*",
#     TRUE ~ "")) 
# 
# bound_peds <- bind_cols(formulas_peds,
#                         glance_peds %>%
#                           dplyr::select(AIC, BestModels)) # Model 1 lowest AIC
# 
# 
# summary(peds_glmer_gradient_01)
# peds_glmer_gradient_01_anova <- car::Anova(peds_glmer_gradient_01) %T>%
#   print() # interaction sig
# 
# # check residuals
# plot(simulateResiduals(peds_glmer_gradient_01)) # not normal... looks underdispersed
# testDispersion(simulateResiduals(peds_glmer_gradient_01)) # yup
# 
# # try generalized Poisson distribution w/glmmTMB
# peds_glmer_gradient_01.1 <- glmmTMB(Peduncles ~ (1|Patch_ID) +
#                                   
#                                   City_dist:Year +
#                                   City_dist +
#                                   Year,
#                                 
#                                 fertile,
#                                 family = "genpois")
# 
# # check residuals
# plot(simulateResiduals(peds_glmer_gradient_01.1)) # didn't help. try negbin
# 
# 
# peds_glmer_gradient_01.2 <- glmmTMB(Peduncles ~ (1|Patch_ID) +
#                                   City_dist:Year +
#                                   City_dist +
#                                   Year,
#                                 fertile,
#                                 family = nbinom1())
# # check residuals
# plot(simulateResiduals(peds_glmer_gradient_01.2)) # didn't help. tried 'compois' (Conway-Maxwell Poisson distribution) which didn't help either.
# 
# ## Hurdle Poisson model
# m1 <- glmmTMB(Peduncles ~ (1|Patch_ID) +
#                                   City_dist:Year +
#                                   City_dist +
#                                   Year,
#                                 fertile,
#               zi = ~City_dist:Year + City_dist + Year,
#               family = truncated_poisson)
# 
# # check residuals
# plot(simulateResiduals(m1)) # didn't help

# hist(AvgVars_byPatch$Peduncles, breaks = 16)

# GOING TO SUBTRACT 1 AND THEN USE ZERO-INFLATED MODEL OR HURDLE MODEL TO DEAL WITH ONE-INFLATION-----

fertile$Peduncles_minus1 <- fertile$Peduncles - 1

## Hurdle Poisson model
peds_glmer_gradient_01 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                  City_dist:Year +
                                  City_dist +
                                  Year,
                                fertile,
              zi = ~City_dist:Year + City_dist + Year,
              family = truncated_poisson)

# check residuals
plot(simulateResiduals(peds_glmer_gradient_01)) # BETTER! will stick with this one


# all main effects and secondary interactions
peds_glmer_gradient_02 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                  City_dist +
                                  Year,
                                fertile,
              zi = ~City_dist + Year,
              family = truncated_poisson)

peds_glmer_gradient_list <- list(peds_glmer_gradient_01,
                                 peds_glmer_gradient_02)

formulas_peds <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_peds$Model <- NA
formulas_peds$Formula <- NA
# formulas_peds$r.squaredGLMM_R2m <- NA
# formulas_peds$r.squaredGLMM_R2c <- NA

# COMMENTING OUT R-SQ BC r.squaredGLMM cannot (yet) handle 'glmmTMB' object with zero-inflation

for (i in 1:length(peds_glmer_gradient_list)) {
  formulas_peds[i, 1] <- toString(i)
  formulas_peds[i, 2] <- toString(formula(peds_glmer_gradient_list[[i]]))
  # formulas_peds[i, 3] <- r.squaredGLMM(peds_glmer_gradient_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_peds[i, 4] <- r.squaredGLMM(peds_glmer_gradient_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_peds <- do.call(rbind,
                       lapply(peds_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ ""))

bound_peds <- bind_cols(formulas_peds,
                        glance_peds %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC


summary(peds_glmer_gradient_01)
peds_glmer_gradient_01_anova <- car::Anova(peds_glmer_gradient_01, type = "III" ) %T>%
  print() # interaction not sig, so will redo with type II ANOVA

peds_glmer_gradient_01_anova <- car::Anova(peds_glmer_gradient_01, type = "II" ) %T>%
  print() # year marg sig



# check residuals
plot(simulateResiduals(peds_glmer_gradient_01)) # again, fine


```

######## Check for spatial autocorrelation
```{r}
DHARMa::testSpatialAutocorrelation(simulateResiduals(peds_glmer_gradient_01),
                           x = fertile$Peduncles_minus1,
                           y = fertile$City_dist)
# if there are multiple observations with the same x values,
# create first ar group with unique values for each location
# then aggregate the residuals per location, and calculate
# spatial autocorrelation on the new group

# calculating x, y positions per population
groupLocations <- fertile %>%
  dplyr::select(City_dist, Peduncles_minus1, Patch_ID, Latitude, Longitude, Year) %>%
  dplyr::group_by(Patch_ID, Year) %>%
  dplyr::summarise(City_dist = first(City_dist),
                   Lat = first(Latitude),
                   Long = first(Longitude),
                   Peduncles = mean(Peduncles_minus1, na.rm = TRUE)) %>%
  # now take average of both years
  dplyr::group_by(Patch_ID) %>%
  dplyr::summarise(City_dist = first(City_dist),
                   Lat = first(Lat),
                   Long = first(Long),
                   Peduncles = mean(Peduncles, na.rm = TRUE))

# calculating residuals per group
res2 = recalculateResiduals(simulateResiduals(peds_glmer_gradient_01),
                            group = fertile$Patch_ID)

# running the spatial test on grouped residuals
testSpatialAutocorrelation(res2,
                           groupLocations$Lat,
                           groupLocations$Long)

# p = 0.0086; reject null of no spatial autocorrelation




# try model which accounts for S.A.

# gls(
#   model = Peduncles_minus1 ~ (1|Patch_ID) +
#                                   City_dist +
#                                   Year,
#                               data = fertile,
#               zi = ~City_dist + Year,
#               family = truncated_poisson,
#   correlation = corExp(form = ~ x + y, nugget = TRUE), 
#   method = "REML"
# )
```

######## Urban sites: NO TRANSFORMATION NEEDED
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
# peds_glmer_subtr_01 <- glmer(Peduncles ~ (1|Patch_ID) +
#                                
#                                City_dist:Year:Transect_ID + 
#                                
#                                Year:Transect_ID + 
#                                City_dist:Transect_ID +
#                                City_dist:Year +
#                                
#                                City_dist +
#                                Year +
#                                Transect_ID,
#                              
#                              fertile %>%
#                                filter(Transect_ID != 'Rural'),
#                              family = "poisson",
#                              glmerControl(optimizer="bobyqa",
#                                           optCtrl = list(maxfun = 100000)))
# THIS MODEL IS ALSO ONE-INFLATED AND NEEDS THE SAME TREATMENT AS THE MODELS ABOVE

# Full model
peds_glmer_subtr_01 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID +
                                City_dist:Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID +
                                City_dist:Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and secondary interactions
peds_glmer_subtr_02 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 2/3 secondary interactions
peds_glmer_subtr_03 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_04 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_05 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year ,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year ,
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 1/3 secondary interactions
peds_glmer_subtr_06 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_07 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID ,
                                # City_dist:Year +
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID ,
                                # City_dist:Year +
                                # Year:Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_08 <-  glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year, 
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects
peds_glmer_subtr_09 <-  glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_list <- list(peds_glmer_subtr_01,
                               peds_glmer_subtr_02,
                               peds_glmer_subtr_03,
                               peds_glmer_subtr_04,
                               peds_glmer_subtr_05,
                               peds_glmer_subtr_06,
                               peds_glmer_subtr_07,
                               peds_glmer_subtr_08,
                               peds_glmer_subtr_09)

formulas_peds <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_peds$Model <- NA
formulas_peds$Formula <- NA
# formulas_peds$r.squaredGLMM_R2m <- NA
# formulas_peds$r.squaredGLMM_R2c <- NA

for (i in 1:length(peds_glmer_subtr_list)) {
  formulas_peds[i, 1] <- toString(i)
  formulas_peds[i, 2] <- toString(formula(peds_glmer_subtr_list[[i]]))
  # formulas_peds[i, 3] <- r.squaredGLMM(peds_glmer_subtr_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_peds[i, 4] <- r.squaredGLMM(peds_glmer_subtr_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_peds <- do.call(rbind,
                       lapply(peds_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_peds <- bind_cols(formulas_peds,
                        glance_peds %>%
                          dplyr::select(AIC, BestModels)) # Models 1, 3, 6 lowest AIC but best is 1

# check residuals
plot(simulateResiduals(peds_glmer_subtr_01)) # looks good
plot(simulateResiduals(peds_glmer_subtr_03)) # looks good
plot(simulateResiduals(peds_glmer_subtr_06)) # looks good


summary(peds_glmer_subtr_01)
peds_glmer_subtr_01_anova <- car::Anova(peds_glmer_subtr_01, type = "III") %T>%
  print() # interactions not sig, so will redo with type II ANOVA

peds_glmer_subtr_01_anova <- car::Anova(peds_glmer_subtr_01, type = "II") %T>%
  print() # transect marg sig



summary(peds_glmer_subtr_03)
peds_glmer_subtr_03_anova <- car::Anova(peds_glmer_subtr_03, type = "III") %T>%
  print() # interactions not sig, so will redo with type II ANOVA

peds_glmer_subtr_03_anova <- car::Anova(peds_glmer_subtr_03, type = "II") %T>%
  print()



summary(peds_glmer_subtr_06)
peds_glmer_subtr_06_anova <- car::Anova(peds_glmer_subtr_06, type = "III") %T>%
  print() # interactions not sig, so will redo with type II ANOVA

peds_glmer_subtr_06_anova <- car::Anova(peds_glmer_subtr_06, type = "II") %T>%
  print() 

AIC(peds_glmer_subtr_06)
```


####### urb_score, not City_dist
######## All sites: NO TRANSFORMATION NEEDED
```{r}
# u_peds_glmer_gradient_1 <- glmer(as.numeric(Peduncles) ~ (1|Patch_ID) + Urb_score * Year,
#                                  fertile,
#                                  family = "poisson",
#                                  glmerControl(optimizer="bobyqa",
#                                               optCtrl = list(maxfun = 100000)))
# plot(simulateResiduals(u_peds_glmer_gradient_1)) # trying zero-inflated model like for city_dist models


## Hurdle Poisson model
u_peds_glmer_gradient_01 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                  Urb_score:Year +
                                  Urb_score +
                                  Year,
                                fertile,
              zi = ~City_dist:Year + City_dist + Year,
              family = truncated_poisson)

# check residuals
plot(simulateResiduals(u_peds_glmer_gradient_01)) # BETTER! will stick with this one


# all main effects and secondary interactions
u_peds_glmer_gradient_02 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                  Urb_score +
                                  Year,
                                fertile,
              zi = ~Urb_score + Year,
              family = truncated_poisson)

u_peds_glmer_gradient_list <- list(u_peds_glmer_gradient_01,
                                 u_peds_glmer_gradient_02)

formulas_u_peds <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_peds$Model <- NA
formulas_u_peds$Formula <- NA
# formulas_u_peds$r.squaredGLMM_R2m <- NA
# formulas_u_peds$r.squaredGLMM_R2c <- NA

# COMMENTING OUT R-SQ BC r.squaredGLMM cannot (yet) handle 'glmmTMB' object with zero-inflation

for (i in 1:length(u_peds_glmer_gradient_list)) {
  formulas_u_peds[i, 1] <- toString(i)
  formulas_u_peds[i, 2] <- toString(formula(u_peds_glmer_gradient_list[[i]]))
  # formulas_u_peds[i, 3] <- r.squaredGLMM(u_peds_glmer_gradient_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_u_peds[i, 4] <- r.squaredGLMM(u_peds_glmer_gradient_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_u_peds <- do.call(rbind,
                       lapply(u_peds_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ ""))

bound_u_peds <- bind_cols(formulas_u_peds,
                        glance_u_peds %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC


summary(u_peds_glmer_gradient_01)
u_peds_glmer_gradient_01_anova <- car::Anova(u_peds_glmer_gradient_01, type = "III") %T>%
  print() # interaction not sig, so will redo with type II ANOVA

u_peds_glmer_gradient_01_anova <- car::Anova(u_peds_glmer_gradient_01, type = "II") %T>%
  print() # year marg sig

# check residuals
plot(simulateResiduals(u_peds_glmer_gradient_01)) # again, fine


```

######## Urban sites: NO TRANSFORMATION NEEDED
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
# u_peds_glmer_subtr_01 <- glmer(Peduncles ~ (1|Patch_ID) +
#                                
#                                Year:Transect_ID:Urb_score + 
#                                
#                                Year:Transect_ID + 
#                                Urb_score:Transect_ID +
#                                Urb_score:Year +
#                                
#                                Urb_score +
#                                Year +
#                                Transect_ID,
#                              
#                              fertile %>%
#                                filter(Transect_ID != 'Rural'),
#                              family = "poisson",
#                              glmerControl(optimizer="bobyqa",
#                                           optCtrl = list(maxfun = 100000)))
# THIS MODEL IS ALSO ONE-INFLATED AND NEEDS THE SAME TREATMENT AS THE MODELS ABOVE

# Full model
u_peds_glmer_subtr_01 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID +
                                Year:Transect_ID:Urb_score,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID +
                                Year:Transect_ID:Urb_score,
                              family = truncated_poisson)

# all main effects and secondary interactions
u_peds_glmer_subtr_02 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 2/3 secondary interactions
u_peds_glmer_subtr_03 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_04 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_05 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year ,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year ,
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 1/3 secondary interactions
u_peds_glmer_subtr_06 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_07 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score ,
                                # Urb_score:Year +
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score ,
                                # Urb_score:Year +
                                # Year:Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_08 <-  glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year, 
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects
u_peds_glmer_subtr_09 <-  glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_list <- list(u_peds_glmer_subtr_01,
                               u_peds_glmer_subtr_02,
                               u_peds_glmer_subtr_03,
                               u_peds_glmer_subtr_04,
                               u_peds_glmer_subtr_05,
                               u_peds_glmer_subtr_06,
                               u_peds_glmer_subtr_07,
                               u_peds_glmer_subtr_08,
                               u_peds_glmer_subtr_09)

formulas_u_peds <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_u_peds$Model <- NA
formulas_u_peds$Formula <- NA
# formulas_u_peds$r.squaredGLMM_R2m <- NA
# formulas_u_peds$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_peds_glmer_subtr_list)) {
  formulas_u_peds[i, 1] <- toString(i)
  formulas_u_peds[i, 2] <- toString(formula(u_peds_glmer_subtr_list[[i]]))
  # formulas_u_peds[i, 3] <- r.squaredGLMM(u_peds_glmer_subtr_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_u_peds[i, 4] <- r.squaredGLMM(u_peds_glmer_subtr_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_u_peds <- do.call(rbind,
                       lapply(u_peds_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_peds <- bind_cols(formulas_u_peds,
                        glance_u_peds %>%
                          dplyr::select(AIC, BestModels)) # Models 3,4,6 lowest AIC but best is 6

# check residuals
plot(simulateResiduals(u_peds_glmer_subtr_03)) # looks good
plot(simulateResiduals(u_peds_glmer_subtr_04)) # looks good
plot(simulateResiduals(u_peds_glmer_subtr_06)) # looks good


summary(u_peds_glmer_subtr_03)
u_peds_glmer_subtr_03_anova <- car::Anova(u_peds_glmer_subtr_03, type = "III") %T>%
  print() # interaction marg sig & transect is sig
# model 19


summary(u_peds_glmer_subtr_04)
u_peds_glmer_subtr_04_anova <- car::Anova(u_peds_glmer_subtr_04, type = "III") %T>%
  print() # no interactions sig so will use type II SS

u_peds_glmer_subtr_04_anova <- car::Anova(u_peds_glmer_subtr_04, type = "II") %T>%
  print() # tarnsect sig
AIC(u_peds_glmer_subtr_04) # model 20



summary(u_peds_glmer_subtr_06)
u_peds_glmer_subtr_06_anova <- car::Anova(u_peds_glmer_subtr_06, type = "III") %T>%
  print() # interaction marg sig and transect and year are sig


```

##### Pollinia
###### GLMER- no transformations needed
####### City_dist, not Urb_score
######## All sites
```{r}

# ## NOT CONVERGING- ERROR
# glmer(as.numeric(Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) + City_dist * Year,
#       long_Transect_Data_18_19,
#       family = "poisson",
#       glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))



# SEPARATE BY YEAR
## do this for only 2018-----
# no error
poll_glmer_gradient_01 <- glmer((Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) + City_dist,
                                long_Transect_Data_18_19 %>%
                                  filter(., Year == '2018'),
                                family = "poisson") %T>%
  simulateResiduals() %T>%
  plot() # looks good



## do this for only 2019-----
# no error
poll_glmer_gradient_02 <- glmer((Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) + City_dist,
                                long_Transect_Data_18_19 %>%
                                  filter(., Year == '2019'),
                                family = "poisson") %T>%
  simulateResiduals() %T>%
  plot() # looks good



# 2018 DATA
summary(poll_glmer_gradient_01)
poll_glmer_gradient_01_anova <- car::Anova(poll_glmer_gradient_01) %T>%
  print()
# city_dist sig


# 2019 DATA
summary(poll_glmer_gradient_02)
poll_glmer_gradient_02_anova <- car::Anova(poll_glmer_gradient_02) %T>%
  print()
# city_dist sig



poll_glmer_gradient_list <- list(poll_glmer_gradient_01,
                                 poll_glmer_gradient_02)

# - ----- GLMMTMB
poll_glmer_gradient_01.v2 <- glmmTMB(as.numeric(Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) + City_dist * Year,
        long_Transect_Data_18_19,
        family = "poisson") # this works

# I've checked that glmer's annual results are identical to glmmtmb's, so I'll use glmmtmb for this Q.





poll_glmer_gradient_02.v2 <- glmmTMB(as.numeric(Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) + City_dist + Year,
        long_Transect_Data_18_19,
        family = "poisson")

AIC(poll_glmer_gradient_01.v2, # lower AIC by >2
    poll_glmer_gradient_02.v2)


# check residuals
plot(simulateResiduals(poll_glmer_gradient_01.v2)) # looks fine


summary(poll_glmer_gradient_01.v2)
poll_glmer_gradient_01.v2_anova <- car::Anova(poll_glmer_gradient_01.v2, type = "III" ) %T>%
  print() # interaction  sig

```

######## Check for spatial autocorrelation
```{r}
# if there are multiple observations with the same x values,
# create first ar group with unique values for each location
# then aggregate the residuals per location, and calculate
# spatial autocorrelation on the new group

# calculating x, y positions per population
groupLocations_pollinia <- long_Transect_Data_18_19 %>%
  dplyr::select(City_dist,
                Average_Pollinia,
                Latitude,
                Longitude,
                Patch_ID) %>%
  dplyr::group_by(Patch_ID) %>%
  dplyr::summarise(City_dist = first(City_dist),
                   Lat = first(Latitude),
                   Long = first(Longitude),
                   Pollinia = mean(Average_Pollinia, na.rm = TRUE))

# calculating residuals per group
res2 = recalculateResiduals(
  simulateResiduals(poll_glmer_gradient_01.v2),
  group = long_Transect_Data_18_19$Patch_ID)

# running the spatial test on grouped residuals
testSpatialAutocorrelation(res2,
                           groupLocations_pollinia$Lat,
                           groupLocations_pollinia$Long)

# p = 0.1009; can't reject null of no spatial autocorrelation
```


######## Just urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
poll_glmer_subtr_01 <- glmer(Pollinia_removed ~ (1|Patch_ID/Plant_Num/Inflor) +
                               
                               City_dist:Year:Transect_ID + 
                               
                               Year:Transect_ID + 
                               City_dist:Transect_ID +
                               City_dist:Year +
                               
                               City_dist +
                               Year +
                               Transect_ID,
                             
                             long_Transect_Data_18_19 %>%
                               filter(Transect_ID != 'Rural'),
                             family = "poisson",
                             glmerControl(optimizer="bobyqa",
                                          optCtrl = list(maxfun = 100000)))

# all main effects and secondary interactions
poll_glmer_subtr_02 <- update(poll_glmer_subtr_01,
                              . ~ . -City_dist:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
poll_glmer_subtr_03 <- update(poll_glmer_subtr_02,
                              . ~ . -City_dist:Transect_ID)
poll_glmer_subtr_04 <- update(poll_glmer_subtr_02,
                              . ~ . -City_dist:Year)
poll_glmer_subtr_05 <- update(poll_glmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
poll_glmer_subtr_06 <- update(poll_glmer_subtr_03,
                              . ~ . -City_dist:Year)
poll_glmer_subtr_07 <- update(poll_glmer_subtr_04,
                              . ~ . -Year:Transect_ID)
poll_glmer_subtr_08 <- update(poll_glmer_subtr_05,
                              . ~ . -City_dist:Transect_ID)

# all main effects
poll_glmer_subtr_09 <- update(poll_glmer_subtr_08,
                              . ~ . -City_dist:Year)

poll_glmer_subtr_list <- list(poll_glmer_subtr_01,
                               poll_glmer_subtr_02,
                               poll_glmer_subtr_03,
                               poll_glmer_subtr_04,
                               poll_glmer_subtr_05,
                               poll_glmer_subtr_06,
                               poll_glmer_subtr_07,
                               poll_glmer_subtr_08,
                               poll_glmer_subtr_09)

# formula(poll_glmer_subtr_list[[2]])
formulas_poll <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_poll$Model <- NA
formulas_poll$Formula <- NA
formulas_poll$r.squaredGLMM_R2m <- NA
formulas_poll$r.squaredGLMM_R2c <- NA

for (i in 1:length(poll_glmer_subtr_list)) {
  formulas_poll[i, 1] <- toString(i)
  formulas_poll[i, 2] <- toString(formula(poll_glmer_subtr_list[[i]]))
  formulas_poll[i, 3] <- r.squaredGLMM(poll_glmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_poll[i, 4] <- r.squaredGLMM(poll_glmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_poll <- do.call(rbind,
                       lapply(poll_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_poll <- bind_cols(formulas_poll,
                        glance_poll %>%
                          dplyr::select(AIC, BestModels)) # Models 1, 3 lowest AIC (1 best)

# check residuals
plot(simulateResiduals(poll_glmer_subtr_01)) # looks good
plot(simulateResiduals(poll_glmer_subtr_03)) # looks good


summary(poll_glmer_subtr_01)
summary(poll_glmer_subtr_03)
poll_glmer_subtr_01_anova <- car::Anova(poll_glmer_subtr_01, type = "III") %T>%
  print() # interactions sig

poll_glmer_subtr_03_anova <- car::Anova(poll_glmer_subtr_03, type = "III") %T>%
  print() # interactions sig

```

####### Urb_score, not city_dist
######## All sites
```{r}
u_poll_glmer_gradient_1 <- glmer(Pollinia_removed ~ (1|Patch_ID/Plant_Num/Inflor) +
                                   
                                   Urb_score:Year +
                                   Urb_score +
                                   Year,
                                 
                                 long_Transect_Data_18_19,
                                 family = "poisson",
             glmerControl(optimizer="bobyqa",
                          optCtrl = list(maxfun = 100000)))

# all main effects and secondary interactions
u_poll_glmer_gradient_1.1 <- update(u_poll_glmer_gradient_1,
                              . ~ . -Urb_score:Year)

u_poll_glmer_gradient_list <- list(u_poll_glmer_gradient_1,
                                   u_poll_glmer_gradient_1.1)

# formula(poll_glmer_subtr_list[[2]])
u_formulas_poll <- data.frame(matrix(ncol = 0, nrow = 2))
u_formulas_poll$Model <- NA
u_formulas_poll$Formula <- NA
u_formulas_poll$r.squaredGLMM_R2m <- NA
u_formulas_poll$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_poll_glmer_gradient_list)) {
  u_formulas_poll[i, 1] <- toString(i)
  u_formulas_poll[i, 2] <- toString(formula(u_poll_glmer_gradient_list[[i]]))
  u_formulas_poll[i, 3] <- r.squaredGLMM(u_poll_glmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  u_formulas_poll[i, 4] <- r.squaredGLMM(u_poll_glmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

u_glance_poll <- do.call(rbind,
                       lapply(u_poll_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

u_bound_poll <- bind_cols(u_formulas_poll,
                        u_glance_poll %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC

# check residuals
plot(simulateResiduals(u_poll_glmer_gradient_1)) # looks good


summary(u_poll_glmer_gradient_1)
u_poll_glmer_gradient_1_anova <- car::Anova(u_poll_glmer_gradient_1, type = "III") %T>%
  print() # interaction sig

```

######## Urban sites
```{r}

# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
u_poll_glmer_subtr_01 <- glmer(Pollinia_removed ~ (1|Patch_ID/Plant_Num/Inflor) +
                               
                               Year:Transect_ID:Urb_score + 
                               
                               Year:Transect_ID + 
                               Urb_score:Transect_ID +
                               Urb_score:Year +
                               
                               Urb_score +
                               Year +
                               Transect_ID,
                             
                             long_Transect_Data_18_19 %>%
                               filter(Transect_ID != 'Rural'),
                             family = "poisson",
                             glmerControl(optimizer="bobyqa",
                                          optCtrl = list(maxfun = 100000)))

# all main effects and secondary interactions
u_poll_glmer_subtr_02 <- update(u_poll_glmer_subtr_01,
                              . ~ . -Year:Transect_ID:Urb_score)

# all main effects and 2/3 secondary interactions
u_poll_glmer_subtr_03 <- update(u_poll_glmer_subtr_02,
                              . ~ . -Transect_ID:Urb_score)
u_poll_glmer_subtr_04 <- update(u_poll_glmer_subtr_02,
                              . ~ . -Urb_score:Year)
u_poll_glmer_subtr_05 <- update(u_poll_glmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_poll_glmer_subtr_06 <- update(u_poll_glmer_subtr_03,
                              . ~ . -Urb_score:Year)
u_poll_glmer_subtr_07 <- update(u_poll_glmer_subtr_04,
                              . ~ . -Year:Transect_ID)
u_poll_glmer_subtr_08 <- update(u_poll_glmer_subtr_05,
                              . ~ . -Transect_ID:Urb_score)

# all main effects
u_poll_glmer_subtr_09 <- update(u_poll_glmer_subtr_08,
                              . ~ . -Urb_score:Year)

u_poll_glmer_subtr_list <- list(u_poll_glmer_subtr_01,
                               u_poll_glmer_subtr_02,
                               u_poll_glmer_subtr_03,
                               u_poll_glmer_subtr_04,
                               u_poll_glmer_subtr_05,
                               u_poll_glmer_subtr_06,
                               u_poll_glmer_subtr_07,
                               u_poll_glmer_subtr_08,
                               u_poll_glmer_subtr_09)

# formula(u_poll_glmer_subtr_list[[2]])
usc_formulas_poll <- data.frame(matrix(ncol = 0, nrow = 9))
usc_formulas_poll$Model <- NA
usc_formulas_poll$Formula <- NA
usc_formulas_poll$r.squaredGLMM_R2m <- NA
usc_formulas_poll$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_poll_glmer_subtr_list)) {
  usc_formulas_poll[i, 1] <- toString(i)
  usc_formulas_poll[i, 2] <- toString(formula(u_poll_glmer_subtr_list[[i]]))
  usc_formulas_poll[i, 3] <- r.squaredGLMM(u_poll_glmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  usc_formulas_poll[i, 4] <- r.squaredGLMM(u_poll_glmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

usc_glance_poll <- do.call(rbind,
                       lapply(u_poll_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

usc_bound_poll <- bind_cols(usc_formulas_poll,
                        usc_glance_poll %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC

# check residuals
plot(simulateResiduals(u_poll_glmer_subtr_01)) # looks good


summary(u_poll_glmer_subtr_01)
u_poll_glmer_subtr_01_anova <- car::Anova(u_poll_glmer_subtr_01, type = "III") %T>%
  print() # interaction sig


```


##### Pods
###### GLMER
####### City-dist
######## All sites- SQUARING TRANSFORMATION
```{r}
# pods_glmer_gradient_01 <- glmer(Viable_Pods ~ (1|Patch_ID) +
#                                   
                                  # City_dist:Year +
                                  # City_dist +
                                  # Year,
#                                 
#                                 fertile,
#                                 family = "poisson",
#                                 glmerControl(optimizer="bobyqa",
#                                              optCtrl = list(maxfun = 100000))) # not converging
# plot(simulateResiduals(pods_glmer_gradient_01)) # not ok... try hurdle model

fertile$Viable_Pods_minus1 <- fertile$Viable_Pods - 1

## Hurdle Poisson model
pods_glmer_gradient_01 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                  City_dist:Year +
                                  City_dist +
                                  Year,
                               
                                fertile,
              zi = ~City_dist:Year +
                                  City_dist +
                                  Year,
              family = truncated_poisson)
plot(simulateResiduals(pods_glmer_gradient_01)) # much better. Will go with this
# CODE DETAILING WHAT i TRIED TO DO BEFORE SETTLING ON SQUARING TRANSFORMATION WITH HURDLE MODEL BELOW
## After trying hurdle model WITHOUT Squaring transformation, I looked at dispersion and saw it was overdispersed, then tried a few other things...
# testDispersion(pods_glmer_gradient_01) # but it's overdispersed... try adding value which gives each row an ID
# 
# fertile$ID <- seq.int(nrow(fertile))
# 
# pods_glmer_gradient_01 <- glmmTMB(Viable_Pods_minus1 ~ (1|Patch_ID) + (1|ID) +
#                  City_dist:Year +
#                     City_dist +
#                     Year,
# 
#                   fertile,
# zi = ~City_dist:Year +
#                     City_dist +
#                     Year,
#               family = truncated_poisson)
# plot(simulateResiduals(pods_glmer_gradient_01)) # didn't help... try neg bin
# 
# pods_glmer_gradient_01 <- glmmTMB(Viable_Pods_minus1 ~ (1|Patch_ID) +
#                                City_dist:Year +
#                     City_dist +
#                     Year,
# 
#                                 fertile,
#               family = nbinom1())
# plot(simulateResiduals(pods_glmer_gradient_01)) # didn't help either
# hist(AvgVars_byPatch$Viable_Pods, breaks = 20)




# all main effects and secondary interactions
pods_glmer_gradient_02 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                  # City_dist:Year +
                                  City_dist +
                                  Year,
                               
                                fertile,
              zi = ~          City_dist +
                                  Year,
              family = truncated_poisson)

pods_glmer_gradient_list <- list(pods_glmer_gradient_01,
                                 pods_glmer_gradient_02)

formulas_pods <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_pods$Model <- NA
formulas_pods$Formula <- NA
# formulas_pods$r.squaredGLMM_R2m <- NA
# formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(pods_glmer_gradient_list)) {
  formulas_pods[i, 1] <- toString(i)
  formulas_pods[i, 2] <- toString(formula(pods_glmer_gradient_list[[i]]))
  # formulas_pods[i, 3] <- r.squaredGLMM(pods_glmer_gradient_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_pods[i, 4] <- r.squaredGLMM(pods_glmer_gradient_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_pods <- do.call(rbind,
                       lapply(pods_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_pods <- bind_cols(formulas_pods,
                        glance_pods %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC

# check residuals
plot(simulateResiduals(pods_glmer_gradient_01)) # looks good


summary(pods_glmer_gradient_01)
pods_glmer_gradient_01_anova <- car::Anova(pods_glmer_gradient_01, type = "III") %T>%
  print() # year and interaxn sig


```

######## Check for spatial autocorrelation
```{r}
# if there are multiple observations with the same x values,
# create first ar group with unique values for each location
# then aggregate the residuals per location, and calculate
# spatial autocorrelation on the new group

# calculating x, y positions per population
groupLocations <- fertile %>%
  dplyr::select(City_dist, Viable_Pods_minus1, Patch_ID, Latitude, Longitude, Year) %>%
  dplyr::group_by(Patch_ID, Year) %>%
  dplyr::summarise(City_dist = first(City_dist),
                   Lat = first(Latitude),
                   Long = first(Longitude),
                   Viable_Pods_minus1 = mean(Viable_Pods_minus1, na.rm = TRUE)) %>%
  # now take average of both years
  dplyr::group_by(Patch_ID) %>%
  dplyr::summarise(City_dist = first(City_dist),
                   Lat = first(Lat),
                   Long = first(Long),
                   Viable_Pods_minus1 = mean(Viable_Pods_minus1, na.rm = TRUE))

# calculating residuals per group
res2 = recalculateResiduals(simulateResiduals(pods_glmer_gradient_01),
                            group = fertile$Patch_ID)

# running the spatial test on grouped residuals
testSpatialAutocorrelation(res2,
                           groupLocations$Lat,
                           groupLocations$Long)

# p = 0.7408; can't reject null of no spatial autocorrelation

```


######## Urban sites- SQUARING TRANSFORMATION
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
# pods_glmer_subtr_01 <- glmer(Viable_Pods ~ (1|Patch_ID) +
#                                
#                                City_dist:Year:Transect_ID + 
#                                
#                                Year:Transect_ID + 
#                                City_dist:Transect_ID +
#                                City_dist:Year +
#                                
#                                City_dist +
#                                Year +
#                                Transect_ID,
#                              
#                              fertile %>%
#                                filter(Transect_ID != 'Rural'),
#                              family = "poisson",
#                              glmerControl(optimizer="bobyqa",
#                                           optCtrl = list(maxfun = 100000))) # diagnostic plot is not normal. Trying a hurdle model like for Q1 above

# GOING TO SUBTRACT 1 AND THEN USE ZERO-INFLATED MODEL OR HURDLE MODEL TO DEAL WITH ONE-INFLATION-----

## Hurdle Poisson model
pods_glmer_subtr_01 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                               City_dist:Year:Transect_ID + 
                                 
                               Year:Transect_ID + 
                               City_dist:Transect_ID +
                               City_dist:Year +
                               
                               City_dist +
                               Year +
                               Transect_ID,
                               
                                fertile,
              zi = ~Year*Transect_ID*City_dist,
              family = truncated_poisson)

# check residuals
plot(simulateResiduals(pods_glmer_subtr_01)) # BETTER! going with this
testDispersion(pods_glmer_subtr_01) # without squaring transf, was overdispersed


# all main effects and secondary interactions
pods_glmer_subtr_02 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 2/3 secondary interactions
pods_glmer_subtr_03 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

pods_glmer_subtr_04 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

pods_glmer_subtr_05 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year ,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year ,
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 1/3 secondary interactions
pods_glmer_subtr_06 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

pods_glmer_subtr_07 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID ,
                                # City_dist:Year +
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID ,
                                # City_dist:Year +
                                # Year:Transect_ID,
                              family = truncated_poisson)

pods_glmer_subtr_08 <-  glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year, 
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects
pods_glmer_subtr_09 <-  glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID,
                              family = truncated_poisson)


pods_glmer_subtr_list <- list(pods_glmer_subtr_01,
                               pods_glmer_subtr_02,
                               pods_glmer_subtr_03,
                               pods_glmer_subtr_04,
                               pods_glmer_subtr_05,
                               pods_glmer_subtr_06,
                               pods_glmer_subtr_07,
                               pods_glmer_subtr_08,
                               pods_glmer_subtr_09)

formulas_pods <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_pods$Model <- NA
formulas_pods$Formula <- NA
# formulas_pods$r.squaredGLMM_R2m <- NA
# formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(pods_glmer_subtr_list)) {
  formulas_pods[i, 1] <- toString(i)
  formulas_pods[i, 2] <- toString(formula(pods_glmer_subtr_list[[i]]))
  # formulas_pods[i, 3] <- r.squaredGLMM(pods_glmer_subtr_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_pods[i, 4] <- r.squaredGLMM(pods_glmer_subtr_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_pods <- do.call(rbind,
                       lapply(pods_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_pods <- bind_cols(formulas_pods,
                        glance_pods %>%
                          dplyr::select(AIC, BestModels)) # Models 2, 3, 8 lowest AIC (3 is lowest)

summary(pods_glmer_subtr_02)
pods_glmer_subtr_02_anova <- car::Anova(pods_glmer_subtr_02, type = "III") %T>%
  print() # no sig interactions, so will use type II SS

pods_glmer_subtr_02_anova <- car::Anova(pods_glmer_subtr_02, type = "II") %T>%
  print() 


summary(pods_glmer_subtr_03)
pods_glmer_subtr_03_anova <- car::Anova(pods_glmer_subtr_03, type = "III") %T>%
  print() # no sig interactions, so will use type II SS

pods_glmer_subtr_03_anova <- car::Anova(pods_glmer_subtr_03, type = "II") %T>%
  print()


summary(pods_glmer_subtr_08)
pods_glmer_subtr_08_anova <- car::Anova(pods_glmer_subtr_08, type = "III") %T>%
  print() # no sig interactions, so will use type II SS) 

pods_glmer_subtr_08_anova <- car::Anova(pods_glmer_subtr_08, type = "II") %T>%
  print()



# check residuals
plot(simulateResiduals(pods_glmer_subtr_02)) # looks fine
plot(simulateResiduals(pods_glmer_subtr_03)) # looks fine
plot(simulateResiduals(pods_glmer_subtr_08)) # looks fine


```

####### urb_score, not dist
######## All sites- CUBING TRANSFORMATION
```{r}
# u_pods_glmer_gradient_1 <- glmer(Viable_Pods ~ (1|Patch_ID) +
#                                    
#                                    Urb_score:Year +
#                                    Urb_score +
#                                    Year,
#                                  
#                                  fertile,
#                                  family = "poisson",
#              glmerControl(optimizer="bobyqa",
#                           optCtrl = list(maxfun = 100000)))
# 
# plot(simulateResiduals(u_pods_glmer_gradient_1)) # not ok... try hurdle model

## Hurdle Poisson model
u_pods_glmer_gradient_1 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                  Urb_score:Year +
                                  Urb_score +
                                  Year,
                               
                                fertile,
              zi = ~Urb_score:Year +
                                  Urb_score +
                                  Year,
              family = truncated_poisson)
plot(simulateResiduals(u_pods_glmer_gradient_1)) # much better. Will go with this


# all main effects and secondary interactions
u_pods_glmer_gradient_1.1 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                  # Urb_score:Year +
                                  Urb_score +
                                  Year,
                               
                                fertile,
              zi = ~Urb_score +
                                  Year,
              family = truncated_poisson)

u_pods_glmer_gradient_list <- list(u_pods_glmer_gradient_1,
                                   u_pods_glmer_gradient_1.1)


u_formulas_pods <- data.frame(matrix(ncol = 0, nrow = 2))
u_formulas_pods$Model <- NA
u_formulas_pods$Formula <- NA
# u_formulas_pods$r.squaredGLMM_R2m <- NA
# u_formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_pods_glmer_gradient_list)) {
  u_formulas_pods[i, 1] <- toString(i)
  u_formulas_pods[i, 2] <- toString(formula(u_pods_glmer_gradient_list[[i]]))
  # u_formulas_pods[i, 3] <- r.squaredGLMM(u_pods_glmer_gradient_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # u_formulas_pods[i, 4] <- r.squaredGLMM(u_pods_glmer_gradient_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

u_glance_pods <- do.call(rbind,
                       lapply(u_pods_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

u_bound_pods <- bind_cols(u_formulas_pods,
                        u_glance_pods %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC

# check residuals
plot(simulateResiduals(u_pods_glmer_gradient_1)) # looks good


summary(u_pods_glmer_gradient_1)
u_pods_glmer_gradient_1_anova <- car::Anova(u_pods_glmer_gradient_1, type = "III") %T>%
  print() # year and interaxn sig

```


######## Urban sites- CUBING TRANSFORMATION
```{r}

# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
# u_pods_glmer_subtr_01 <- glmer(Viable_Pods ~ (1|Patch_ID) +
#                                
#                                Year:Transect_ID:Urb_score + 
#                                
#                                Year:Transect_ID + 
#                                Urb_score:Transect_ID +
#                                Urb_score:Year +
#                                
#                                Urb_score +
#                                Year +
#                                Transect_ID,
#                              
#                              fertile %>%
#                                filter(Transect_ID != 'Rural'),
#                              family = "poisson",
#                              glmerControl(optimizer="bobyqa",
#                                           optCtrl = list(maxfun = 100000)))
# plot(simulateResiduals(u_pods_glmer_subtr_01)) # not normal... try hurdle model


## Hurdle Poisson model
u_pods_glmer_subtr_01 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                               Year:Transect_ID:Urb_score + 
                                 
                               Year:Transect_ID + 
                               Urb_score:Transect_ID +
                               Urb_score:Year +
                               
                               Urb_score +
                               Year +
                               Transect_ID,
                               
                                fertile,
              zi = ~Year*Transect_ID*Urb_score,
              family = truncated_poisson)

# check residuals
plot(simulateResiduals(u_pods_glmer_subtr_01)) # BETTER! going with this


# all main effects and secondary interactions
u_pods_glmer_subtr_02 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 2/3 secondary interactions
u_pods_glmer_subtr_03 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_pods_glmer_subtr_04 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_pods_glmer_subtr_05 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year ,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year ,
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 1/3 secondary interactions
u_pods_glmer_subtr_06 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_pods_glmer_subtr_07 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score ,
                                # Urb_score:Year +
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score ,
                                # Urb_score:Year +
                                # Year:Transect_ID,
                              family = truncated_poisson)

u_pods_glmer_subtr_08 <-  glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year, 
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects
u_pods_glmer_subtr_09 <-  glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID,
                              family = truncated_poisson)



u_pods_glmer_subtr_list <- list(u_pods_glmer_subtr_01,
                               u_pods_glmer_subtr_02,
                               u_pods_glmer_subtr_03,
                               u_pods_glmer_subtr_04,
                               u_pods_glmer_subtr_05,
                               u_pods_glmer_subtr_06,
                               u_pods_glmer_subtr_07,
                               u_pods_glmer_subtr_08,
                               u_pods_glmer_subtr_09)

# formula(pods_glmer_subtr_list[[2]])
u_formulas_pods <- data.frame(matrix(ncol = 0, nrow = 9))
u_formulas_pods$Model <- NA
u_formulas_pods$Formula <- NA
# u_formulas_pods$r.squaredGLMM_R2m <- NA
# u_formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_pods_glmer_subtr_list)) {
  u_formulas_pods[i, 1] <- toString(i)
  u_formulas_pods[i, 2] <- toString(formula(u_pods_glmer_subtr_list[[i]]))
  # u_formulas_pods[i, 3] <- r.squaredGLMM(u_pods_glmer_subtr_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # u_formulas_pods[i, 4] <- r.squaredGLMM(u_pods_glmer_subtr_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

u_glance_pods <- do.call(rbind,
                       lapply(u_pods_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

u_bound_pods <- bind_cols(u_formulas_pods,
                        u_glance_pods %>%
                          dplyr::select(AIC, BestModels)) # Models 2,3 lowest AIC. Model 3 is the best though.

# check residuals
plot(simulateResiduals(u_pods_glmer_subtr_02)) # looks fine
plot(simulateResiduals(u_pods_glmer_subtr_03)) # looks fine



summary(u_pods_glmer_subtr_02)
u_pods_glmer_subtr_02_anova <- car::Anova(u_pods_glmer_subtr_02, type = "III") %T>%
  print()

summary(u_pods_glmer_subtr_03)
u_pods_glmer_subtr_03_anova <- car::Anova(u_pods_glmer_subtr_03, type = "III") %T>%
  print()

```


##### Pods per peduncle (i.e. follicles per inflorescence)
###### LMER
####### City_dist, not urb-score
######## All sites
```{r}
podsperped_lmer_gradient_01 <- lmer(pods_per_ped ~ (1|Patch_ID) +
                                  
                                  City_dist:Year +
                                  City_dist +
                                  Year,
                                
                                fertile,
                                REML = F) 


# all main effects and secondary interactions
podsperped_lmer_gradient_02 <- update(podsperped_lmer_gradient_01,
                                 . ~ . -City_dist:Year)

podsperped_lmer_gradient_list <- list(podsperped_lmer_gradient_01,
                                 podsperped_lmer_gradient_02)

formulas_podsperped <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_podsperped$Model <- NA
formulas_podsperped$Formula <- NA
formulas_podsperped$r.squaredGLMM_R2m <- NA
formulas_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(podsperped_lmer_gradient_list)) {
  formulas_podsperped[i, 1] <- toString(i)
  formulas_podsperped[i, 2] <- toString(formula(podsperped_lmer_gradient_list[[i]]))
  formulas_podsperped[i, 3] <- r.squaredGLMM(podsperped_lmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_podsperped[i, 4] <- r.squaredGLMM(podsperped_lmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_podsperped <- do.call(rbind,
                       lapply(podsperped_lmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_podsperped <- bind_cols(formulas_podsperped,
                        glance_podsperped %>%
                          dplyr::select(AIC, BestModels)) # Models 1 & 2 lowest AIC (2 is best)

# check residuals
library(effects) 
library(sjPlot) 
plot_model(podsperped_lmer_gradient_01, type='diag') # looks fine
plot_model(podsperped_lmer_gradient_02, type='diag') # looks fine


summary(podsperped_lmer_gradient_01)
podsperped_lmer_gradient_01_anova <- car::Anova(podsperped_lmer_gradient_01, type = "III") %T>%
  print() # interaction not sig so will use type II SS

podsperped_lmer_gradient_01_anova <- car::Anova(podsperped_lmer_gradient_01, type = "II") %T>%
  print() # city_dist marg sig


summary(podsperped_lmer_gradient_02)
podsperped_lmer_gradient_02_anova <- car::Anova(podsperped_lmer_gradient_02, type = "II") %T>%
  print() #  city_dist marg sig

```

######## Check for spatial autocorrelation
```{r}
# if there are multiple observations with the same x values,
# create first ar group with unique values for each location
# then aggregate the residuals per location, and calculate
# spatial autocorrelation on the new group

# calculating x, y positions per population
groupLocations <- fertile %>%
  dplyr::select(City_dist, pods_per_ped, Patch_ID, Latitude, Longitude, Year) %>%
  dplyr::group_by(Patch_ID, Year) %>%
  dplyr::summarise(City_dist = first(City_dist),
                   Lat = first(Latitude),
                   Long = first(Longitude),
                   podsperped = mean(pods_per_ped, na.rm = TRUE)) %>%
  # now take average of both years
  dplyr::group_by(Patch_ID) %>%
  dplyr::summarise(City_dist = first(City_dist),
                   Lat = first(Lat),
                   Long = first(Long),
                   podsperped = mean(podsperped, na.rm = TRUE))

# calculating residuals per group
res2 = recalculateResiduals(simulateResiduals(podsperped_lmer_gradient_02),
                            group = fertile$Patch_ID)

# running the spatial test on grouped residuals
testSpatialAutocorrelation(res2,
                           groupLocations$Lat,
                           groupLocations$Long)

# p = 0.5123; can't reject null of no spatial autocorrelation

```

######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
podsperped_lmer_subtr_01 <- lmer(pods_per_ped ~ (1|Patch_ID) +
                               
                               City_dist:Year:Transect_ID + 
                               
                               Year:Transect_ID + 
                               City_dist:Transect_ID +
                               City_dist:Year +
                               
                               City_dist +
                               Year +
                               Transect_ID,
                             
                             fertile %>%
                               filter(Transect_ID != 'Rural'),
                           REML = F)

# all main effects and secondary interactions
podsperped_lmer_subtr_02 <- update(podsperped_lmer_subtr_01,
                              . ~ . -City_dist:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
podsperped_lmer_subtr_03 <- update(podsperped_lmer_subtr_02,
                              . ~ . -City_dist:Transect_ID)
podsperped_lmer_subtr_04 <- update(podsperped_lmer_subtr_02,
                              . ~ . -City_dist:Year)
podsperped_lmer_subtr_05 <- update(podsperped_lmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
podsperped_lmer_subtr_06 <- update(podsperped_lmer_subtr_03,
                              . ~ . -City_dist:Year)
podsperped_lmer_subtr_07 <- update(podsperped_lmer_subtr_04,
                              . ~ . -Year:Transect_ID)
podsperped_lmer_subtr_08 <- update(podsperped_lmer_subtr_05,
                              . ~ . -City_dist:Transect_ID)

# all main effects
podsperped_lmer_subtr_09 <- update(podsperped_lmer_subtr_08,
                              . ~ . -City_dist:Year)

podsperped_lmer_subtr_list <- list(podsperped_lmer_subtr_01,
                               podsperped_lmer_subtr_02,
                               podsperped_lmer_subtr_03,
                               podsperped_lmer_subtr_04,
                               podsperped_lmer_subtr_05,
                               podsperped_lmer_subtr_06,
                               podsperped_lmer_subtr_07,
                               podsperped_lmer_subtr_08,
                               podsperped_lmer_subtr_09)

formulas_podsperped <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_podsperped$Model <- NA
formulas_podsperped$Formula <- NA
formulas_podsperped$r.squaredGLMM_R2m <- NA
formulas_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(podsperped_lmer_subtr_list)) {
  formulas_podsperped[i, 1] <- toString(i)
  formulas_podsperped[i, 2] <- toString(formula(podsperped_lmer_subtr_list[[i]]))
  formulas_podsperped[i, 3] <- r.squaredGLMM(podsperped_lmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_podsperped[i, 4] <- r.squaredGLMM(podsperped_lmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_podsperped <- do.call(rbind,
                       lapply(podsperped_lmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_podsperped <- bind_cols(formulas_podsperped,
                        glance_podsperped %>%
                          dplyr::select(AIC, BestModels)) # Models 3,5, 8 lowest AIC (8 is lowest)

# check residuals
library(effects) 
library(sjPlot)
plot_model(podsperped_lmer_subtr_03, type='diag') # looks fine
plot_model(podsperped_lmer_subtr_05, type='diag') # looks fine
plot_model(podsperped_lmer_subtr_08, type='diag') # looks fine



summary(podsperped_lmer_subtr_03)
podsperped_lmer_subtr_03_anova <- car::Anova(podsperped_lmer_subtr_03, type = "III") %T>%
  print() # Model 16

summary(podsperped_lmer_subtr_05)
podsperped_lmer_subtr_05_anova <- car::Anova(podsperped_lmer_subtr_05, type = "III") %T>%
  print() # city_dist isn't marg sig anymore
AIC(podsperped_lmer_subtr_05) # Model 17

summary(podsperped_lmer_subtr_08)
podsperped_lmer_subtr_08_anova <- car::Anova(podsperped_lmer_subtr_08, type = "III") %T>%
  print() 

```

####### Urb_score, not City_dist
######## All sites
```{r}
u_podsperped_lmer_gradient_01 <- lmer(pods_per_ped ~ (1|Patch_ID) +
                                  
                                  Urb_score:Year +
                                  Urb_score +
                                  Year,
                                
                                fertile,
                                REML = F) 


# all main effects and secondary interactions
u_podsperped_lmer_gradient_02 <- update(u_podsperped_lmer_gradient_01,
                                 . ~ . -Urb_score:Year)

u_podsperped_lmer_gradient_list <- list(u_podsperped_lmer_gradient_01,
                                 u_podsperped_lmer_gradient_02)

formulas_u_podsperped <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_podsperped$Model <- NA
formulas_u_podsperped$Formula <- NA
formulas_u_podsperped$r.squaredGLMM_R2m <- NA
formulas_u_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_podsperped_lmer_gradient_list)) {
  formulas_u_podsperped[i, 1] <- toString(i)
  formulas_u_podsperped[i, 2] <- toString(formula(u_podsperped_lmer_gradient_list[[i]]))
  formulas_u_podsperped[i, 3] <- r.squaredGLMM(u_podsperped_lmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_podsperped[i, 4] <- r.squaredGLMM(u_podsperped_lmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_podsperped <- do.call(rbind,
                       lapply(u_podsperped_lmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_podsperped <- bind_cols(formulas_u_podsperped,
                        glance_u_podsperped %>%
                          dplyr::select(AIC, BestModels)) # Models 1 & 2 lowest AIC (2 is best)

# check residuals
library(effects) 
library(sjPlot)
plot_model(u_podsperped_lmer_gradient_01, type='diag') # looks fine
plot_model(u_podsperped_lmer_gradient_02, type='diag') # looks fine


summary(u_podsperped_lmer_gradient_01)
u_podsperped_lmer_gradient_01_anova <- car::Anova(u_podsperped_lmer_gradient_01, type = "III") %T>%
  print()  # itneraction not sig so will use type II SS

u_podsperped_lmer_gradient_01_anova <- car::Anova(u_podsperped_lmer_gradient_01, type = "II") %T>%
  print()  # Urb_score sig

summary(u_podsperped_lmer_gradient_02)
u_podsperped_lmer_gradient_02_anova <- car::Anova(u_podsperped_lmer_gradient_02, type = "II") %T>%
  print() #  Urb_score sig

```

######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
u_podsperped_lmer_subtr_01 <- lmer(pods_per_ped ~ (1|Patch_ID) +
                               
                               Year:Transect_ID:Urb_score + 
                               
                               Year:Transect_ID + 
                               Urb_score:Transect_ID +
                               Urb_score:Year +
                               
                               Urb_score +
                               Year +
                               Transect_ID,
                             
                             fertile %>%
                               filter(Transect_ID != 'Rural'),
                           REML = F)

# all main effects and secondary interactions
u_podsperped_lmer_subtr_02 <- update(u_podsperped_lmer_subtr_01,
                              . ~ . -Year:Transect_ID:Urb_score)

# all main effects and 2/3 secondary interactions
u_podsperped_lmer_subtr_03 <- update(u_podsperped_lmer_subtr_02,
                              . ~ . -Transect_ID:Urb_score)
u_podsperped_lmer_subtr_04 <- update(u_podsperped_lmer_subtr_02,
                              . ~ . -Urb_score:Year)
u_podsperped_lmer_subtr_05 <- update(u_podsperped_lmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_podsperped_lmer_subtr_06 <- update(u_podsperped_lmer_subtr_03,
                              . ~ . -Urb_score:Year)
u_podsperped_lmer_subtr_07 <- update(u_podsperped_lmer_subtr_04,
                              . ~ . -Year:Transect_ID)
u_podsperped_lmer_subtr_08 <- update(u_podsperped_lmer_subtr_05,
                              . ~ . -Transect_ID:Urb_score)

# all main effects
u_podsperped_lmer_subtr_09 <- update(u_podsperped_lmer_subtr_08,
                              . ~ . -Urb_score:Year)

u_podsperped_lmer_subtr_list <- list(u_podsperped_lmer_subtr_01,
                               u_podsperped_lmer_subtr_02,
                               u_podsperped_lmer_subtr_03,
                               u_podsperped_lmer_subtr_04,
                               u_podsperped_lmer_subtr_05,
                               u_podsperped_lmer_subtr_06,
                               u_podsperped_lmer_subtr_07,
                               u_podsperped_lmer_subtr_08,
                               u_podsperped_lmer_subtr_09)

formulas_u_podsperped <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_u_podsperped$Model <- NA
formulas_u_podsperped$Formula <- NA
formulas_u_podsperped$r.squaredGLMM_R2m <- NA
formulas_u_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_podsperped_lmer_subtr_list)) {
  formulas_u_podsperped[i, 1] <- toString(i)
  formulas_u_podsperped[i, 2] <- toString(formula(u_podsperped_lmer_subtr_list[[i]]))
  formulas_u_podsperped[i, 3] <- r.squaredGLMM(u_podsperped_lmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_podsperped[i, 4] <- r.squaredGLMM(u_podsperped_lmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_podsperped <- do.call(rbind,
                       lapply(u_podsperped_lmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_podsperped <- bind_cols(formulas_u_podsperped,
                        glance_u_podsperped %>%
                          dplyr::select(AIC, BestModels)) # Models 6,7,8,9 lowest AIC (9 is lowest)

# check residuals
library(effects) 
library(sjPlot) 
plot_model(u_podsperped_lmer_subtr_06, type='diag') # looks fine
plot_model(u_podsperped_lmer_subtr_07, type='diag') # looks fine
plot_model(u_podsperped_lmer_subtr_08, type='diag') # looks fine
plot_model(u_podsperped_lmer_subtr_09, type='diag') # looks fine

summary(u_podsperped_lmer_subtr_06)
u_podsperped_lmer_subtr_06_anova <- car::Anova(u_podsperped_lmer_subtr_06, type = "III") %T>%
  print() #nothing sig so will use type II SS

u_podsperped_lmer_subtr_06_anova <- car::Anova(u_podsperped_lmer_subtr_06, type = "II") %T>%
  print()
AIC(u_podsperped_lmer_subtr_06) # Model 22


summary(u_podsperped_lmer_subtr_07)
u_podsperped_lmer_subtr_07_anova <- car::Anova(u_podsperped_lmer_subtr_07, type = "III") %T>%
  print() # interaction not sig so will use type II SS

u_podsperped_lmer_subtr_07_anova <- car::Anova(u_podsperped_lmer_subtr_07, type = "II") %T>%
  print()
AIC(u_podsperped_lmer_subtr_07) # Model 23


summary(u_podsperped_lmer_subtr_08)
u_podsperped_lmer_subtr_08_anova <- car::Anova(u_podsperped_lmer_subtr_08, type = "III") %T>%
  print()  # interaction not sig so will use type II SS

u_podsperped_lmer_subtr_08_anova <- car::Anova(u_podsperped_lmer_subtr_08, type = "II") %T>%
  print()  
AIC(u_podsperped_lmer_subtr_08) # Model 24


summary(u_podsperped_lmer_subtr_09)
u_podsperped_lmer_subtr_09_anova <- car::Anova(u_podsperped_lmer_subtr_09, type = "II") %T>%
  print() 

```


##### Height (Sept)
###### LMER
####### City_dist
######## All sites
```{r}
height_lmer_gradient_01 <- lmer(Height_Sept ~ (1|Patch_ID) +
                                  
                                  City_dist:Year +
                                  City_dist +
                                  Year,
                                
                                fertile,
                                REML = F) 


# all main effects and secondary interactions
height_lmer_gradient_02 <- update(height_lmer_gradient_01,
                                 . ~ . -City_dist:Year)

height_lmer_gradient_list <- list(height_lmer_gradient_01,
                                 height_lmer_gradient_02)

formulas_height <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_height$Model <- NA
formulas_height$Formula <- NA
formulas_height$r.squaredGLMM_R2m <- NA
formulas_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(height_lmer_gradient_list)) {
  formulas_height[i, 1] <- toString(i)
  formulas_height[i, 2] <- toString(formula(height_lmer_gradient_list[[i]]))
  formulas_height[i, 3] <- r.squaredGLMM(height_lmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_height[i, 4] <- r.squaredGLMM(height_lmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_height <- do.call(rbind,
                       lapply(height_lmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_height <- bind_cols(formulas_height,
                        glance_height %>%
                          dplyr::select(AIC, BestModels)) # Models 1 & 2 lowest AIC (2 is best)

# check residuals
plot_model(height_lmer_gradient_01, type='diag') # looks fine
plot_model(height_lmer_gradient_02, type='diag') # looks fine


summary(height_lmer_gradient_01)
height_lmer_gradient_01_anova <- car::Anova(height_lmer_gradient_01, type = "III") %T>%
  print() # interaction not sig so will use type II

height_lmer_gradient_01_anova <- car::Anova(height_lmer_gradient_01, type = "II") %T>%
  print() # year sig

summary(height_lmer_gradient_02)
height_lmer_gradient_02_anova <- car::Anova(height_lmer_gradient_02) %T>%
  print() # year sig

```

######## Check for spatial autocorrelation
```{r}
# if there are multiple observations with the same x values,
# create first ar group with unique values for each location
# then aggregate the residuals per location, and calculate
# spatial autocorrelation on the new group

# calculating x, y positions per population
groupLocations <- fertile %>%
  dplyr::select(City_dist, Height_Sept, Patch_ID, Latitude, Longitude, Year) %>%
  dplyr::group_by(Patch_ID, Year) %>%
  dplyr::summarise(City_dist = first(City_dist),
                   Lat = first(Latitude),
                   Long = first(Longitude),
                   height = mean(Height_Sept, na.rm = TRUE)) %>%
  # now take average of both years
  dplyr::group_by(Patch_ID) %>%
  dplyr::summarise(City_dist = first(City_dist),
                   Lat = first(Lat),
                   Long = first(Long),
                   height = mean(height, na.rm = TRUE))

# calculating residuals per group
res2 = recalculateResiduals(simulateResiduals(height_lmer_gradient_02),
                            group = fertile$Patch_ID)

# running the spatial test on grouped residuals
testSpatialAutocorrelation(res2,
                           groupLocations$Lat,
                           groupLocations$Long)

# p = 0.3936; can't reject null of no spatial autocorrelation

```


######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
height_lmer_subtr_01 <- lmer(Height_Sept ~ (1|Patch_ID) +
                               
                               City_dist:Year:Transect_ID + 
                               
                               Year:Transect_ID + 
                               City_dist:Transect_ID +
                               City_dist:Year +
                               
                               City_dist +
                               Year +
                               Transect_ID,
                             
                             fertile %>%
                               filter(Transect_ID != 'Rural'),
                           REML = F)

# all main effects and secondary interactions
height_lmer_subtr_02 <- update(height_lmer_subtr_01,
                              . ~ . -City_dist:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
height_lmer_subtr_03 <- update(height_lmer_subtr_02,
                              . ~ . -City_dist:Transect_ID)
height_lmer_subtr_04 <- update(height_lmer_subtr_02,
                              . ~ . -City_dist:Year)
height_lmer_subtr_05 <- update(height_lmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
height_lmer_subtr_06 <- update(height_lmer_subtr_03,
                              . ~ . -City_dist:Year)
height_lmer_subtr_07 <- update(height_lmer_subtr_04,
                              . ~ . -Year:Transect_ID)
height_lmer_subtr_08 <- update(height_lmer_subtr_05,
                              . ~ . -City_dist:Transect_ID)

# all main effects
height_lmer_subtr_09 <- update(height_lmer_subtr_08,
                              . ~ . -City_dist:Year)

height_lmer_subtr_list <- list(height_lmer_subtr_01,
                               height_lmer_subtr_02,
                               height_lmer_subtr_03,
                               height_lmer_subtr_04,
                               height_lmer_subtr_05,
                               height_lmer_subtr_06,
                               height_lmer_subtr_07,
                               height_lmer_subtr_08,
                               height_lmer_subtr_09)

formulas_height <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_height$Model <- NA
formulas_height$Formula <- NA
formulas_height$r.squaredGLMM_R2m <- NA
formulas_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(height_lmer_subtr_list)) {
  formulas_height[i, 1] <- toString(i)
  formulas_height[i, 2] <- toString(formula(height_lmer_subtr_list[[i]]))
  formulas_height[i, 3] <- r.squaredGLMM(height_lmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_height[i, 4] <- r.squaredGLMM(height_lmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_height <- do.call(rbind,
                       lapply(height_lmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_height <- bind_cols(formulas_height,
                        glance_height %>%
                          dplyr::select(AIC, BestModels)) # Models 1, 8 lowest AIC (1 is lowest)

# check residuals
plot_model(height_lmer_subtr_01, type='diag') # looks fine
plot_model(height_lmer_subtr_08, type='diag') # looks fine


summary(height_lmer_subtr_01)
height_lmer_subtr_01_anova <- car::Anova(height_lmer_subtr_01, type = "III") %T>%
  print() 

summary(height_lmer_subtr_08)
height_lmer_subtr_08_anova <- car::Anova(height_lmer_subtr_08, type = "III") %T>%
  print() 


```

####### urb-score
######## All sites
```{r}
u_height_lmer_gradient_01 <- lmer(Height_Sept ~ (1|Patch_ID) +
                                  
                                  Urb_score:Year +
                                  Urb_score +
                                  Year,
                                
                                fertile,
                                REML = F) 


# all main effects and secondary interactions
u_height_lmer_gradient_02 <- update(u_height_lmer_gradient_01,
                                 . ~ . -Urb_score:Year)

u_height_lmer_gradient_list <- list(u_height_lmer_gradient_01,
                                 u_height_lmer_gradient_02)

formulas_height <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_height$Model <- NA
formulas_height$Formula <- NA
formulas_height$r.squaredGLMM_R2m <- NA
formulas_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_height_lmer_gradient_list)) {
  formulas_height[i, 1] <- toString(i)
  formulas_height[i, 2] <- toString(formula(u_height_lmer_gradient_list[[i]]))
  formulas_height[i, 3] <- r.squaredGLMM(u_height_lmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_height[i, 4] <- r.squaredGLMM(u_height_lmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_height <- do.call(rbind,
                       lapply(u_height_lmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_height <- bind_cols(formulas_height,
                        glance_height %>%
                          dplyr::select(AIC, BestModels)) # Models 1 & 2 lowest AIC (1 best)

# check residuals
plot(simulateResiduals(u_height_lmer_gradient_01)) # looks good
plot(simulateResiduals(u_height_lmer_gradient_02)) # looks good


summary(u_height_lmer_gradient_01)
u_height_lmer_gradient_01_anova <- car::Anova(u_height_lmer_gradient_01, type = "III") %T>%
  print() # year sig, interaxn marg sig
AIC(u_height_lmer_gradient_01)

summary(u_height_lmer_gradient_02)
u_height_lmer_gradient_02_anova <- car::Anova(u_height_lmer_gradient_02, type = "II") %T>%
  print() # year sig
AIC(u_height_lmer_gradient_02)

```


######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
u_height_lmer_subtr_01 <- lmer(Height_Sept ~ (1|Patch_ID) +
                               
                               Year:Transect_ID:Urb_score + 
                               
                               Year:Transect_ID + 
                               Urb_score:Transect_ID +
                               Urb_score:Year +
                               
                               Urb_score +
                               Year +
                               Transect_ID,
                             
                             fertile %>%
                               filter(Transect_ID != 'Rural'),
                           REML = F)

# all main effects and secondary interactions
u_height_lmer_subtr_02 <- update(u_height_lmer_subtr_01,
                              . ~ . -Year:Transect_ID:Urb_score)

# all main effects and 2/3 secondary interactions
u_height_lmer_subtr_03 <- update(u_height_lmer_subtr_02,
                              . ~ . -Transect_ID:Urb_score)
u_height_lmer_subtr_04 <- update(u_height_lmer_subtr_02,
                              . ~ . -Urb_score:Year)
u_height_lmer_subtr_05 <- update(u_height_lmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_height_lmer_subtr_06 <- update(u_height_lmer_subtr_03,
                              . ~ . -Urb_score:Year)
u_height_lmer_subtr_07 <- update(u_height_lmer_subtr_04,
                              . ~ . -Year:Transect_ID)
u_height_lmer_subtr_08 <- update(u_height_lmer_subtr_05,
                              . ~ . -Transect_ID:Urb_score)

# all main effects
u_height_lmer_subtr_09 <- update(u_height_lmer_subtr_08,
                              . ~ . -Urb_score:Year)

u_height_lmer_subtr_list <- list(u_height_lmer_subtr_01,
                               u_height_lmer_subtr_02,
                               u_height_lmer_subtr_03,
                               u_height_lmer_subtr_04,
                               u_height_lmer_subtr_05,
                               u_height_lmer_subtr_06,
                               u_height_lmer_subtr_07,
                               u_height_lmer_subtr_08,
                               u_height_lmer_subtr_09)

formulas_height <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_height$Model <- NA
formulas_height$Formula <- NA
formulas_height$r.squaredGLMM_R2m <- NA
formulas_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_height_lmer_subtr_list)) {
  formulas_height[i, 1] <- toString(i)
  formulas_height[i, 2] <- toString(formula(u_height_lmer_subtr_list[[i]]))
  formulas_height[i, 3] <- r.squaredGLMM(u_height_lmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_height[i, 4] <- r.squaredGLMM(u_height_lmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_height <- do.call(rbind,
                       lapply(u_height_lmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_height <- bind_cols(formulas_height,
                        glance_height %>%
                          dplyr::select(AIC, BestModels)) # Models 1, 9 lowest AIC (1 is lowest)

# check residuals
plot(simulateResiduals(u_height_lmer_subtr_01)) # looks good
plot(simulateResiduals(u_height_lmer_subtr_09)) # looks good


summary(u_height_lmer_subtr_01)
u_height_lmer_subtr_01_anova <- car::Anova(u_height_lmer_subtr_01, type = "III") %T>%
  print()

summary(u_height_lmer_subtr_09)
u_height_lmer_subtr_09_anova <- car::Anova(u_height_lmer_subtr_09, type = "II") %T>%
  print()


```


#### Combine models into one df
##### Best models: Inflors, pollen, pods, pods/inflor
```{r}
# function that IDs if there is >= 1 sig interaction in the type III anova
ID_intxn <- function(model){
  model.df <- broom.mixed::tidy(car::Anova(model, type = "III"))
  intxn.df <- model.df[grep(":", model.df$term), "p.value"]
  sig.intxns <- sum(intxn.df <= 0.1)
  return(sig.intxns)
}


# tidy anovas
tidy_sb <- function(model){
      type.choice <- ifelse(ID_intxn(model) > 0,
                          3,
                          2)
  return(
    car::Anova(model, type = type.choice) %>%
      broom.mixed::tidy() %>%
      # as.data.frame() %>%
      dplyr::mutate(Response = as.character(formula(model)[2]),
                    .before = term) %>%
      # dplyr::mutate(Model = paste(n(model)),
      #               .before = term) %>%
      dplyr::mutate(Sites = case_when(
        str_detect(as.character(formula(model)[3]), "Transect_ID") == TRUE ~ "Urban Only",
        str_detect(as.character(formula(model)[3]), "Transect_ID") == FALSE ~ "All"),
                    .before = term) %>%
      dplyr::mutate(Significance = case_when(p.value < 0.001 ~ "***",
                                             p.value < 0.01 ~ "**",
                                             p.value <= 0.05 ~ "*")) %>%
      dplyr::mutate(., AIC = as.numeric(AIC(model))) %>%
      mutate_if(is.numeric, round, 3)      %>%
      dplyr::mutate(p.value = replace(p.value, Significance == "***", "<0.001"))  %>%
      dplyr::select(., -df) %>%
      dplyr::rename(., Chi_sq = statistic,
                    Predictor = term,
                    p = p.value) %>%
      unite("p", p:Significance, sep = "", na.rm = TRUE) %>%
      dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("City_dist"),
                replacement = c("Distance to City Center")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Urb_score"),
                replacement = c("Urbanization Score")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Transect_ID"),
                replacement = c("Subtransect")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c(":"),
                replacement = c(" x ")) %>%
    dplyr::mutate_if(.,
          is.character,
          str_replace_all,
          pattern = c("Year x Urbanization Score"),
          replacement = c("Urbanization Score x Year")) # %>%
        # dplyr::mutate_if(.,
        #         is.character,
        #         str_replace_all,
        #         pattern = c("Year x Distance to City Center"),
        #         replacement = c("Distance to City Center x Year")) %>%
        # dplyr::mutate_if(.,
        #         is.character,
        #         str_replace_all,
        #         pattern = c("Subtransect x Distance to City Center"),
        #         replacement = c("Distance to City Center x Subtransect")) %>%
        # dplyr::mutate_if(.,
        #         is.character,
        #         str_replace_all,
        #         pattern = c("Distance to City Center x Year x Subtransect"),
        #         replacement = c("Year x Subtransect x Distance to City Center"))
    )}

# combine anovas into publication-quality tables
make_Q1Q2_Anova <- function(anova_list){
  return(
    lapply(anova_list, tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", "AIC", "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::filter(Predictor != "(Intercept)") %>%
    dplyr::rename('X2' = 2,
                  'p' = 3,
                  'X2 ' = 4,
                  'p ' = 5,
                  'X2  ' = 6,
                  'p  ' = 7,
                  'X2   ' = 8,
                  'p   ' = 9) %>%
      flextable::flextable() %>%
      add_header_row(
        values = c(" ",
                   "Pollinaria Removed",
                   "Follicles",
                   "Follicles per Inflorescence",
                    "Inflorescences"),
        colwidths = c(1, 2, 2, 2, 2)) %>%
      align(j = 1, align = "left", part = "all") %>%
      align(j = 2:9, align = "center", part = "body") %>%
      align(j = 2:9, align = "center", part = "header") %>%
      flextable::compose(i = 2, j = 2, part = "header",
              value = as_paragraph("χ", as_sup("2"))) %>%
      flextable::compose(i = 2, j = 4, part = "header",
              value = as_paragraph("χ", as_sup("2"))) %>%
      flextable::compose(i = 2, j = 6, part = "header",
              value = as_paragraph("χ", as_sup("2"))) %>%
      flextable::compose(i = 2, j = 8, part = "header",
              value = as_paragraph("χ", as_sup("2"))) %>%
      flextable::compose(i = 2, j = c(3,5,7,9), part = "header",
              value = as_paragraph(as_i("p"))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body")
    )
  }



# CITY_DIST-----
## ALL SITES

best_mods_Q1.dist_list <- list(
### Pollinia
  poll_glmer_gradient_01.v2,
### Pods
  pods_glmer_gradient_01,
### Pods/Peduncle
  podsperped_lmer_gradient_02,
### Peduncles
  peds_glmer_gradient_01 
)

make_Q1Q2_Anova(best_mods_Q1.dist_list) %>%
  width(j = 1, width = 2.7) %>%
  width(j = 2:9, width = 0.8) %>%
  # italic(i = 2, j = 2:9, part = "header") %>%
  # add_footer_lines("Table X: Results from general and generalized linear mixed models examining the effects of urbanization on 4 traits: inflorescences, pollinaria removed, follicles, and mean no. follicles per inflorescence. Urbanization was quantified via distance to city center and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  # add_footer_lines(paste0("AIC, Inflorescences: ",
  #                         AIC(peds_glmer_gradient_01) %>% round(., 3))) %>%
  # add_footer_lines(paste0("AIC, Pollinaria Removed: ",
  #                         AIC(poll_glmer_gradient_01.v2) %>% round(., 3))) %>%
  # add_footer_lines(paste0("AIC, Follicles: ",
  #                         AIC(pods_glmer_gradient_01) %>% round(., 3))) %>%  
  # add_footer_lines(paste0("AIC, Follicles per Inflorescence: ",
  #                         AIC(podsperped_lmer_gradient_02) %>% round(., 3))) %>% 
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Q1_Dist_ANOVA.png"))




## URBAN SITES
best_mods_Q2.dist_list <- list(
  
### Pollinia
  poll_glmer_subtr_01,
### Pods
  pods_glmer_subtr_03,
### Pods/Peduncle
  podsperped_lmer_subtr_08,
### Peduncles
  peds_glmer_subtr_01
)


make_Q1Q2_Anova(best_mods_Q2.dist_list) %>%
  width(j = 1, width = 3.7) %>%
  width(j = 2:9, width = 0.9) %>%
  # italic(i = 2, j = 2:9, part = "header") %>%
  # add_footer_lines("Table X: Results from general and generalized linear mixed models examining the effects of urbanization and proximity to an urban corridor on 4 traits: pollinaria removed, follicles, inflorescences, and mean no. follicles per inflorescence. Urbanization was quantified via urbanization score. Urbanization was quantified via distance to city center and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  # add_footer_lines(paste0("AIC, Inflorescences: ",
  #                         AIC(peds_glmer_subtr_01) %>% round(., 3))) %>%
  # add_footer_lines(paste0("AIC, Pollinaria Removed: ",
  #                         AIC(poll_glmer_subtr_01) %>% round(., 3))) %>%
  # add_footer_lines(paste0("AIC, Follicles: ",
  #                         AIC(pods_glmer_subtr_03) %>% round(., 3))) %>%
  # add_footer_lines(paste0("AIC, Follicles per Inflorescence: ",
  #                         AIC(podsperped_lmer_subtr_08) %>% round(., 3))) %>% 
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Q2_Dist_ANOVA.png"))


# URB_SCORE-----
## ALL SITES

best_mods_Q1.urbscore_list <- list(
 
### Pollinia
  u_poll_glmer_gradient_1,
### Pods
  u_pods_glmer_gradient_1,
### Pods/Peduncle
  u_podsperped_lmer_gradient_02,
### Peduncles
  u_peds_glmer_gradient_01
)


make_Q1Q2_Anova(best_mods_Q1.urbscore_list) %>%
  width(j = 1, width = 2.4) %>%
  width(j = 2:9, width = 0.8) %>%
  # italic(i = 2, j = 2:9, part = "header") %>%
  # add_footer_lines("Table X: Results from general and generalized linear mixed models examining the effects of urbanization on 4 traits: pollinaria removed, follicles, inflorescences, and mean no. follicles per inflorescence. Urbanization was quantified via urbanization score and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  # add_footer_lines(paste0("AIC, Inflorescences: ",
  #                         AIC(u_peds_glmer_gradient_01) %>% round(., 3))) %>%
  # add_footer_lines(paste0("AIC, Pollinaria Removed: ",
  #                         AIC(u_poll_glmer_gradient_1) %>% round(., 3))) %>%
  # add_footer_lines(paste0("AIC, Follicles: ",
  #                         AIC(u_pods_glmer_gradient_1) %>% round(., 3))) %>%
  # add_footer_lines(paste0("AIC, Follicles per Inflorescence: ",
  #                         AIC(u_podsperped_lmer_gradient_02) %>% round(., 3))) %>% 
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Q1_Urbscore_ANOVA.png"))







## URBAN SITES

best_mods_Q2.urbscore_list <- list(

### Pollinia
  u_poll_glmer_subtr_01,
### Pods
  u_pods_glmer_subtr_03,
### Pods/Peduncle
  u_podsperped_lmer_subtr_09,
### Peduncles
  u_peds_glmer_subtr_06
)


make_Q1Q2_Anova(best_mods_Q2.urbscore_list) %>%
  width(j = 1, width = 3.3) %>%
  width(j = 2:9, width = 0.9) %>%
  # italic(i = 2, j = 2:9, part = "header") %>%
  # add_footer_lines("Table X: Results from general and generalized linear mixed models examining the effects of urbanization and proximity to an urban corridor on 4 traits: inflorescences, pollinaria removed, follicles, and mean no. follicles per inflorescence. Urbanization was quantified via urbanization score. Urbanization was quantified via urbanization score and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  # add_footer_lines(paste0("AIC, Inflorescences: ",
  #                         AIC(u_peds_glmer_subtr_06) %>% round(., 3))) %>%
  # add_footer_lines(paste0("AIC, Pollinaria Removed: ",
  #                         AIC(u_poll_glmer_subtr_01) %>% round(., 3))) %>%
  # add_footer_lines(paste0("AIC, Follicles: ",
  #                         AIC(u_pods_glmer_subtr_03) %>% round(., 3))) %>%
  # add_footer_lines(paste0("AIC, Follicles per Inflorescence: ",
  #                         AIC(u_podsperped_lmer_subtr_09) %>% round(., 3))) %>% 
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Q2_Urbscore_ANOVA.png"))

```

##### Best models: height
```{r}
# make_anova function tweaked to handle one model- height- instead of a list
make_Q1Q2_Anova.height <- function(model){
  
  return(
    tidy_sb(model) %>%
    as.data.frame() %>%
    arrange(factor(Predictor,
                   levels = c("Distance to City Center",
                              "Urbanization Score",
                              "Year",
                              "Subtransect",
                              "Distance to City Center x Subtransect",
                              "Urbanization Score x Subtransect",
                              "Distance to City Center x Year",
                              "Urbanization Score x Year",
                              "Year x Subtransect",
                              "Urbanization Score x Year x Subtransect",
                              "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", "AIC", "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::filter(Predictor != "(Intercept)") %>%
    dplyr::rename('X2' = 2,
                  'p' = 3) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Height"),
      colwidths = c(1, 2)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:3, align = "center", part = "body") %>%
    align(j = 2:3, align = "center", part = "header") %>%
      flextable::compose(i = 2, j = 2, part = "header",
        value = as_paragraph("χ", as_sup("2"))) %>%
      flextable::compose(i = 2, j = 3, part = "header",
              value = as_paragraph(as_i("p")))
    )
}


# CITY_DIST-----
## ALL SITES
# Height: height_lmer_gradient_02


make_Q1Q2_Anova.height(height_lmer_gradient_02) %>%
  width(j = 1, width = 1.8) %>%
  width(j = 2:3, width = 1) %>%
  # italic(i = 2, j = 2:3, part = "header") %>%
  # add_footer_lines("Table X: Results from general linear mixed models examining the effects of urbanization on plant height. Urbanization was quantified via distance to city center and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%  add_footer_lines(paste0("AIC, Height: ",
  #                         AIC(height_lmer_gradient_02) %>% round(., 3))) %>%
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Best_models_Height/Q1_Dist_ANOVA_HEIGHT.png"))





## URBAN SITES
# Height: height_lmer_subtr_01

make_Q1Q2_Anova.height(height_lmer_subtr_01) %>%
  width(j = 1, width = 3.3) %>%
  width(j = 2:3, width = 1) %>%
  # italic(i = 2, j = 2:3, part = "header") %>%
  # add_footer_lines("Table X: Results from general linear mixed models examining the effects of urbanization and proximity to an urban corridor on plant height. Urbanization was quantified via distance to city center and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  # add_footer_lines(paste0("AIC, Height: ",
  #                         AIC(height_lmer_subtr_01) %>% round(., 3))) %>%
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Best_models_Height/Q2_Dist_ANOVA_HEIGHT.png"))




# URB_SCORE-----
## ALL SITES
# Height: u_height_lmer_gradient_01

make_Q1Q2_Anova.height(u_height_lmer_gradient_01) %>%
  width(j = 1, width = 2) %>%
  width(j = 2:3, width = 1) %>%
  # italic(i = 2, j = 2:3, part = "header") %>%
  # add_footer_lines("Table X: Results from general linear mixed models examining the effects of urbanization on plant height. Urbanization was quantified via urbanization score and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  #   add_footer_lines(paste0("AIC, Height: ",
  #                         AIC(u_height_lmer_gradient_01) %>% round(., 3))) %>%
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Best_models_Height/Q1_Urbscore_ANOVA_HEIGHT.png"))






## URBAN SITES
# Height: u_height_lmer_subtr_01

make_Q1Q2_Anova.height(u_height_lmer_subtr_01) %>%
  width(j = 1, width = 3.2) %>%
  width(j = 2:3, width = 1) %>%
  # italic(i = 2, j = 2:3, part = "header") %>%
  # add_footer_lines("Table X: Results from general linear mixed models examining the effects of urbanization and proximity to an urban corridor on plant height. Urbanization was quantified via urbanization score and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  #   add_footer_lines(paste0("AIC, Height: ",
  #                         AIC(u_height_lmer_subtr_01) %>% round(., 3))) %>%
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Best_models_Height/Q2_Urbscore_ANOVA_HEIGHT.png"))

```

##### Alternative (AIC<2 from best) models: Inflors, pollen, pods, pods/inflor
```{r}

# CITY_DIST-----
## ALL SITES-----
### Peduncles- NONE- only one best model
### Pollinia-  NONE because each model analyzed year separately
### Pods-      NONE- only one best model
### ****Pods/Peduncle:  podsperped_lmer_gradient_01


podsperped_lmer_gradient_01 %>%
  tidy_sb() %>%
    as.data.frame() %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance",
                                 "AIC",
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('X2' = 2,
                  'p' = 3) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Follicles per Inflorescence"),
      colwidths = c(1, 2)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:3, align = "center", part = "body") %>%
    align(j = 2:3, align = "center", part = "header") %>%
      flextable::compose(i = 2, j = 2, part = "header",
        value = as_paragraph("χ", as_sup("2"))) %>%
      flextable::compose(i = 2, j = 3, part = "header",
              value = as_paragraph(as_i("p"))) %>%
  width(j = 1, width = 2.3) %>%
  width(j = 2:3, width = 1) %>%
  # italic(i = 2, j = 2:3, part = "header") %>%
  # merge_at(i = 1:2, j = 4 ) %>%
  # fix_border_issues() %>%
  # add_footer_lines("Table X: Results from an alternative general linear mixed model within 2 AIC from the best model examining the effects of urbanization on mean no. follicles per inflorescence. Alternative models of other estimates of reproductive success were >2 AIC of the best models and are not shown. Urbanization was quantified via distance to city center and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  # add_footer_lines(paste0("AIC: ",
  #                         AIC(podsperped_lmer_gradient_01) %>% round(., 3))) %>%
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Q1_Dist_ANOVA_altmodels.png"))




## URBAN SITES-----
alt_best_mods_Q2.dist_list <- list(
### Peduncles
  peds_glmer_subtr_03,
  peds_glmer_subtr_06,  
### Pollinia
  poll_glmer_subtr_03,
### Pods
  pods_glmer_subtr_02,
  pods_glmer_subtr_08,
### Pods/Peduncle
  podsperped_lmer_subtr_03,
  podsperped_lmer_subtr_05

)



lapply(alt_best_mods_Q2.dist_list, tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('X2' = 2,
                  'p' = 3,
                  'X2 ' = 4,
                  'p ' = 5,
                  'X2  ' = 6,
                  'p  ' = 7,
                  'X2   ' = 8,
                  'p   ' = 9,
                  'X2    ' = 10,
                  'p    ' = 11,
                  'X2     ' = 12,
                  'p     ' = 13,
                  'X2      ' = 14,
                  'p      ' = 15) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Inflorescences, Alt. Model 1",
                 "Inflorescences, Alt. Model 2",
                 "Pollinaria Removed, Alt. Model 1",
                 "Follicles, Alt. Model 1",
                 "Follicles, Alt. Model 2",
                 "Follicles per Inflorescence, Alt. Model 1",
                 "Follicles per Inflorescence, Alt. Model 2"),
      colwidths = c(1, 2, 2, 2, 2, 2, 2, 2)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:15, align = "center", part = "body") %>%
    align(j = 2:15, align = "center", part = "header") %>%
      flextable::compose(i = 2, j = c(2,4,6,8,10,12,14), part = "header",
        value = as_paragraph("χ", as_sup("2"))) %>%
      flextable::compose(i = 2, j = c(3,5,7,9,11,13,15), part = "header",
              value = as_paragraph(as_i("p"))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 1.8) %>%
  width(j = 2:15, width = 1) %>%
  # italic(i = 2, j = 2:15, part = "header") %>%
  # merge_at(i = 1:6, j = 4 ) %>%
  # merge_at(i = 1:6, j = 7 ) %>%
  # merge_at(i = 1:6, j = 10 ) %>%
  # merge_at(i = 1:6, j = 13 ) %>%
  # merge_at(i = 1:6, j = 16) %>%
  # merge_at(i = 1:6, j = 19) %>%
  # merge_at(i = 1:6, j = 22) %>%
  # fix_border_issues() %>%
  # add_footer_lines("Table X: Results from alternative general linear mixed models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on 4 traits: inflorescences, pollinaria removed, follicles, and mean no. follicles per inflorescence. Urbanization was quantified via distance to city center and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  # add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 1: ",
  #                         AIC(peds_glmer_subtr_03) %>% round(., 3))) %>%  add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 2: ",
  #                         AIC(peds_glmer_subtr_06) %>% round(., 3))) %>%  add_footer_lines(paste0("AIC, Pollinaria Removed, Alt. Model 1: ",
  #                         AIC(poll_glmer_subtr_03) %>% round(., 3))) %>%  add_footer_lines(paste0("AIC, Follicles, Alt. Model 1: ",
  #                         AIC(pods_glmer_subtr_02) %>% round(., 3))) %>%  add_footer_lines(paste0("AIC, Follicles, Alt. Model 2: ",
  #                         AIC(pods_glmer_subtr_08) %>% round(., 3))) %>%  add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 1: ",
  #                         AIC(podsperped_lmer_subtr_03) %>% round(., 3))) %>%  add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 2: ",
  #                         AIC(podsperped_lmer_subtr_05) %>% round(., 3))) %>%
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Q2_Dist_ANOVA_altmodels.png"))


  


# URB_SCORE-----
## ALL SITES

alt_best_mods_Q1.urbscore_list <- list(
### Peduncles- NONE- only 1 best model
### Pollinia- NONE- only 1 best model
### Pods-      NONE- only 1 best model
### Pods/Peduncle
  u_podsperped_lmer_gradient_01

)


lapply(alt_best_mods_Q1.urbscore_list, tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('X2' = 2,
                  'p' = 3) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Follicles per Inflorescence, Alt. Model 1"),
      colwidths = c(1, 2)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:3, align = "center", part = "body") %>%
    align(j = 2:3, align = "center", part = "header") %>%
      flextable::compose(i = 2, j = 2, part = "header",
        value = as_paragraph("χ", as_sup("2"))) %>%
      flextable::compose(i = 2, j = 3, part = "header",
              value = as_paragraph(as_i("p"))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 2.5) %>%
  width(j = 2:3, width = 1) %>%
  # italic(i = 2, j = 2:5, part = "header") %>%
  # merge_at(i = 1:6, j = 4 ) %>%
  # merge_at(i = 1:6, j = 7 ) %>%
  # merge_at(i = 1:6, j = 10 ) %>%
  # merge_at(i = 1:6, j = 13 ) %>%
  # merge_at(i = 1:6, j = 16) %>%
  # merge_at(i = 1:6, j = 19) %>%
  # merge_at(i = 1:6, j = 22) %>%
  # fix_border_issues() %>%
  # add_footer_lines("Table X: Results from alternative general linear mixed models within 2 AIC from the best models examining the effects of urbanization on 2 traits: pollinaria removed and mean no. follicles per inflorescence. Alternative models of other estimates of reproductive success were >2 AIC of the best models and are not shown. Urbanization was quantified via urbanization score and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  # add_footer_lines(paste0("AIC, Pollinaria Removed, Alt. Model 1: ",
  #                         AIC(u_poll_glmer_gradient_1.1) %>% round(., 3))) %>%
  # add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 1: ",
  #                         AIC(u_podsperped_lmer_gradient_01) %>% round(., 3))) %>% 
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Q1_Urbscore_ANOVA_altmodels.png"))



## URBAN SITES

alt_best_mods_Q2.urbscore_list <- list(
### Peduncles
  u_peds_glmer_subtr_03,
  u_peds_glmer_subtr_04,  
### Pollinia- NONE- only one best model
### Pods
  u_pods_glmer_subtr_02,
### Pods/Peduncle
  u_podsperped_lmer_subtr_06,
  u_podsperped_lmer_subtr_07,
  u_podsperped_lmer_subtr_08

)



lapply(alt_best_mods_Q2.urbscore_list, tidy_sb) %>%
  lapply(., as.data.frame) %>%
  purrr::reduce(full_join, by = "Predictor") %>%
  arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('X2' = 2,
                  'p' = 3,
                  'X2 ' = 4,
                  'p ' = 5,
                  'X2  ' = 6,
                  'p  ' = 7,
                  'X2   ' = 8,
                  'p   ' = 9,
                  'X2    ' = 10,
                  'p    ' = 11,
                  'X2     ' = 12,
                  'p     ' = 13) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Inflorescences, Alt. Model 1",
                 "Inflorescences, Alt. Model 2",
                 "Follicles, Alt. Model 1",
                 "Follicles per Inflorescence, Alt. Model 1",
                 "Follicles per Inflorescence, Alt. Model 2",
                 "Follicles per Inflorescence, Alt. Model 3"),
      colwidths = c(1, 2, 2, 2, 2, 2, 2)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:13, align = "center", part = "body") %>%
    align(j = 2:13, align = "center", part = "header") %>%
    flextable::compose(i = 2, j = c(2,4,6,8,10,12), part = "header",
      value = as_paragraph("χ", as_sup("2"))) %>%
    flextable::compose(i = 2, j = c(3,5,7,9,11,13), part = "header",
              value = as_paragraph(as_i("p"))) %>%
  fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 1.8) %>%
  width(j = 2:13, width = 1) %>%
  # italic(i = 2, j = 2:13, part = "header") %>%
  # merge_at(i = 1:6, j = 4 ) %>%
  # merge_at(i = 1:6, j = 7 ) %>%
  # merge_at(i = 1:6, j = 10 ) %>%
  # merge_at(i = 1:6, j = 13 ) %>%
  # merge_at(i = 1:6, j = 16) %>%
  # merge_at(i = 1:6, j = 19) %>%
  # merge_at(i = 1:6, j = 22) %>%
  # fix_border_issues() %>%
  # add_footer_lines("Table X: Results from alternative general linear mixed models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on 4 traits: inflorescences, follicles, and mean no. follicles per inflorescence. Alternative models of pollinaria removed were >2 AIC of the best models and are not shown. Urbanization was quantified via urbanization score and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  #   add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 1: ",
  #                         AIC(u_peds_glmer_subtr_03) %>% round(., 3))) %>%
  #   add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 2: ",
  #                         AIC(u_peds_glmer_subtr_04) %>% round(., 3))) %>%
  #   add_footer_lines(paste0("AIC, Follicles, Alt. Model 1: ",
  #                         AIC(u_pods_glmer_subtr_02) %>% round(., 3))) %>%
  #   add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 1: ",
  #                         AIC(u_podsperped_lmer_subtr_06) %>% round(., 3))) %>% 
  #   add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 2: ",
  #                         AIC(u_podsperped_lmer_subtr_07) %>% round(., 3))) %>%
  #   add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 3: ",
  #                         AIC(u_podsperped_lmer_subtr_08) %>% round(., 3))) %>%
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Q2_Urbscore_ANOVA_altmodels.png"))


```

##### Alternative (AIC<2 from best) models: height
```{r}
# City_dist x all sites: height_lmer_gradient_01
make_Q1Q2_Anova.height(height_lmer_gradient_01) %>%
  width(j = 1, width = 2.4) %>%
  width(j = 2:3, width = 1) %>%
  # italic(i = 2, j = 2:3, part = "header") %>%
  # add_footer_lines("Table X: Results from an alternative general linear mixed model within 2 AIC from the best model examining the effects of urbanization on plant height. Urbanization was quantified via distance to city center and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  #   add_footer_lines(paste0("AIC, Height, Alt. Model 1: ",
  #                         AIC(height_lmer_gradient_01) %>% round(., 3))) %>% 
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Alt_models_Height/Q1_Dist_ANOVA_altmodels_HEIGHT.png"))


# City_dist x urban sites: height_lmer_subtr_08
make_Q1Q2_Anova.height(height_lmer_subtr_08) %>%
  width(j = 1, width = 2.4) %>%
  width(j = 2:3, width = 1) %>%
  # italic(i = 2, j = 2:3, part = "header") %>%
  # add_footer_lines("Table X: Results from an alternative general linear mixed model within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on plant height. Urbanization was quantified via distance to city center and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  #     add_footer_lines(paste0("AIC, Height, Alt. Model 1: ",
  #                         AIC(height_lmer_subtr_08) %>% round(., 3))) %>% 
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Alt_models_Height/Q2_Dist_ANOVA_altmodels_HEIGHT.png"))


# Urb_score x all sites: u_height_lmer_gradient_02
make_Q1Q2_Anova.height(u_height_lmer_gradient_02) %>%
  width(j = 1, width = 2.4) %>%
  width(j = 2:3, width = 1) %>%
  # italic(i = 2, j = 2:3, part = "header") %>%
  # add_footer_lines("Table X: Results from an alternative general linear mixed model within 2 AIC from the best model examining the effects of urbanization on plant height. Urbanization was quantified via urbanization score and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  #       add_footer_lines(paste0("AIC, Height, Alt. Model 1: ",
  #                         AIC(u_height_lmer_gradient_02) %>% round(., 3))) %>% 
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Alt_models_Height/Q1_Urbscore_ANOVA_altmodels_HEIGHT.png"))


# Urb_score x urban sites: u_height_lmer_subtr_09
make_Q1Q2_Anova.height(u_height_lmer_subtr_09) %>%
  width(j = 1, width = 2.4) %>%
  width(j = 2:3, width = 1) %>%
  # italic(i = 2, j = 2:3, part = "header") %>%
  # add_footer_lines("Table X: Results from an alternative general linear mixed model within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on plant height. Urbanization was quantified via urbanization score and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  #       add_footer_lines(paste0("AIC, Height, Alt. Model 1: ",
  #                         AIC(u_height_lmer_subtr_09) %>% round(., 3))) %>% 
  # add_footer_lines("*: p-value <= 0.05") %>%
  # add_footer_lines("**: p-value <= 0.01") %>%
  # add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Alt_models_Height/Q2_Urbscore_ANOVA_altmodels_HEIGHT.png"))
```


##### Creating table with AIC scores
###### Question 1
```{r}
# Lists of models

# BEST MODELS
## Q1/Dist: best_mods_Q1.dist_list
### HEIGHT: height_lmer_gradient_02

## Q1/Urb score: best_mods_Q1.urbscore_list
### HEIGHT: u_height_lmer_gradient_01

# ALTERNATIVE MODELS
## Q1/Dist: ONLY podsperped_lmer_gradient_01 (1)
### HEIGHT: height_lmer_gradient_01

## Q1/Urb score: ONLY u_podsperped_lmer_gradient_01 (1)
### HEIGHT: u_height_lmer_gradient_02


AIC_df.Q1 <- data.frame(matrix(nrow = 14,
                            ncol = 6))

colnames(AIC_df.Q1) <- c("Model", "Urbanization_Metric", "Best_or_Alt_Model", "Variable", "AIC", "Delta_AIC_from_Best_Model")
AIC_df.Q1$Model <- seq.int(nrow(AIC_df.Q1))
AIC_df.Q1[c(1:5, 11:12),  2] <- "Distance to Urban Center"
AIC_df.Q1[c(6:10, 13:14), 2] <- "Urbanization Score"
AIC_df.Q1[1:10,  3] <- "Best Model"
AIC_df.Q1[11:14, 3] <- "Alternative Model"
AIC_df.Q1 %<>%
  mutate(Delta_AIC_from_Best_Model = case_when(
    Best_or_Alt_Model == "Best Model" ~ "-"))

# Q1/Dist- BEST- main vars
for (i in 1:length(best_mods_Q1.dist_list)){
  AIC_df.Q1[i, 4] <- as.character(formula(best_mods_Q1.dist_list[[i]])[2])
  AIC_df.Q1[i, 5] <- as.double(AIC(best_mods_Q1.dist_list[[i]])) %>%
    round(., 3)
}
# Q1/Dist- BEST- height
AIC_df.Q1[5, 4] <- as.character(formula(height_lmer_gradient_02)[2])
AIC_df.Q1[5, 5] <- as.double(AIC(height_lmer_gradient_02)) %>%
  round(., 3)



# Q1/Urb score- BEST- main vars
for (i in 1:length(best_mods_Q1.urbscore_list)){
  AIC_df.Q1[(i + 5), 4] <- as.character(formula(best_mods_Q1.urbscore_list[[i]])[2])
  AIC_df.Q1[(i + 5), 5] <- as.double(AIC(best_mods_Q1.urbscore_list[[i]])) %>%
    round(., 3)
}

# Q1/Urb score- BEST- height
AIC_df.Q1[10, 4] <- as.character(formula(u_height_lmer_gradient_01)[2])
AIC_df.Q1[10, 5] <- as.double(AIC(u_height_lmer_gradient_01)) %>%
  round(., 3)

# ----

# Q1/Dist- ALTERNATIVE- main vars
AIC_df.Q1[11, 4] <- as.character(formula(podsperped_lmer_gradient_01)[2])
AIC_df.Q1[11, 5] <- as.double(AIC(podsperped_lmer_gradient_01)) %>%
  round(., 3)
## now calculate Delta AIC
AIC_df.Q1[11, 6] <- as.numeric(AIC_df.Q1[11, 5] - AIC_df.Q1[4, 5]) %>% 
  round(3)

# Q1/Dist- ALTERNATIVE- height
AIC_df.Q1[12, 4] <- as.character(formula(height_lmer_gradient_01)[2])
AIC_df.Q1[12, 5] <- as.double(AIC(height_lmer_gradient_01)) %>%
  round(., 3)
## now calculate Delta AIC
AIC_df.Q1[12, 6] <- as.numeric(AIC_df.Q1[12, 5] - AIC_df.Q1[5, 5]) %>% 
  round(3)




# Q1/Urb score- ALTERNATIVE- main vars
AIC_df.Q1[13, 4] <- as.character(formula(u_podsperped_lmer_gradient_01)[2])
AIC_df.Q1[13, 5] <- as.double(AIC(u_podsperped_lmer_gradient_01)) %>%
    round(., 3)
## now calculate Delta AIC
AIC_df.Q1[13, 6] <- as.numeric(AIC_df.Q1[13, 5] - AIC_df.Q1[9, 5]) %>% 
  round(3)

# Q1/Urb score- ALTERNATIVE- height
AIC_df.Q1[14, 4] <- as.character(formula(u_height_lmer_gradient_02)[2])
AIC_df.Q1[14, 5] <- as.double(AIC(u_height_lmer_gradient_02)) %>%
  round(., 3)
## now calculate Delta AIC
AIC_df.Q1[14, 6] <- as.numeric(AIC_df.Q1[14, 5] - AIC_df.Q1[10, 5]) %>% 
  round(3)



# Now make variable names nice
AIC_df.Q1 %<>%
  mutate(Variable = case_when(
    str_detect(Variable, "Peduncles") ~ "Inflorescences",
    str_detect(Variable, "Pollinia")  ~ "Pollinaria Removed",
    str_detect(Variable, "Viable_Pods") ~ "Follicles",
    str_detect(Variable, "pods_per")  ~ "Follicles per Inflorescence",
    str_detect(Variable, "Sept")  ~ "Height"
    )
  )


write.table(AIC_df.Q1, file = here::here("./Figures_Tables/AIC_df_Q1.txt"), sep = ",", quote = FALSE, row.names = F)

```


###### Question 2
```{r}
# Lists of models

# BEST MODELS
## Q2/Dist: best_mods_Q2.dist_list
### HEIGHT: height_lmer_subtr_01
## Q2/Urb score: best_mods_Q2.urbscore_list
### HEIGHT: u_height_lmer_subtr_01

# ALTERNATIVE MODELS
## Q2/Dist: alt_best_mods_Q2.dist_list (7)- 1 pollinia, 2 everything else
### HEIGHT: height_lmer_subtr_08
## Q2/Urb score: alt_best_mods_Q2.urbscore_list (6)- 2 ped, 1 pod, 3 pod/ped
### HEIGHT: u_height_lmer_subtr_09

AIC_df.Q2 <- data.frame(matrix(nrow = 25, 
                            ncol = 6))

colnames(AIC_df.Q2) <- c("Model", "Urbanization_Metric", "Best_or_Alt_Model", "Variable", "AIC", "Delta_AIC_from_Best_Model")
AIC_df.Q2$Model <- seq.int(nrow(AIC_df.Q2))
AIC_df.Q2[c(1:5, 11:18),  2] <- "Distance to Urban Center"
AIC_df.Q2[c(6:10, 19:25), 2] <- "Urbanization Score"
AIC_df.Q2[1:10,  3] <- "Best Model"
AIC_df.Q2[11:25, 3] <- "Alternative Model"
AIC_df.Q2 %<>%
  mutate(Delta_AIC_from_Best_Model = case_when(
    Best_or_Alt_Model == "Best Model" ~ "-"))

# Q2/Dist- BEST- main vars
for (i in 1:length(best_mods_Q2.dist_list)){
  AIC_df.Q2[i, 4] <- as.character(formula(best_mods_Q2.dist_list[[i]])[2])
  AIC_df.Q2[i, 5] <- as.double(AIC(best_mods_Q2.dist_list[[i]])) %>%
    round(., 3)
}
# Q2/Dist- BEST- height
AIC_df.Q2[5, 4] <- as.character(formula(height_lmer_subtr_01)[2])
AIC_df.Q2[5, 5] <- as.double(AIC(height_lmer_subtr_01)) %>%
  round(., 3)
  

# Q2/Urb score- BEST
for (i in 1:length(best_mods_Q2.urbscore_list)){
  AIC_df.Q2[(i + 5), 4] <- as.character(formula(best_mods_Q2.urbscore_list[[i]])[2])
  AIC_df.Q2[(i + 5), 5] <- as.double(AIC(best_mods_Q2.urbscore_list[[i]])) %>%
    round(., 3)
}
# Q2/Urb score- BEST- height
AIC_df.Q2[10, 4] <- as.character(formula(u_height_lmer_subtr_01)[2])
AIC_df.Q2[10, 5] <- as.double(AIC(u_height_lmer_subtr_01)) %>%
  round(., 3)
  


# Q2/Dist- ALTERNATIVE
for (i in 1:length(alt_best_mods_Q2.dist_list)){
  AIC_df.Q2[(i + 10), 4] <- as.character(formula(alt_best_mods_Q2.dist_list[[i]])[2])
  AIC_df.Q2[(i + 10), 5] <- as.double(AIC(alt_best_mods_Q2.dist_list[[i]])) %>%
    round(., 3)
}
## now calculate Delta AIC
AIC_df.Q2[11, 6] <- as.numeric(AIC_df.Q2[11, 5] - AIC_df.Q2[1, 5]) %>% 
  round(3)
AIC_df.Q2[12, 6] <- as.numeric(AIC_df.Q2[12, 5] - AIC_df.Q2[1, 5]) %>% 
  round(3)
AIC_df.Q2[13, 6] <- as.numeric(AIC_df.Q2[13, 5] - AIC_df.Q2[2, 5]) %>% 
  round(3)
AIC_df.Q2[14, 6] <- as.numeric(AIC_df.Q2[14, 5] - AIC_df.Q2[3, 5]) %>% 
  round(3)
AIC_df.Q2[15, 6] <- as.numeric(AIC_df.Q2[15, 5] - AIC_df.Q2[3, 5]) %>% 
  round(3)
AIC_df.Q2[16, 6] <- as.numeric(AIC_df.Q2[16, 5] - AIC_df.Q2[4, 5]) %>% 
  round(3)
AIC_df.Q2[17, 6] <- as.numeric(AIC_df.Q2[17, 5] - AIC_df.Q2[4, 5]) %>% 
  round(3)
# Q2/Dist- ALTERNATIVE- height
AIC_df.Q2[18, 4] <- as.character(formula(height_lmer_subtr_08)[2])
AIC_df.Q2[18, 5] <- as.double(AIC(height_lmer_subtr_08)) %>%
  round(., 3)
## now calculate Delta AIC
AIC_df.Q2[18, 6] <- as.numeric(AIC_df.Q2[18, 5] - AIC_df.Q2[5, 5]) %>% 
  round(3)

# Q2/Urb score- ALTERNATIVE
for (i in 1:length(alt_best_mods_Q2.urbscore_list)){
  AIC_df.Q2[(i + 18), 4] <- as.character(formula(alt_best_mods_Q2.urbscore_list[[i]])[2])
  AIC_df.Q2[(i + 18), 5] <- as.double(AIC(alt_best_mods_Q2.urbscore_list[[i]])) %>%
    round(., 3)
}
## now calculate Delta AIC
AIC_df.Q2[19, 6] <- as.numeric(AIC_df.Q2[19, 5] - AIC_df.Q2[6, 5]) %>% 
  round(3)
AIC_df.Q2[20, 6] <- as.numeric(AIC_df.Q2[20, 5] - AIC_df.Q2[6, 5]) %>% 
  round(3)
AIC_df.Q2[21, 6] <- as.numeric(AIC_df.Q2[21, 5] - AIC_df.Q2[8, 5]) %>% 
  round(3)
AIC_df.Q2[22, 6] <- as.numeric(AIC_df.Q2[22, 5] - AIC_df.Q2[9, 5]) %>% 
  round(3)
AIC_df.Q2[23, 6] <- as.numeric(AIC_df.Q2[23, 5] - AIC_df.Q2[9, 5]) %>% 
  round(3)
AIC_df.Q2[24, 6] <- as.numeric(AIC_df.Q2[24, 5] - AIC_df.Q2[9, 5]) %>% 
  round(3)
# Q2/Dist- ALTERNATIVE- height
AIC_df.Q2[25, 4] <- as.character(formula(u_height_lmer_subtr_09)[2])
AIC_df.Q2[25, 5] <- as.double(AIC(u_height_lmer_subtr_09)) %>%
  round(., 3)
## now calculate Delta AIC
AIC_df.Q2[25, 6] <- as.numeric(AIC_df.Q2[25, 5] - AIC_df.Q2[10, 5]) %>% 
  round(3)



# Now make variable names nice
AIC_df.Q2 %<>%
  mutate(Variable = case_when(
    str_detect(Variable, "Peduncles") ~ "Inflorescences",
    str_detect(Variable, "Pollinia")  ~ "Pollinaria Removed",
    str_detect(Variable, "Viable_Pods") ~ "Follicles",
    str_detect(Variable, "pods_per")  ~ "Follicles per Inflorescence",
    str_detect(Variable, "Sept")  ~ "Height"
    )
  )



write.table(AIC_df.Q2, file = here::here("./Figures_Tables/AIC_df_Q2.txt"), sep = ",", quote = FALSE, row.names = F)
```



