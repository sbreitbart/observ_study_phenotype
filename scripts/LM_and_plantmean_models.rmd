---
title: "LM_and_plantmean_models"
author: "Sophie Breitbart"
date: "April 29, 2021"
output: html_document
---
# Set up notebook
## Install, load packages
```{r message=FALSE, warning=FALSE}
# devtools::install_github("cardiomoon/ggiraphExtra")
# devtools::install_github("dkahle/ggmap")
# devtools::install_github("hadley/devtools")
# install.packages("agricolae")
# install.packages("BH")
# install.packages("car")
# install.packages("cowplot")
# install.packages("digest", type="source")
# install.packages("dplyr")
# install.packages("factoextra")
# install.packages("flextable")
# install.packages("geosphere")
# install.packages("ggiraphExtra")
# install.packages("ggpubr")
# install.packages("ggsn")
# install.packages("ggspatial")
# install.packages("GISTools")
# install.packages("ISLR")
# install.packages("janitor")
# install.packages("lindia")
# install.packages("lme4")
# install.packages("lmerTest")
# install.packages("mnormt")
# install.packages("patchwork")
# install.packages("plogr")
# install.packages("psych")
# install.packages("RcppEigen")
# install.packages("rpart")
# install.packages('sjPlot')
# install.packages('stargazer')
# install.packages("swirl")
# install.packages("tibble")
# install.packages("tidyverse")
# install.packages("vegan")
# install.packages("XLConnect")
# install.packages('backports')
# install.packages(c("slidify", "ggplot2", "devtools"))
# install.packages('maps')
# install.packages('rmarkdown')
# install_github("vqv/ggbiplot")
library("FactoMineR")
library("tibble", lib.loc="~/R/win-library/3.5")
library(agricolae)
library(apaTables)
library(car)
library(data.table)
library(devtools)
library(DHARMa)
library(dplyr)
library(e1071)
library(factoextra)
library(flextable)
library(forcats)
library(geosphere)
library(ggbiplot)
library(ggmap)
library(ggpubr)
library(ggsn)
library(ggspatial)
library(GISTools)
library(glmmTMB)
library(gridExtra)
library(here)
library(Hmisc)
library(hrbrthemes)
library(ISLR)
library(janitor)
library(lindia)
library(lme4)
library(lmerTest)
library(lsmeans)
library(MASS)
library(multcomp)
library(MuMIn)
library(nlme)
library(patchwork)
library(plyr)
library(reshape)
library(reshape2)
library(rpart)
library(sjPlot)
library(stargazer)
library(tibble)
library(tidyr)
library(tidyverse)
library(vegan)
library(viridis)
require(ggiraph)
require(ggiraphExtra)
require(ggplot2)
require(MASS)
require(scales)

```

## Import data
```{r, import}
long_Transect_Data_18_19 <-
  read.csv(here::here("./clean_data/long_Transect_Data_18_19.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)


AvgVars_notNA_Poll_18_19 <-
  read.csv(here::here("./clean_data/AvgVars_notNA_Poll_18_19.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)

fertile_long <-
  read.csv(here::here("./clean_data/fertile_long.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)


fertile <-
  read.csv(here::here("./clean_data/fertile.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)

fertile_pops_all <-
  read.csv(here::here("./clean_data/fertile_pops_all.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)
```
## Make sure classes are correct
```{r}
# long_Transect_Data_18_19-----

str(long_Transect_Data_18_19)

# Make columns numeric
long_Transect_Data_18_19$Inflor <- as.numeric(as.character(long_Transect_Data_18_19$Inflor))
long_Transect_Data_18_19$Pollinia_removed <- as.numeric(as.character(long_Transect_Data_18_19$Pollinia_removed))
long_Transect_Data_18_19$Flower <- as.numeric(as.character(long_Transect_Data_18_19$Flower))

# make patch ID, plant, year, and inflor cols factors
long_Transect_Data_18_19$Patch_ID <- as.factor(as.character(long_Transect_Data_18_19$Patch_ID))
long_Transect_Data_18_19$Plant_Num <- as.factor(as.character(long_Transect_Data_18_19$Plant_Num))
long_Transect_Data_18_19$Inflor <- as.factor(as.character(long_Transect_Data_18_19$Inflor))
long_Transect_Data_18_19$Year <- as.factor(as.character(long_Transect_Data_18_19$Year))

# make pollinia removed an integer
long_Transect_Data_18_19$Pollinia_removed <- as.integer(as.character(long_Transect_Data_18_19$Pollinia_removed))


# AvgVars_notNA_Poll_18_19------

str(AvgVars_notNA_Poll_18_19)

# make cols factors
AvgVars_notNA_Poll_18_19$Patch_ID <- as.factor(as.character(AvgVars_notNA_Poll_18_19$Patch_ID))
AvgVars_notNA_Poll_18_19$Year <- as.factor(as.character(AvgVars_notNA_Poll_18_19$Year))


# fertile_long-----

str(fertile_long)

# Make columns numeric
fertile_long$Inflor <- as.numeric(as.character(fertile_long$Inflor))
fertile_long$Pollinia_removed <- as.numeric(as.character(fertile_long$Pollinia_removed))
fertile_long$Flower <- as.numeric(as.character(fertile_long$Flower))

# make patch ID, plant, year, and inflor cols factors
fertile_long$Patch_ID <- as.factor(as.character(fertile_long$Patch_ID))
fertile_long$Plant_Num <- as.factor(as.character(fertile_long$Plant_Num))
fertile_long$Inflor <- as.factor(as.character(fertile_long$Inflor))
fertile_long$Year <- as.factor(as.character(fertile_long$Year))

str(fertile_long)


# fertile-----

str(fertile)

# make patch ID, plant, year, and inflor cols factors
fertile$Patch_ID <- as.factor(as.character(fertile$Patch_ID))
fertile$Plant_Num <- as.factor(as.character(fertile$Plant_Num))
fertile$Year <- as.factor(as.character(fertile$Year))

str(fertile)


# fertile_pops_all-----

str(fertile_pops_all)

fertile_pops_all$Year <- as.factor(as.character(fertile_pops_all$Year))

str(fertile_pops_all)

```

## Variable key

* Average_Pollinia
: Average number of pollinia removed per flower, per plant, per population (0-5). Was measured in July of 2018 and 2019.

* City_dist
: Population's distance from urban center (Yonge & Dundas in Toronto), in kilometers.

* Transect_ID
: + Northern urban transect,
: + Southern urban transect (which follows green corridors including railroad tracks, trails, hydro lines, etc.), or
: + Rural transect.

    See [link](https://www.google.com/maps/d/u/0/edit?hl=en&mid=1T6o02xqdFY49LpaV5fgpNYcgUNfy6hWJ&ll=43.54856560494681%2C-79.7330821595105&z=10) for a map of the 3 transects.  
  
* Peduncles
: Average number of peduncles per plant per population

* Height_July
: Average height of sampled plants in July (when performing pollinia removal survey), in centimeters

* Plants_present_2018
: Number of plants present at the sampling site in 2018. Populations were spaced at least 500 meters apart to ensure population distinction.

* Height_Sept
: Average height of sampled plants in September (when performing follicle, peduncle survey), in centimeters

* Viable_Pods
: Average number of viable follciles per plant per population. These follicles were usually around 6-10 cm long, compared to aborted follicles, which were usually about 1 cm long and seemed to have stopped growing based on size and color (oftentimes brown/dried up).

* Total_Pods
: Average number of *combined* viable and aborted follciles per plant per population. In 2018, we did not distinguish between aborted and viable follicles, so this variable is used to compare follicle production over both years. Viable follicle production can only be measured for 2019 alone.

* nPlants
: Number of plants sampled per population.

* Average_pod_length
: Average length of all pods measured on surveyed plants in 2019, in centimeters. This data was not collected in 2018. In 2019, it was collected to understand whether there is a relationship between pod dimensions and seed number and/or seed mass. (As of October 2019, it seems there is a surprisingly weak relationship.)

# Pollinia
###### LM- no transformations needed
####### Without transect- NO TRANSFORMATION NEEDED
######## Diagnostics
######### City_dist: NO TRANSFORMATION NEEDED
```{r}
# POLLINIA

# old model-checking code: using lm
allpoll_lm <- lm(Average_Pollinia ~ City_dist * Year,
                 data = AvgVars_notNA_Poll_18_19)

par(mfrow=c(2,2))
plot(allpoll_lm)
summary(allpoll_lm)

ggqqplot(AvgVars_notNA_Poll_18_19$Average_Pollinia)
## Almost all data points fall within the envelope but some don't.

# Histogram
gg_reshist(allpoll_lm, bins=20)

# # Shapiro-Wilk normality test
# shapiro.test(AvgVars_notNA_Poll_18_19$Average_Pollinia)
# ## From the output, the p-value < 0.05 implying that the distribution of the data are significantly different from normal distribution. We cannot assume the normality.

# DATA LOOKS NORMAL ENOUGH.

```

######### Urb_score: NO TRANSFORMATION NEEDED
```{r}
# POLLINIA
diag_urb_poll_1 <- lm(Average_Pollinia ~ Urb_score * Year,
                      data = AvgVars_notNA_Poll_18_19)

par(mfrow=c(2,2))
plot(diag_urb_poll_1)
summary(diag_urb_poll_1)
ggqqplot(AvgVars_notNA_Poll_18_19$Average_Pollinia)
## Almost all data points fall within the envelope but some don't.

# Histogram
gg_reshist(diag_urb_poll_1, bins=20)

# DATA LOOKS NORMAL ENOUGH.

```


######## ANOVA
######### City_dist, not urb_score
```{r}
lm.poll.gr.1 <- lm(Average_Pollinia 	~ Year * City_dist, data = AvgVars_notNA_Poll_18_19)
lm.poll.gr.1_anova <- car::Anova(lm.poll.gr.1, REML = F)
summary(lm.poll.gr.1)
# Interaction not significant but main effects are.

lm.poll.gr.2 <- lm(Average_Pollinia 	~ Year + City_dist, data = AvgVars_notNA_Poll_18_19)
lm.poll.gr.2_anova <- car::Anova(lm.poll.gr.2, REML = F)
# Interaction not significant but main effects are.

AIC(lm.poll.gr.1, lm.poll.gr.2)
```

######### urb_score
```{r}
u_poll_glm_gradient_1 <- lm(Average_Pollinia 	~ Year * Urb_score, data = AvgVars_notNA_Poll_18_19)
u_poll_glm_gradient_1_anova <- car::Anova(u_poll_glm_gradient_1, REML = F)
summary(u_poll_glm_gradient_1, REML = F)
# Interaction not significant but main effects are.

u_poll_glm_gradient_2 <- lm(Average_Pollinia 	~ Year + Urb_score, data = AvgVars_notNA_Poll_18_19)
u_poll_glm_gradient_2_anova <- car::Anova(u_poll_glm_gradient_2, REML = F)
# Year and urb_score sig.

AIC(u_poll_glm_gradient_1, u_poll_glm_gradient_2)

```

####### With transect- NO TRANSFORMATION NEEDED
######## Diagnostics
######### City_dist: NO TRANSFORMATION NEEDED
```{r}
AvgVars_notNA_Poll_18_19 %>% filter(Transect_ID == "North" | Transect_ID == "South")

urbpoll_lm <- lm(Average_Pollinia ~ City_dist * Year * Transect_ID, 
                 data = AvgVars_notNA_Poll_18_19 %>% filter(Transect_ID == "North" | Transect_ID == "South"))

par(mfrow=c(2,2))
plot(urbpoll_lm)
summary(urbpoll_lm)

ggqqplot(AvgVars_notNA_Poll_18_19 %>% filter(Transect_ID == "North" | Transect_ID == "South")$Average_Pollinia)
## Almost all data points fall within the envelope but some don't.

# Histogram
gg_reshist(urbpoll_lm, bins=20)

 #looks normal!

```

######### Urb_score: NO TRANSFORMATION NEEDED
```{r}

diag_urb_poll_1 <- lm(Average_Pollinia ~ Urb_score * Year * Transect_ID,
                      data = AvgVars_notNA_Poll_18_19 %>% filter(Transect_ID == "Rural"))

par(mfrow=c(2,2))
plot(diag_urb_poll_1)
summary(diag_urb_poll_1)

ggqqplot((AvgVars_notNA_Poll_18_19 %>% filter(Transect_ID == "Rural"))$Average_Pollinia)
## Nearly all data points fall within the envelope

# Histogram
gg_reshist(diag_urb_poll_1, bins=20)

 #looks normal!

```


######## ANOVA
######### City_dist, not urb_index
```{r}
lm.poll.subt.1 <- lm(Average_Pollinia 	~ Year * City_dist * Transect_ID,
                     data = AvgVars_notNA_Poll_18_19 %>% filter(Transect_ID == "North" | Transect_ID == "South"))
car::Anova(lm.poll.subt.1, REML = F)
# 3-way interaction not significant, so let's look at lower-level interactions and main effects.

lm.poll.subt.2 <- lm(Average_Pollinia 	~ Year + City_dist + Transect_ID + Year:City_dist + Year:Transect_ID + City_dist:Transect_ID,
                     data = AvgVars_notNA_Poll_18_19 %>% filter(Transect_ID == "North" | Transect_ID == "South"))
lm.poll.subt.2_anova <- car::Anova(lm.poll.subt.2, REML = F)
# Year:transect interaction is marginally sig but year:citydist and citydist:transect aren't, so I'll remove those

lm.poll.subt.3 <- (lm(Average_Pollinia 	~ Year + City_dist + Transect_ID + Year:Transect_ID,
                      data = AvgVars_notNA_Poll_18_19 %>% filter(Transect_ID == "North" | Transect_ID == "South")))
lm.poll.subt.3_anova <- car::Anova(lm.poll.subt.3, REML = F)

lm.poll.subt.4 <- (lm(Average_Pollinia 	~ Year + City_dist + Transect_ID,
                      data = AvgVars_notNA_Poll_18_19 %>% filter(Transect_ID == "North" | Transect_ID == "South")))
lm.poll.subt.4_anova <- car::Anova(lm.poll.subt.4, REML = F)

AIC(lm.poll.subt.1, lm.poll.subt.2, lm.poll.subt.3, lm.poll.subt.4)
```


######### Urb_index, not city_dist
```{r}
u_poll_glm_subtr_1 <- lm(Average_Pollinia 	~ Year * Urb_score * Transect_ID, 
                         data = AvgVars_notNA_Poll_18_19 %>%
                           filter(Transect_ID == "Rural"))
u_poll_glm_subtr_1_anova <- car::Anova(u_poll_glm_subtr_1, REML = F)
# 3-way interaction not significant, so let's look at lower-level interactions and main effects.

u_poll_glm_subtr_2 <- lm(Average_Pollinia 	~ Year + Urb_score + Transect_ID + Year:Urb_score + Year:Transect_ID + Urb_score:Transect_ID,
                         data = AvgVars_notNA_Poll_18_19 %>%
                           filter(Transect_ID == "Rural"))
u_poll_glm_subtr_2_anova <- car::Anova(u_poll_glm_subtr_2, REML = F)
# Year:transect interaction is sig but year:Urb_score and Urb_score:transect aren't, so I'll remove those

u_poll_glm_subtr_3 <- lm(Average_Pollinia 	~ Year + Urb_score + Transect_ID + Year:Transect_ID,
                         data = AvgVars_notNA_Poll_18_19 %>%
                           filter(Transect_ID == "Rural"))
u_poll_glm_subtr_3_anova <- car::Anova(u_poll_glm_subtr_3, REML = F)
# Urb_score not significant alone but going to keep it since it's central to my question. I'll remove the year:transect itneraxn though since I don't really care about year.


u_poll_glm_subtr_4 <- lm(Average_Pollinia 	~ Year + Urb_score + Transect_ID, 
                         data = AvgVars_notNA_Poll_18_19 %>%
                           filter(Transect_ID == "Rural"))
u_poll_glm_subtr_4_anova <- car::Anova(u_poll_glm_subtr_4, REML = F)
# Year sig, transect marg sig


AIC(u_poll_glm_subtr_1, u_poll_glm_subtr_2, u_poll_glm_subtr_3, u_poll_glm_subtr_4)
# only 2 and 3 are top models

```



###### inflor/plant-level means
The point of this is to test whether the complicated glmer model is better than the simple lmer. Additionally, is the lm better than lmer? The simpler model will make the regression results easier to interpret if, in fact, the simplest model provides the same conclusions/results as the most complicated.
The lm uses population-level means while lmer and glmer use flower-level, nested data.
```{r}
# Make new dfs with hierarchical means
## make new df w/inflor-level means
long_inflor_means <- long_Transect_Data_18_19 %>%
  group_by(Patch_ID, Year, Pop_ID, Plant_Num, Inflor) %>%
    dplyr::summarise(
      Poll_rm_per_inflor=mean(Pollinia_removed,na.rm = TRUE),
      City_dist=mean(City_dist),
      Transect_ID=first(Transect_ID),
      Plants_present_2018=mean(Plants_present_2018,na.rm=TRUE),
      nPlants=n()
      )

## make new df w/plant-level means
long_plant_means <- long_inflor_means %>%
  group_by(Patch_ID, Year, Pop_ID, Plant_Num) %>%
    dplyr::summarise(
      Poll_rm_per_plant=mean(Poll_rm_per_inflor,na.rm = TRUE),
      City_dist=mean(City_dist),
      Transect_ID=first(Transect_ID),
      Plants_present_2018=mean(Plants_present_2018,na.rm=TRUE),
      nPlants=n()
      )

# xxxxx <- long_Transect_Data_18_19 %>%
#   group_by(Patch_ID, Year, Pop_ID, Plant_Num, Inflor) %>%
#   dplyr::summarise(
#       flowers_surveyed=n_distinct(Pollinia_removed,na.rm = TRUE))
# 
# xxxxx <- xxxxx %>% group_by(Patch_ID, Year, Pop_ID) %>%
#     dplyr::summarise(
#       flowers_surveyed=sum(flowers_surveyed,na.rm = TRUE))

test <- long_Transect_Data_18_19 %>%
  group_by(Patch_ID, Year, Pop_ID, Plant_Num, Inflor) %>%
  dplyr::summarise(
      flowers_surveyed=n_distinct(Pollinia_removed,na.rm = TRUE)) %>%
  group_by(Patch_ID, Year, Pop_ID) %>%
    dplyr::summarise(
      flowers_surveyed=sum(flowers_surveyed,na.rm = TRUE))

hist(test$flowers_surveyed, breaks = 15)

# try out new lmers
###### INFLORESCENCE MEANS ########
######### GRADIENT
z1 <- lmer(Poll_rm_per_inflor ~ (1|Patch_ID/Plant_Num) * City_dist * Year,
           long_inflor_means,
           REML = F)
summary(z1)
car::Anova(z1)
# interxn not sig but main effects are
z1.1 <- car::Anova(lmer(Poll_rm_per_inflor ~ (1|Patch_ID/Plant_Num) + City_dist + Year,
                        long_inflor_means,
                        REML = F))
# Year and city_dist sig-
# **SAME "STORY" as anova w/pop means for lm**

###### INFLORESCENCE MEANS ########
######### urban transects
z2 <- lmer(Poll_rm_per_inflor ~ (1|Patch_ID/Plant_Num) + City_dist * Year * Transect_ID,
           (long_inflor_means %>%
              filter(Transect_ID != 'Rural')),
           REML = F)
summary(z2)
z2.1 <- car::Anova(z2)
# **SAME "STORY" as anova w/pop means for lmer in that same vars are sig, but slightly less so than anova w/pop means; 3-way interaxn marginally sig whereas other was < 0.05**


###### PLANT MEANS ########
######### GRADIENT
z3 <- lmer(Poll_rm_per_plant ~ (1|Patch_ID) + City_dist * Year,
           long_plant_means,
           REML = F)
summary(z3)
car::Anova(z3)
# interxn not sig but main effects are

z3.1 <- car::Anova(lmer(Poll_rm_per_plant ~ (1|Patch_ID) + City_dist + Year,
                        long_plant_means,
                        REML = F))
# SAME "STORY" as anova w/pop means 


###### PLANT MEANS ########
######### urban transects
z4 <- lmer(Poll_rm_per_plant ~ (1|Patch_ID) + City_dist * Year * Transect_ID,
           (long_plant_means %>%
              filter(Transect_ID != 'Rural')),
           REML = F)
summary(z4 )
car::Anova(z4 )
# 3-way interaxn not sig, so removing

z4.1 <- lmer(Poll_rm_per_plant ~ (1|Patch_ID) + City_dist:Year + City_dist:Transect_ID + Transect_ID:Year + Transect_ID + City_dist + Year,
             (long_plant_means %>% filter
              (Transect_ID != 'Rural')),
             REML = F)
summary(z4.1)
car::Anova(z4.1)

z4.2 <- lmer(Poll_rm_per_plant ~ (1|Patch_ID) + City_dist:Year + Transect_ID:Year + Transect_ID + City_dist + Year, 
             (long_plant_means %>%
                filter(Transect_ID != 'Rural')),
             REML = F)
summary(z4.2)
z4.22 <- car::Anova(z4.2)
## Year:Transect+ID and City_dist:Year both marginally sig, so this is the best model unless want to make p = 0.05 strict cutoff

# Making p = 0.05 the strict cutoff...
z4.3 <- lmer(Poll_rm_per_plant ~ (1|Patch_ID) + Transect_ID + City_dist + Year,
             (long_plant_means %>%
                filter(Transect_ID != 'Rural')),
             REML = F)
summary(z4.3)
car::Anova(z4.3)
## Only Year is significant

z4.4 <- lmer(Poll_rm_per_plant ~ (1|Patch_ID)+ Year,
             (long_plant_means %>% filter(Transect_ID != 'Rural')), REML = F)
summary(z4.4)
z4.5 <- car::Anova(z4.4)
# Year is significant

# THIS 'STORY' DIFFERS FROM ANOVA W/POP MEANS.
```

# Pods
###### plant-level means
The point of this is to test whether the complicated glmer model is better than the simple lmer. Additionally, is the lm better than lmer? The simpler model will make the regression results easier to interpret if, in fact, the simplest model provides the same conclusions/results as the most complicated.
The lm uses population-level means while lmer and glmer use plant-level data.
```{r}
# Make new dfs with hierarchical means
## make new df w/plant-level means
### this is the same as Transect_Data_18_19!
long_plant_means_pods <- fertile_long %>%
  group_by(Patch_ID, Year, Pop_ID, Plant_Num) %>%
    dplyr::summarise(
      Pods_per_plant=mean(Viable_Pods,na.rm = TRUE),
      City_dist=mean(City_dist),
      Transect_ID=first(Transect_ID),
      Plants_present_2018=mean(Plants_present_2018,na.rm=TRUE),
      nPlants=n()
      )

# try out new glmer
## GRADIENT
y1 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist * Year,
            long_plant_means_pods,
            family = "poisson")
summary(y1)
car::Anova(y1)
# Year marg sig but interaxn isn't, so removing that

y1.1 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist + Year,
              long_plant_means_pods,
              family = "poisson")
summary(y1.1)
car::Anova(y1.1)
# Year marg sig. Removing city_dist

y1.2 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + Year,
              long_plant_means_pods,
              family = "poisson")
summary(y1.2)
y1.21 <- car::Anova(y1.2)
# Year marg sig


## URBAN SUBTRANSECTS
y2 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist * Year * Transect_ID,
            (long_plant_means_pods %>% filter(Transect_ID != 'Rural')),
            family = "poisson",
            glmerControl(optimizer="bobyqa",
                         optCtrl = list(maxfun = 100000)))
summary(y2)
y2.1 <- car::Anova(y2)
# 3-way interaxn is significant here


```

###### LM
####### Without transect -USE SQRT TRANSFORMATION
######## Diagnostics
######### City_dist: USE SQRT TRANSFORMATION
```{r}

allpod_lm <- lm(Viable_Pods ~ City_dist * Year ,
                data = fertile_pops_all)

par(mfrow=c(2,2))
plot(allpod_lm)
summary(allpod_lm)

qplot(fertile_pops_all$Viable_Pods)
#looks like 15 may be an outlier that could be removed

summary(fertile_pops_all$Viable_Pods)
sd(fertile_pops_all$Viable_Pods)
# so, planst with 12 and 15 pods are (12-3.89)/2.6 = 3.11 and (15-3.89)/2.6 = 4.27 standard deviations from the mean, respectively

gg_reshist(lm((Viable_Pods) ~ City_dist * Year, data = fertile_pops_all), bins=20)
ggqqplot(fertile_pops_all$Viable_Pods)
## Most data points fall within the envelope but some don't. (towards one end)



# try  transformations
gg_reshist(lm((Viable_Pods)^(1/2) ~ City_dist * Year, data = fertile_pops_all), bins=20)
plot(lm((Viable_Pods)^(1/2) ~ City_dist * Year , data = fertile_pops_all))
ggqqplot((fertile_pops_all$Viable_Pods)^(1/2))
shapiro.test((fertile_pops_all$Viable_Pods)^(1/2))
##### GOING WITH THIS ONE. LOOKS GOOD.

# gg_reshist(lm((Viable_Pods)^(1/3) ~ City_dist * Year, data = fertile_pops_all), bins=20)
# plot(lm((Viable_Pods)^(1/3) ~ City_dist * Year, data = fertile_pops_all))
# ggqqplot((fertile_pops_all$Viable_Pods)^(1/3))
# shapiro.test((fertile_pops_all$Viable_Pods)^(1/3))
# 
# gg_reshist(lm(log(Viable_Pods + 1) ~ City_dist * Year, data = fertile_pops_all), bins=20)
# plot(lm(log(Viable_Pods + 1) ~ City_dist * Year, data = fertile_pops_all))
# ggqqplot(log(fertile_pops_all$Viable_Pods + 1))
# shapiro.test(log(fertile_pops_all$Viable_Pods + 1))


### NOT USING THIS ANYMORE
# add log(pods) col to df
# fertile_pops_all$Viable_Pods_log <- log(fertile_pops_all$Viable_Pods +1)


# add sqrt(pods) col to df
fertile_pops_all$Viable_Pods_sqrt <- sqrt(fertile_pops_all$Viable_Pods)
```

######### Urb_score: USE SQRT TRANSFORMATION
```{r}

diag_urb_pods_1 <- lm(Viable_Pods ~ Urb_score * Year ,
                      data = fertile_pops_all)

par(mfrow=c(2,2))
plot(diag_urb_pods_1)
summary(diag_urb_pods_1)

gg_reshist(diag_urb_pods_1, bins=20)
#looks like 98 & 76 may be outliers

summary(fertile_pops_all$Viable_Pods)
sd(fertile_pops_all$Viable_Pods)
# so, planst with 12 and 15 pods are (12-3.89)/2.6 = 3.11 and (15-3.89)/2.6 = 4.27 standard deviations from the mean, respectively

ggqqplot(fertile_pops_all$Viable_Pods)
## Most data points fall within the envelope but some don't. (towards one end)



# try  transformations
gg_reshist(lm((Viable_Pods)^(1/2) ~ Urb_score * Year, data = fertile_pops_all), bins=20)
plot(lm((Viable_Pods)^(1/2) ~ Urb_score * Year , data = fertile_pops_all))
ggqqplot((fertile_pops_all$Viable_Pods)^(1/2))
shapiro.test((fertile_pops_all$Viable_Pods)^(1/2))
##### GOING WITH THIS ONE. LOOKS GOOD.


# add sqrt(pods) col to df
fertile_pops_all$Viable_Pods_sqrt <- sqrt(fertile_pops_all$Viable_Pods)
```


######## ANOVA
######### City_dist, not urb_score
```{r}
# ANOVA
lm.pods.gr.1 <- lm(Viable_Pods_sqrt ~ Year * City_dist,
                   data = fertile_pops_all)
lm.pods.gr.1_anova <- car::Anova((lm.pods.gr.1), REML = F)
# Interaction and both main effects not significant.

lm.pods.gr.2 <- lm(Viable_Pods_sqrt ~ Year + City_dist,
                   data = fertile_pops_all)
lm.pods.gr.2_anova <- car::Anova((lm.pods.gr.2), REML = F)
# both main effects not significant.

AIC(lm.pods.gr.1, lm.pods.gr.2)

```

######### urb_score
```{r}
u_pod_glm_gradient_1 <- lm(Viable_Pods_sqrt 	~ Year * Urb_score,
                           data = fertile_pops_all)
u_pod_glm_gradient_1_anova <- car::Anova(u_pod_glm_gradient_1, REML = F)
# Interaction and both main effects not significant.

u_pod_glm_gradient_2 <- lm(Viable_Pods_sqrt 	~ Year + Urb_score,
                           data = fertile_pops_all)
u_pod_glm_gradient_2_anova <- car::Anova(u_pod_glm_gradient_2, REML = F)
# both main effects not significant.

AIC(u_pod_glm_gradient_1, u_pod_glm_gradient_2)
```


####### With transect- USE SQRT TRANSFORMATION
######## Diagnostics
######### City_dist: USE SQRT TRANSFORMATION
```{r}

urbpods_lm <- lm(Viable_Pods ~ City_dist * Year * Transect_ID,
                 data = (fertile_pops_all %>%
                           dplyr::filter(Transect_ID != "Rural")))

par(mfrow=c(2,2))
plot(urbpods_lm)
# FANNING EFFECT IN RESIDS VS. FITTED PLOT- Heteroscedastic
library(lmtest)
bptest(urbpods_lm)
# high p-value (0.31) indicates homoscedasticity... so maybe it's ok?
ncvTest(urbpods_lm)
# low p-value (0.001) indicates heteroscedasticity... so maybe it's not ok?

summary(urbpods_lm)
summary((fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))$Viable_Pods)
sd((fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))$Viable_Pods)

qplot((fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))$Viable_Pods)

ggqqplot((fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))$Viable_Pods)
## Almost all data points fall within the envelope but some along one end don't.

# Histogram
gg_reshist(urbpods_lm, bins=20)


# try log transformation
gg_reshist(lm(log(Viable_Pods+1) ~ City_dist * Transect_ID * Year, data = (fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))), bins=20)
par(mfrow=c(2,2))
plot(lm(log(Viable_Pods+1) ~ City_dist* Transect_ID * Year, data = (fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))))
summary(lm(log(Viable_Pods+1) ~ City_dist* Transect_ID * Year, data = (fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))))
ggqqplot(log((fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))$Viable_Pods+1))
shapiro.test(log((fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))$Viable_Pods+1))
# still not good (too strong?)


# try sq rt & cube root
gg_reshist(lm(Viable_Pods^(1/2) ~ City_dist * Transect_ID * Year, data = (fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))), bins=20)
plot(lm(Viable_Pods^(1/2) ~ City_dist * Transect_ID * Year, data = (fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))))
summary(lm(Viable_Pods^(1/2) ~ City_dist * Transect_ID * Year, data = (fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))))

par(mfrow=c(2,2))
plot(lm(Viable_Pods^(1/2) ~ City_dist, (fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))))
ggqqplot((fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))$Viable_Pods^(1/2))
shapiro.test((fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South"))$Viable_Pods^(1/2))
# still not great but better than log & cube root. going with sq rt

# add sqrt(pods) col to df
fertile_pops_all$Viable_Pods_sqrt <- sqrt(fertile_pops_all$Viable_Pods)
```


######### Urb_score: USE SQRT TRANSFORMATION
```{r}

diag_urb_pods_2 <- lm(Viable_Pods ~ Urb_score * Year * Transect_ID,
                      data = fertile_pops_all %>% filter(Transect_ID != "Rural"))

par(mfrow=c(2,2))
plot(diag_urb_pods_2)
# FANNING EFFECT IN RESIDS VS. FITTED PLOT- Heteroscedastic
library(lmtest)
bptest(diag_urb_pods_2)
# high p-value (0.23) indicates homoscedasticity... so maybe it's ok?
ncvTest(diag_urb_pods_2)
# low p-value (0.003) indicates heteroscedasticity... so maybe it's not ok?

summary(diag_urb_pods_2)

gg_reshist(diag_urb_pods_2, bins = 20)

ggqqplot(fertile_pops_all$Viable_Pods %>%
           filter(Transect_ID != "Rural"))
## Almost all data points fall within the envelope but some along one end don't


# try log transformation
gg_reshist(lm(log(Viable_Pods+1) ~ Urb_score * Transect_ID * Year, fertile_pops_all %>% filter(Transect_ID != "Rural"))), bins=20)
par(mfrow=c(2,2))
plot(lm(log(Viable_Pods+1) ~ Urb_score* Transect_ID * Year,  fertile_pops_all %>% filter(Transect_ID != "Rural"))))
summary(lm(log(Viable_Pods+1) ~ Urb_score* Transect_ID * Year, fertile_pops_all %>% filter(Transect_ID != "Rural"))))
ggqqplot(log( fertile_pops_all %>% filter(Transect_ID != "Rural"))$Viable_Pods+1))
shapiro.test(log( fertile_pops_all %>% filter(Transect_ID != "Rural"))$Viable_Pods+1))
# still not good (too strong?)


# try sq rt
gg_reshist(lm(Viable_Pods^(1/2) ~ Urb_score * Transect_ID * Year,
              fertile_pops_all %>% filter(Transect_ID != "Rural")), bins=20)
plot(lm(Viable_Pods^(1/2) ~ Urb_score * Transect_ID * Year,
        fertile_pops_all %>% filter(Transect_ID != "Rural")))
summary(lm(Viable_Pods^(1/2) ~ Urb_score * Transect_ID * Year,
           fertile_pops_all %>% filter(Transect_ID != "Rural")))
ggqqplot(fertile_pops_all$Viable_Pods^(1/2) %>% filter(Transect_ID != "Rural"))
shapiro.test( fertile_pops_all %>% filter(Transect_ID != "Rural"))$Viable_Pods^(1/2)


# try cube root
gg_reshist(lm(Viable_Pods^(1/3) ~ Urb_score * Transect_ID * Year,
              fertile_pops_all %>% filter(Transect_ID != "Rural"))), bins=20)
plot(lm(Viable_Pods^(1/3) ~ Urb_score * Transect_ID * Year,
        fertile_pops_all %>% filter(Transect_ID != "Rural"))))
ggqqplot(fertile_pops_all %>% filter(Transect_ID != "Rural"))$Viable_Pods^(1/3))
shapiro.test(fertile_pops_all %>% filter(Transect_ID != "Rural"))$Viable_Pods^(1/3))
# still not great but better than log & cube root. going with sq rt

# add sqrt(pods) col to df
fertile_pops_all$Viable_Pods_sqrt <- sqrt(fertile_pops_all$Viable_Pods)

```

######## ANOVA
######### City_dist, not urb_scores
```{r}
lm.pods.subt.1 <- lm(Viable_Pods_sqrt ~ Year * City_dist * Transect_ID,
                     data = (fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South")))
lm.pods.subt.1_anova <- car::Anova(lm.pods.subt.1, REML = F)
# 3-way interaction not significant, so let's look at lower-level interactions and main effects.

lm.pods.subt.2 <- lm(Viable_Pods_sqrt 	~ Year + City_dist + Transect_ID + Year:City_dist + Year:Transect_ID + City_dist:Transect_ID,
                     data = (fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South")))
lm.pods.subt.2_anova <- car::Anova(lm.pods.subt.2, REML = F)
# Nothing significant

lm.pods.subt.3 <- lm(Viable_Pods_sqrt 	~ Year + City_dist + Transect_ID,
                     data = (fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South")))
lm.pods.subt.3_anova <- car::Anova(lm.pods.subt.3, REML = F)
# Nothing significant

AIC(lm.pods.subt.1, lm.pods.subt.2, lm.pods.subt.3)
```

######### urb_scores, not city_dist
```{r}
u_pod_glm_subtr_1 <- lm(Viable_Pods_sqrt 	~ Year * Urb_score * Transect_ID,
                        data = fertile_pops_all %>% filter(Transect_ID != "Rural"))
u_pod_glm_subtr_1_anova <- car::Anova(u_pod_glm_subtr_1,
                                      REML = F)
# 3-way interaction not significant, so let's look at lower-level interactions and main effects.

u_pod_glm_subtr_2 <- lm(Viable_Pods_sqrt 	~ Year + Urb_score + Transect_ID + Year:Urb_score + Year:Transect_ID + Urb_score:Transect_ID,
                        data = fertile_pops_all %>%
                          filter(Transect_ID != "Rural"))
u_pod_glm_subtr_2_anova <- car::Anova(u_pod_glm_subtr_2, REML = F)
# Nothing significant

u_pod_glm_subtr_3 <- lm(Viable_Pods_sqrt 	~ Year + Urb_score + Transect_ID,
                        data = fertile_pops_all %>%
                          filter(Transect_ID != "Rural"))
u_pod_glm_subtr_3_anova <- car::Anova(u_pod_glm_subtr_3, REML = F)
# nothing sig

AIC(u_pod_glm_subtr_1, u_pod_glm_subtr_2, u_pod_glm_subtr_3)
```


# Peduncles (Inflorescences)
###### plant-level means
The point of this is to test whether the complicated glmer model is better than the simple lmer. Additionally, is the lm better than lmer? The simpler model will make the regression results easier to interpret if, in fact, the simplest model provides the same conclusions/results as the most complicated.
The lm uses population-level means while lmer and glmer use plant-level data.
```{r}
# Make new dfs with hierarchical means
## make new df w/plant-level means
long_plant_means_peds <- fertile_long %>%
  group_by(Patch_ID, Year, Pop_ID, Plant_Num) %>%
    dplyr::summarise(
      Peds_per_plant=mean(Peduncles,na.rm = TRUE),
      City_dist=mean(City_dist),
      Transect_ID=first(Transect_ID),
      Plants_present_2018=mean(Plants_present_2018,na.rm=TRUE),
      nPlants=n()
      )

# try out new glmer
x1 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist * Year, 
            long_plant_means_peds,
            family = "poisson")
summary(x1)
x1.1 <- car::Anova(x1)
# City_dist:Year interaxn sig, main effects aren't


# try out new glmer w/transects
x2 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist * Year * Transect_ID, 
            (long_plant_means_peds %>%
               filter(Transect_ID != 'Rural')),
            family = "poisson",
            glmerControl(optimizer="bobyqa",
                         optCtrl = list(maxfun = 100000)))
summary(x2)
car::Anova(x2)
# 3-way interaxn not sig- trying secondary interaxns


# x2.1 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist + Year + Transect_ID + Transect_ID:City_dist + Transect_ID:Year + City_dist:Year, (long_plant_means_peds %>% filter(Transect_ID != 'Rural')), family = "poisson", 
#             glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# summary(x2.1)
# car::Anova(x2.1)
##### NOT CONVERGING. TRYING SEPARATE MAIN EFFECTS

# Remove 2-way interactions one by one to see if any are sig- NONE WERE.
## Removed City_dist:Year
x2.2 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist + Year + Transect_ID + Transect_ID:City_dist + Transect_ID:Year,
              (long_plant_means_peds %>%
                 filter(Transect_ID != 'Rural')),
              family = "poisson", 
            glmerControl(optimizer="bobyqa",
                         optCtrl = list(maxfun = 100000)))
summary(x2.2)
car::Anova(x2.2)
## No 2-way interaxn sig

# Removed Transect_ID:Year
x2.3 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist + Year + Transect_ID + Transect_ID:City_dist + City_dist:Year,
              (long_plant_means_peds %>%
                 filter(Transect_ID != 'Rural')),
              family = "poisson", 
              glmerControl(optimizer="bobyqa",
                           optCtrl = list(maxfun = 100000)))
summary(x2.3)
car::Anova(x2.3)
## No 2-way interaxn sig

# Removed Transect_ID:City_dist
x2.4 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist + Year + Transect_ID + Year:City_dist + Transect_ID:Year,
              (long_plant_means_peds %>%
                 filter(Transect_ID != 'Rural')),
              family = "poisson", 
              glmerControl(optimizer="bobyqa",
                           optCtrl = list(maxfun = 100000)))
summary(x2.4)
car::Anova(x2.4)
## No 2-way interaxn sig


x2.5 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist + Year + Transect_ID,
              (long_plant_means_peds %>%
                 filter(Transect_ID != 'Rural')),
              family = "poisson",
            glmerControl(optimizer="bobyqa",
                         optCtrl = list(maxfun = 100000)))
summary(x2.5)
car::Anova(x2.5)
# City_dist sig


x2.6 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist,
              (long_plant_means_peds %>%
                 filter(Transect_ID != 'Rural')),
              family = "poisson", 
              glmerControl(optimizer="bobyqa",
                           optCtrl = list(maxfun = 100000)))
summary(x2.6)
x2.61 <- car::Anova(x2.6)
# City_dist sig
```

###### LM
####### Without transect- USE SQUARING TRANSFORMATION
######## Diagnostics
######### City_dist: USE SQUARING TRANSFORMATION
```{r}

allped_lm <- lm(Peduncles ~ City_dist * Year, 
                data = (fertile_pops_all %>%
                          filter(!is.na(Peduncles))))

par(mfrow=c(2,2))
plot(allped_lm)
summary(allped_lm)

## Histogram
gg_reshist(allped_lm, bins=20)

qplot((fertile_pops_all %>% filter(!is.na(Peduncles)))$Peduncles, bins = 15)

summary((fertile_pops_all %>% filter(!is.na(Peduncles)))$Peduncles)
sd((fertile_pops_all %>% filter(!is.na(Peduncles)))$Peduncles)

ggqqplot((fertile_pops_all %>% filter(!is.na(Peduncles)))$Peduncles)
## Most data points fall within the envelope but several don't. (towards one end)

# Shapiro-Wilk normality test
shapiro.test((fertile_pops_all %>% filter(!is.na(Peduncles)))$Peduncles)
## From the output, the p-value < 0.05 implying that the distribution of the data are significantly different from normal distribution. We cannot assume the normality.
# looks left-skewed.

qplot(((fertile_pops_all %>% filter(!is.na(Peduncles)))$Peduncles)^2, bins = 20)
plot(lm((Peduncles^2) ~ City_dist, data = (fertile_pops_all %>% filter(!is.na(Peduncles)))), bins=20)
gg_reshist(lm((Peduncles^2) ~ City_dist, data = (fertile_pops_all %>% filter(!is.na(Peduncles)))), bins=20)
ggqqplot(((fertile_pops_all %>% filter(!is.na(Peduncles)))$Peduncles)^2)
shapiro.test(((fertile_pops_all %>% filter(!is.na(Peduncles)))$Peduncles)^2)

## tried squaring, cubing, log transformations. Squaring looks best.


# add sq(pods) col to df
fertile_pops_all$Peduncles_sq <- (fertile_pops_all$Peduncles)^2

```

######### Urb_score: Use Squaring transformation
```{r}

diag_urb_peds_1 <- lm(Peduncles ~ Urb_score * Year, data = fertile_pops_all)

par(mfrow=c(2,2))
plot(diag_urb_peds_1)
summary(diag_urb_peds_1)

## Histogram
gg_reshist(diag_urb_peds_1, bins=20)
hist(fertile_pops_all$Peduncles)


ggqqplot(fertile_pops_all$Peduncles)
## Most data points fall within the envelope but several don't. (towards one end)

bptest(diag_urb_peds_1)
# homoskedastic?

# Shapiro-Wilk normality test
shapiro.test(fertile_pops_all$Peduncles)
## From the output, the p-value < 0.05 implying that the distribution of the data are significantly different from normal distribution. We cannot assume the normality. But the biological background for peduncle production backs this up; that distribution would be expected to not be normal anyway.
# looks left-skewed.

hist(fertile_pops_all$Peduncles^(1/2), breaks = 12)
hist(log(fertile_pops_all$Peduncles + 1), breaks = 12)
hist(fertile_pops_all$Peduncles^(2), breaks = 12)

qplot((fertile_pops_all$Peduncles)^2, bins = 20)
plot(lm((Peduncles^2) ~ Urb_score * Year, data = fertile_pops_all), bins=20)
gg_reshist(lm((Peduncles^2) ~ Urb_score* Year, data = fertile_pops_all), bins=20)
ggqqplot((fertile_pops_all$Peduncles)^2)

## tried squaring, cubing, log transformations. Squaring looks best.


# add sq(pods) col to df
fertile_pops_all$Peduncles_sq <- (fertile_pops_all$Peduncles)^2



# ----------------
# try negative binomial

summary(glm.nb(Peduncles ~ Urb_score * Year, data = fertile_pops_all))
# AIC is lower than lm



# --------------
# Export residuals, then look at spatial pattern
fertile_pops_all$residuals <- residuals(lm((Peduncles ~ Urb_score * Year),data = fertile_pops_all))

# new df with site coordinates and residuals
sites1 <- dplyr::rename(sites, Patch_ID = Pop_ID)
fertile_pops_all <- as.data.frame(fertile_pops_all)
sites_pedresids <- dplyr::full_join(sites1, fertile_pops_all, by = 'Patch_ID')


# look at mapped out residuals
 base_map +
   geom_point(data = sites_pedresids, mapping = aes(x = lon, y = lat, shape=Transect.y, color = residuals), size= 2) +
  labs(x = 'Longitude', y = 'Latitude') +
   scale_color_gradient2(low = "blue", 
                         midpoint = 0,
                          mid = "white",
                          high = "red",
                          space="Lab")

```

######## ANOVA
######### City_dist, not urb_score
```{r}
lm.peds.gr.1 <- lm(Peduncles_sq	~ Year * City_dist,
                   data = (fertile_pops_all %>% filter(!is.na(Peduncles))))
lm.peds.gr.1_anova <- car::Anova(lm.peds.gr.1, REML = F)
# Interaction is significant but both main effects aren't.

lm.peds.gr.2 <- lm(Peduncles_sq	~ Year + City_dist,
                   data = (fertile_pops_all %>% filter(!is.na(Peduncles))))
lm.peds.gr.2_anova <- car::Anova(lm.peds.gr.2, REML = F)

AIC(lm.peds.gr.1, lm.peds.gr.2)

```

######### urb_score, not city_dist
```{r}
u_ped_glm_gradient_1 <- lm(Peduncles_sq 	~ Year * Urb_score,
                           data = fertile_pops_all)
u_ped_glm_gradient_1_anova <- car::Anova(u_ped_glm_gradient_1, REML = F)
# Nothing significant

u_ped_glm_gradient_2 <- lm(Peduncles_sq 	~ Year + Urb_score,
                           data = fertile_pops_all)
u_ped_glm_gradient_2_anova <- car::Anova(u_ped_glm_gradient_2, REML = F)
# Nothing significant

AIC(u_ped_glm_gradient_1, u_ped_glm_gradient_2)

```

####### With transect- USE SQUARING TRANSFORMATION
######## Diagnostics
######### City_dist: USE SQUARING TRANSFORMATION
```{r}

urbpeds_lm <- lm(Peduncles ~ City_dist * Year * Transect_ID,
                 data = fertile_pops_all %>% filter(Transect_ID != "Rural"))

par(mfrow=c(2,2))
plot(urbpeds_lm)
summary(urbpeds_lm)

## Histogram
gg_reshist(urbpeds_lm, bins=20)

qplot(fertile_pops_all %>% filter(Transect_ID != "Rural")$Peduncles, bins = 15)

summary(fertile_pops_all %>% filter(Transect_ID != "Rural")$Peduncles)
sd(fertile_pops_all %>% filter(Transect_ID != "Rural")$Peduncles)

ggqqplot(fertile_pops_all %>% filter(Transect_ID != "Rural")$Peduncles)
## Most data points fall within the envelope but several don't. (towards one end)

# Shapiro-Wilk normality test
shapiro.test(fertile_pops_all %>% filter(Transect_ID != "Rural")$Peduncles)
## From the output, the p-value < 0.05 implying that the distribution of the data are significantly different from normal distribution. We cannot assume the normality.

qplot((fertile_pops_all %>% filter(Transect_ID != "Rural")$Peduncles)^2)
plot(lm((Peduncles^2) ~ City_dist * Year * Transect_ID, data = fertile_pops_all %>% filter(Transect_ID != "Rural")), bins=20)
gg_reshist(lm((Peduncles^2) ~ City_dist * Year * Transect_ID, data = fertile_pops_all %>% filter(Transect_ID != "Rural")), bins=20)
ggqqplot((fertile_pops_all %>% filter(Transect_ID != "Rural")$Peduncles)^2)
shapiro.test((fertile_pops_all %>% filter(Transect_ID != "Rural")$Peduncles)^2)
# looks really good!


# add squared peduncles col to df
fertile_pops_all$Peduncles_sq <- (fertile_pops_all$Peduncles)^2

```


######### Urb_score: USE SQUARING TRANSFORMATION
```{r}

diag_urb_peds_2 <- lm(Peduncles ~ Urb_score * Year * Transect_ID,
                      data = fertile_pops_all %>% filter(Transect_ID != "Rural"))

par(mfrow=c(2,2))
plot(diag_urb_peds_2)
summary(diag_urb_peds_2)

## Histogram
gg_reshist(diag_urb_peds_2, bins=20)

ggqqplot(fertile_pops_all %>% filter(Transect_ID != "Rural")$Peduncles)
## Most data points fall within the envelope but several don't. (towards one end)
# Looks left-skewed

# Shapiro-Wilk normality test
shapiro.test(fertile_pops_all %>% filter(Transect_ID != "Rural")$Peduncles)
## From the output, the p-value < 0.05 implying that the distribution of the data are significantly different from normal distribution. We cannot assume the normality.

qplot((fertile_pops_all %>% filter(Transect_ID != "Rural")$Peduncles)^2, bins = 15)
plot(lm((Peduncles^2) ~ Urb_score * Year * Transect_ID, data = fertile_pops_all %>% filter(Transect_ID != "Rural")), bins=20)
gg_reshist(lm((Peduncles^2) ~ Urb_score * Year * Transect_ID, data = fertile_pops_all %>% filter(Transect_ID != "Rural")), bins=20)
ggqqplot((fertile_pops_all %>% filter(Transect_ID != "Rural")$Peduncles)^2)
shapiro.test((fertile_pops_all %>% filter(Transect_ID != "Rural")$Peduncles)^2)
# looks really good!


# add squared peduncles col to df
fertile_pops_all$Peduncles_sq <- (fertile_pops_all$Peduncles)^2

```



######## ANOVA
######### City_dist, not urb_score
```{r}
lm.peds.subt.1 <- lm(Peduncles_sq	~ Year * City_dist * Transect_ID,
                     data = fertile_pops_all %>% filter(Transect_ID != "Rural"))
lm.peds.subt.1_anova <- car::Anova(lm.peds.subt.1, REML = F)
# 3-way interaction not significant, so let's look at lower-level interactions and main effects.

lm.peds.subt.2 <- lm(Peduncles_sq	~ Year + City_dist + Transect_ID + Year:City_dist + Year:Transect_ID + City_dist:Transect_ID,
                     data = fertile_pops_all %>% filter(Transect_ID != "Rural"))
lm.peds.subt.2_anova <- car::Anova(lm.peds.subt.2, REML = F)
# Only city_dist significant. look at main effects and no interactions

lm.peds.subt.3 <- lm(Peduncles_sq	~ Year + City_dist + Transect_ID, data = fertile_pops_all %>% filter(Transect_ID != "Rural"))
lm.peds.subt.3_anova <- car::Anova(lm.peds.subt.3, REML = F)
# City_dist is sig

AIC(lm.peds.subt.1, lm.peds.subt.2, lm.peds.subt.3)

```

######### Urb_score, not city_dist
```{r}
u_ped_glm_subtr_1 <- lm(Peduncles_sq 	~ Year * Urb_score * Transect_ID,
                        data = fertile_pops_all %>% filter(Transect_ID != "Rural"))
u_ped_glm_subtr_1_anova <- car::Anova(u_ped_glm_subtr_1, REML = F)
# 3-way interaction not significant, so let's look at lower-level interactions and main effects.

u_ped_glm_subtr_2 <- lm(Peduncles_sq 	~ Year + Urb_score + Transect_ID + Year:Urb_score + Year:Transect_ID + Urb_score:Transect_ID,
                        data = fertile_pops_all %>% filter(Transect_ID != "Rural"))
u_ped_glm_subtr_2_anova <- car::Anova(u_ped_glm_subtr_2, REML = F)
# nothing sig

u_ped_glm_subtr_3 <- lm(Peduncles_sq 	~ Year + Urb_score + Transect_ID,
                        data = fertile_pops_all %>% filter(Transect_ID != "Rural"))
u_ped_glm_subtr_3_anova <- car::Anova(u_ped_glm_subtr_3, REML = F)
# nothing sig

AIC(u_ped_glm_subtr_1,u_ped_glm_subtr_2,u_ped_glm_subtr_3)
```

# Height
###### LM
####### Without transect
######## Diagnostics
######### City_dist- NO TRANSFORMATION NEEDED
```{r}

allheight_lm_sept <- lm(Height_Sept ~ City_dist * Year, data = (fertile_pops_all %>% filter(!is.na(Height_Sept))))

par(mfrow=c(2,2))
plot(allheight_lm_sept)
summary(allheight_lm_sept)

ggqqplot((fertile_pops_all %>% filter(!is.na(Height_Sept)))$Height_Sept)
# all data points within envelope

# Histogram
gg_reshist(allheight_lm_sept, bins=20)
# looks normal!

# Shapiro-Wilk normality test
shapiro.test((fertile_pops_all %>% filter(!is.na(Height_Sept)))$Height_Sept)
## From the output, the p-value > 0.05 implying that the distribution of the data are NOT significantly different from normal distribution. We can assume normality!
```


######### Urb_score- NO TRANSFORMATION NEEDED
```{r}
diag_urb_height_1 <- lm(Height_Sept ~ Urb_score * Year, data = (fertile_pops_all %>% filter(!is.na(Height_Sept))))

par(mfrow=c(2,2))
plot(diag_urb_height_1)
summary(diag_urb_height_1)

ggqqplot((fertile_pops_all %>% filter(!is.na(Height_Sept)))$Height_Sept)
# all data points within envelope

# Histogram
gg_reshist(diag_urb_height_1, bins=20)
# looks normal!

# Shapiro-Wilk normality test
shapiro.test((fertile_pops_all %>% filter(!is.na(Height_Sept)))$Height_Sept)
## From the output, the p-value > 0.05 implying that the distribution of the data are NOT significantly different from normal distribution. We can assume normality!
```



######## ANOVA
######### City_dist, not urb_score
```{r}
lm.height.gr.1 <- lm(Height_Sept	~ Year * City_dist, data = (fertile_pops_all %>% filter(!is.na(Height_Sept))))
lm.height.gr.1_anova <- car::Anova(lm.height.gr.1, REML = F)
# No effects or interactions significant,

lm.height.gr.2 <- lm(Height_Sept ~ Year + City_dist, data = (fertile_pops_all %>% filter(!is.na(Height_Sept))))
lm.height.gr.2_anova <- car::Anova(lm.height.gr.2, REML = F)
# No effects or interactions significant,

AIC(lm.height.gr.1, lm.height.gr.2)

```

######### urb_score
```{r}
u_height_glm_gradient_1 <- lm(Height_Sept 	~ Year * Urb_score, data = (fertile_pops_all %>% filter(!is.na(Height_Sept))))
u_height_glm_gradient_1_anova <- car::Anova(u_height_glm_gradient_1, REML = F)
# No interactions significant,

u_height_glm_gradient_2 <- lm(Height_Sept 	~ Year + Urb_score, data = (fertile_pops_all %>% filter(!is.na(Height_Sept))))
u_height_glm_gradient_2_anova <- car::Anova(u_height_glm_gradient_2, REML = F)
# No main effects significant,

AIC(u_height_glm_gradient_1, u_height_glm_gradient_2)

```


####### With transect
######## Diagnostics
######### City_dist: NO TRANSFORMATION NEEDED
```{r}

urbheight_lm_sept <- lm(Height_Sept ~ City_dist * Year * Transect_ID,
                        data = (fertile_pops_all %>% 
                                  filter(!is.na(Height_Sept) & Transect_ID != "Rural")))

par(mfrow=c(2,2))
plot(urbheight_lm_sept)
# looks like fanning (heteroskedasticity) 
## Felipe says it's not a big deal, esp. since dist_city is not normally distributed (b/c of my study design)
bptest(urbheight_lm_sept) # p = 0.153... not significant = there'sNO heteroskedasticity here

summary(urbheight_lm_sept)
hist((fertile_pops_all %>%
        filter(!is.na(Height_Sept) & Transect_ID != "Rural"))$City_dist)

ggqqplot((fertile_pops_all %>% filter(!is.na(Height_Sept) & Transect_ID != "Rural"))$Height_Sept)
## Data points don't fit in envelope towards right margin.

# Histogram
gg_reshist(urbheight_lm, bins=20)
# slightly right-skewed

# Shapiro-Wilk normality test
shapiro.test((fertile_pops_all %>% filter(!is.na(Height_Sept) & Transect_ID != "Rural"))$Height_Sept)
## From the output, the p-value > 0.05 implying that the distribution of the data are NOT significantly different from normal distribution. We can assume normality.
```


######### Urb_score: NO TRANSFORMATION NEEDED
```{r}
diag_urb_height_2 <- lm(Height_Sept ~ Urb_score * Year * Transect_ID,
                        data = (fertile_pops_all %>% filter(!is.na(Height_Sept) & Transect_ID != "Rural")))

par(mfrow=c(2,2))
plot(diag_urb_height_2)
# looks like fanning (heteroskedasticity) 
## Felipe says it's not a big deal, esp. since dist_city is not normally distributed (b/c of my study design)
bptest(diag_urb_height_2) # there'sNO heteroskedasticity here

summary(diag_urb_height_2)
hist((fertile_pops_all %>% filter(!is.na(Height_Sept) & Transect_ID != "Rural"))$Urb_score)

ggqqplot((fertile_pops_all %>% filter(!is.na(Height_Sept) & Transect_ID != "Rural"))$Height_Sept)
## Data points don't fit in envelope towards right margin.

# Histogram
gg_reshist(diag_urb_height_2, bins=20)
# slightly right-skewed

# Shapiro-Wilk normality test
shapiro.test((fertile_pops_all %>% filter(!is.na(Height_Sept) & Transect_ID != "Rural"))$Height_Sept)
## From the output, the p-value > 0.05 implying that the distribution of the data are NOT significantly different from normal distribution. We can assume normality.
```



######## ANOVA
######### City_dist, not urb_score
```{r}
lm.height.subt.1 <- lm(Height_Sept 	~ Year * City_dist * Transect_ID,
                       data = (fertile_pops_all %>%
                                 filter(!is.na(Height_Sept) & Transect_ID != "Rural")))
lm.height.subt.1_anova <- car::Anova(lm.height.subt.1, REML = F)
# nothing sig

lm.height.subt.2 <- lm(Height_Sept ~ Year + City_dist + Transect_ID + Year:City_dist + Year:Transect_ID + City_dist:Transect_ID,
                       data = (fertile_pops_all %>% 
                                 filter(!is.na(Height_Sept) & Transect_ID != "Rural")))
lm.height.subt.2_anova <- car::Anova(lm.height.subt.2, REML = F)
# Nothing significant, so removing interactions

lm.height.subt.3 <- lm(Height_Sept 	~ Year + City_dist + Transect_ID,
                       data = (fertile_pops_all %>% 
                                 filter(!is.na(Height_Sept) & Transect_ID != "Rural")))
lm.height.subt.3_anova <- car::Anova(lm.height.subt.3, REML = F)
# nothing significant

AIC(lm.height.subt.1, lm.height.subt.2, lm.height.subt.3)
```


######### urb_score, not city_dist
```{r}
u_height_glm_subtr_1 <- lm(Height_Sept 	~ Year * Urb_score * Transect_ID, 
                           data = (fertile_pops_all %>% 
                                     filter(!is.na(Height_Sept) & Transect_ID != "Rural")))
u_height_glm_subtr_1_anova <- car::Anova(u_height_glm_subtr_1, REML = F)
# 3-way interaction not significant, so let's look at lower-level interactions and main effects.

u_height_glm_subtr_2 <-lm(Height_Sept 	~ Year + Urb_score + Transect_ID + Year:Urb_score + Year:Transect_ID + Urb_score:Transect_ID, 
                          data = (fertile_pops_all %>%
                                    filter(!is.na(Height_Sept) & Transect_ID != "Rural"))) 
u_height_glm_subtr_2_anova <- car::Anova(u_height_glm_subtr_2, REML = F)
# Nothing significant, so removing interactions

u_height_glm_subtr_3 <- lm(Height_Sept 	~ Year + Urb_score + Transect_ID, 
                           data = (fertile_pops_all %>% 
                                     filter(!is.na(Height_Sept) & Transect_ID != "Rural")))
u_height_glm_subtr_3_anova <- car::Anova(u_height_glm_subtr_3, REML = F)
# nothing sig

AIC(u_height_glm_subtr_1, u_height_glm_subtr_2, u_height_glm_subtr_3)
```



# Pods per peduncle
###### LM
####### Without transect
######## Diagnostics
######### City_dist: USE SQRT TRANSFORMATION
```{r}
lm(pods_per_ped ~ City_dist * Year , data = fertile_pops_all)

par(mfrow=c(2,2))
plot(lm(pods_per_ped ~ City_dist * Year , data = fertile_pops_all))
summary(lm(pods_per_ped ~ City_dist * Year , data = fertile_pops_all))

qplot(fertile_pops_all$pods_per_ped)

lmtest::bptest(lm(pods_per_ped ~ City_dist * Year , data = fertile_pops_all)) 
# plot is heteroskedastic
## Felipe says it's not a big deal, esp. since dist_city is not normally distributed (b/c of my study design)

gg_reshist(lm((pods_per_ped) ~ City_dist * Year, data = fertile_pops_all), bins=20)
ggqqplot(fertile_pops_all$pods_per_ped)
## Most data points fall within the envelope but some don't. (towards one end)



# try  transformations
gg_reshist(lm((pods_per_ped)^(1/2) ~ City_dist * Year, data = fertile_pops_all), bins=20)
plot(lm((pods_per_ped)^(1/2) ~ City_dist * Year , data = fertile_pops_all))
ggqqplot((fertile_pops_all$pods_per_ped)^(1/2))
shapiro.test((fertile_pops_all$pods_per_ped)^(1/2))
##### GOING WITH THIS ONE. LOOKS GOOD.



# add sqrt(pods) col to df
fertile_pops_all$pods_per_ped_sqrt <- sqrt(fertile_pops_all$pods_per_ped)
```

######### Urb_score: No transformation necessary
```{r}
diag_urb_podperped_1 <- lm(pods_per_ped ~ Urb_score * Year , data = fertile_pops_all)

par(mfrow=c(2,2))
plot(diag_urb_podperped_1)
summary(diag_urb_podperped_1)

qplot(fertile_pops_all$pods_per_ped, bins = 20)

lmtest::bptest(diag_urb_podperped_1)
# Marginally homoskedastic

gg_reshist(diag_urb_podperped_1, bins=20)
ggqqplot(fertile_pops_all$pods_per_ped)
## Most data points fall within the envelope but some don't. (towards one end). Looks very normal except for those 3 potential outliers
# Good enough.


# try squaring trnasformation
gg_reshist(lm(pods_per_ped^(1/2) ~ Urb_score * Year , data = fertile_pops_all), bins=20)
plot(lm(pods_per_ped^(1/2) ~ Urb_score * Year , data = fertile_pops_all))
lmtest::bptest(lm(pods_per_ped^(1/2) ~ Urb_score * Year , data = fertile_pops_all))
# now it's heteroskedastic? doesn't look like it

```


######## ANOVA
######### City_dist, not urb_score
```{r}
lm.podperped.gr.1 <- lm(pods_per_ped_sqrt	~ Year * City_dist, data = fertile_pops_all)
lm.podperped.gr.1_anova <- car::Anova(lm.podperped.gr.1, REML = F)
# Interaction  not significant but city_dist is

lm.podperped.gr.2 <- lm(pods_per_ped_sqrt	~ Year + City_dist, data = fertile_pops_all)
lm.podperped.gr.2_anova <- car::Anova(lm.podperped.gr.2, REML = F)
# city_dist sig

AIC(lm.podperped.gr.1, lm.podperped.gr.2)
```

######### Urb_score
```{r}
u_podperped_glm_gradient_1 <- lm(pods_per_ped 	~ Year * Urb_score, data = fertile_pops_all)
u_podperped_glm_gradient_1_anova <- car::Anova(u_podperped_glm_gradient_1, REML = F)
# Interaction  not significant.

u_podperped_glm_gradient_2 <- lm(pods_per_ped 	~ Year + Urb_score, data = fertile_pops_all)
u_podperped_glm_gradient_2_anova <- car::Anova(u_podperped_glm_gradient_2, REML = F)# Urb_score sig
# urb_score sig

AIC(u_podperped_glm_gradient_1, u_podperped_glm_gradient_2)
```


####### With transect
######## Diagnostics
######### City_dist- USE SQRT TRANSFORMATION
```{r}
lm(pods_per_ped_sqrt ~ City_dist * Year * Transect_ID, data = fertile_pops_all %>% filter(Transect_ID != 'Rural'))

par(mfrow=c(2,2))
plot(lm(pods_per_ped_sqrt ~ City_dist * Year * Transect_ID, data = fertile_pops_all %>% filter(Transect_ID != 'Rural')))

summary(lm(pods_per_ped_sqrt ~ City_dist * Year * Transect_ID, data = fertile_pops_all %>% filter(Transect_ID != 'Rural')))

ggqqplot(fertile_pops_all %>% filter(Transect_ID != 'Rural')$pods_per_ped_sqrt)

# Histogram
gg_reshist(lm(pods_per_ped_sqrt ~ City_dist * Year * Transect_ID, data = fertile_pops_all %>% filter(Transect_ID != 'Rural')) , bins=20)

# I think it looks normal enough.
```


######### Urb_score- No transformation necessary
```{r}

diag_urb_podperped_2 <- lm(pods_per_ped ~ Urb_score * Year * Transect_ID, data = urb_scores_podperped)

par(mfrow=c(2,2))
plot(diag_urb_podperped_2)

ggqqplot(urb_scores_podperped$pods_per_ped)
bptest(diag_urb_podperped_2)
# homoskedastic ?

# Histogram
gg_reshist(diag_urb_podperped_2, bins=20)
shapiro.test((urb_scores_podperped$pods_per_ped))

# Slight right skew but overall looks close to normal

```

######## ANOVA
######### City_dist, not urb_score
```{r}
lm.podperped.subt.1 <- lm(pods_per_ped 	~ Year * City_dist * Transect_ID, data = fertile_pops_all %>% filter(Transect_ID != 'Rural'))
lm.podperped.subt.1_anova <- car::Anova(lm.podperped.subt.1, REML = F)
# nothing sig

lm.podperped.subt.2 <- lm(pods_per_ped 	~ Year + City_dist + Transect_ID + Year:City_dist + Year:Transect_ID + City_dist:Transect_ID, data = fertile_pops_all %>% filter(Transect_ID != 'Rural'))
lm.podperped.subt.2_anova <- car::Anova(lm.podperped.subt.2, REML = F)
# Nothing significant

lm.podperped.subt.3 <- lm(pods_per_ped 	~ Year + City_dist + Transect_ID, data = fertile_pops_all %>% filter(Transect_ID != 'Rural'))
lm.podperped.subt.3_anova <- car::Anova(lm.podperped.subt.3, REML = F)
# Nothing significant

AIC(lm.podperped.subt.1, lm.podperped.subt.2, lm.podperped.subt.3)
```

######### urb_score, not City_dist
```{r}
u_podperped_glm_subtr_1 <- lm(pods_per_ped 	~ Year * Urb_score * Transect_ID, data = urb_scores_podperped)
u_podperped_glm_subtr_1_anova <- car::Anova(u_podperped_glm_subtr_1, REML = F)
# 3-way interaction IS significant but no 2-way interaxns are, or main effects

u_podperped_glm_subtr_2 <- lm(pods_per_ped 	~ Year:Urb_score:Transect_ID + Year + Urb_score + Transect_ID, data = urb_scores_podperped)
u_podperped_glm_subtr_2_anova <- car::Anova(u_podperped_glm_subtr_2, REML = F)
# nothing sig now

AIC(u_podperped_glm_subtr_1, u_podperped_glm_subtr_2)

```


###### plant-level means
The point of this is to test whether the complicated glmer model is better than the simple lmer. Additionally, is the lm better than lmer? The simpler model will make the regression results easier to interpret if, in fact, the simplest model provides the same conclusions/results as the most complicated.
The lm uses population-level means while lmer and glmer use plant-level data.
```{r}
# Make new dfs with hierarchical means
## make new df w/plant-level means
long_plant_means_pods <- fertile_long %>% group_by(Patch_ID, Year, Pop_ID, Plant_Num) %>%
    dplyr::summarise(
      Pods_per_plant=mean(Viable_Pods,na.rm = TRUE),
      City_dist=mean(City_dist),
      Transect_ID=first(Transect_ID),
      Plants_present_2018=mean(Plants_present_2018,na.rm=TRUE),
      nPlants=n()
      )

# try out new glmer
v1 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist * Year, long_plant_means_pods, family = "poisson")
summary(v1)
car::Anova(v1)
# Year marginally sig. Removing interaxn

v1.1 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist + Year, long_plant_means_pods, family = "poisson")
summary(v1.1)
car::Anova(v1.1)
# Year marginally sig. Removing city_dist

v1.2 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + Year, long_plant_means_pods, family = "poisson")
summary(v1.2)
v1.21 <- car::Anova(v1.2)
# Year marginally sig




# try out new glmer- URBAN SUBTRANSECTS
glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist * Transect_ID * Year, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# Won't converge... removing year

### TRYING ALL SECONDARY INTERAXNS SEPARATELY
car::Anova(glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist * Transect_ID, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# Nothing sig

car::Anova(glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist * Year, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# city x year interaxn is highly sig

car::Anova(glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + Transect_ID * Year, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# Transect x year interaxn is sig

## ALL SECONDARY INTERAXNS... NO TERTIARY
car::Anova(glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + Transect_ID:City_dist + Transect_ID:Year + City_dist:Year + Year + Transect_ID + City_dist, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# both interaxns with year are sig, but not city x transect, so removing that


summary(glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + Transect_ID:Year + City_dist:Year + Year + Transect_ID + City_dist, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

v2 <- car::Anova(glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + Transect_ID:Year + City_dist:Year + Year + Transect_ID + City_dist, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# two interaxns still sig. Best model


```


# Plant density (plants per sq m of patch, as observed in 2018)
###### LM
####### Without transect
######## Diagnostics- can't transform data and assume normality. Go with non-parametric tests?
```{r}
# Removing rows with NA and only keeping data from 2018, since I only quantified patch size and plant density in that year.
density_18 <- AvgVars_byPatch[!is.na(AvgVars_byPatch$density_sqm_18),] %>% filter(Year == '2018')

density_lm <- lm(density_sqm_18 ~ City_dist * Year, data = density_18)

par(mfrow=c(2,2))
plot(density_lm)
summary(density_lm)

ggqqplot(density_18$density_sqm_18)
gg_reshist(density_lm, bins=20)
# major right skew

## try transformation.
##################################

## tried square, cube + roots: not strong enough
par(mfrow=c(2,2))
plot(lm(log(density_sqm_18^(1/10) ~ City_dist , data = density_18 )))
ggqqplot(density_18$density_sqm_18^(1/10))
gg_reshist(lm(density_sqm_18^(1/10) ~ City_dist , data = density_18 ), bins=20)

## tried log(x): makes it into a bimodal distribution... looks much better but not enough, I don't think
par(mfrow=c(2,2))
plot(lm(log(density_sqm_18) ~ City_dist , data = density_18 ))
ggqqplot(log(density_18$density_sqm_18))
gg_reshist(lm(log(density_sqm_18) ~ City_dist , data = density_18 ), bins=20)

# tried reciprocal transformation (1/x): still have ~20 data points not fitting
par(mfrow=c(2,2))
plot(lm((1/(density_sqm_18)) ~ City_dist , data = density_18 ))
ggqqplot((1/(density_18$density_sqm_18)))
gg_reshist(lm((1/(density_sqm_18)) ~ City_dist , data = density_18 ), bins=20)

# go with a non-parametric test: Kruskal-Wallace rank sum test
```


######## Kruskal-Wallace rank sum test
```{r}
kruskal.test(density_sqm_18 ~  City_dist , data = density_18)
# Plant density does not significantly change along the gradient.

# same insignificant results if using ANOVA with log-transformed data too.
car::Anova(lm(log(density_sqm_18) ~  City_dist , data = density_18))

```

####### With transects
######## Diagnostics- WHICH TEST TO USE?
```{r}

# First, remove rural points to avoid collinearity.
density_18_urban <- subset(density_18, Transect_ID == "North" | Transect_ID == "South")

urbdensity_lm <- lm(density_sqm_18 ~ City_dist * Transect_ID, data = density_18_urban)

par(mfrow=c(2,2))
plot(urbdensity_lm)

ggqqplot(density_18_urban$density_sqm_18)
## Data points don't fit in envelope towards right margin.

# Histogram
gg_reshist(urbdensity_lm, bins=20)
# very right-skewed

## try transformation.
##################################

## tried square, cube + roots: not strong enough
par(mfrow=c(2,2))
plot(lm(log(density_sqm_18^(1/10) ~ City_dist* Transect_ID, data = density_18_urban )))
ggqqplot(density_18_urban$density_sqm_18^(1/10))
gg_reshist(lm(density_sqm_18^(1/10) ~ City_dist* Transect_ID, data = density_18_urban ), bins=20)

## tried log(x): makes it into a bimodal distribution...
par(mfrow=c(2,2))
plot(lm(log(density_sqm_18) ~ City_dist* Transect_ID , data = density_18_urban ))
ggqqplot(log(density_18_urban$density_sqm_18))
gg_reshist(lm(log(density_sqm_18) ~ City_dist* Transect_ID , data = density_18_urban ), bins=20)

# tried reciprocal transformation (1/x): still have ~20 data points not fitting
par(mfrow=c(2,2))
plot(lm(1/(density_sqm_18) ~ City_dist* Transect_ID , data = density_18_urban ))
ggqqplot(1/(density_18_urban$density_sqm_18))
gg_reshist(lm(1/(density_sqm_18) ~ City_dist* Transect_ID, data = density_18_urban ), bins=20)

# go with a non-parametric test?
```


######### ANOVA
```{r}
# car::Anova(lm(density_sqm_18	~ City_dist * Transect_ID, data = density_18_urban))
# # 3-way interaction not significant, so let's look at lower-level interactions and main effects.
# 


```

# Export ANOVAs
###### xtableList
```{r}
xtable(p.3,
           digits = c(0,3,0,3),
           caption = "$(1|Patch_ID/Plant_Num/Inflor) $ + Citydist - ONLY 2018")

kable(p.3,
      format = "latex", 
      caption = "kableExtra to format spanning columns",
      digits=c(0,3,0,3)) %>%
  kable_styling( full_width=F) %>%
  add_footnote(c("Note, means and medians are often the same with this data."))
```

###### City_dist
####### One csv- lm/glm
```{r}

# Start a sink file with a CSV extension
sink('Figures_Tables/Q1_Q3_ANOVA/lm_glm_ANOVA_citydist.csv')

#### Pollinaria ####
## table 1
cat('Pollinaria- Q1')
cat('\n')
cat('P ~ city_dist * year')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.poll.gr.1))
cat('\n')
write.csv(r.squaredGLMM(lm.poll.gr.1))
cat('\n')
cat('Main Effect')
write.csv(lm.poll.gr.1_anova)
cat('\n')

## table 2
cat('Pollinaria- Q1')
cat('\n')
cat('P ~ city_dist + year')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.poll.gr.2))
cat('\n')
write.csv(r.squaredGLMM(lm.poll.gr.2))
cat('\n')
cat('Main Effect')
write.csv(lm.poll.gr.2_anova)
cat('\n')

## table 3
cat('Pollinaria- Q3')
cat('\n')
cat('P ~ Year + City_dist + Transect_ID + Year:City_dist + Year:Transect_ID + City_dist:Transect_ID')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.poll.subt.2))
cat('\n')
write.csv(r.squaredGLMM(lm.poll.subt.2))
cat('\n')
cat('Main Effect')
write.csv(lm.poll.subt.2_anova)
cat('\n')

## table 4
cat('Pollinaria- Q3')
cat('\n')
cat('P ~  Year + City_dist + Transect_ID + Year:Transect_ID')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.poll.subt.3))
cat('\n')
write.csv(r.squaredGLMM(lm.poll.subt.3))
cat('\n')
cat('Main Effect')
write.csv(lm.poll.subt.3_anova)
cat('\n')

## table 5
cat('Pollinaria- Q3')
cat('\n')
cat('P ~ Year + City_dist + Transect_ID')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.poll.subt.4))
cat('\n')
write.csv(r.squaredGLMM(lm.poll.subt.4))
cat('\n')
cat('Main Effect')
write.csv(lm.poll.subt.4_anova)
cat('\n')
cat('\n')

#### Pods ####
## table 1
cat('Follicles- Q1')
cat('\n')
cat('p ~ Year * City_dist')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.pods.gr.1))
cat('\n')
write.csv(r.squaredGLMM(lm.pods.gr.1))
cat('\n')
cat('Main Effect')
write.csv(lm.pods.gr.1_anova)
cat('\n')

## table 2
cat('Follicles- Q1')
cat('\n')
cat('p ~ Year + City_dist')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.pods.gr.2))
cat('\n')
write.csv(r.squaredGLMM(lm.pods.gr.2))
cat('\n')
cat('Main Effect')
write.csv(lm.pods.gr.2_anova)
cat('\n')

## table 3
cat('Follicles- Q3')
cat('\n')
cat('P ~ Year + City_dist + Transect')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.pods.subt.3))
cat('\n')
write.csv(r.squaredGLMM(lm.pods.subt.3))
cat('\n')
cat('Main Effect')
write.csv(lm.pods.subt.3_anova)
cat('\n')
cat('\n')


#### Peduncles ####
## table 1
cat('Peduncles- Q1')
cat('\n')
cat('p ~ Year * City_dist')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.peds.gr.1))
cat('\n')
write.csv(r.squaredGLMM(lm.peds.gr.1))
cat('\n')
cat('Main Effect')
write.csv(lm.peds.gr.1_anova)
cat('\n')

## table 2
cat('Peduncles- Q3')
cat('\n')
cat('P ~ Year + City_dist + Transect')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.peds.subt.3))
cat('\n')
write.csv(r.squaredGLMM(lm.peds.subt.3))
cat('\n')
cat('Main Effect')
write.csv(lm.peds.subt.3_anova)
cat('\n')
cat('\n')

#### Height ####
## table 1
cat('Height- Q1')
cat('\n')
cat('p ~ Year * City_dist')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.height.gr.1))
cat('\n')
write.csv(r.squaredGLMM(lm.height.gr.1))
cat('\n')
cat('Main Effect')
write.csv(lm.height.gr.1_anova)
cat('\n')

## table 2
cat('Height- Q1')
cat('\n')
cat('p ~ Year + City_dist')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.height.gr.2))
cat('\n')
write.csv(r.squaredGLMM(lm.height.gr.2))
cat('\n')
cat('Main Effect')
write.csv(lm.height.gr.2_anova)
cat('\n')

## table 3
cat('Height- Q3')
cat('\n')
cat('P ~ Year + City_dist + Transect')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.height.subt.3))
cat('\n')
write.csv(r.squaredGLMM(lm.height.subt.3))
cat('\n')
cat('Main Effect')
write.csv(lm.height.subt.3_anova)
cat('\n')
cat('\n')

#### Follicles per Inflorescence ####
## table 1
cat('Follicles per Inflorescence- Q1')
cat('\n')
cat('p ~ Year * City_dist')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.podperped.gr.1))
cat('\n')
write.csv(r.squaredGLMM(lm.podperped.gr.1))
cat('\n')
cat('Main Effect')
write.csv(lm.podperped.gr.1_anova)
cat('\n')

## table 2
cat('Follicles per Inflorescence- Q1')
cat('\n')
cat('p ~ Year + City_dist')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.podperped.gr.2))
cat('\n')
write.csv(r.squaredGLMM(lm.podperped.gr.2))
cat('\n')
cat('Main Effect')
write.csv(lm.podperped.gr.2_anova)
cat('\n')

## table 3
cat('Follicles per Inflorescence- Q3')
cat('\n')
cat('P ~ Year + City_dist + Transect')
cat('\n')
cat('AIC: ')
write.csv(AIC(lm.podperped.subt.3))
cat('\n')
write.csv(r.squaredGLMM(lm.podperped.subt.3))
cat('\n')
cat('Main Effect')
write.csv(lm.podperped.subt.3_anova)
cat('\n')
cat('\n')


##### Close the sink ####
sink()

```

###### Urb_score
####### One csv- lm/glm
```{r}

# Start a sink file with a CSV extension
sink('Figures_Tables/Q1_Q3_ANOVA/lm_glm_ANOVA_urbscore.csv')

#### Pollinaria ####
## table 1
cat('Pollinaria- Q1')
cat('\n')
cat('p ~ (1|Patch_ID/Plant_Num/Inflor) + Urb_score * Year')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_poll_glm_gradient_1))
cat('\n')
write.csv(r.squaredGLMM(u_poll_glm_gradient_1))
cat('\n')
cat('Main Effect')
write.csv(u_poll_glm_gradient_1_anova)
cat('\n')


## table 2
cat('Pollinaria- Q1')
cat('\n')
cat('p ~ (1|Patch_ID/Plant_Num/Inflor) + Urb_score + Year')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_poll_glm_gradient_2))
cat('\n')
write.csv(r.squaredGLMM(u_poll_glm_gradient_2))
cat('\n')
cat('Main Effect')
write.csv(u_poll_glm_gradient_2_anova)
cat('\n')

## table 3
cat('Pollinaria- Q3')
cat('\n')
cat('p ~ (1|Patch_ID/Plant_Num/Inflor) + Year + Urb_score + Transect_ID + Year:Urb_score + Year:Transect_ID + Urb_score:Transect_ID')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_poll_glm_subtr_2))
cat('\n')
write.csv(r.squaredGLMM(u_poll_glm_subtr_2))
cat('\n')
cat('Main Effect')
write.csv(u_poll_glm_subtr_2_anova)
cat('\n')

## table 4
cat('Pollinaria- Q3')
cat('\n')
cat('p ~ (1|Patch_ID/Plant_Num/Inflor) + Year + Urb_score + Transect_ID + Year:Transect_ID')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_poll_glm_subtr_3))
cat('\n')
write.csv(r.squaredGLMM(u_poll_glm_subtr_3))
cat('\n')
cat('Main Effect')
write.csv(u_poll_glm_subtr_3_anova)
cat('\n')
cat('\n')

#### Pods ####
## table 1
cat('Follicles- Q1')
cat('\n')
cat('p ~ (1|Patch_ID) + Urb_score * Year')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_pod_glm_gradient_1))
cat('\n')
write.csv(r.squaredGLMM(u_pod_glm_gradient_1))
cat('\n')
cat('Main Effect')
write.csv(u_pod_glm_gradient_1_anova)
cat('\n')

# Table 2
cat('Follicles- Q1')
cat('\n')
cat('p ~ (1|Patch_ID) + Urb_score + Year')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_pod_glm_gradient_2))
cat('\n')
write.csv(r.squaredGLMM(u_pod_glm_gradient_2))
cat('\n')
cat('Main Effect')
write.csv(u_pod_glm_gradient_2_anova)
cat('\n')

## table 3
cat('Follicles- Q3')
cat('\n')
cat('p ~ (1|Patch_ID) + Urb_score + Year + Transect_ID')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_pod_glm_subtr_3))
cat('\n')
write.csv(r.squaredGLMM(u_pod_glm_subtr_3))
cat('\n')
cat('Main Effect')
write.csv(u_pod_glm_subtr_3_anova)
cat('\n')
cat('\n')

#### Peduncles ####
## table 1
cat('Peduncles- Q1')
cat('\n')
cat('p ~ (1|Patch_ID) + Urb_score * Year')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_ped_glm_gradient_1))
cat('\n')
write.csv(r.squaredGLMM(u_ped_glm_gradient_1))
cat('\n')
cat('Main Effect')
write.csv(u_ped_glm_gradient_1_anova)
cat('\n')

## table 2
cat('Peduncles- Q1')
cat('\n')
cat('p ~ (1|Patch_ID) + Urb_score + Year')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_ped_glm_gradient_2))
cat('\n')
write.csv(r.squaredGLMM(u_ped_glm_gradient_2))
cat('\n')
cat('Main Effect')
write.csv(u_ped_glm_gradient_2_anova)
cat('\n')

## table 3
cat('Peduncles- Q3')
cat('\n')
cat('p ~ (1|Patch_ID) + Urb_score + Year + Transect_ID')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_ped_glm_subtr_3))
cat('\n')
write.csv(r.squaredGLMM(u_ped_glm_subtr_3))
cat('\n')
cat('Main Effect')
write.csv(u_ped_glm_subtr_3_anova)
cat('\n')
cat('\n')

#### Height ####
## table 1
cat('Height- Q1')
cat('\n')
cat('p ~ (1|Patch_ID) + Urb_score * Year')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_height_glm_gradient_1))
cat('\n')
write.csv(r.squaredGLMM(u_height_glm_gradient_1))
cat('\n')
cat('Main Effect')
write.csv(u_height_glm_gradient_1_anova)
cat('\n')

## table 2
cat('Height- Q1')
cat('\n')
cat('p ~ (1|Patch_ID) + Urb_score + Year')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_height_glm_gradient_2))
cat('\n')
write.csv(r.squaredGLMM(u_height_glm_gradient_2))
cat('\n')
cat('Main Effect')
write.csv(u_height_glm_gradient_2_anova)
cat('\n')

## table 3
cat('Height- Q3')
cat('\n')
cat('p ~ (1|Patch_ID) + Urb_score + Year + Transect_ID')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_height_glm_subtr_3))
cat('\n')
write.csv(r.squaredGLMM(u_height_glm_subtr_3))
cat('\n')
cat('Main Effect')
write.csv(u_height_glm_subtr_3_anova)
cat('\n')
cat('\n')


#### Follicles per Inflorescence ####
## table 1
cat('Follicles per Inflorescence- Q1')
cat('\n')
cat('p ~ (1|Patch_ID) + Urb_score * Year')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_podperped_glm_gradient_1))
cat('\n')
write.csv(r.squaredGLMM(u_podperped_glm_gradient_1))
cat('\n')
cat('Main Effect')
write.csv(u_podperped_glm_gradient_1_anova)
cat('\n')

## table 2
cat('Follicles per Inflorescence- Q1')
cat('\n')
cat('p ~ (1|Patch_ID) + Urb_score + Year')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_podperped_glm_gradient_2))
cat('\n')
write.csv(r.squaredGLMM(u_podperped_glm_gradient_2))
cat('\n')
cat('Main Effect')
write.csv(u_podperped_glm_gradient_2_anova)
cat('\n')

## table 3
cat('Follicles per Inflorescence- Q3')
cat('\n')
cat('p ~ (1|Patch_ID) + Urb_score * Year * Transect_ID')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_podperped_glm_subtr_1))
cat('\n')
write.csv(r.squaredGLMM(u_podperped_glm_subtr_1))
cat('\n')
cat('Main Effect')
write.csv(u_podperped_glm_subtr_1_anova)
cat('\n')

## table 4
cat('Follicles per Inflorescence- Q3')
cat('\n')
cat('p ~ (1|Patch_ID) + Urb_score:Year:Transect_ID + Urb_score + Year + Transect_ID')
cat('\n')
cat('AIC: ')
write.csv(AIC(u_podperped_glm_subtr_2))
cat('\n')
write.csv(r.squaredGLMM(u_podperped_glm_subtr_2))
cat('\n')
cat('Main Effect')
write.csv(u_podperped_glm_subtr_2_anova)
cat('\n')
cat('\n')

##### Close the sink ####
sink()

```


####### One csv- lmer/glmer - plant/inflor-level means
```{r}

# Start a sink file with a CSV extension
sink('lmer_glmer_Inflorplantlevelmeans_ANOVA.csv')

#### Pollinaria ####
## table 1
cat('Pollinaria- Inflorescence means- Q1')
cat('\n')
cat('p ~ (1|Patch_ID/Plant_Num) + City_dist + Year')
cat('\n')
cat('Main Effect')
write.csv(z1.1)
cat('\n')

## table 2
cat('Pollinaria- Inflorescence means- Q3')
cat('\n')
cat('p ~ (1|Patch_ID/Plant_Num) + City_dist * Year * Transect_ID')
cat('\n')
cat('Main Effect')
write.csv(z2.1)
cat('\n')

## table 3
cat('Pollinaria- Plant means- Q1')
cat('\n')
cat('p ~ (1|Patch_ID) + City_dist + Year')
cat('\n')
cat('Main Effect')
write.csv(z3.1)
cat('\n')

## table 4
cat('Pollinaria- Plant means- Q3')
cat('Loose p = 0.05 cutoff')
cat('\n')
cat('p ~ Poll_rm_per_plant ~ (1|Patch_ID) + City_dist:Year + Transect_ID:Year + Transect_ID + City_dist + Year')
cat('\n')
cat('Main Effect')
write.csv(z4.22)
cat('\n')

## table 5
cat('Pollinaria- Plant means- Q3')
cat('Strict p = 0.05 cutoff')
cat('\n')
cat('p ~ Poll_rm_per_plant ~ (1|Patch_ID) + Year')
cat('\n')
cat('Main Effect')
write.csv(z4.5)
cat('\n')
cat('\n')

#### Pods ####
## table 1
cat('Follicles- Plant means- Q1')
cat('\n')
cat('p ~ (1|Patch_ID) + Year')
cat('\n')
cat('Main Effect')
write.csv(y1.21)
cat('\n')

## table 2
cat('Follicles- Plant means- Q3')
cat('\n')
cat('p ~ (1|Patch_ID) + City_dist * Year * Transect_ID')
cat('\n')
cat('Main Effect')
write.csv(y2.1)
cat('\n')
cat('\n')


#### Peduncles ####
## table 1
cat('Peduncles- Plant means- Q1')
cat('\n')
cat('p ~ (1|Patch_ID) + City_dist * Year')
cat('\n')
cat('Main Effect')
write.csv(x1.1)
cat('\n')

## table 2
cat('Peduncles- Plant means- Q3')
cat('\n')
cat('p ~ (1|Patch_ID) + City_dist')
cat('\n')
cat('Main Effect')
write.csv(x2.61)
cat('\n')
cat('\n')

#### Height ####
## table 1
cat('Height- Plant means- same as lmer csv- Q1')
cat('\n')
cat('p ~ (1|Patch_ID) + year')
cat('\n')
cat('Main Effect')
write.csv(w1.21)
cat('\n')

## table 2
cat('Height- Plant means- same as lmer csv- Q3')
cat('\n')
cat('p ~ (1|Patch_ID) * City_dist * Year * Transect_ID')
cat('\n')
cat('Main Effect')
write.csv(w2.1)
cat('\n')
cat('\n')

#### Follicles per Inflorescence ####
## table 1
cat('Follicles per Inflorescence- Plant means- Q1')
cat('\n')
cat('p ~ (1|Patch_ID) + Year')
cat('\n')
cat('Main Effect')
write.csv(v1.21)
cat('\n')

## table 2
cat('Follicles per Inflorescence- Plant means- Q3')
cat('\n')
cat('p ~ (1|Patch_ID) + Transect_ID:Year + City_dist:Year + Year + Transect_ID + City_dist')
cat('\n')
cat('Main Effect')
write.csv(v2)
cat('\n')
cat('\n')


##### Close the sink ####
sink()

```

