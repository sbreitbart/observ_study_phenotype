---
title: "LM_and_plantmean_models"
author: "Sophie Breitbart"
date: "April 29, 2021"
output: html_document
---
# Set up notebook
## Install, load packages
```{r message=FALSE, warning=FALSE}
# devtools::install_github("cardiomoon/ggiraphExtra")
# devtools::install_github("dkahle/ggmap")
# devtools::install_github("hadley/devtools")
# install.packages("agricolae")
# install.packages("BH")
# install.packages("car")
# install.packages("cowplot")
# install.packages("digest", type="source")
# install.packages("dplyr")
# install.packages("factoextra")
# install.packages("flextable")
# install.packages("geosphere")
# install.packages("ggiraphExtra")
# install.packages("ggpubr")
# install.packages("ggsn")
# install.packages("ggspatial")
# install.packages("GISTools")
# install.packages("ISLR")
# install.packages("janitor")
# install.packages("lindia")
# install.packages("lme4")
# install.packages("lmerTest")
# install.packages("mnormt")
# install.packages("patchwork")
# install.packages("plogr")
# install.packages("psych")
# install.packages("RcppEigen")
# install.packages("rpart")
# install.packages('sjPlot')
# install.packages('stargazer')
# install.packages("swirl")
# install.packages("tibble")
# install.packages("tidyverse")
# install.packages("vegan")
# install.packages("XLConnect")
# install.packages('backports')
# install.packages(c("slidify", "ggplot2", "devtools"))
# install.packages('maps')
# install.packages('rmarkdown')
# install_github("vqv/ggbiplot")
library("FactoMineR")
library("tibble", lib.loc="~/R/win-library/3.5")
library(agricolae)
library(apaTables)
library(car)
library(data.table)
library(devtools)
library(DHARMa)
library(dplyr)
library(e1071)
library(factoextra)
library(flextable)
library(forcats)
library(geosphere)
library(ggbiplot)
library(ggmap)
library(ggpubr)
library(ggsn)
library(ggspatial)
library(GISTools)
library(glmmTMB)
library(gridExtra)
library(here)
library(Hmisc)
library(hrbrthemes)
library(ISLR)
library(janitor)
library(lindia)
library(lme4)
library(lmerTest)
library(lsmeans)
library(MASS)
library(multcomp)
library(MuMIn)
library(nlme)
library(patchwork)
library(plyr)
library(reshape)
library(reshape2)
library(rpart)
library(sjPlot)
library(stargazer)
library(tibble)
library(tidyr)
library(tidyverse)
library(vegan)
library(viridis)
require(ggiraph)
require(ggiraphExtra)
require(ggplot2)
require(MASS)
require(scales)

```

## Import data
```{r, import}
long_Transect_Data_18_19 <-
  read.csv(here::here("./clean_data/long_Transect_Data_18_19.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)


AvgVars_notNA_Poll_18_19 <-
  read.csv(here::here("./clean_data/AvgVars_notNA_Poll_18_19.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)

fertile_long <-
  read.csv(here::here("./clean_data/fertile_long.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)


fertile <-
  read.csv(here::here("./clean_data/fertile.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)

fertile_pops_all <-
  read.csv(here::here("./clean_data/fertile_pops_all.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)
```
## Make sure classes are correct
```{r}
# long_Transect_Data_18_19-----

str(long_Transect_Data_18_19)

# Make columns numeric
long_Transect_Data_18_19$Inflor <- as.numeric(as.character(long_Transect_Data_18_19$Inflor))
long_Transect_Data_18_19$Pollinia_removed <- as.numeric(as.character(long_Transect_Data_18_19$Pollinia_removed))
long_Transect_Data_18_19$Flower <- as.numeric(as.character(long_Transect_Data_18_19$Flower))

# make patch ID, plant, year, and inflor cols factors
long_Transect_Data_18_19$Patch_ID <- as.factor(as.character(long_Transect_Data_18_19$Patch_ID))
long_Transect_Data_18_19$Plant_Num <- as.factor(as.character(long_Transect_Data_18_19$Plant_Num))
long_Transect_Data_18_19$Inflor <- as.factor(as.character(long_Transect_Data_18_19$Inflor))
long_Transect_Data_18_19$Year <- as.factor(as.character(long_Transect_Data_18_19$Year))

# make pollinia removed an integer
long_Transect_Data_18_19$Pollinia_removed <- as.integer(as.character(long_Transect_Data_18_19$Pollinia_removed))


# AvgVars_notNA_Poll_18_19------

str(AvgVars_notNA_Poll_18_19)

# make cols factors
AvgVars_notNA_Poll_18_19$Patch_ID <- as.factor(as.character(AvgVars_notNA_Poll_18_19$Patch_ID))
AvgVars_notNA_Poll_18_19$Year <- as.factor(as.character(AvgVars_notNA_Poll_18_19$Year))


# fertile_long-----

str(fertile_long)

# Make columns numeric
fertile_long$Inflor <- as.numeric(as.character(fertile_long$Inflor))
fertile_long$Pollinia_removed <- as.numeric(as.character(fertile_long$Pollinia_removed))
fertile_long$Flower <- as.numeric(as.character(fertile_long$Flower))

# make patch ID, plant, year, and inflor cols factors
fertile_long$Patch_ID <- as.factor(as.character(fertile_long$Patch_ID))
fertile_long$Plant_Num <- as.factor(as.character(fertile_long$Plant_Num))
fertile_long$Inflor <- as.factor(as.character(fertile_long$Inflor))
fertile_long$Year <- as.factor(as.character(fertile_long$Year))

str(fertile_long)


# fertile-----

str(fertile)

# make patch ID, plant, year, and inflor cols factors
fertile$Patch_ID <- as.factor(as.character(fertile$Patch_ID))
fertile$Plant_Num <- as.factor(as.character(fertile$Plant_Num))
fertile$Year <- as.factor(as.character(fertile$Year))

str(fertile)


# fertile_pops_all-----

str(fertile_pops_all)

fertile_pops_all$Year <- as.factor(as.character(fertile_pops_all$Year))

str(fertile_pops_all)

```

## Variable key

* Average_Pollinia
: Average number of pollinia removed per flower, per plant, per population (0-5). Was measured in July of 2018 and 2019.

* City_dist
: Population's distance from urban center (Yonge & Dundas in Toronto), in kilometers.

* Transect_ID
: + Northern urban transect,
: + Southern urban transect (which follows green corridors including railroad tracks, trails, hydro lines, etc.), or
: + Rural transect.

    See [link](https://www.google.com/maps/d/u/0/edit?hl=en&mid=1T6o02xqdFY49LpaV5fgpNYcgUNfy6hWJ&ll=43.54856560494681%2C-79.7330821595105&z=10) for a map of the 3 transects.  
  
* Peduncles
: Average number of peduncles per plant per population

* Height_July
: Average height of sampled plants in July (when performing pollinia removal survey), in centimeters

* Plants_present_2018
: Number of plants present at the sampling site in 2018. Populations were spaced at least 500 meters apart to ensure population distinction.

* Height_Sept
: Average height of sampled plants in September (when performing follicle, peduncle survey), in centimeters

* Viable_Pods
: Average number of viable follciles per plant per population. These follicles were usually around 6-10 cm long, compared to aborted follicles, which were usually about 1 cm long and seemed to have stopped growing based on size and color (oftentimes brown/dried up).

* Total_Pods
: Average number of *combined* viable and aborted follciles per plant per population. In 2018, we did not distinguish between aborted and viable follicles, so this variable is used to compare follicle production over both years. Viable follicle production can only be measured for 2019 alone.

* nPlants
: Number of plants sampled per population.

* Average_pod_length
: Average length of all pods measured on surveyed plants in 2019, in centimeters. This data was not collected in 2018. In 2019, it was collected to understand whether there is a relationship between pod dimensions and seed number and/or seed mass. (As of October 2019, it seems there is a surprisingly weak relationship.)

# Peduncles (Inflorescences)
## plant-level means
The point of this is to test whether the complicated glmer model is better than the simple lmer. Additionally, is the lm better than lmer? The simpler model will make the regression results easier to interpret if, in fact, the simplest model provides the same conclusions/results as the most complicated.
The lm uses population-level means while lmer and glmer use plant-level data.
```{r}
# Make new dfs with hierarchical means
## make new df w/plant-level means
long_plant_means_peds <- fertile_long %>%
  group_by(Patch_ID, Year, Pop_ID, Plant_Num) %>%
    dplyr::summarise(
      Peds_per_plant=mean(Peduncles,na.rm = TRUE),
      City_dist=mean(City_dist),
      Transect_ID=first(Transect_ID),
      Plants_present_2018=mean(Plants_present_2018,na.rm=TRUE),
      nPlants=n()
      )

# try out new glmer
x1 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist * Year, 
            long_plant_means_peds,
            family = "poisson")
summary(x1)
x1.1 <- car::Anova(x1)
# City_dist:Year interaxn sig, main effects aren't


# try out new glmer w/transects
x2 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist * Year * Transect_ID, 
            (long_plant_means_peds %>%
               filter(Transect_ID != 'Rural')),
            family = "poisson",
            glmerControl(optimizer="bobyqa",
                         optCtrl = list(maxfun = 100000)))
summary(x2)
car::Anova(x2)
# 3-way interaxn not sig- trying secondary interaxns


# x2.1 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist + Year + Transect_ID + Transect_ID:City_dist + Transect_ID:Year + City_dist:Year, (long_plant_means_peds %>% filter(Transect_ID != 'Rural')), family = "poisson", 
#             glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# summary(x2.1)
# car::Anova(x2.1)
##### NOT CONVERGING. TRYING SEPARATE MAIN EFFECTS

# Remove 2-way interactions one by one to see if any are sig- NONE WERE.
## Removed City_dist:Year
x2.2 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist + Year + Transect_ID + Transect_ID:City_dist + Transect_ID:Year,
              (long_plant_means_peds %>%
                 filter(Transect_ID != 'Rural')),
              family = "poisson", 
            glmerControl(optimizer="bobyqa",
                         optCtrl = list(maxfun = 100000)))
summary(x2.2)
car::Anova(x2.2)
## No 2-way interaxn sig

# Removed Transect_ID:Year
x2.3 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist + Year + Transect_ID + Transect_ID:City_dist + City_dist:Year,
              (long_plant_means_peds %>%
                 filter(Transect_ID != 'Rural')),
              family = "poisson", 
              glmerControl(optimizer="bobyqa",
                           optCtrl = list(maxfun = 100000)))
summary(x2.3)
car::Anova(x2.3)
## No 2-way interaxn sig

# Removed Transect_ID:City_dist
x2.4 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist + Year + Transect_ID + Year:City_dist + Transect_ID:Year,
              (long_plant_means_peds %>%
                 filter(Transect_ID != 'Rural')),
              family = "poisson", 
              glmerControl(optimizer="bobyqa",
                           optCtrl = list(maxfun = 100000)))
summary(x2.4)
car::Anova(x2.4)
## No 2-way interaxn sig


x2.5 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist + Year + Transect_ID,
              (long_plant_means_peds %>%
                 filter(Transect_ID != 'Rural')),
              family = "poisson",
            glmerControl(optimizer="bobyqa",
                         optCtrl = list(maxfun = 100000)))
summary(x2.5)
car::Anova(x2.5)
# City_dist sig


x2.6 <- glmer(as.numeric(Peds_per_plant) ~ (1|Patch_ID) + City_dist,
              (long_plant_means_peds %>%
                 filter(Transect_ID != 'Rural')),
              family = "poisson", 
              glmerControl(optimizer="bobyqa",
                           optCtrl = list(maxfun = 100000)))
summary(x2.6)
x2.61 <- car::Anova(x2.6)
# City_dist sig
```

## LM
### Without transect- USE SQUARING TRANSFORMATION
#### Diagnostics
##### City_dist: USE SQUARING TRANSFORMATION
```{r}

peds_lm_gradient_01 <- lm(Peduncles ~ City_dist * Year, 
                data = fertile_pops_all)

par(mfrow=c(2,2))
plot(peds_lm_gradient_01)
summary(peds_lm_gradient_01)

## Histogram
gg_reshist(peds_lm_gradient_01, bins=20)

qplot(fertile_pops_all$Peduncles, bins = 15)

summary(fertile_pops_all$Peduncles)
sd(fertile_pops_all$Peduncles)

ggqqplot(fertile_pops_all$Peduncles)
## Most data points fall within the envelope but several don't. (towards one end)

# Shapiro-Wilk normality test
shapiro.test(fertile_pops_all$Peduncles)
## From the output, the p-value < 0.05 implying that the distribution of the data are significantly different from normal distribution. We cannot assume the normality.
# looks left-skewed.

qplot((fertile_pops_all$Peduncles)^2, bins = 20)
plot(lm((Peduncles^2) ~ City_dist, data = fertile_pops_all), bins=20)
gg_reshist(lm((Peduncles^2) ~ City_dist, data = fertile_pops_all), bins=20)
ggqqplot((fertile_pops_all$Peduncles)^2)
shapiro.test((fertile_pops_all$Peduncles)^2)

## tried squaring, cubing, log transformations. Squaring looks best.


# add sq(pods) col to df
fertile_pops_all$Peduncles_sq <- (fertile_pops_all$Peduncles)^2



# Reduced model
peds_lm_gradient_02 <- update(peds_lm_gradient_02, . ~ . - City_dist:Year)
```

##### Urb_score: Use Squaring transformation
```{r}

u_peds_lm_gradient_01 <- lm(Peduncles ~ Urb_score * Year, data = fertile_pops_all)

par(mfrow=c(2,2))
plot(u_peds_lm_gradient_01)
summary(u_peds_lm_gradient_01)

## Histogram
gg_reshist(u_peds_lm_gradient_01, bins=20)
hist(fertile_pops_all$Peduncles)


ggqqplot(fertile_pops_all$Peduncles)
## Most data points fall within the envelope but several don't. (towards one end)

bptest(u_peds_lm_gradient_01)
# homoskedastic?

# Shapiro-Wilk normality test
shapiro.test(fertile_pops_all$Peduncles)
## From the output, the p-value < 0.05 implying that the distribution of the data are significantly different from normal distribution. We cannot assume the normality. But the biological background for peduncle production backs this up; that distribution would be expected to not be normal anyway.
# looks left-skewed.

hist(fertile_pops_all$Peduncles^(1/2), breaks = 12)
hist(log(fertile_pops_all$Peduncles + 1), breaks = 12)
hist(fertile_pops_all$Peduncles^(2), breaks = 12)

qplot((fertile_pops_all$Peduncles)^2, bins = 20)
plot(lm((Peduncles^2) ~ Urb_score * Year, data = fertile_pops_all), bins=20)
gg_reshist(lm((Peduncles^2) ~ Urb_score* Year, data = fertile_pops_all), bins=20)
ggqqplot((fertile_pops_all$Peduncles)^2)

## tried squaring, cubing, log transformations. Squaring looks best.

# add sq(pods) col to df
fertile_pops_all$Peduncles_sq <- (fertile_pops_all$Peduncles)^2

# Reduced model:
u_peds_lm_gradient_02 <- update(u_peds_lm_gradient_01, . ~ . - Urb_score:Year)




# ----------------
# try negative binomial
# 
# summary(glm.nb(Peduncles ~ Urb_score * Year, data = fertile_pops_all))
# # didn't help
# 
# 
# 
# # --------------
# # Export residuals, then look at spatial pattern
# fertile_pops_all$residuals <- residuals(lm((Peduncles ~ Urb_score * Year),data = fertile_pops_all))
# 
# # new df with site coordinates and residuals
# sites1 <- dplyr::rename(sites, Patch_ID = Pop_ID)
# fertile_pops_all <- as.data.frame(fertile_pops_all)
# sites_pedresids <- dplyr::full_join(sites1, fertile_pops_all, by = 'Patch_ID')
# 
# 
# # look at mapped out residuals
#  base_map +
#    geom_point(data = sites_pedresids, mapping = aes(x = lon, y = lat, shape=Transect.y, color = residuals), size= 2) +
#   labs(x = 'Longitude', y = 'Latitude') +
#    scale_color_gradient2(low = "blue", 
#                          midpoint = 0,
#                           mid = "white",
#                           high = "red",
#                           space="Lab")

```

#### ANOVA
##### City_dist, not urb_score
```{r}
peds_lm_gradient_list <- list(peds_lm_gradient_01,
                                 peds_lm_gradient_02)


formulas_peds <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_peds$Model <- NA
formulas_peds$Formula <- NA
formulas_peds$r.squaredGLMM_R2m <- NA
formulas_peds$r.squaredGLMM_R2c <- NA

for (i in 1:length(peds_lm_gradient_list)) {
  formulas_peds[i, 1] <- toString(i)
  formulas_peds[i, 2] <- toString(formula(peds_lm_gradient_list[[i]]))
  formulas_peds[i, 3] <- r.squaredGLMM(peds_lm_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_peds[i, 4] <- r.squaredGLMM(peds_lm_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_peds <- do.call(rbind,
                       lapply(peds_lm_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_peds <- bind_cols(formulas_peds,
                        glance_peds %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC

# check residuals
plot((peds_lm_gradient_01)) # looks good


summary(peds_lm_gradient_01)
peds_lm_gradient_01_anova <- car::Anova(peds_lm_gradient_01) %T>%
  print() # interaxn sig

```

##### urb_score, not city_dist
```{r}
u_peds_lm_gradient_list <- list(u_peds_lm_gradient_01,
                                 u_peds_lm_gradient_02)

formulas_u_peds <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_peds$Model <- NA
formulas_u_peds$Formula <- NA
formulas_u_peds$r.squaredGLMM_R2m <- NA
formulas_u_peds$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_peds_lm_gradient_list)) {
  formulas_u_peds[i, 1] <- toString(i)
  formulas_u_peds[i, 2] <- toString(formula(u_peds_lm_gradient_list[[i]]))
  formulas_u_peds[i, 3] <- r.squaredGLMM(u_peds_lm_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_peds[i, 4] <- r.squaredGLMM(u_peds_lm_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_peds <- do.call(rbind,
                       lapply(u_peds_lm_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_peds <- bind_cols(formulas_u_peds,
                        glance_u_peds %>%
                          dplyr::select(AIC, BestModels)) # Models 1, 2 lowest AIC (1 is best)

# check residuals
plot((u_peds_lm_gradient_01)) # looks good


summary(u_peds_lm_gradient_01)
u_peds_lm_gradient_01_anova <- car::Anova(u_peds_lm_gradient_01) %T>%
  print() # interaxn marg sig

```

### With transect- USE SQUARING TRANSFORMATION
#### Diagnostics
##### City_dist: USE SQUARING TRANSFORMATION
```{r}

peds_lm_subtr_01 <- lm(Peduncles ~ City_dist * Year * Transect_ID,
                 data = fertile_pops_all %>%
                   filter(Transect_ID != "Rural"))

par(mfrow=c(2,2))
plot(peds_lm_subtr_01)
summary(peds_lm_subtr_01)

## Histogram
gg_reshist(peds_lm_subtr_01, bins=20) # slightly left-tailed

# Try squaring
par(mfrow=c(2,2))
plot(update(peds_lm_subtr_01, Peduncles^2 ~ .)) # much better! Going with this



# Full model
peds_lm_subtr_01 <- update(peds_lm_subtr_01, Peduncles^2 ~ .)

# # add squared peduncles col to df
# fertile_pops_all$Peduncles_sq <- (fertile_pops_all$Peduncles)^2

# all main effects and secondary interactions
peds_lm_subtr_02 <- update(peds_lm_subtr_01,
                              . ~ . -City_dist:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
peds_lm_subtr_03 <- update(peds_lm_subtr_02,
                              . ~ . -City_dist:Transect_ID)
peds_lm_subtr_04 <- update(peds_lm_subtr_02,
                              . ~ . -City_dist:Year)
peds_lm_subtr_05 <- update(peds_lm_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
peds_lm_subtr_06 <- update(peds_lm_subtr_03,
                              . ~ . -City_dist:Year)
peds_lm_subtr_07 <- update(peds_lm_subtr_04,
                              . ~ . -Year:Transect_ID)
peds_lm_subtr_08 <- update(peds_lm_subtr_05,
                              . ~ . -City_dist:Transect_ID)

# all main effects
peds_lm_subtr_09 <- update(peds_lm_subtr_08,
                              . ~ . -City_dist:Year)


```


##### Urb_score: USE SQUARING TRANSFORMATION
```{r}
u_peds_lm_subtr_01 <- lm(Peduncles ~ Urb_score * Year * Transect_ID,
                 data = fertile_pops_all %>%
                   filter(Transect_ID != "Rural"))

par(mfrow=c(2,2))
plot(u_peds_lm_subtr_01)
summary(u_peds_lm_subtr_01)

## Histogram
gg_reshist(u_peds_lm_subtr_01, bins=20) # slightly left-tailed

# Try squaring
par(mfrow=c(2,2))
plot(update(u_peds_lm_subtr_01, Peduncles^2 ~ .)) # much better! Going with this
gg_reshist(update(u_peds_lm_subtr_01, Peduncles^2 ~ .), bins = 15) 

# Full model
u_peds_lm_subtr_01 <- update(u_peds_lm_subtr_01, Peduncles^2 ~ .)

# # add squared peduncles col to df
# fertile_pops_all$Peduncles_sq <- (fertile_pops_all$Peduncles)^2

# all main effects and secondary interactions
u_peds_lm_subtr_02 <- update(u_peds_lm_subtr_01,
                              . ~ . -Urb_score:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
u_peds_lm_subtr_03 <- update(u_peds_lm_subtr_02,
                              . ~ . -Urb_score:Transect_ID)
u_peds_lm_subtr_04 <- update(u_peds_lm_subtr_02,
                              . ~ . -Urb_score:Year)
u_peds_lm_subtr_05 <- update(u_peds_lm_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_peds_lm_subtr_06 <- update(u_peds_lm_subtr_03,
                              . ~ . -Urb_score:Year)
u_peds_lm_subtr_07 <- update(u_peds_lm_subtr_04,
                              . ~ . -Year:Transect_ID)
u_peds_lm_subtr_08 <- update(u_peds_lm_subtr_05,
                              . ~ . -Urb_score:Transect_ID)

# all main effects
u_peds_lm_subtr_09 <- update(u_peds_lm_subtr_08,
                              . ~ . -Urb_score:Year)

```

#### ANOVA
##### City_dist, not urb_score
```{r}
peds_lm_subtr_list <- list(peds_lm_subtr_01,
                             peds_lm_subtr_02,
                             peds_lm_subtr_03,
                             peds_lm_subtr_04,
                             peds_lm_subtr_05,
                             peds_lm_subtr_06,
                             peds_lm_subtr_07,
                             peds_lm_subtr_08)


formulas_peds <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_peds$Model <- NA
formulas_peds$Formula <- NA
formulas_peds$r.squaredGLMM_R2m <- NA
formulas_peds$r.squaredGLMM_R2c <- NA

for (i in 1:length(peds_lm_subtr_list)) {
  formulas_peds[i, 1] <- toString(i)
  formulas_peds[i, 2] <- toString(formula(peds_lm_subtr_list[[i]]))
  formulas_peds[i, 3] <- r.squaredGLMM(peds_lm_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_peds[i, 4] <- r.squaredGLMM(peds_lm_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_peds <- do.call(rbind,
                       lapply(peds_lm_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_peds <- bind_cols(formulas_peds,
                        glance_peds %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 3,4,6,7,8 lowest AIC (6 is best)

# check residuals
plot((peds_lm_subtr_06)) # looks good


summary(peds_lm_subtr_06)
peds_lm_subtr_06_anova <- car::Anova(peds_lm_subtr_06) %T>%
  print() # City_dist sig, transect marg sig

```

##### Urb_score, not city_dist
```{r}
u_peds_lm_subtr_list <- list(u_peds_lm_subtr_01,
                             u_peds_lm_subtr_02,
                             u_peds_lm_subtr_03,
                             u_peds_lm_subtr_04,
                             u_peds_lm_subtr_05,
                             u_peds_lm_subtr_06,
                             u_peds_lm_subtr_07,
                             u_peds_lm_subtr_08)


formulas_peds <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_peds$Model <- NA
formulas_peds$Formula <- NA
formulas_peds$r.squaredGLMM_R2m <- NA
formulas_peds$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_peds_lm_subtr_list)) {
  formulas_peds[i, 1] <- toString(i)
  formulas_peds[i, 2] <- toString(formula(u_peds_lm_subtr_list[[i]]))
  formulas_peds[i, 3] <- r.squaredGLMM(u_peds_lm_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_peds[i, 4] <- r.squaredGLMM(u_peds_lm_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_peds <- do.call(rbind,
                       lapply(u_peds_lm_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_peds <- bind_cols(formulas_peds,
                        glance_peds %>%
                          dplyr::select(AIC, BestModels)) %T>%
  print() # Models 3,4,6,7,8 lowest AIC (6 is best)

# check residuals
plot(u_peds_lm_subtr_06) # looks good


summary(u_peds_lm_subtr_06)
u_peds_lm_subtr_06_anova <- car::Anova(u_peds_lm_subtr_06) %T>%
  print() # transect marg sig
```

# Pollinia
## LM- no transformations needed
### Without transect- NO TRANSFORMATION NEEDED
#### Diagnostics
##### City_dist: NO TRANSFORMATION NEEDED
```{r}
poll_lm_gradient_01 <- lm(Average_Pollinia ~ City_dist * Year,
                 data = AvgVars_notNA_Poll_18_19)

par(mfrow=c(2,2))
plot(poll_lm_gradient_01)
summary(poll_lm_gradient_01)

ggqqplot(AvgVars_notNA_Poll_18_19$Average_Pollinia)
## Almost all data points fall within the envelope but some don't.

# Histogram
gg_reshist(poll_lm_gradient_01, bins=20) # DATA LOOKS NORMAL ENOUGH.

# Reduced model:
poll_lm_gradient_02 <- update(poll_lm_gradient_01, . ~ . -City_dist:Year)

```

##### Urb_score: NO TRANSFORMATION NEEDED
```{r}
# POLLINIA
u_poll_lm_gradient_01 <- lm(Average_Pollinia ~ Urb_score * Year,
                      data = AvgVars_notNA_Poll_18_19)

par(mfrow=c(2,2))
plot(u_poll_lm_gradient_01)
summary(u_poll_lm_gradient_01)

# Histogram
gg_reshist(u_poll_lm_gradient_01, bins=20) # looks good!

# Reduced model:
u_poll_lm_gradient_02 <- update(u_poll_lm_gradient_01, . ~ . -Urb_score:Year)

```


#### ANOVA
##### City_dist, not urb_score
```{r}
poll_lm_gradient_list <- list(poll_lm_gradient_01,
                                 poll_lm_gradient_02)


formulas_poll <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_poll$Model <- NA
formulas_poll$Formula <- NA
formulas_poll$r.squaredGLMM_R2m <- NA
formulas_poll$r.squaredGLMM_R2c <- NA

for (i in 1:length(poll_lm_gradient_list)) {
  formulas_poll[i, 1] <- toString(i)
  formulas_poll[i, 2] <- toString(formula(poll_lm_gradient_list[[i]]))
  formulas_poll[i, 3] <- r.squaredGLMM(poll_lm_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_poll[i, 4] <- r.squaredGLMM(poll_lm_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_poll <- do.call(rbind,
                       lapply(poll_lm_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_poll <- bind_cols(formulas_poll,
                        glance_poll %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 1, 2 lowest AIC (2 is best)

# check residuals
plot(poll_lm_gradient_02) # looks good


summary(poll_lm_gradient_02)
poll_lm_gradient_02_anova <- car::Anova(poll_lm_gradient_02) %T>%
  print() # city_dist, year sig

```


##### urb_score
```{r}
u_poll_lm_gradient_list <- list(u_poll_lm_gradient_01,
                                 u_poll_lm_gradient_02)


formulas_u_poll <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_poll$Model <- NA
formulas_u_poll$Formula <- NA
formulas_u_poll$r.squaredGLMM_R2m <- NA
formulas_u_poll$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_poll_lm_gradient_list)) {
  formulas_u_poll[i, 1] <- toString(i)
  formulas_u_poll[i, 2] <- toString(formula(u_poll_lm_gradient_list[[i]]))
  formulas_u_poll[i, 3] <- r.squaredGLMM(u_poll_lm_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_poll[i, 4] <- r.squaredGLMM(u_poll_lm_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_poll <- do.call(rbind,
                       lapply(u_poll_lm_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_poll <- bind_cols(formulas_u_poll,
                        glance_u_poll %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 1, 2 lowest AIC (2 is best)

# check residuals
plot(u_poll_lm_gradient_02) # looks good


summary(u_poll_lm_gradient_02)
u_poll_lm_gradient_02_anova <- car::Anova(u_poll_lm_gradient_02) %T>%
  print() # urb_score, year sig

```

### With transect- NO TRANSFORMATION NEEDED
#### Diagnostics
##### City_dist: NO TRANSFORMATION NEEDED
```{r}

poll_lm_subtr_01 <- lm(Average_Pollinia ~ City_dist * Year * Transect_ID, 
                 data = AvgVars_notNA_Poll_18_19 %>%
                   filter(Transect_ID != "Rural"))

par(mfrow=c(2,2))
plot(poll_lm_subtr_01)
summary(poll_lm_subtr_01)


# Histogram
gg_reshist(poll_lm_subtr_01, bins=20)  #looks normal!


# all main effects and secondary interactions
poll_lm_subtr_02 <- update(poll_lm_subtr_01,
                              . ~ . -City_dist:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
poll_lm_subtr_03 <- update(poll_lm_subtr_02,
                              . ~ . -City_dist:Transect_ID)
poll_lm_subtr_04 <- update(poll_lm_subtr_02,
                              . ~ . -City_dist:Year)
poll_lm_subtr_05 <- update(poll_lm_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
poll_lm_subtr_06 <- update(poll_lm_subtr_03,
                              . ~ . -City_dist:Year)
poll_lm_subtr_07 <- update(poll_lm_subtr_04,
                              . ~ . -Year:Transect_ID)
poll_lm_subtr_08 <- update(poll_lm_subtr_05,
                              . ~ . -City_dist:Transect_ID)

# all main effects
poll_lm_subtr_09 <- update(poll_lm_subtr_08,
                              . ~ . -City_dist:Year)

```

##### Urb_score: NO TRANSFORMATION NEEDED
```{r}

u_poll_lm_subtr_01 <- lm(Average_Pollinia ~ Urb_score * Year * Transect_ID,
                      data = AvgVars_notNA_Poll_18_19 %>%
                        filter(Transect_ID != "Rural"))

par(mfrow=c(2,2))
plot(u_poll_lm_subtr_01)
summary(u_poll_lm_subtr_01)

# Histogram
gg_reshist(u_poll_lm_subtr_01, bins=20) #looks normal!



# all main effects and secondary interactions
u_poll_lm_subtr_02 <- update(u_poll_lm_subtr_01,
                              . ~ . -Urb_score:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
u_poll_lm_subtr_03 <- update(u_poll_lm_subtr_02,
                              . ~ . -Urb_score:Transect_ID)
u_poll_lm_subtr_04 <- update(u_poll_lm_subtr_02,
                              . ~ . -Urb_score:Year)
u_poll_lm_subtr_05 <- update(u_poll_lm_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_poll_lm_subtr_06 <- update(u_poll_lm_subtr_03,
                              . ~ . -Urb_score:Year)
u_poll_lm_subtr_07 <- update(u_poll_lm_subtr_04,
                              . ~ . -Year:Transect_ID)
u_poll_lm_subtr_08 <- update(u_poll_lm_subtr_05,
                              . ~ . -Urb_score:Transect_ID)

# all main effects
u_poll_lm_subtr_09 <- update(u_poll_lm_subtr_08,
                              . ~ . -Urb_score:Year)
```


#### ANOVA
##### City_dist, not urb_index
```{r}
poll_lm_subtr_list <- list(poll_lm_subtr_01,
                             poll_lm_subtr_02,
                             poll_lm_subtr_03,
                             poll_lm_subtr_04,
                             poll_lm_subtr_05,
                             poll_lm_subtr_06,
                             poll_lm_subtr_07,
                             poll_lm_subtr_08)


formulas_poll <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_poll$Model <- NA
formulas_poll$Formula <- NA
formulas_poll$r.squaredGLMM_R2m <- NA
formulas_poll$r.squaredGLMM_R2c <- NA

for (i in 1:length(poll_lm_subtr_list)) {
  formulas_poll[i, 1] <- toString(i)
  formulas_poll[i, 2] <- toString(formula(poll_lm_subtr_list[[i]]))
  formulas_poll[i, 3] <- r.squaredGLMM(poll_lm_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_poll[i, 4] <- r.squaredGLMM(poll_lm_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_poll <- do.call(rbind,
                       lapply(poll_lm_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_poll <- bind_cols(formulas_poll,
                        glance_poll %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 2,3,4,6,8 lowest AIC (6 is best)

# check residuals
plot((poll_lm_subtr_06)) # looks good


summary(poll_lm_subtr_06)
poll_lm_subtr_06_anova <- car::Anova(poll_lm_subtr_06) %T>%
  print() # year sig, transect  sig, interaxn marg sig

```


##### Urb_score, not city_dist
```{r}
u_poll_lm_subtr_list <- list(u_poll_lm_subtr_01,
                             u_poll_lm_subtr_02,
                             u_poll_lm_subtr_03,
                             u_poll_lm_subtr_04,
                             u_poll_lm_subtr_05,
                             u_poll_lm_subtr_06,
                             u_poll_lm_subtr_07,
                             u_poll_lm_subtr_08)


formulas_u_poll <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_poll$Model <- NA
formulas_u_poll$Formula <- NA
formulas_u_poll$r.squaredGLMM_R2m <- NA
formulas_u_poll$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_poll_lm_subtr_list)) {
  formulas_u_poll[i, 1] <- toString(i)
  formulas_u_poll[i, 2] <- toString(formula(u_poll_lm_subtr_list[[i]]))
  formulas_u_poll[i, 3] <- r.squaredGLMM(u_poll_lm_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_poll[i, 4] <- r.squaredGLMM(u_poll_lm_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_poll <- do.call(rbind,
                       lapply(u_poll_lm_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_poll <- bind_cols(formulas_u_poll,
                        glance_u_poll %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 3,4,6 lowest AIC (6 is best)

# check residuals
plot((u_poll_lm_subtr_06)) # looks good


summary(u_poll_lm_subtr_06)
u_poll_lm_subtr_06_anova <- car::Anova(u_poll_lm_subtr_06) %T>%
  print() # year sig, transect & interaxn marg sig

```


## inflor/plant-level means
The point of this is to test whether the complicated glmer model is better than the simple lmer. Additionally, is the lm better than lmer? The simpler model will make the regression results easier to interpret if, in fact, the simplest model provides the same conclusions/results as the most complicated.
The lm uses population-level means while lmer and glmer use flower-level, nested data.
```{r}
# Make new dfs with hierarchical means
## make new df w/inflor-level means
long_inflor_means <- long_Transect_Data_18_19 %>%
  group_by(Patch_ID, Year, Pop_ID, Plant_Num, Inflor) %>%
    dplyr::summarise(
      Poll_rm_per_inflor=mean(Pollinia_removed,na.rm = TRUE),
      City_dist=mean(City_dist),
      Transect_ID=first(Transect_ID),
      Plants_present_2018=mean(Plants_present_2018,na.rm=TRUE),
      nPlants=n()
      )

## make new df w/plant-level means
long_plant_means <- long_inflor_means %>%
  group_by(Patch_ID, Year, Pop_ID, Plant_Num) %>%
    dplyr::summarise(
      Poll_rm_per_plant=mean(Poll_rm_per_inflor,na.rm = TRUE),
      City_dist=mean(City_dist),
      Transect_ID=first(Transect_ID),
      Plants_present_2018=mean(Plants_present_2018,na.rm=TRUE),
      nPlants=n()
      )

# xxxxx <- long_Transect_Data_18_19 %>%
#   group_by(Patch_ID, Year, Pop_ID, Plant_Num, Inflor) %>%
#   dplyr::summarise(
#       flowers_surveyed=n_distinct(Pollinia_removed,na.rm = TRUE))
# 
# xxxxx <- xxxxx %>% group_by(Patch_ID, Year, Pop_ID) %>%
#     dplyr::summarise(
#       flowers_surveyed=sum(flowers_surveyed,na.rm = TRUE))

test <- long_Transect_Data_18_19 %>%
  group_by(Patch_ID, Year, Pop_ID, Plant_Num, Inflor) %>%
  dplyr::summarise(
      flowers_surveyed=n_distinct(Pollinia_removed,na.rm = TRUE)) %>%
  group_by(Patch_ID, Year, Pop_ID) %>%
    dplyr::summarise(
      flowers_surveyed=sum(flowers_surveyed,na.rm = TRUE))

hist(test$flowers_surveyed, breaks = 15)

# try out new lmers
###### INFLORESCENCE MEANS ########
######### GRADIENT
z1 <- lmer(Poll_rm_per_inflor ~ (1|Patch_ID/Plant_Num) * City_dist * Year,
           long_inflor_means,
           REML = F)
summary(z1)
car::Anova(z1)
# interxn not sig but main effects are
z1.1 <- car::Anova(lmer(Poll_rm_per_inflor ~ (1|Patch_ID/Plant_Num) + City_dist + Year,
                        long_inflor_means,
                        REML = F))
# Year and city_dist sig-
# **SAME "STORY" as anova w/pop means for lm**

###### INFLORESCENCE MEANS ########
######### urban transects
z2 <- lmer(Poll_rm_per_inflor ~ (1|Patch_ID/Plant_Num) + City_dist * Year * Transect_ID,
           (long_inflor_means %>%
              filter(Transect_ID != 'Rural')),
           REML = F)
summary(z2)
z2.1 <- car::Anova(z2)
# **SAME "STORY" as anova w/pop means for lmer in that same vars are sig, but slightly less so than anova w/pop means; 3-way interaxn marginally sig whereas other was < 0.05**


###### PLANT MEANS ########
######### GRADIENT
z3 <- lmer(Poll_rm_per_plant ~ (1|Patch_ID) + City_dist * Year,
           long_plant_means,
           REML = F)
summary(z3)
car::Anova(z3)
# interxn not sig but main effects are

z3.1 <- car::Anova(lmer(Poll_rm_per_plant ~ (1|Patch_ID) + City_dist + Year,
                        long_plant_means,
                        REML = F))
# SAME "STORY" as anova w/pop means 


###### PLANT MEANS ########
######### urban transects
z4 <- lmer(Poll_rm_per_plant ~ (1|Patch_ID) + City_dist * Year * Transect_ID,
           (long_plant_means %>%
              filter(Transect_ID != 'Rural')),
           REML = F)
summary(z4 )
car::Anova(z4 )
# 3-way interaxn not sig, so removing

z4.1 <- lmer(Poll_rm_per_plant ~ (1|Patch_ID) + City_dist:Year + City_dist:Transect_ID + Transect_ID:Year + Transect_ID + City_dist + Year,
             (long_plant_means %>% filter
              (Transect_ID != 'Rural')),
             REML = F)
summary(z4.1)
car::Anova(z4.1)

z4.2 <- lmer(Poll_rm_per_plant ~ (1|Patch_ID) + City_dist:Year + Transect_ID:Year + Transect_ID + City_dist + Year, 
             (long_plant_means %>%
                filter(Transect_ID != 'Rural')),
             REML = F)
summary(z4.2)
z4.22 <- car::Anova(z4.2)
## Year:Transect+ID and City_dist:Year both marginally sig, so this is the best model unless want to make p = 0.05 strict cutoff

# Making p = 0.05 the strict cutoff...
z4.3 <- lmer(Poll_rm_per_plant ~ (1|Patch_ID) + Transect_ID + City_dist + Year,
             (long_plant_means %>%
                filter(Transect_ID != 'Rural')),
             REML = F)
summary(z4.3)
car::Anova(z4.3)
## Only Year is significant

z4.4 <- lmer(Poll_rm_per_plant ~ (1|Patch_ID)+ Year,
             (long_plant_means %>% filter(Transect_ID != 'Rural')), REML = F)
summary(z4.4)
z4.5 <- car::Anova(z4.4)
# Year is significant

# THIS 'STORY' DIFFERS FROM ANOVA W/POP MEANS.
```

# Pods
## plant-level means
The point of this is to test whether the complicated glmer model is better than the simple lmer. Additionally, is the lm better than lmer? The simpler model will make the regression results easier to interpret if, in fact, the simplest model provides the same conclusions/results as the most complicated.
The lm uses population-level means while lmer and glmer use plant-level data.
```{r}
# Make new dfs with hierarchical means
## make new df w/plant-level means
### this is the same as Transect_Data_18_19!
long_plant_means_pods <- fertile_long %>%
  group_by(Patch_ID, Year, Pop_ID, Plant_Num) %>%
    dplyr::summarise(
      Pods_per_plant=mean(Viable_Pods,na.rm = TRUE),
      City_dist=mean(City_dist),
      Transect_ID=first(Transect_ID),
      Plants_present_2018=mean(Plants_present_2018,na.rm=TRUE),
      nPlants=n()
      )

# try out new glmer
## GRADIENT
y1 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist * Year,
            long_plant_means_pods,
            family = "poisson")
summary(y1)
car::Anova(y1)
# Year marg sig but interaxn isn't, so removing that

y1.1 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist + Year,
              long_plant_means_pods,
              family = "poisson")
summary(y1.1)
car::Anova(y1.1)
# Year marg sig. Removing city_dist

y1.2 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + Year,
              long_plant_means_pods,
              family = "poisson")
summary(y1.2)
y1.21 <- car::Anova(y1.2)
# Year marg sig


## URBAN SUBTRANSECTS
y2 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist * Year * Transect_ID,
            (long_plant_means_pods %>% filter(Transect_ID != 'Rural')),
            family = "poisson",
            glmerControl(optimizer="bobyqa",
                         optCtrl = list(maxfun = 100000)))
summary(y2)
y2.1 <- car::Anova(y2)
# 3-way interaxn is significant here


```

## LM
### Without transect -USE SQRT TRANSFORMATION
#### Diagnostics
##### City_dist: USE SQRT TRANSFORMATION
```{r}

pods_lm_gradient_01 <- lm(Viable_Pods ~ City_dist * Year ,
                data = fertile_pops_all)

par(mfrow=c(2,2))
plot(pods_lm_gradient_01)
summary(pods_lm_gradient_01)

qplot(fertile_pops_all$Viable_Pods)
#looks like 15 may be an outlier that could be removed

summary(fertile_pops_all$Viable_Pods)
sd(fertile_pops_all$Viable_Pods)
# so, planst with 12 and 15 pods are (12-3.89)/2.6 = 3.11 and (15-3.89)/2.6 = 4.27 standard deviations from the mean, respectively

gg_reshist(pods_lm_gradient_01, bins=20)
ggqqplot(fertile_pops_all$Viable_Pods)
## Most data points fall within the envelope but some don't. (towards one end)



# try  transformations
gg_reshist(update(pods_lm_gradient_01, Viable_Pods^(1/2) ~ .), bins=20)
plot(update(pods_lm_gradient_01, Viable_Pods^(1/2) ~ .)) # better
ggqqplot((fertile_pops_all$Viable_Pods)^(1/2))
shapiro.test((fertile_pops_all$Viable_Pods)^(1/2))
##### GOING WITH THIS ONE. LOOKS good enough

pods_lm_gradient_01 <- update(pods_lm_gradient_01, Viable_Pods^(1/2) ~ .)
pods_lm_gradient_02 <- update(pods_lm_gradient_01, . ~ . - City_dist:Year)

# add sqrt(pods) col to df
fertile_pops_all$Viable_Pods_sqrt <- sqrt(fertile_pops_all$Viable_Pods)
```

##### Urb_score: USE SQRT TRANSFORMATION
```{r}

u_pods_lm_gradient_01 <- lm(Viable_Pods ~ Urb_score * Year ,
                      data = fertile_pops_all)

par(mfrow=c(2,2))
plot(u_pods_lm_gradient_01)
summary(u_pods_lm_gradient_01)

gg_reshist(u_pods_lm_gradient_01, bins=20)
#looks like 98 & 76 may be outliers



# try  transformations
gg_reshist(update(u_pods_lm_gradient_01, Viable_Pods^(1/2) ~ .), bins=20)
plot(update(u_pods_lm_gradient_01, Viable_Pods^(1/2) ~ .))
ggqqplot((fertile_pops_all$Viable_Pods)^(1/2))
shapiro.test((fertile_pops_all$Viable_Pods)^(1/2))
##### GOING WITH THIS ONE. good enough

u_pods_lm_gradient_01 <- update(u_pods_lm_gradient_01, Viable_Pods^(1/2) ~ .)
u_pods_lm_gradient_02 <- update(u_pods_lm_gradient_01, . ~ . - Urb_score:Year)


# add sqrt(pods) col to df- already did for chunk above
# fertile_pops_all$Viable_Pods_sqrt <- sqrt(fertile_pops_all$Viable_Pods)
```


#### ANOVA
##### City_dist, not urb_score
```{r}
pods_lm_gradient_list <- list(pods_lm_gradient_01,
                                 pods_lm_gradient_02)


formulas_pods <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_pods$Model <- NA
formulas_pods$Formula <- NA
formulas_pods$r.squaredGLMM_R2m <- NA
formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(pods_lm_gradient_list)) {
  formulas_pods[i, 1] <- toString(i)
  formulas_pods[i, 2] <- toString(formula(pods_lm_gradient_list[[i]]))
  formulas_pods[i, 3] <- r.squaredGLMM(pods_lm_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_pods[i, 4] <- r.squaredGLMM(pods_lm_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_pods <- do.call(rbind,
                       lapply(pods_lm_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_pods <- bind_cols(formulas_pods,
                        glance_pods %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 1, 2 lowest AIC (1 is best though)

# check residuals
plot(pods_lm_gradient_01) # looks good


summary(pods_lm_gradient_01)
pods_lm_gradient_01_anova <- car::Anova(pods_lm_gradient_01) %T>%
  print() # nothing sig

```

##### urb_score
```{r}
u_pods_lm_gradient_list <- list(u_pods_lm_gradient_01,
                                 u_pods_lm_gradient_02)


formulas_u_pods <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_pods$Model <- NA
formulas_u_pods$Formula <- NA
formulas_u_pods$r.squaredGLMM_R2m <- NA
formulas_u_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_pods_lm_gradient_list)) {
  formulas_u_pods[i, 1] <- toString(i)
  formulas_u_pods[i, 2] <- toString(formula(u_pods_lm_gradient_list[[i]]))
  formulas_u_pods[i, 3] <- r.squaredGLMM(u_pods_lm_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_pods[i, 4] <- r.squaredGLMM(u_pods_lm_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_pods <- do.call(rbind,
                       lapply(u_pods_lm_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_pods <- bind_cols(formulas_u_pods,
                        glance_u_pods %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 1, 2 lowest AIC (2 is best though)

# check residuals
plot(u_pods_lm_gradient_02) # looks good


summary(u_pods_lm_gradient_02)
u_pods_lm_gradient_02_anova <- car::Anova(u_pods_lm_gradient_02) %T>%
  print() # nothing sig

```


### With transect- USE SQRT TRANSFORMATION
#### Diagnostics
##### City_dist: USE SQUARING TRANSFORMATION
```{r}

pods_lm_subtr_01 <- lm(Viable_Pods ~ City_dist * Year * Transect_ID,
                 data = (fertile_pops_all %>%
                           dplyr::filter(Transect_ID != "Rural")))

par(mfrow=c(2,2))
plot(pods_lm_subtr_01)
# FANNING EFFECT IN RESIDS VS. FITTED PLOT- Heteroscedastic
library(lmtest)
bptest(pods_lm_subtr_01)
# high p-value (0.23) indicates homoscedasticity... so maybe it's ok?
ncvTest(pods_lm_subtr_01)
# low p-value (0.031) indicates heteroscedasticity... so maybe it's not ok?


# Histogram
gg_reshist(pods_lm_subtr_01, bins=15)


# try squaring transformation
gg_reshist(update(pods_lm_subtr_01, Viable_Pods^2 ~ .), bins=15)
par(mfrow=c(2,2))
plot(update(pods_lm_subtr_01, Viable_Pods^2 ~ .))
summary(update(pods_lm_subtr_01, Viable_Pods^2 ~ .))


# try cubing
# gg_reshist(update(pods_lm_subtr_01, Viable_Pods^3 ~ .), bins=15)
# par(mfrow=c(2,2))
# plot(update(pods_lm_subtr_01, Viable_Pods^3 ~ .))
# summary(update(pods_lm_subtr_01, Viable_Pods^3 ~ .)) # too much. going with sq rt

# # add square(pods) col to df
fertile_pops_all$Viable_Pods_squared <- (fertile_pops_all$Viable_Pods)^2

# Full model
pods_lm_subtr_01 <- update(pods_lm_subtr_01, Viable_Pods^2 ~ .)

# all main effects and secondary interactions
pods_lm_subtr_02 <- update(pods_lm_subtr_01,
                              . ~ . -City_dist:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
pods_lm_subtr_03 <- update(pods_lm_subtr_02,
                              . ~ . -City_dist:Transect_ID)
pods_lm_subtr_04 <- update(pods_lm_subtr_02,
                              . ~ . -City_dist:Year)
pods_lm_subtr_05 <- update(pods_lm_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
pods_lm_subtr_06 <- update(pods_lm_subtr_03,
                              . ~ . -City_dist:Year)
pods_lm_subtr_07 <- update(pods_lm_subtr_04,
                              . ~ . -Year:Transect_ID)
pods_lm_subtr_08 <- update(pods_lm_subtr_05,
                              . ~ . -City_dist:Transect_ID)

# all main effects
pods_lm_subtr_09 <- update(pods_lm_subtr_08,
                              . ~ . -City_dist:Year)
```

##### Urb_score: USE SQUARING TRANSFORMATION
```{r}

u_pods_lm_subtr_01 <- lm(Viable_Pods ~ Urb_score * Year * Transect_ID,
                 data = (fertile_pops_all %>%
                           dplyr::filter(Transect_ID != "Rural")))

par(mfrow=c(2,2))
plot(u_pods_lm_subtr_01) # has a tail


# Histogram
gg_reshist(u_pods_lm_subtr_01, bins=20) # left skewed


# try squaring transformation
gg_reshist(update(u_pods_lm_subtr_01, Viable_Pods^2 ~ .), bins=20)
par(mfrow=c(2,2))
plot(update(u_pods_lm_subtr_01, Viable_Pods^2 ~ .))
summary(update(u_pods_lm_subtr_01, Viable_Pods^2 ~ .))


# # try cubing
# gg_reshist(update(u_pods_lm_subtr_01, Viable_Pods^3 ~ .), bins=20)
# par(mfrow=c(2,2))
# plot(update(u_pods_lm_subtr_01, Viable_Pods^3 ~ .))
# summary(update(u_pods_lm_subtr_01, Viable_Pods^3 ~ .)) # too much. going with sq rt

# add square(pods) col to df- already done
# fertile_pops_all$Viable_Pods_squared <- (fertile_pops_all$Viable_Pods)^2



# Full model
u_pods_lm_subtr_01 <- update(u_pods_lm_subtr_01, Viable_Pods^2 ~ .)

# all main effects and secondary interactions
u_pods_lm_subtr_02 <- update(u_pods_lm_subtr_01,
                              . ~ . -Urb_score:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
u_pods_lm_subtr_03 <- update(u_pods_lm_subtr_02,
                              . ~ . -Urb_score:Transect_ID)
u_pods_lm_subtr_04 <- update(u_pods_lm_subtr_02,
                              . ~ . -Urb_score:Year)
u_pods_lm_subtr_05 <- update(u_pods_lm_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_pods_lm_subtr_06 <- update(u_pods_lm_subtr_03,
                              . ~ . -Urb_score:Year)
u_pods_lm_subtr_07 <- update(u_pods_lm_subtr_04,
                              . ~ . -Year:Transect_ID)
u_pods_lm_subtr_08 <- update(u_pods_lm_subtr_05,
                              . ~ . -Urb_score:Transect_ID)

# all main effects
u_pods_lm_subtr_09 <- update(u_pods_lm_subtr_08,
                              . ~ . -Urb_score:Year)
```

#### ANOVA
##### City_dist, not urb_scores
```{r}
pods_lm_subtr_list <- list(pods_lm_subtr_01,
                             pods_lm_subtr_02,
                             pods_lm_subtr_03,
                             pods_lm_subtr_04,
                             pods_lm_subtr_05,
                             pods_lm_subtr_06,
                             pods_lm_subtr_07,
                             pods_lm_subtr_08)


formulas_pods <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_pods$Model <- NA
formulas_pods$Formula <- NA
formulas_pods$r.squaredGLMM_R2m <- NA
formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(pods_lm_subtr_list)) {
  formulas_pods[i, 1] <- toString(i)
  formulas_pods[i, 2] <- toString(formula(pods_lm_subtr_list[[i]]))
  formulas_pods[i, 3] <- r.squaredGLMM(pods_lm_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_pods[i, 4] <- r.squaredGLMM(pods_lm_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_pods <- do.call(rbind,
                       lapply(pods_lm_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_pods <- bind_cols(formulas_pods,
                        glance_pods %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 3,5,8 lowest AIC (8 is best)

# check residuals
plot(pods_lm_subtr_08) # looks good


summary(pods_lm_subtr_08)
pods_lm_subtr_08_anova <- car::Anova(pods_lm_subtr_08) %T>%
  print() # City_dist sig

```

##### urb_scores, not city_dist
```{r}
u_pods_lm_subtr_list <- list(u_pods_lm_subtr_01,
                             u_pods_lm_subtr_02,
                             u_pods_lm_subtr_03,
                             u_pods_lm_subtr_04,
                             u_pods_lm_subtr_05,
                             u_pods_lm_subtr_06,
                             u_pods_lm_subtr_07,
                             u_pods_lm_subtr_08)


formulas_u_pods <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_pods$Model <- NA
formulas_u_pods$Formula <- NA
formulas_u_pods$r.squaredGLMM_R2m <- NA
formulas_u_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_pods_lm_subtr_list)) {
  formulas_u_pods[i, 1] <- toString(i)
  formulas_u_pods[i, 2] <- toString(formula(u_pods_lm_subtr_list[[i]]))
  formulas_u_pods[i, 3] <- r.squaredGLMM(u_pods_lm_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_pods[i, 4] <- r.squaredGLMM(u_pods_lm_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_pods <- do.call(rbind,
                       lapply(u_pods_lm_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_pods <- bind_cols(formulas_u_pods,
                        glance_u_pods %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 3,4,6,7,8 lowest AIC (6 is best)

# check residuals
plot(u_pods_lm_subtr_06) # looks good


summary(u_pods_lm_subtr_06)
u_pods_lm_subtr_06_anova <- car::Anova(u_pods_lm_subtr_06) %T>%
  print() # nothing sig

```


# Pods per peduncle
## LM
### Without transect
#### Diagnostics
##### City_dist: USE SQRT TRANSFORMATION
```{r}
podsperped_lm_gradient_01 <- lm(pods_per_ped ~ City_dist * Year ,
                                data = fertile_pops_all)

par(mfrow=c(2,2))
plot(podsperped_lm_gradient_01)
summary(podsperped_lm_gradient_01)

qplot(fertile_pops_all$pods_per_ped)

lmtest::bptest(podsperped_lm_gradient_01) 
# plot is heteroskedastic
## Felipe says it's not a big deal, esp. since dist_city is not normally distributed (b/c of my study design)

gg_reshist(podsperped_lm_gradient_01, bins=20)
ggqqplot(fertile_pops_all$pods_per_ped)
## Most data points fall within the envelope. I think it's fine

# Reduced model
podsperped_lm_gradient_02 <- update(podsperped_lm_gradient_01, . ~ . - City_dist:Year)
```

##### Urb_score: No transformation necessary
```{r}
u_podsperped_lm_gradient_01 <- lm(pods_per_ped ~ Urb_score * Year ,
                                data = fertile_pops_all)

par(mfrow=c(2,2))
plot(u_podsperped_lm_gradient_01)
summary(u_podsperped_lm_gradient_01)

lmtest::bptest(u_podsperped_lm_gradient_01) 
# plot is heteroskedastic
## Felipe says it's not a big deal, esp. since urb)score is not normally distributed (b/c of my study design)

gg_reshist(u_podsperped_lm_gradient_01, bins=20)
# looks fine

# Reduced model
u_podsperped_lm_gradient_02 <- update(u_podsperped_lm_gradient_01, . ~ . - Urb_score:Year)

```


#### ANOVA
##### City_dist, not urb_score
```{r}
pods_per_ped_lm_gradient_list <- list(podsperped_lm_gradient_01,
                                 podsperped_lm_gradient_02)


formulas_pods_per_ped <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_pods_per_ped$Model <- NA
formulas_pods_per_ped$Formula <- NA
formulas_pods_per_ped$r.squaredGLMM_R2m <- NA
formulas_pods_per_ped$r.squaredGLMM_R2c <- NA

for (i in 1:length(pods_per_ped_lm_gradient_list)) {
  formulas_pods_per_ped[i, 1] <- toString(i)
  formulas_pods_per_ped[i, 2] <- toString(formula(pods_per_ped_lm_gradient_list[[i]]))
  formulas_pods_per_ped[i, 3] <- r.squaredGLMM(pods_per_ped_lm_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_pods_per_ped[i, 4] <- r.squaredGLMM(pods_per_ped_lm_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_pods_per_ped <- do.call(rbind,
                       lapply(pods_per_ped_lm_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_pods_per_ped <- bind_cols(formulas_pods_per_ped,
                        glance_pods_per_ped %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 1, 2 lowest AIC (2 is best though)

# check residuals
plot(podsperped_lm_gradient_02) # looks good


summary(podsperped_lm_gradient_02)
podsperped_lm_gradient_02_anova <- car::Anova(podsperped_lm_gradient_02) %T>%
  print() # city_dist and year marg sig

```

##### urb_score
```{r}
u_podsperped_lm_gradient_list <- list(u_podsperped_lm_gradient_01,
                                 u_podsperped_lm_gradient_02)


formulas_u_pods_per_ped <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_pods_per_ped$Model <- NA
formulas_u_pods_per_ped$Formula <- NA
formulas_u_pods_per_ped$r.squaredGLMM_R2m <- NA
formulas_u_pods_per_ped$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_podsperped_lm_gradient_list)) {
  formulas_u_pods_per_ped[i, 1] <- toString(i)
  formulas_u_pods_per_ped[i, 2] <- toString(formula(u_podsperped_lm_gradient_list[[i]]))
  formulas_u_pods_per_ped[i, 3] <- r.squaredGLMM(u_podsperped_lm_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_pods_per_ped[i, 4] <- r.squaredGLMM(u_podsperped_lm_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_pods_per_ped <- do.call(rbind,
                       lapply(u_podsperped_lm_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_pods_per_ped <- bind_cols(formulas_u_pods_per_ped,
                        glance_u_pods_per_ped %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 1, 2 lowest AIC (2 is best though)

# check residuals
plot(u_podsperped_lm_gradient_02) # looks good


summary(u_podsperped_lm_gradient_02)
u_podsperped_lm_gradient_02_anova <- car::Anova(u_podsperped_lm_gradient_02) %T>%
  print() # year, urb_score sig

```


### With transect
#### Diagnostics
##### City_dist- No transformation necessary
```{r}

podsperped_lm_subtr_01 <- lm(pods_per_ped ~ City_dist * Year * Transect_ID,
                 data = (fertile_pops_all %>%
                           dplyr::filter(Transect_ID != "Rural")))

par(mfrow=c(2,2))
plot(podsperped_lm_subtr_01)

# Histogram
gg_reshist(podsperped_lm_subtr_01, bins=15) # looks good



# all main effects and secondary interactions
podsperped_lm_subtr_02 <- update(podsperped_lm_subtr_01,
                              . ~ . -City_dist:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
podsperped_lm_subtr_03 <- update(podsperped_lm_subtr_02,
                              . ~ . -City_dist:Transect_ID)
podsperped_lm_subtr_04 <- update(podsperped_lm_subtr_02,
                              . ~ . -City_dist:Year)
podsperped_lm_subtr_05 <- update(podsperped_lm_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
podsperped_lm_subtr_06 <- update(podsperped_lm_subtr_03,
                              . ~ . -City_dist:Year)
podsperped_lm_subtr_07 <- update(podsperped_lm_subtr_04,
                              . ~ . -Year:Transect_ID)
podsperped_lm_subtr_08 <- update(podsperped_lm_subtr_05,
                              . ~ . -City_dist:Transect_ID)

# all main effects
podsperped_lm_subtr_09 <- update(podsperped_lm_subtr_08,
                              . ~ . -City_dist:Year)
```

##### Urb_score- No transformation necessary
```{r}

u_podsperped_lm_subtr_01 <- lm(pods_per_ped ~ Urb_score * Year * Transect_ID,
                 data = (fertile_pops_all %>%
                           dplyr::filter(Transect_ID != "Rural")))

par(mfrow=c(2,2))
plot(u_podsperped_lm_subtr_01)

# Histogram
gg_reshist(u_podsperped_lm_subtr_01, bins=15) # looks good



# all main effects and secondary interactions
u_podsperped_lm_subtr_02 <- update(u_podsperped_lm_subtr_01,
                              . ~ . -Urb_score:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
u_podsperped_lm_subtr_03 <- update(u_podsperped_lm_subtr_02,
                              . ~ . -Urb_score:Transect_ID)
u_podsperped_lm_subtr_04 <- update(u_podsperped_lm_subtr_02,
                              . ~ . -Urb_score:Year)
u_podsperped_lm_subtr_05 <- update(u_podsperped_lm_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_podsperped_lm_subtr_06 <- update(u_podsperped_lm_subtr_03,
                              . ~ . -Urb_score:Year)
u_podsperped_lm_subtr_07 <- update(u_podsperped_lm_subtr_04,
                              . ~ . -Year:Transect_ID)
u_podsperped_lm_subtr_08 <- update(u_podsperped_lm_subtr_05,
                              . ~ . -Urb_score:Transect_ID)

# all main effects
u_podsperped_lm_subtr_09 <- update(u_podsperped_lm_subtr_08,
                              . ~ . -Urb_score:Year)
```

#### ANOVA
##### City_dist, not urb_scores
```{r}
podsperped_lm_subtr_list <- list(podsperped_lm_subtr_01,
                             podsperped_lm_subtr_02,
                             podsperped_lm_subtr_03,
                             podsperped_lm_subtr_04,
                             podsperped_lm_subtr_05,
                             podsperped_lm_subtr_06,
                             podsperped_lm_subtr_07,
                             podsperped_lm_subtr_08)


formulas_podsperped <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_podsperped$Model <- NA
formulas_podsperped$Formula <- NA
formulas_podsperped$r.squaredGLMM_R2m <- NA
formulas_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(podsperped_lm_subtr_list)) {
  formulas_podsperped[i, 1] <- toString(i)
  formulas_podsperped[i, 2] <- toString(formula(podsperped_lm_subtr_list[[i]]))
  formulas_podsperped[i, 3] <- r.squaredGLMM(podsperped_lm_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_podsperped[i, 4] <- r.squaredGLMM(podsperped_lm_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_podsperped <- do.call(rbind,
                       lapply(podsperped_lm_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_podsperped <- bind_cols(formulas_podsperped,
                        glance_podsperped %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 3,5,8 lowest AIC (8 is best)

# check residuals
plot(podsperped_lm_subtr_08) # looks good


summary(podsperped_lm_subtr_08)
podsperped_lm_subtr_08_anova <- car::Anova(podsperped_lm_subtr_08) %T>%
  print() # City_dist:year interaxn marg sig

```

##### urb_score, not City_dist
```{r}
u_podsperped_lm_subtr_list <- list(u_podsperped_lm_subtr_01,
                             u_podsperped_lm_subtr_02,
                             u_podsperped_lm_subtr_03,
                             u_podsperped_lm_subtr_04,
                             u_podsperped_lm_subtr_05,
                             u_podsperped_lm_subtr_06,
                             u_podsperped_lm_subtr_07,
                             u_podsperped_lm_subtr_08)


formulas_u_podsperped <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_podsperped$Model <- NA
formulas_u_podsperped$Formula <- NA
formulas_u_podsperped$r.squaredGLMM_R2m <- NA
formulas_u_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_podsperped_lm_subtr_list)) {
  formulas_u_podsperped[i, 1] <- toString(i)
  formulas_u_podsperped[i, 2] <- toString(formula(u_podsperped_lm_subtr_list[[i]]))
  formulas_u_podsperped[i, 3] <- r.squaredGLMM(u_podsperped_lm_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_podsperped[i, 4] <- r.squaredGLMM(u_podsperped_lm_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_podsperped <- do.call(rbind,
                       lapply(u_podsperped_lm_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_podsperped <- bind_cols(formulas_u_podsperped,
                        glance_u_podsperped %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 3,4,5,6,7,8 lowest AIC (7 is best)

# check residuals
plot(u_podsperped_lm_subtr_07) # looks good


summary(u_podsperped_lm_subtr_07)
u_podsperped_lm_subtr_07_anova <- car::Anova(u_podsperped_lm_subtr_07) %T>%
  print() # nothing sig

```


## plant-level means
The point of this is to test whether the complicated glmer model is better than the simple lmer. Additionally, is the lm better than lmer? The simpler model will make the regression results easier to interpret if, in fact, the simplest model provides the same conclusions/results as the most complicated.
The lm uses population-level means while lmer and glmer use plant-level data.
```{r}
# Make new dfs with hierarchical means
## make new df w/plant-level means
long_plant_means_pods <- fertile_long %>% group_by(Patch_ID, Year, Pop_ID, Plant_Num) %>%
    dplyr::summarise(
      Pods_per_plant=mean(Viable_Pods,na.rm = TRUE),
      City_dist=mean(City_dist),
      Transect_ID=first(Transect_ID),
      Plants_present_2018=mean(Plants_present_2018,na.rm=TRUE),
      nPlants=n()
      )

# try out new glmer
v1 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist * Year, long_plant_means_pods, family = "poisson")
summary(v1)
car::Anova(v1)
# Year marginally sig. Removing interaxn

v1.1 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist + Year, long_plant_means_pods, family = "poisson")
summary(v1.1)
car::Anova(v1.1)
# Year marginally sig. Removing city_dist

v1.2 <- glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + Year, long_plant_means_pods, family = "poisson")
summary(v1.2)
v1.21 <- car::Anova(v1.2)
# Year marginally sig




# try out new glmer- URBAN SUBTRANSECTS
glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist * Transect_ID * Year, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# Won't converge... removing year

### TRYING ALL SECONDARY INTERAXNS SEPARATELY
car::Anova(glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist * Transect_ID, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# Nothing sig

car::Anova(glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + City_dist * Year, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# city x year interaxn is highly sig

car::Anova(glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + Transect_ID * Year, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# Transect x year interaxn is sig

## ALL SECONDARY INTERAXNS... NO TERTIARY
car::Anova(glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + Transect_ID:City_dist + Transect_ID:Year + City_dist:Year + Year + Transect_ID + City_dist, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# both interaxns with year are sig, but not city x transect, so removing that


summary(glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + Transect_ID:Year + City_dist:Year + Year + Transect_ID + City_dist, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

v2 <- car::Anova(glmer(as.numeric(Pods_per_plant) ~ (1|Patch_ID) + Transect_ID:Year + City_dist:Year + Year + Transect_ID + City_dist, (long_plant_means_pods %>% filter(Transect_ID != 'Rural')), family = "poisson", glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# two interaxns still sig. Best model


```


# Height
## LM
### Without transect
#### Diagnostics
##### City_dist: USE SQRT TRANSFORMATION
```{r}
height_lm_gradient_01 <- lm(Height_Sept ~ City_dist * Year ,
                                data = fertile_pops_all)

par(mfrow=c(2,2))
plot(height_lm_gradient_01)
summary(height_lm_gradient_01)

qplot(fertile_pops_all$Height_Sept)

gg_reshist(height_lm_gradient_01, bins=20) # looks fine

# Reduced model
height_lm_gradient_02 <- update(height_lm_gradient_01, . ~ . - City_dist:Year)
```

##### Urb_score: No transformation necessary
```{r}
u_height_lm_gradient_01 <- lm(Height_Sept ~ Urb_score * Year ,
                                data = fertile_pops_all)

par(mfrow=c(2,2))
plot(u_height_lm_gradient_01)
summary(u_height_lm_gradient_01)

gg_reshist(u_height_lm_gradient_01, bins=20)
# looks fine

# Reduced model
u_height_lm_gradient_02 <- update(u_height_lm_gradient_01, . ~ . - Urb_score:Year)

```


#### ANOVA
##### City_dist, not urb_score
```{r}
Height_Sept_lm_gradient_list <- list(height_lm_gradient_01,
                                 height_lm_gradient_02)


formulas_Height_Sept <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_Height_Sept$Model <- NA
formulas_Height_Sept$Formula <- NA
formulas_Height_Sept$r.squaredGLMM_R2m <- NA
formulas_Height_Sept$r.squaredGLMM_R2c <- NA

for (i in 1:length(Height_Sept_lm_gradient_list)) {
  formulas_Height_Sept[i, 1] <- toString(i)
  formulas_Height_Sept[i, 2] <- toString(formula(Height_Sept_lm_gradient_list[[i]]))
  formulas_Height_Sept[i, 3] <- r.squaredGLMM(Height_Sept_lm_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_Height_Sept[i, 4] <- r.squaredGLMM(Height_Sept_lm_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_Height_Sept <- do.call(rbind,
                       lapply(Height_Sept_lm_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_Height_Sept <- bind_cols(formulas_Height_Sept,
                        glance_Height_Sept %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 1, 2 lowest AIC (2 is best though)

# check residuals
plot(height_lm_gradient_02) # looks good


summary(height_lm_gradient_02)
height_lm_gradient_02_anova <- car::Anova(height_lm_gradient_02) %T>%
  print() #  year marg sig

```

##### urb_score
```{r}
u_height_lm_gradient_list <- list(u_height_lm_gradient_01,
                                 u_height_lm_gradient_02)


formulas_u_Height_Sept <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_Height_Sept$Model <- NA
formulas_u_Height_Sept$Formula <- NA
formulas_u_Height_Sept$r.squaredGLMM_R2m <- NA
formulas_u_Height_Sept$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_height_lm_gradient_list)) {
  formulas_u_Height_Sept[i, 1] <- toString(i)
  formulas_u_Height_Sept[i, 2] <- toString(formula(u_height_lm_gradient_list[[i]]))
  formulas_u_Height_Sept[i, 3] <- r.squaredGLMM(u_height_lm_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_Height_Sept[i, 4] <- r.squaredGLMM(u_height_lm_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_Height_Sept <- do.call(rbind,
                       lapply(u_height_lm_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_Height_Sept <- bind_cols(formulas_u_Height_Sept,
                        glance_u_Height_Sept %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 1, 2 lowest AIC (2 is best though)

# check residuals
plot(u_height_lm_gradient_02) # looks good


summary(u_height_lm_gradient_02)
u_height_lm_gradient_02_anova <- car::Anova(u_height_lm_gradient_02) %T>%
  print() # nothing sig

```


### With transect
#### Diagnostics
##### City_dist- No transformation necessary
```{r}

height_lm_subtr_01 <- lm(Height_Sept ~ City_dist * Year * Transect_ID,
                 data = (fertile_pops_all %>%
                           dplyr::filter(Transect_ID != "Rural")))

par(mfrow=c(2,2))
plot(height_lm_subtr_01)

# Histogram
gg_reshist(height_lm_subtr_01, bins=15) # looks good



# all main effects and secondary interactions
height_lm_subtr_02 <- update(height_lm_subtr_01,
                              . ~ . -City_dist:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
height_lm_subtr_03 <- update(height_lm_subtr_02,
                              . ~ . -City_dist:Transect_ID)
height_lm_subtr_04 <- update(height_lm_subtr_02,
                              . ~ . -City_dist:Year)
height_lm_subtr_05 <- update(height_lm_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
height_lm_subtr_06 <- update(height_lm_subtr_03,
                              . ~ . -City_dist:Year)
height_lm_subtr_07 <- update(height_lm_subtr_04,
                              . ~ . -Year:Transect_ID)
height_lm_subtr_08 <- update(height_lm_subtr_05,
                              . ~ . -City_dist:Transect_ID)

# all main effects
height_lm_subtr_09 <- update(height_lm_subtr_08,
                              . ~ . -City_dist:Year)
```

##### Urb_score- No transformation necessary
```{r}

u_height_lm_subtr_01 <- lm(Height_Sept ~ Urb_score * Year * Transect_ID,
                 data = (fertile_pops_all %>%
                           dplyr::filter(Transect_ID != "Rural")))

par(mfrow=c(2,2))
plot(u_height_lm_subtr_01)

# Histogram
gg_reshist(u_height_lm_subtr_01, bins=15) # looks good



# all main effects and secondary interactions
u_height_lm_subtr_02 <- update(u_height_lm_subtr_01,
                              . ~ . -Urb_score:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
u_height_lm_subtr_03 <- update(u_height_lm_subtr_02,
                              . ~ . -Urb_score:Transect_ID)
u_height_lm_subtr_04 <- update(u_height_lm_subtr_02,
                              . ~ . -Urb_score:Year)
u_height_lm_subtr_05 <- update(u_height_lm_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_height_lm_subtr_06 <- update(u_height_lm_subtr_03,
                              . ~ . -Urb_score:Year)
u_height_lm_subtr_07 <- update(u_height_lm_subtr_04,
                              . ~ . -Year:Transect_ID)
u_height_lm_subtr_08 <- update(u_height_lm_subtr_05,
                              . ~ . -Urb_score:Transect_ID)

# all main effects
u_height_lm_subtr_09 <- update(u_height_lm_subtr_08,
                              . ~ . -Urb_score:Year)
```

#### ANOVA
##### City_dist, not urb_scores
```{r}
height_lm_subtr_list <- list(height_lm_subtr_01,
                             height_lm_subtr_02,
                             height_lm_subtr_03,
                             height_lm_subtr_04,
                             height_lm_subtr_05,
                             height_lm_subtr_06,
                             height_lm_subtr_07,
                             height_lm_subtr_08)


formulas_height <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_height$Model <- NA
formulas_height$Formula <- NA
formulas_height$r.squaredGLMM_R2m <- NA
formulas_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(height_lm_subtr_list)) {
  formulas_height[i, 1] <- toString(i)
  formulas_height[i, 2] <- toString(formula(height_lm_subtr_list[[i]]))
  formulas_height[i, 3] <- r.squaredGLMM(height_lm_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_height[i, 4] <- r.squaredGLMM(height_lm_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_height <- do.call(rbind,
                       lapply(height_lm_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_height <- bind_cols(formulas_height,
                        glance_height %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 3,5,6,7, 8 lowest AIC (8 is best)

# check residuals
plot(height_lm_subtr_08) # looks good


summary(height_lm_subtr_08)
height_lm_subtr_08_anova <- car::Anova(height_lm_subtr_08) %T>%
  print() # nothing sig

```

##### urb_score, not City_dist
```{r}
u_height_lm_subtr_list <- list(u_height_lm_subtr_01,
                             u_height_lm_subtr_02,
                             u_height_lm_subtr_03,
                             u_height_lm_subtr_04,
                             u_height_lm_subtr_05,
                             u_height_lm_subtr_06,
                             u_height_lm_subtr_07,
                             u_height_lm_subtr_08)


formulas_u_height <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_height$Model <- NA
formulas_u_height$Formula <- NA
formulas_u_height$r.squaredGLMM_R2m <- NA
formulas_u_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_height_lm_subtr_list)) {
  formulas_u_height[i, 1] <- toString(i)
  formulas_u_height[i, 2] <- toString(formula(u_height_lm_subtr_list[[i]]))
  formulas_u_height[i, 3] <- r.squaredGLMM(u_height_lm_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_height[i, 4] <- r.squaredGLMM(u_height_lm_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_height <- do.call(rbind,
                       lapply(u_height_lm_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_height <- bind_cols(formulas_u_height,
                        glance_u_height %>%
                          dplyr::select(AIC, BestModels)) %T>%
  view() # Models 4,5,7 lowest AIC (7 is best)

# check residuals
plot(u_height_lm_subtr_07) # looks good


summary(u_height_lm_subtr_07)
u_height_lm_subtr_07_anova <- car::Anova(u_height_lm_subtr_07) %T>%
  print() # urb_score sig

```


# Plant density (plants per sq m of patch, as observed in 2018)
###### LM
####### Without transect
######## Diagnostics- can't transform data and assume normality. Go with non-parametric tests?
```{r}
# Removing rows with NA and only keeping data from 2018, since I only quantified patch size and plant density in that year.
density_18 <- AvgVars_byPatch[!is.na(AvgVars_byPatch$density_sqm_18),] %>% filter(Year == '2018')

density_lm <- lm(density_sqm_18 ~ City_dist * Year, data = density_18)

par(mfrow=c(2,2))
plot(density_lm)
summary(density_lm)

ggqqplot(density_18$density_sqm_18)
gg_reshist(density_lm, bins=20)
# major right skew

## try transformation.
##################################

## tried square, cube + roots: not strong enough
par(mfrow=c(2,2))
plot(lm(log(density_sqm_18^(1/10) ~ City_dist , data = density_18 )))
ggqqplot(density_18$density_sqm_18^(1/10))
gg_reshist(lm(density_sqm_18^(1/10) ~ City_dist , data = density_18 ), bins=20)

## tried log(x): makes it into a bimodal distribution... looks much better but not enough, I don't think
par(mfrow=c(2,2))
plot(lm(log(density_sqm_18) ~ City_dist , data = density_18 ))
ggqqplot(log(density_18$density_sqm_18))
gg_reshist(lm(log(density_sqm_18) ~ City_dist , data = density_18 ), bins=20)

# tried reciprocal transformation (1/x): still have ~20 data points not fitting
par(mfrow=c(2,2))
plot(lm((1/(density_sqm_18)) ~ City_dist , data = density_18 ))
ggqqplot((1/(density_18$density_sqm_18)))
gg_reshist(lm((1/(density_sqm_18)) ~ City_dist , data = density_18 ), bins=20)

# go with a non-parametric test: Kruskal-Wallace rank sum test
```


######## Kruskal-Wallace rank sum test
```{r}
kruskal.test(density_sqm_18 ~  City_dist , data = density_18)
# Plant density does not significantly change along the gradient.

# same insignificant results if using ANOVA with log-transformed data too.
car::Anova(lm(log(density_sqm_18) ~  City_dist , data = density_18))

```

####### With transects
######## Diagnostics- WHICH TEST TO USE?
```{r}

# First, remove rural points to avoid collinearity.
density_18_urban <- subset(density_18, Transect_ID == "North" | Transect_ID == "South")

urbdensity_lm <- lm(density_sqm_18 ~ City_dist * Transect_ID, data = density_18_urban)

par(mfrow=c(2,2))
plot(urbdensity_lm)

ggqqplot(density_18_urban$density_sqm_18)
## Data points don't fit in envelope towards right margin.

# Histogram
gg_reshist(urbdensity_lm, bins=20)
# very right-skewed

## try transformation.
##################################

## tried square, cube + roots: not strong enough
par(mfrow=c(2,2))
plot(lm(log(density_sqm_18^(1/10) ~ City_dist* Transect_ID, data = density_18_urban )))
ggqqplot(density_18_urban$density_sqm_18^(1/10))
gg_reshist(lm(density_sqm_18^(1/10) ~ City_dist* Transect_ID, data = density_18_urban ), bins=20)

## tried log(x): makes it into a bimodal distribution...
par(mfrow=c(2,2))
plot(lm(log(density_sqm_18) ~ City_dist* Transect_ID , data = density_18_urban ))
ggqqplot(log(density_18_urban$density_sqm_18))
gg_reshist(lm(log(density_sqm_18) ~ City_dist* Transect_ID , data = density_18_urban ), bins=20)

# tried reciprocal transformation (1/x): still have ~20 data points not fitting
par(mfrow=c(2,2))
plot(lm(1/(density_sqm_18) ~ City_dist* Transect_ID , data = density_18_urban ))
ggqqplot(1/(density_18_urban$density_sqm_18))
gg_reshist(lm(1/(density_sqm_18) ~ City_dist* Transect_ID, data = density_18_urban ), bins=20)

# go with a non-parametric test?
```


######### ANOVA
```{r}
# car::Anova(lm(density_sqm_18	~ City_dist * Transect_ID, data = density_18_urban))
# # 3-way interaction not significant, so let's look at lower-level interactions and main effects.
# 


```

# Export ANOVAs
## Best models: Inflors, pollen, pods, pods/inflor
```{r}
# tidy anovas
tidy_sb <- function(model){
  
  return(
    car::Anova(model) %>%
      broom.mixed::tidy() %>%
      # as.data.frame() %>%
      dplyr::mutate(Response = as.character(formula(model)[2]),
                    .before = term) %>%
      # dplyr::mutate(Model = paste(n(model)),
      #               .before = term) %>%
      dplyr::mutate(Sites = case_when(
        str_detect(as.character(formula(model)[3]), "Transect_ID") == TRUE ~ "Urban Only",
        str_detect(as.character(formula(model)[3]), "Transect_ID") == FALSE ~ "All"),
                    .before = term) %>%
      dplyr::mutate(Significance = case_when(p.value < 0.001 ~ "***",
                                             p.value < 0.01 ~ "**",
                                             p.value <= 0.05 ~ "*")) %>%
      dplyr::mutate(., AIC = as.numeric(AIC(model))) %>%
      mutate_if(is.numeric, round, 3))      %>%
      dplyr::mutate(p.value = replace(p.value, p.value < 0.001, "<0.001"))  %>%
      dplyr::select(., -df) %>%
      dplyr::rename(., Chi_sq = statistic,
                    Predictor = term,
                    p = p.value) %>%
      unite("p", p:Significance, sep = "", na.rm = TRUE) %>%
      dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("City_dist"),
                replacement = c("Distance to City Center")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Urb_score"),
                replacement = c("Urbanization Score")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Transect_ID"),
                replacement = c("Subtransect")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c(":"),
                replacement = c(" x ")) %>%
    dplyr::mutate_if(.,
          is.character,
          str_replace_all,
          pattern = c("Year x Urbanization Score"),
          replacement = c("Urbanization Score x Year")) # %>%
        # dplyr::mutate_if(.,
        #         is.character,
        #         str_replace_all,
        #         pattern = c("Year x Distance to City Center"),
        #         replacement = c("Distance to City Center x Year")) %>%
        # dplyr::mutate_if(.,
        #         is.character,
        #         str_replace_all,
        #         pattern = c("Subtransect x Distance to City Center"),
        #         replacement = c("Distance to City Center x Subtransect")) %>%
        # dplyr::mutate_if(.,
        #         is.character,
        #         str_replace_all,
        #         pattern = c("Distance to City Center x Year x Subtransect"),
        #         replacement = c("Year x Subtransect x Distance to City Center"))
}

# combine anovas into publication-quality tables
make_Q1Q2_Anova.lm <- function(anova_list){
  return(
    lapply(anova_list, tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", "AIC", "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename(
      'SS' = 2,
      'X2' = 3,
      'p' = 4,
      'SS ' = 5,
      'X2 ' = 6,
      'p ' = 7,
      'SS  ' = 8,
      'X2  ' = 9,
      'p  ' = 10,
      'SS   ' = 11,
      'X2   ' = 12,
      'p   ' = 13) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Inflorescences",
                 "Pollinaria Removed",
                 "Follicles",
                 "Follicles per Inflorescence"),
      colwidths = c(1, 3, 3, 3, 3)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:13, align = "center", part = "body") %>%
    align(j = 2:13, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2  ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2   ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body")
    )
  }



# CITY_DIST-----
## ALL SITES

best_mods_Q1.dist_list_lm <- list(
### Peduncles
   peds_lm_gradient_01,
### Pollinia
  poll_lm_gradient_02,
### Pods
  pods_lm_gradient_01,
### Pods/Peduncle
  podsperped_lm_gradient_02

)

make_Q1Q2_Anova.lm(best_mods_Q1.dist_list_lm) %>%
  width(j = 1, width = 2.7) %>%
  width(j = 2:13, width = 0.8) %>%
  italic(i = 2, j = 2:13, part = "header") %>%
  add_footer_lines("Table X: Results from general linear models examining the effects of urbanization on 4 traits: inflorescences, pollinaria removed, follicles, and mean no. follicles per inflorescence. Urbanization was quantified via distance to city center and all populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Q1_Dist_ANOVA_lm.png"))





## URBAN SITES
best_mods_Q2.dist_list.lm <- list(
### Peduncles
  peds_lm_subtr_06,
### Pollinia
  poll_lm_subtr_06,
### Pods
   pods_lm_subtr_08, 
### Pods/Peduncle
 podsperped_lm_subtr_08

)


make_Q1Q2_Anova.lm(best_mods_Q2.dist_list.lm) %>%
  width(j = 1, width = 3) %>%
  width(j = 2:13, width = 0.9) %>%
  italic(i = 2, j = 2:13, part = "header") %>%
  add_footer_lines("Table X: Results from general linear models examining the effects of urbanization and proximity to an urban corridor on 4 traits: pollinaria removed, follicles, inflorescences, and mean no. follicles per inflorescence. Urbanization was quantified via urbanization score. Urbanization was quantified via distance to city center and only urban populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Q2_Dist_ANOVA_lm.png"))





# URB_SCORE-----
## ALL SITES

best_mods_Q1.urbscore_list.lm <- list(
### Peduncles
  u_peds_lm_gradient_01,
### Pollinia
  u_poll_lm_gradient_02,
### Pods
  u_pods_lm_gradient_02,
### Pods/Peduncle
  u_podsperped_lm_gradient_02

)


make_Q1Q2_Anova.lm(best_mods_Q1.urbscore_list.lm) %>%
  width(j = 1, width = 2.4) %>%
  width(j = 2:13, width = 0.8) %>%
  italic(i = 2, j = 2:13, part = "header") %>%
  add_footer_lines("Table X: Results from general linear models examining the effects of urbanization on 4 traits: pollinaria removed, follicles, inflorescences, and mean no. follicles per inflorescence. Urbanization was quantified via urbanization score and all populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Q1_Urbscore_ANOVA_lm.png"))










## URBAN SITES

best_mods_Q2.urbscore_list_lm <- list(
### Peduncles
  u_peds_lm_subtr_06,
### Pollinia
  u_poll_lm_subtr_06,
### Pods
   u_pods_lm_subtr_06,
### Pods/Peduncle
  u_podsperped_lm_subtr_07

)


make_Q1Q2_Anova.lm(best_mods_Q2.urbscore_list_lm) %>%
  width(j = 1, width = 3.3) %>%
  width(j = 2:9, width = 0.9) %>%
  italic(i = 2, j = 2:9, part = "header") %>%
  add_footer_lines("Table X: Results from general linear models examining the effects of urbanization and proximity to an urban corridor on 4 traits: inflorescences, pollinaria removed, follicles, and mean no. follicles per inflorescence. Urbanization was quantified via urbanization score. Urbanization was quantified via urbanization score and only urban populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Q2_Urbscore_ANOVA_lm.png"))

```

## Best models: height
```{r}
# make_anova function tweaked to handle one model- height- instead of a list
make_Q1Q2_Anova.height_lm <- function(anova){
  return(
    tidy_sb(anova) %>%
    as.data.frame() %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", "AIC", "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('SS' = 2,
                  'X2' = 3,
                  'p' = 4) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Height"),
      colwidths = c(1, 3)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:4, align = "center", part = "body") %>%
    align(j = 2:4, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) 
    )
}


# CITY_DIST-----
## ALL SITES
# Height: height_lm_gradient_02

make_Q1Q2_Anova.height_lm(height_lm_gradient_02) %>%
  width(j = 1, width = 1.8) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from general linear models examining the effects of urbanization on plant height. Urbanization was quantified via distance to city center and all populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Height/Q1_Dist_ANOVA_HEIGHT_lm.png"))





## URBAN SITES
# Height:  height_lm_subtr_08

make_Q1Q2_Anova.height_lm(height_lm_subtr_08) %>%
  width(j = 1, width = 2.5) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from general linear models examining the effects of urbanization and proximity to an urban corridor on plant height. Urbanization was quantified via distance to city center and only urban populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Height/Q2_Dist_ANOVA_HEIGHT_lm.png"))



# URB_SCORE-----
## ALL SITES
# Height: 

make_Q1Q2_Anova.height_lm(u_height_lm_gradient_02) %>%
  width(j = 1, width = 1.7) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from general linear models examining the effects of urbanization on plant height. Urbanization was quantified via urbanization score and all populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Height/Q1_Urbscore_ANOVA_HEIGHT_lm.png"))





## URBAN SITES
# Height: u_height_lm_subtr_07

make_Q1Q2_Anova.height_lm(u_height_lm_subtr_07) %>%
  width(j = 1, width = 2.5) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from general linear models examining the effects of urbanization and proximity to an urban corridor on plant height. Urbanization was quantified via urbanization score and only urban populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Height/Q2_Urbscore_ANOVA_HEIGHT_lm.png"))
```

## Alternative (AIC<2 from best) models: Inflors, pollen, pods, pods/inflor
```{r}

# CITY_DIST-----
## ALL SITES-----
alt_best_mods_Q1.dist_list_lm <- list(
### Peduncles- NONE- only one best model
### Pollinia-
  poll_lm_gradient_01,
### Pods-
pods_lm_gradient_02,
### Pods/Peduncle:
podsperped_lm_gradient_01
)



lapply(alt_best_mods_Q1.dist_list_lm, tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('SS' = 2,
                  'X2' = 3,
                  'p' = 4,
                  'SS ' = 5,
                  'X2 ' = 6,
                  'p ' = 7,
                  'SS  ' = 8,
                  'X2  ' = 9,
                  'p  ' = 10) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Pollinaria Removed, Alt. Model 1",
                 "Follicles, Alt. Model 1",
                 "Follicles per Inflorescence, Alt. Model 1"),
      colwidths = c(1, 3, 3, 3)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:10, align = "center", part = "body") %>%
    align(j = 2:10, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 2.5) %>%
  width(j = 2:5, width = 1) %>%
  italic(i = 2, j = 2:5, part = "header") %>%
  add_footer_lines("Table X: Results from alternative general linear models within 2 AIC from the best models examining the effects of urbanization on 3 traits: pollinaria removed, follicles, and mean no. follicles per inflorescence. Alternative models of other estimates of reproductive success were >2 AIC of the best models and are not shown. Urbanization was quantified via distance to city center and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC, Pollinaria Removed, Alt. Model 1: ",
                          AIC(poll_lm_gradient_01) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Follicles, Alt. Model 1: ",
                          AIC(pods_lm_gradient_02) %>% round(., 3))) %>%  
  add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 1: ",
                          AIC(podsperped_lm_gradient_01) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Alternative_Models/Q1_Dist_ANOVA_altmodels_lm.png"))





## URBAN SITES-----
### THIS IS VERY LONG SO SPLITTING INTO SMALLER LISTS

alt_best_mods_Q2.dist_list_lm <- list(
### Peduncles
peds_lm_subtr_03, peds_lm_subtr_04, peds_lm_subtr_07, peds_lm_subtr_08,
  ### Pollinia
poll_lm_subtr_02, poll_lm_subtr_03, poll_lm_subtr_04, poll_lm_subtr_08,
  ### Pods
pods_lm_subtr_03, pods_lm_subtr_05,
  ### Pods/Peduncle
podsperped_lm_subtr_03, podsperped_lm_subtr_05)


alt_best_mods_Q2.dist_list_lm.peds <- list(
### Peduncles
peds_lm_subtr_03, peds_lm_subtr_04, peds_lm_subtr_07, peds_lm_subtr_08)


alt_best_mods_Q2.dist_list_lm.poll <- list(
  ### Pollinia
poll_lm_subtr_02, poll_lm_subtr_03, poll_lm_subtr_04, poll_lm_subtr_08)


alt_best_mods_Q2.dist_list_lm.pods_podsperped <- list(
  ### Pods
pods_lm_subtr_03, pods_lm_subtr_05,
  ### Pods/Peduncle
podsperped_lm_subtr_03, podsperped_lm_subtr_05)


lapply(alt_best_mods_Q2.dist_list_lm.peds, tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('SS' = 2,
                  'X2' = 3,
                  'p' = 4,
                  'SS ' = 5,
                  'X2 ' = 6,
                  'p ' = 7,
                  'SS  ' = 8,
                  'X2  ' = 9,
                  'p  ' = 10,
                  'SS   ' = 11,
                  'X2   ' = 12,
                  'p   ' = 13) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Inflorescences, Alt. Model 1",
                 "Inflorescences, Alt. Model 2",
                 "Inflorescences, Alt. Model 3",
                 "Inflorescences, Alt. Model 4"),
      colwidths = c(1, 3, 3, 3, 3)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:13, align = "center", part = "body") %>%
    align(j = 2:13, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2  ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2   ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 3) %>%
  width(j = 2:13, width = 1) %>%
  italic(i = 2, j = 2:13, part = "header") %>%
  add_footer_lines("Table X: Results from alternative general linear models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on inflorescences. Urbanization was quantified via distance to city center and only urban populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 1: ",
                          AIC(peds_lm_subtr_03) %>% round(., 3))) %>% 
  add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 2: ",
                          AIC(peds_lm_subtr_04) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 3: ",
                          AIC(peds_lm_subtr_07) %>% round(., 3))) %>% 
  add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 4: ",
                          AIC(peds_lm_subtr_08) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Alternative_Models/Q2_Dist_ANOVA_altmodels_lm_inflorescences.png"))



lapply(alt_best_mods_Q2.dist_list_lm.poll, tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('SS' = 2,
                  'X2' = 3,
                  'p' = 4,
                  'SS ' = 5,
                  'X2 ' = 6,
                  'p ' = 7,
                  'SS  ' = 8,
                  'X2  ' = 9,
                  'p  ' = 10,
                  'SS   ' = 11,
                  'X2   ' = 12,
                  'p   ' = 13) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Pollinaria Removed, Alt. Model 1",
                 "Pollinaria Removed, Alt. Model 2",
                 "Pollinaria Removed, Alt. Model 3",
                 "Pollinaria Removed, Alt. Model 4"),
      colwidths = c(1, 3, 3, 3, 3)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:13, align = "center", part = "body") %>%
    align(j = 2:13, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2  ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2   ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 3.3) %>%
  width(j = 2:13, width = 1) %>%
  italic(i = 2, j = 2:13, part = "header") %>%
  add_footer_lines("Table X: Results from alternative general linear models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on pollinaria removed. Urbanization was quantified via distance to city center and only urban populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC, Pollinaria Removed, Alt. Model 1: ",
                          AIC(poll_lm_subtr_02) %>% round(., 3))) %>% 
  add_footer_lines(paste0("AIC, Pollinaria Removed, Alt. Model 2: ",
                          AIC(poll_lm_subtr_03) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Pollinaria Removed, Alt. Model 3: ",
                          AIC(poll_lm_subtr_04) %>% round(., 3))) %>% 
  add_footer_lines(paste0("AIC, Pollinaria Removed, Alt. Model 4: ",
                          AIC(poll_lm_subtr_08) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Alternative_Models/Q2_Dist_ANOVA_altmodels_lm_pollinaria.png"))



lapply(alt_best_mods_Q2.dist_list_lm.pods_podsperped, tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('SS' = 2,
                  'X2' = 3,
                  'p' = 4,
                  'SS ' = 5,
                  'X2 ' = 6,
                  'p ' = 7,
                  'SS  ' = 8,
                  'X2  ' = 9,
                  'p  ' = 10,
                  'SS   ' = 11,
                  'X2   ' = 12,
                  'p   ' = 13) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Follicles, Alt. Model 1",
                 "Follicles, Alt. Model 2",
                 "Follicles per Inflorescence, Alt. Model 1",
                 "Follicles per Inflorescence, Alt. Model 2"),
      colwidths = c(1, 3, 3, 3, 3)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:13, align = "center", part = "body") %>%
    align(j = 2:13, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2  ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2   ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 3.3) %>%
  width(j = 2:13, width = 1) %>%
  italic(i = 2, j = 2:13, part = "header") %>%
  add_footer_lines("Table X: Results from alternative general linear models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on follicles and mean no. follicles per inflorescence. Urbanization was quantified via distance to city center and only urban populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC, Follicles, Alt. Model 1: ",
                          AIC(pods_lm_subtr_03) %>% round(., 3))) %>% 
  add_footer_lines(paste0("AIC, Follicles, Alt. Model 2: ",
                          AIC(pods_lm_subtr_05) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 1: ",
                          AIC(podsperped_lm_subtr_03) %>% round(., 3))) %>% 
  add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 2: ",
                          AIC(podsperped_lm_subtr_05) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Alternative_Models/Q2_Dist_ANOVA_altmodels_lm_follicles_and_follperinflor.png"))






# URB_SCORE-----
## ALL SITES-----

alt_best_mods_Q1.urbscore_list_lm <- list(
### Peduncles
 u_peds_lm_gradient_02,  
### Pollinia
  u_poll_lm_gradient_01,
### Pods
 u_pods_lm_gradient_01,
### Pods/Peduncle
u_podsperped_lm_gradient_01

)



lapply(alt_best_mods_Q1.urbscore_list_lm, tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('SS' = 2,
                  'X2' = 3,
                  'p' = 4,
                  'SS ' = 5,
                  'X2 ' = 6,
                  'p ' = 7,
                  'SS  ' = 8,
                  'X2  ' = 9,
                  'p  ' = 10,
                  'SS   ' = 11,
                  'X2   ' = 12,
                  'p   ' = 13) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Inflorescences, Alt. Model 1",
                 "Pollinaria Removed, Alt. Model 1",
                 "Follicles, Alt. Model 1",
                 "Follicles per Inflorescence, Alt. Model 1"),
      colwidths = c(1, 3, 3, 3, 3)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:13, align = "center", part = "body") %>%
    align(j = 2:13, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2  ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2   ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 2.2) %>%
  width(j = 2:13, width = 1) %>%
  italic(i = 2, j = 2:13, part = "header") %>%
  add_footer_lines("Table X: Results from alternative general linear models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on 4 traits: inflorescences, pollinaria removed, follicles, and mean no. follicles per inflorescence. Urbanization was quantified via urbanization score and all populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 1: ",
                          AIC(u_peds_lm_gradient_02) %>% round(., 3))) %>% 
  add_footer_lines(paste0("AIC, Pollinaria Removed, Alt. Model 1: ",
                          AIC(u_poll_lm_gradient_01) %>% round(., 3))) %>%  add_footer_lines(paste0("AIC, Follicles, Alt. Model 1: ",
                          AIC(u_pods_lm_gradient_01) %>% round(., 3))) %>% 
  add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 1: ",
                          AIC(u_podsperped_lm_gradient_01) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Alternative_Models/Q1_Urbscore_ANOVA_altmodels_lm.png"))



## URBAN SITES-----

### THIS IS VERY LONG SO SPLITTING INTO SMALLER LISTS
alt_best_mods_Q2.urbscore_list_lm <- list(
### Peduncles 
  u_peds_lm_subtr_03, u_peds_lm_subtr_04, u_peds_lm_subtr_07, u_peds_lm_subtr_08, 
### Pollinia
u_poll_lm_subtr_03,
### Pods
 u_poll_lm_subtr_04, u_pods_lm_subtr_03, u_pods_lm_subtr_04, u_pods_lm_subtr_07, u_pods_lm_subtr_08,
### Pods/Peduncle
 u_podsperped_lm_subtr_03, u_podsperped_lm_subtr_04, u_podsperped_lm_subtr_05, u_podsperped_lm_subtr_06, u_podsperped_lm_subtr_08)




alt_best_mods_Q2.urbscore_list_lm.peds <- list(
### Peduncles 
  u_peds_lm_subtr_03, u_peds_lm_subtr_04, u_peds_lm_subtr_07, u_peds_lm_subtr_08)


alt_best_mods_Q2.urbscore_list_lm.poll <- list(
### Pollinia
u_poll_lm_subtr_03, u_poll_lm_subtr_04)


alt_best_mods_Q2.urbscore_list_lm.pods <- list(
### Pods
 u_pods_lm_subtr_03, u_pods_lm_subtr_04, u_pods_lm_subtr_07, u_pods_lm_subtr_08)


alt_best_mods_Q2.urbscore_list_lm.podsperped <- list(
### Pods/Peduncle
 u_podsperped_lm_subtr_03, u_podsperped_lm_subtr_04, u_podsperped_lm_subtr_05, u_podsperped_lm_subtr_06, u_podsperped_lm_subtr_08)



lapply(alt_best_mods_Q2.urbscore_list_lm.peds, tidy_sb) %>%
  lapply(., as.data.frame) %>%
  purrr::reduce(full_join, by = "Predictor") %>%
  arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('SS' = 2,
                  'X2' = 3,
                  'p' = 4,
                  'SS ' = 5,
                  'X2 ' = 6,
                  'p ' = 7,
                  'SS  ' = 8,
                  'X2  ' = 9,
                  'p  ' = 10,
                  'SS   ' = 11,
                  'X2   ' = 12,
                  'p   ' = 13) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Inflorescences, Alt. Model 1",
                 "Inflorescences, Alt. Model 2",
                 "Inflorescences, Alt. Model 3",
                 "Inflorescences, Alt. Model 4"),
      colwidths = c(1, 3, 3, 3, 3)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:13, align = "center", part = "body") %>%
    align(j = 2:13, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2  ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2   ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 3) %>%
  width(j = 2:13, width = 1) %>%
  italic(i = 2, j = 2:13, part = "header") %>%
  add_footer_lines("Table X: Results from alternative general linear models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on inflorescences. Urbanization was quantified via urbanization score and only urban populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
    add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 1: ",
                          AIC(u_peds_lm_subtr_03) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 2: ",
                          AIC(u_peds_lm_subtr_04) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 3: ",
                          AIC(u_peds_lm_subtr_07) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 4: ",
                          AIC(u_peds_lm_subtr_08) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Alternative_Models/Q2_Urbscore_ANOVA_altmodels_lm_inflors.png"))



lapply(alt_best_mods_Q2.urbscore_list_lm.poll, tidy_sb) %>%
  lapply(., as.data.frame) %>%
  purrr::reduce(full_join, by = "Predictor") %>%
  arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('SS' = 2,
                  'X2' = 3,
                  'p' = 4,
                  'SS ' = 5,
                  'X2 ' = 6,
                  'p ' = 7) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Pollinaria Removed, Alt. Model 1",
                 "Pollinaria Removed, Alt. Model 2"),
      colwidths = c(1, 3, 3)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:7, align = "center", part = "body") %>%
    align(j = 2:7, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 3) %>%
  width(j = 2:7, width = 1) %>%
  italic(i = 2, j = 2:7, part = "header") %>%
  add_footer_lines("Table X: Results from alternative general linear models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on pollinaria removed. Urbanization was quantified via urbanization score and only urban populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
    add_footer_lines(paste0("AIC, Pollinaria Removed, Alt. Model 1: ",
                          AIC(u_poll_lm_subtr_03) %>% round(., 3))) %>%   
    add_footer_lines(paste0("AIC, Pollinaria Removed, Alt. Model 2: ",
                          AIC(u_poll_lm_subtr_04) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Alternative_Models/Q2_Urbscore_ANOVA_altmodels_lm_pollinaria.png"))



lapply(alt_best_mods_Q2.urbscore_list_lm.pods, tidy_sb) %>%
  lapply(., as.data.frame) %>%
  purrr::reduce(full_join, by = "Predictor") %>%
  arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('SS' = 2,
                  'X2' = 3,
                  'p' = 4,
                  'SS ' = 5,
                  'X2 ' = 6,
                  'p ' = 7,
                  'SS  ' = 8,
                  'X2  ' = 9,
                  'p  ' = 10,
                  'SS   ' = 11,
                  'X2   ' = 12,
                  'p   ' = 13) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Follicles, Alt. Model 1",
                 "Follicles, Alt. Model 2",
                 "Follicles, Alt. Model 3",
                 "Follicles, Alt. Model 4"),
      colwidths = c(1, 3, 3, 3, 3)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:13, align = "center", part = "body") %>%
    align(j = 2:13, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2  ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2   ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 3) %>%
  width(j = 2:13, width = 1) %>%
  italic(i = 2, j = 2:13, part = "header") %>%
  add_footer_lines("Table X: Results from alternative general linear models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on follicles. Urbanization was quantified via urbanization score and only urban populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
    add_footer_lines(paste0("AIC, Follicles, Alt. Model 1: ",
                          AIC(u_pods_lm_subtr_03) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Follicles, Alt. Model 2: ",
                          AIC(u_pods_lm_subtr_04) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Follicles, Alt. Model 3: ",
                          AIC(u_pods_lm_subtr_07) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Follicles, Alt. Model 4: ",
                          AIC(u_pods_lm_subtr_08) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Alternative_Models/Q2_Urbscore_ANOVA_altmodels_lm_follicles.png"))




lapply(alt_best_mods_Q2.urbscore_list_lm.podsperped, tidy_sb) %>%
  lapply(., as.data.frame) %>%
  purrr::reduce(full_join, by = "Predictor") %>%
  arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('SS' = 2,
                  'X2' = 3,
                  'p' = 4,
                  'SS ' = 5,
                  'X2 ' = 6,
                  'p ' = 7,
                  'SS  ' = 8,
                  'X2  ' = 9,
                  'p  ' = 10,
                  'SS   ' = 11,
                  'X2   ' = 12,
                  'p   ' = 13,
                  'SS    ' = 14,
                  'X2    ' = 15,
                  'p    ' = 16) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Follicles per Inflorescence, Alt. Model 1",
                 "Follicles per Inflorescence, Alt. Model 2",
                 "Follicles per Inflorescence, Alt. Model 3",
                 "Follicles per Inflorescence, Alt. Model 4",
                 "Follicles per Inflorescence, Alt. Model 5"),
      colwidths = c(1, 3, 3, 3, 3, 3)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:16, align = "center", part = "body") %>%
    align(j = 2:16, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2  ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2   ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2    ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2    ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    fontsize(size = 12, part = "header") %>%
    fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 3) %>%
  width(j = 2:16, width = 1) %>%
  italic(i = 2, j = 2:16, part = "header") %>%
  add_footer_lines("Table X: Results from alternative general linear models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on mean no. follicles per inflorescence. Urbanization was quantified via urbanization score and only urban populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
    add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 1: ",
                          AIC(u_podsperped_lm_subtr_03) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 2: ",
                          AIC(u_podsperped_lm_subtr_04) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 3: ",
                          AIC(u_podsperped_lm_subtr_05) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 4: ",
                          AIC(u_podsperped_lm_subtr_06) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 5: ",
                          AIC(u_podsperped_lm_subtr_08) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Alternative_Models/Q2_Urbscore_ANOVA_altmodels_lm_folliclesperinflor.png"))


```

## Alternative (AIC<2 from best) models: height
```{r}

# City_dist x all sites: height_lm_gradient_01
make_Q1Q2_Anova.height_lm(height_lm_gradient_01) %>%
  width(j = 1, width = 2.4) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from an alternative general linear model within 2 AIC from the best model examining the effects of urbanization on plant height. Urbanization was quantified via distance to city center and all populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 1: ",
                          AIC(height_lm_gradient_01) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Alternative_Models/Q1_Dist_ANOVA_altmodels_HEIGHT_lm.png"))


# City_dist x urban sites: height_lm_subtr_03, height_lm_subtr_05, height_lm_subtr_06, height_lm_subtr_07
lapply(list(height_lm_subtr_03,
            height_lm_subtr_05,
            height_lm_subtr_06,
            height_lm_subtr_07), tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('SS' = 2,
                  'X2' = 3,
                  'p' = 4,
                  'SS ' = 5,
                  'X2 ' = 6,
                  'p ' = 7,
                  'SS  ' = 8,
                  'X2  ' = 9,
                  'p  ' = 10,
                  'SS   ' = 11,
                  'X2   ' = 12,
                  'p   ' = 13) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Height, Alt. Model 1",
                 "Height, Alt. Model 2",
                 "Height, Alt. Model 3",
                 "Height, Alt. Model 4"),
      colwidths = c(1, 3, 3, 3, 3)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:13, align = "center", part = "body") %>%
    align(j = 2:13, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2  ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2   ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 3.5) %>%
  width(j = 2:13, width = 1) %>%
  italic(i = 2, j = 2:13, part = "header") %>%
  add_footer_lines("Table X: Results from alternative general linear models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on plant height. Urbanization was quantified via distance to city center and only urban populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
    add_footer_lines(paste0("AIC, Height, Alt. Model 1: ",
                          AIC(height_lm_subtr_03) %>% round(., 3))) %>%     add_footer_lines(paste0("AIC, Height, Alt. Model 2: ",
                          AIC(height_lm_subtr_05) %>% round(., 3))) %>%     add_footer_lines(paste0("AIC, Height, Alt. Model 3: ",
                          AIC(height_lm_subtr_06) %>% round(., 3))) %>%     add_footer_lines(paste0("AIC, Height, Alt. Model 4: ",
                          AIC(height_lm_subtr_07) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Alternative_Models/Q2_Dist_ANOVA_altmodels_HEIGHT_lm.png"))



# Urb_score x all sites: u_height_lm_gradient_01
make_Q1Q2_Anova.height_lm(u_height_lm_gradient_01) %>%
  width(j = 1, width = 2.4) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from an alternative general linear model within 2 AIC from the best model examining the effects of urbanization on plant height. Urbanization was quantified via urbanization score and all populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>% 
  add_footer_lines(paste0("AIC, Height, Alt. Model 1: ",
                          AIC(u_height_lm_gradient_01) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Alternative_Models/Q1_Urbscore_ANOVA_altmodels_HEIGHT_lm.png"))


# Urb_score x urban sites: u_height_lm_subtr_04, u_height_lm_subtr_05
lapply(list(u_height_lm_subtr_04,
            u_height_lm_subtr_05), tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('SS' = 2,
                  'X2' = 3,
                  'p' = 4,
                  'SS ' = 5,
                  'X2 ' = 6,
                  'p ' = 7) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Height, Alt. Model 1",
                 "Height, Alt. Model 2"),
      colwidths = c(1, 3, 3)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:7, align = "center", part = "body") %>%
    align(j = 2:7, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 3.5) %>%
  width(j = 2:7, width = 1) %>%
  italic(i = 2, j = 2:7, part = "header") %>%
  add_footer_lines("Table X: Results from alternative general linear models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on plant height. Urbanization was quantified via urbanization score and only urban populations were included. Shown are sum of squares (SS), maximum likelihood chi-square (X2), and p-values (p) obtained from a type II ANOVA.") %>%
    add_footer_lines(paste0("AIC, Height, Alt. Model 1: ",
                          AIC(height_lm_subtr_03) %>% round(., 3))) %>%     add_footer_lines(paste0("AIC, Height, Alt. Model 2: ",
                          AIC(height_lm_subtr_05) %>% round(., 3))) %>%     add_footer_lines(paste0("AIC, Height, Alt. Model 3: ",
                          AIC(height_lm_subtr_06) %>% round(., 3))) %>%     add_footer_lines(paste0("AIC, Height, Alt. Model 4: ",
                          AIC(height_lm_subtr_07) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/Linear_Models/Alternative_Models/Q2_Urbscore_ANOVA_altmodels_HEIGHT_lm.png"))

```


