---
title: "Chapter One- Observational Study of Milkweed Reproductive Success along Toronto Urban-Rural Gradient."
author: "Sophie Breitbart"
date: "12/22/2020"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console

WHEN TOTALLY DONE, type this:
renv::activate()
renv::snapshot()
---

For code comparing variable means  across years, urban to rural terminii, and subtransects, run "set up notebook" chunk, "Linear Models (lmer and glmer)" chunk under Results, and then open "ggpredict_figures.R" script.

# Set up notebook
## Install, load packages
```{r message=FALSE, warning=FALSE}
# devtools::install_github("cardiomoon/ggiraphExtra")
# devtools::install_github("dkahle/ggmap")
# devtools::install_github("hadley/devtools")
# install.packages("agricolae")
# install.packages("BH")
# install.packages("car")
# install.packages("cowplot")
# install.packages("DHARMa")
# install.packages("digest", type="source")
# install.packages("dplyr")
# install.packages("factoextra")
# install.packages("flextable")
# install.packages("geosphere")
# install.packages("ggiraphExtra")
# install.packages("ggpubr")
# install.packages("ggsn")
# install.packages("ggspatial")
# install.packages("GISTools")
# install.packages("ISLR")
# install.packages("janitor")
# install.packages("lindia")
# install.packages("lme4")
# install.packages("lmerTest")
# install.packages("mnormt")
# install.packages("patchwork")
# install.packages("plogr")
# install.packages("psych")
# install.packages("RcppEigen")
# install.packages("rpart")
# install.packages('sjPlot')
# install.packages('stargazer')
# install.packages("swirl")
# install.packages("tibble")
# install.packages("tidyverse")
# install.packages("vegan")
# install.packages("XLConnect")
# install.packages('backports')
# install.packages(c("slidify", "ggplot2", "devtools"))
# install.packages('maps')
# install.packages('rmarkdown')
# install_github("vqv/ggbiplot")
# library("FactoMineR")
# library("tibble", lib.loc="~/R/win-library/3.5")
# library(agricolae)
# library(apaTables)
library(broom.mixed)
library(car)
library(data.table)
# library(devtools)
library(DHARMa)
library(dplyr)
library(e1071)
# library(factoextra)
library(flextable)
library(forcats)
library(geosphere)
# library(ggbiplot)
library(ggeffects)
library(ggiraphExtra)
library(ggmap)
library(ggpubr)
library(ggsn)
library(ggspatial)
library(GISTools)
library(glmmTMB)
library(gridExtra)
library(here)
library(Hmisc)
# library(hrbrthemes)
# library(ISLR)
# library(janitor)
# library(lindia)
library(lme4)
library(lmerTest)
# library(lsmeans)
library(MASS)
library(magrittr)
library(multcomp)
# library(MuMIn)
library(nlme)
library(officer)
library(patchwork)
library(plyr)
library(reshape)
library(reshape2)
library(Rmisc)
library(rpart)
library(sjPlot)
# library(stargazer)
library(tibble)
library(tidyr)
library(tidyverse)
library(vegan)
library(viridis)
library(xlsx)
require(ggiraph)
require(ggiraphExtra)
require(ggplot2)
# require(MASS)
require(scales)

```

## Import data
```{r, import}
long_Transect_Data_18_19 <-
  read.csv(here::here("./clean_data/long_Transect_Data_18_19.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)


AvgVars_notNA_Poll_18_19 <-
  read.csv(here::here("./clean_data/AvgVars_notNA_Poll_18_19.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)

fertile_long <-
  read.csv(here::here("./clean_data/fertile_long.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)


fertile <-
  read.csv(here::here("./clean_data/fertile.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)

fertile_pops_all <-
  read.csv(here::here("./clean_data/fertile_pops_all.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)
```
## Make sure classes are correct
```{r}
# long_Transect_Data_18_19-----

str(long_Transect_Data_18_19)

# Make columns numeric
long_Transect_Data_18_19$Inflor <- as.numeric(as.character(long_Transect_Data_18_19$Inflor))
long_Transect_Data_18_19$Pollinia_removed <- as.numeric(as.character(long_Transect_Data_18_19$Pollinia_removed))
long_Transect_Data_18_19$Flower <- as.numeric(as.character(long_Transect_Data_18_19$Flower))

# make patch ID, plant, year, and inflor cols factors
long_Transect_Data_18_19$Patch_ID <- as.factor(as.character(long_Transect_Data_18_19$Patch_ID))
long_Transect_Data_18_19$Plant_Num <- as.factor(as.character(long_Transect_Data_18_19$Plant_Num))
long_Transect_Data_18_19$Inflor <- as.factor(as.character(long_Transect_Data_18_19$Inflor))
long_Transect_Data_18_19$Year <- as.factor(as.character(long_Transect_Data_18_19$Year))

# make pollinia removed an integer
long_Transect_Data_18_19$Pollinia_removed <- as.integer(as.character(long_Transect_Data_18_19$Pollinia_removed))


# AvgVars_notNA_Poll_18_19------

str(AvgVars_notNA_Poll_18_19)

# make cols factors
AvgVars_notNA_Poll_18_19$Patch_ID <- as.factor(as.character(AvgVars_notNA_Poll_18_19$Patch_ID))
AvgVars_notNA_Poll_18_19$Year <- as.factor(as.character(AvgVars_notNA_Poll_18_19$Year))


# fertile_long-----

str(fertile_long)

# Make columns numeric
fertile_long$Inflor <- as.numeric(as.character(fertile_long$Inflor))
fertile_long$Pollinia_removed <- as.numeric(as.character(fertile_long$Pollinia_removed))
fertile_long$Flower <- as.numeric(as.character(fertile_long$Flower))

# make patch ID, plant, year, and inflor cols factors
fertile_long$Patch_ID <- as.factor(as.character(fertile_long$Patch_ID))
fertile_long$Plant_Num <- as.factor(as.character(fertile_long$Plant_Num))
fertile_long$Inflor <- as.factor(as.character(fertile_long$Inflor))
fertile_long$Year <- as.factor(as.character(fertile_long$Year))

str(fertile_long)


# fertile-----

str(fertile)

# make patch ID, plant, year, and inflor cols factors
fertile$Patch_ID <- as.factor(as.character(fertile$Patch_ID))
fertile$Plant_Num <- as.factor(as.character(fertile$Plant_Num))
fertile$Year <- as.factor(as.character(fertile$Year))

str(fertile)


# fertile_pops_all-----

str(fertile_pops_all)

fertile_pops_all$Year <- as.factor(as.character(fertile_pops_all$Year))

str(fertile_pops_all)

```

## Variable key

* Average_Pollinia
: Average number of pollinia removed per flower, per plant, per population (0-5). Was measured in July of 2018 and 2019.

* City_dist
: Population's distance from urban center (Yonge & Dundas in Toronto), in kilometers.

* Transect_ID
: + Northern urban transect,
: + Southern urban transect (which follows green corridors including railroad tracks, trails, hydro lines, etc.), or
: + Rural transect.

    See [link](https://www.google.com/maps/d/u/0/edit?hl=en&mid=1T6o02xqdFY49LpaV5fgpNYcgUNfy6hWJ&ll=43.54856560494681%2C-79.7330821595105&z=10) for a map of the 3 transects.  
  
* Peduncles
: Average number of peduncles per plant per population

* Height_July
: Average height of sampled plants in July (when performing pollinia removal survey), in centimeters

* Plants_present_2018
: Number of plants present at the sampling site in 2018. Populations were spaced at least 500 meters apart to ensure population distinction.

* Height_Sept
: Average height of sampled plants in September (when performing follicle, peduncle survey), in centimeters

* Viable_Pods
: Average number of viable follciles per plant per population. These follicles were usually around 6-10 cm long, compared to aborted follicles, which were usually about 1 cm long and seemed to have stopped growing based on size and color (oftentimes brown/dried up).

* Total_Pods
: Average number of *combined* viable and aborted follciles per plant per population. In 2018, we did not distinguish between aborted and viable follicles, so this variable is used to compare follicle production over both years. Viable follicle production can only be measured for 2019 alone.

* nPlants
: Number of plants sampled per population.

* Average_pod_length
: Average length of all pods measured on surveyed plants in 2019, in centimeters. This data was not collected in 2018. In 2019, it was collected to understand whether there is a relationship between pod dimensions and seed number and/or seed mass. (As of October 2019, it seems there is a surprisingly weak relationship.)

# Methods
## Sampling design stats
### How many plants are within transects?
```{r}
# For the southern urban (green corridor) subtransect, these sites are within the green corridor: MW032, MW014, MW013, MW003, MW004, MW069, MW050
# **MW013 isn't technically within the green corridor itself but it's perpendicular and connected through a different green corridor, so I'm counting it. It's ~100m from the corridor.

# 29 southern urban sites total, 7 within the corridor itself (<25%)
```

### Histograms of green corridor site proximities
```{r}
library(ggplot2)
library(dplyr)

corridor_data <- read.csv(here("./Corridor_Analysis/SouthernUrbanSites_ProximitytoCorridor.csv"),  header=T, na.strings=c("","NA"))


corridor_data %>%
  ggplot( aes(x=Distance, fill = Corr_or_greenspace)) +
    geom_histogram( alpha=0.5, position = 'identity', binwidth = 50) +
  facet_wrap(~Corr_or_greenspace) +
  scale_x_continuous(name="Site Distance to...",
                     breaks = seq(0,2800,500),
                     labels = seq(0,2800,500)) +
  theme(legend.position = 'none')

corr_dist <- (corridor_data$Distance)
bins <- seq(0,2700,by=50)
corr_table <- cut(corr_dist,bins)
# transform(table(corr_table))

corr_table1<- with(corridor_data, table(Corr_or_greenspace, cut(Distance, bins, include.lowest = TRUE)))
# transform(corr_table1)
library(data.table)
corr_df <- setDT(corridor_data)[, .N, by = .(Corr_or_greenspace, Bin = cut(Distance, bins, include.lowest = TRUE))] 

corr_df_spread <- tidyr::spread(corr_df, Corr_or_greenspace, N)

corr_df_spread$Percent_Corridor <- as.numeric(corr_df_spread$Corridor) / .34
corr_df_spread$Percent_Greenspace <- as.numeric(corr_df_spread$Greenspace) / .34
corr_df_spread[is.na(corr_df_spread)] <- 0
corr_df_spread$Perc_Corr_Cumulative <- cumsum(corr_df_spread[, 4])
corr_df_spread$Perc_Greensp_Cumulative <- cumsum(corr_df_spread[, 5])

write.csv(corr_df_spread, here::here("./Corridor_Analysis/corr_df_spread.csv"), row.names = FALSE)

```

# Results
## Questions 1-2 (Milkweed data)
### Model Selection
#### Linear Models (lmer and glmer)
##### Peduncles
###### GLMER (be sure to indicate that model is zero-inflated and minus 1, so results need to be explained with that in mind!!)
####### City_dist, not urb_score
######## All sites: NO TRANSFORMATION NEEDED
```{r}
# OLD- BEFORE ZERO-INFLATED MODEL -----
# peds_glmer_gradient_01 <- glmer(Peduncles ~ (1|Patch_ID) +
#                                   
#                                   City_dist:Year +
#                                   City_dist +
#                                   Year,
#                                 
#                                 fertile,
#                                 family = "poisson",
#                                 glmerControl(optimizer="bobyqa",
#                                              optCtrl = list(maxfun = 100000))) # not converging, but I don't get error messages when I use glmmTMB yet I get nearly identical ANOVA results, so I'll stick with this
# 
# # # the glmmTMB anova, for reference:
# # glmmTMB::Anova.glmmTMB(glmmTMB::glmmTMB(Peduncles ~ (1|Patch_ID) + City_dist:Year +
# #                                   City_dist +
# #                                   Year,
# #                                 data = fertile,
# #                                 family = "poisson"), type = "II")
# 
# 
# # all main effects and secondary interactions
# peds_glmer_gradient_02 <- update(peds_glmer_gradient_01,
#                                  . ~ . -City_dist:Year)
# 
# peds_glmer_gradient_list <- list(peds_glmer_gradient_01,
#                                  peds_glmer_gradient_02)
# 
# formulas_peds <- data.frame(matrix(ncol = 0, nrow = 2))
# formulas_peds$Model <- NA
# formulas_peds$Formula <- NA
# formulas_peds$r.squaredGLMM_R2m <- NA
# formulas_peds$r.squaredGLMM_R2c <- NA
# 
# for (i in 1:length(peds_glmer_gradient_list)) {
#   formulas_peds[i, 1] <- toString(i)
#   formulas_peds[i, 2] <- toString(formula(peds_glmer_gradient_list[[i]]))
#   formulas_peds[i, 3] <- r.squaredGLMM(peds_glmer_gradient_list[[i]])[1,1] %>%
#     round(digits = 3)
#   formulas_peds[i, 4] <- r.squaredGLMM(peds_glmer_gradient_list[[i]])[1,2] %>%
#     round(digits = 3)
# }
# 
# glance_peds <- do.call(rbind,
#                        lapply(peds_glmer_gradient_list,
#                               broom.mixed::glance)) %>%
#   as.data.frame() %>%
#   mutate(BestModels = case_when(
#     AIC == min(AIC, na.rm=T) ~ "*",
#     AIC <= 2 + min(AIC, na.rm=T) ~ "*",
#     TRUE ~ "")) 
# 
# bound_peds <- bind_cols(formulas_peds,
#                         glance_peds %>%
#                           dplyr::select(AIC, BestModels)) # Model 1 lowest AIC
# 
# 
# summary(peds_glmer_gradient_01)
# peds_glmer_gradient_01_anova <- car::Anova(peds_glmer_gradient_01) %T>%
#   print() # interaction sig
# 
# # check residuals
# plot(simulateResiduals(peds_glmer_gradient_01)) # not normal... looks underdispersed
# testDispersion(simulateResiduals(peds_glmer_gradient_01)) # yup
# 
# # try generalized Poisson distribution w/glmmTMB
# peds_glmer_gradient_01.1 <- glmmTMB(Peduncles ~ (1|Patch_ID) +
#                                   
#                                   City_dist:Year +
#                                   City_dist +
#                                   Year,
#                                 
#                                 fertile,
#                                 family = "genpois")
# 
# # check residuals
# plot(simulateResiduals(peds_glmer_gradient_01.1)) # didn't help. try negbin
# 
# 
# peds_glmer_gradient_01.2 <- glmmTMB(Peduncles ~ (1|Patch_ID) +
#                                   City_dist:Year +
#                                   City_dist +
#                                   Year,
#                                 fertile,
#                                 family = nbinom1())
# # check residuals
# plot(simulateResiduals(peds_glmer_gradient_01.2)) # didn't help. tried 'compois' (Conway-Maxwell Poisson distribution) which didn't help either.
# 
# ## Hurdle Poisson model
# m1 <- glmmTMB(Peduncles ~ (1|Patch_ID) +
#                                   City_dist:Year +
#                                   City_dist +
#                                   Year,
#                                 fertile,
#               zi = ~City_dist:Year + City_dist + Year,
#               family = truncated_poisson)
# 
# # check residuals
# plot(simulateResiduals(m1)) # didn't help

# hist(AvgVars_byPatch$Peduncles, breaks = 16)

# GOING TO SUBTRACT 1 AND THEN USE ZERO-INFLATED MODEL OR HURDLE MODEL TO DEAL WITH ONE-INFLATION-----

fertile$Peduncles_minus1 <- fertile$Peduncles - 1

## Hurdle Poisson model
peds_glmer_gradient_01 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                  City_dist:Year +
                                  City_dist +
                                  Year,
                                fertile,
              zi = ~City_dist:Year + City_dist + Year,
              family = truncated_poisson)

# check residuals
plot(simulateResiduals(peds_glmer_gradient_01)) # BETTER! will stick with this one


# all main effects and secondary interactions
peds_glmer_gradient_02 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                  City_dist +
                                  Year,
                                fertile,
              zi = ~City_dist + Year,
              family = truncated_poisson)

peds_glmer_gradient_list <- list(peds_glmer_gradient_01,
                                 peds_glmer_gradient_02)

formulas_peds <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_peds$Model <- NA
formulas_peds$Formula <- NA
# formulas_peds$r.squaredGLMM_R2m <- NA
# formulas_peds$r.squaredGLMM_R2c <- NA

# COMMENTING OUT R-SQ BC r.squaredGLMM cannot (yet) handle 'glmmTMB' object with zero-inflation

for (i in 1:length(peds_glmer_gradient_list)) {
  formulas_peds[i, 1] <- toString(i)
  formulas_peds[i, 2] <- toString(formula(peds_glmer_gradient_list[[i]]))
  # formulas_peds[i, 3] <- r.squaredGLMM(peds_glmer_gradient_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_peds[i, 4] <- r.squaredGLMM(peds_glmer_gradient_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_peds <- do.call(rbind,
                       lapply(peds_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ ""))

bound_peds <- bind_cols(formulas_peds,
                        glance_peds %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC


summary(peds_glmer_gradient_01)
peds_glmer_gradient_01_anova <- car::Anova(peds_glmer_gradient_01) %T>%
  print() # year marg sig

# check residuals
plot(simulateResiduals(peds_glmer_gradient_01)) # again, fine


```

######## Urban sites: NO TRANSFORMATION NEEDED
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
# peds_glmer_subtr_01 <- glmer(Peduncles ~ (1|Patch_ID) +
#                                
#                                City_dist:Year:Transect_ID + 
#                                
#                                Year:Transect_ID + 
#                                City_dist:Transect_ID +
#                                City_dist:Year +
#                                
#                                City_dist +
#                                Year +
#                                Transect_ID,
#                              
#                              fertile %>%
#                                filter(Transect_ID != 'Rural'),
#                              family = "poisson",
#                              glmerControl(optimizer="bobyqa",
#                                           optCtrl = list(maxfun = 100000)))
# THIS MODEL IS ALSO ONE-INFLATED AND NEEDS THE SAME TREATMENT AS THE MODELS ABOVE

# Full model
peds_glmer_subtr_01 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID +
                                City_dist:Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID +
                                City_dist:Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and secondary interactions
peds_glmer_subtr_02 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 2/3 secondary interactions
peds_glmer_subtr_03 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_04 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_05 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year ,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year ,
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 1/3 secondary interactions
peds_glmer_subtr_06 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_07 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID ,
                                # City_dist:Year +
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID ,
                                # City_dist:Year +
                                # Year:Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_08 <-  glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year, 
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects
peds_glmer_subtr_09 <-  glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_list <- list(peds_glmer_subtr_01,
                               peds_glmer_subtr_02,
                               peds_glmer_subtr_03,
                               peds_glmer_subtr_04,
                               peds_glmer_subtr_05,
                               peds_glmer_subtr_06,
                               peds_glmer_subtr_07,
                               peds_glmer_subtr_08,
                               peds_glmer_subtr_09)

formulas_peds <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_peds$Model <- NA
formulas_peds$Formula <- NA
# formulas_peds$r.squaredGLMM_R2m <- NA
# formulas_peds$r.squaredGLMM_R2c <- NA

for (i in 1:length(peds_glmer_subtr_list)) {
  formulas_peds[i, 1] <- toString(i)
  formulas_peds[i, 2] <- toString(formula(peds_glmer_subtr_list[[i]]))
  # formulas_peds[i, 3] <- r.squaredGLMM(peds_glmer_subtr_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_peds[i, 4] <- r.squaredGLMM(peds_glmer_subtr_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_peds <- do.call(rbind,
                       lapply(peds_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_peds <- bind_cols(formulas_peds,
                        glance_peds %>%
                          dplyr::select(AIC, BestModels)) # Models 1, 3, 6 lowest AIC but best is 1

# check residuals
plot(simulateResiduals(peds_glmer_subtr_01)) # looks good
plot(simulateResiduals(peds_glmer_subtr_03)) # looks good
plot(simulateResiduals(peds_glmer_subtr_06)) # looks good


summary(peds_glmer_subtr_01)
peds_glmer_subtr_01_anova <- car::Anova(peds_glmer_subtr_01) %T>%
  print()

summary(peds_glmer_subtr_03)
peds_glmer_subtr_03_anova <- car::Anova(peds_glmer_subtr_03) %T>%
  print()

summary(peds_glmer_subtr_06)
peds_glmer_subtr_06_anova <- car::Anova(peds_glmer_subtr_06) %T>%
  print()


```


####### urb_score, not City_dist
######## All sites: NO TRANSFORMATION NEEDED
```{r}
# u_peds_glmer_gradient_1 <- glmer(as.numeric(Peduncles) ~ (1|Patch_ID) + Urb_score * Year,
#                                  fertile,
#                                  family = "poisson",
#                                  glmerControl(optimizer="bobyqa",
#                                               optCtrl = list(maxfun = 100000)))
# plot(simulateResiduals(u_peds_glmer_gradient_1)) # trying zero-inflated model like for city_dist models


## Hurdle Poisson model
u_peds_glmer_gradient_01 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                  Urb_score:Year +
                                  Urb_score +
                                  Year,
                                fertile,
              zi = ~City_dist:Year + City_dist + Year,
              family = truncated_poisson)

# check residuals
plot(simulateResiduals(u_peds_glmer_gradient_01)) # BETTER! will stick with this one


# all main effects and secondary interactions
u_peds_glmer_gradient_02 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                  Urb_score +
                                  Year,
                                fertile,
              zi = ~Urb_score + Year,
              family = truncated_poisson)

u_peds_glmer_gradient_list <- list(u_peds_glmer_gradient_01,
                                 u_peds_glmer_gradient_02)

formulas_u_peds <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_peds$Model <- NA
formulas_u_peds$Formula <- NA
# formulas_u_peds$r.squaredGLMM_R2m <- NA
# formulas_u_peds$r.squaredGLMM_R2c <- NA

# COMMENTING OUT R-SQ BC r.squaredGLMM cannot (yet) handle 'glmmTMB' object with zero-inflation

for (i in 1:length(u_peds_glmer_gradient_list)) {
  formulas_u_peds[i, 1] <- toString(i)
  formulas_u_peds[i, 2] <- toString(formula(u_peds_glmer_gradient_list[[i]]))
  # formulas_u_peds[i, 3] <- r.squaredGLMM(u_peds_glmer_gradient_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_u_peds[i, 4] <- r.squaredGLMM(u_peds_glmer_gradient_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_u_peds <- do.call(rbind,
                       lapply(u_peds_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ ""))

bound_u_peds <- bind_cols(formulas_u_peds,
                        glance_u_peds %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC


summary(u_peds_glmer_gradient_01)
u_peds_glmer_gradient_01_anova <- car::Anova(u_peds_glmer_gradient_01) %T>%
  print() # year marg sig

# check residuals
plot(simulateResiduals(u_peds_glmer_gradient_01)) # again, fine


```

######## Urban sites: NO TRANSFORMATION NEEDED
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
# u_peds_glmer_subtr_01 <- glmer(Peduncles ~ (1|Patch_ID) +
#                                
#                                Year:Transect_ID:Urb_score + 
#                                
#                                Year:Transect_ID + 
#                                Urb_score:Transect_ID +
#                                Urb_score:Year +
#                                
#                                Urb_score +
#                                Year +
#                                Transect_ID,
#                              
#                              fertile %>%
#                                filter(Transect_ID != 'Rural'),
#                              family = "poisson",
#                              glmerControl(optimizer="bobyqa",
#                                           optCtrl = list(maxfun = 100000)))
# THIS MODEL IS ALSO ONE-INFLATED AND NEEDS THE SAME TREATMENT AS THE MODELS ABOVE

# Full model
u_peds_glmer_subtr_01 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID +
                                Year:Transect_ID:Urb_score,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID +
                                Year:Transect_ID:Urb_score,
                              family = truncated_poisson)

# all main effects and secondary interactions
u_peds_glmer_subtr_02 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 2/3 secondary interactions
u_peds_glmer_subtr_03 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_04 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_05 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year ,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year ,
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 1/3 secondary interactions
u_peds_glmer_subtr_06 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_07 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score ,
                                # Urb_score:Year +
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score ,
                                # Urb_score:Year +
                                # Year:Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_08 <-  glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year, 
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects
u_peds_glmer_subtr_09 <-  glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_list <- list(u_peds_glmer_subtr_01,
                               u_peds_glmer_subtr_02,
                               u_peds_glmer_subtr_03,
                               u_peds_glmer_subtr_04,
                               u_peds_glmer_subtr_05,
                               u_peds_glmer_subtr_06,
                               u_peds_glmer_subtr_07,
                               u_peds_glmer_subtr_08,
                               u_peds_glmer_subtr_09)

formulas_u_peds <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_u_peds$Model <- NA
formulas_u_peds$Formula <- NA
# formulas_u_peds$r.squaredGLMM_R2m <- NA
# formulas_u_peds$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_peds_glmer_subtr_list)) {
  formulas_u_peds[i, 1] <- toString(i)
  formulas_u_peds[i, 2] <- toString(formula(u_peds_glmer_subtr_list[[i]]))
  # formulas_u_peds[i, 3] <- r.squaredGLMM(u_peds_glmer_subtr_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_u_peds[i, 4] <- r.squaredGLMM(u_peds_glmer_subtr_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_u_peds <- do.call(rbind,
                       lapply(u_peds_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_peds <- bind_cols(formulas_u_peds,
                        glance_u_peds %>%
                          dplyr::select(AIC, BestModels)) # Models 3,4,6 lowest AIC but best is 6

# check residuals
plot(simulateResiduals(u_peds_glmer_subtr_03)) # looks good
plot(simulateResiduals(u_peds_glmer_subtr_04)) # looks good
plot(simulateResiduals(u_peds_glmer_subtr_06)) # looks good


summary(u_peds_glmer_subtr_03)
u_peds_glmer_subtr_03_anova <- car::Anova(u_peds_glmer_subtr_03) %T>%
  print()

summary(u_peds_glmer_subtr_04)
u_peds_glmer_subtr_04_anova <- car::Anova(u_peds_glmer_subtr_04) %T>%
  print()

summary(u_peds_glmer_subtr_06)
u_peds_glmer_subtr_06_anova <- car::Anova(u_peds_glmer_subtr_06) %T>%
  print()


```

##### Pollinia
###### GLMER- no transformations needed
####### City_dist, not Urb_score
######## All sites
```{r}

# ## NOT CONVERGING- ERROR
# glmer(as.numeric(Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) + City_dist * Year,
#       long_Transect_Data_18_19,
#       family = "poisson",
#       glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))



# SEPARATE BY YEAR
## do this for only 2018-----
# no error
poll_glmer_gradient_01 <- glmer((Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) + City_dist,
                                long_Transect_Data_18_19 %>%
                                  filter(., Year == '2018'),
                                family = "poisson") %T>%
  simulateResiduals() %T>%
  plot() # looks good



## do this for only 2019-----
# no error
poll_glmer_gradient_02 <- glmer((Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) + City_dist,
                                long_Transect_Data_18_19 %>%
                                  filter(., Year == '2019'),
                                family = "poisson") %T>%
  simulateResiduals() %T>%
  plot() # looks good



# 2018 DATA
summary(poll_glmer_gradient_01)
poll_glmer_gradient_01_anova <- car::Anova(poll_glmer_gradient_01) %T>%
  print()
# city_dist sig


# 2019 DATA
summary(poll_glmer_gradient_02)
poll_glmer_gradient_02_anova <- car::Anova(poll_glmer_gradient_02) %T>%
  print()
# city_dist sig



poll_glmer_gradient_list <- list(poll_glmer_gradient_01,
                                 poll_glmer_gradient_02)

# - ----- GLMMTMB
poll_glmer_gradient_01.v2 <- glmmTMB(as.numeric(Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) + City_dist * Year,
        long_Transect_Data_18_19,
        family = "poisson") # this works

# I've checked that glmer's annual results are identical to glmmtmb's, so I'll use glmmtmb for this Q.

```

######## Just urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
poll_glmer_subtr_01 <- glmer(Pollinia_removed ~ (1|Patch_ID/Plant_Num/Inflor) +
                               
                               City_dist:Year:Transect_ID + 
                               
                               Year:Transect_ID + 
                               City_dist:Transect_ID +
                               City_dist:Year +
                               
                               City_dist +
                               Year +
                               Transect_ID,
                             
                             long_Transect_Data_18_19 %>%
                               filter(Transect_ID != 'Rural'),
                             family = "poisson",
                             glmerControl(optimizer="bobyqa",
                                          optCtrl = list(maxfun = 100000)))

# all main effects and secondary interactions
poll_glmer_subtr_02 <- update(poll_glmer_subtr_01,
                              . ~ . -City_dist:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
poll_glmer_subtr_03 <- update(poll_glmer_subtr_02,
                              . ~ . -City_dist:Transect_ID)
poll_glmer_subtr_04 <- update(poll_glmer_subtr_02,
                              . ~ . -City_dist:Year)
poll_glmer_subtr_05 <- update(poll_glmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
poll_glmer_subtr_06 <- update(poll_glmer_subtr_03,
                              . ~ . -City_dist:Year)
poll_glmer_subtr_07 <- update(poll_glmer_subtr_04,
                              . ~ . -Year:Transect_ID)
poll_glmer_subtr_08 <- update(poll_glmer_subtr_05,
                              . ~ . -City_dist:Transect_ID)

# all main effects
poll_glmer_subtr_09 <- update(poll_glmer_subtr_08,
                              . ~ . -City_dist:Year)

poll_glmer_subtr_list <- list(poll_glmer_subtr_01,
                               poll_glmer_subtr_02,
                               poll_glmer_subtr_03,
                               poll_glmer_subtr_04,
                               poll_glmer_subtr_05,
                               poll_glmer_subtr_06,
                               poll_glmer_subtr_07,
                               poll_glmer_subtr_08,
                               poll_glmer_subtr_09)

# formula(poll_glmer_subtr_list[[2]])
formulas_poll <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_poll$Model <- NA
formulas_poll$Formula <- NA
formulas_poll$r.squaredGLMM_R2m <- NA
formulas_poll$r.squaredGLMM_R2c <- NA

for (i in 1:length(poll_glmer_subtr_list)) {
  formulas_poll[i, 1] <- toString(i)
  formulas_poll[i, 2] <- toString(formula(poll_glmer_subtr_list[[i]]))
  formulas_poll[i, 3] <- r.squaredGLMM(poll_glmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_poll[i, 4] <- r.squaredGLMM(poll_glmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_poll <- do.call(rbind,
                       lapply(poll_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_poll <- bind_cols(formulas_poll,
                        glance_poll %>%
                          dplyr::select(AIC, BestModels)) # Models 1, 3 lowest AIC (1 best)

# check residuals
plot(simulateResiduals(poll_glmer_subtr_01)) # looks good
plot(simulateResiduals(poll_glmer_subtr_03)) # looks good


summary(poll_glmer_subtr_01)
summary(poll_glmer_subtr_03)
poll_glmer_subtr_01_anova <- car::Anova(poll_glmer_subtr_01) %T>%
  print()
poll_glmer_subtr_03_anova <- car::Anova(poll_glmer_subtr_03) %T>%
  print()

```

####### Urb_score, not city_dist
######## All sites
```{r}
u_poll_glmer_gradient_1 <- glmer(Pollinia_removed ~ (1|Patch_ID/Plant_Num/Inflor) +
                                   
                                   Urb_score:Year +
                                   Urb_score +
                                   Year,
                                 
                                 long_Transect_Data_18_19,
                                 family = "poisson",
             glmerControl(optimizer="bobyqa",
                          optCtrl = list(maxfun = 100000)))

# all main effects and secondary interactions
u_poll_glmer_gradient_1.1 <- update(u_poll_glmer_gradient_1,
                              . ~ . -Urb_score:Year)

u_poll_glmer_gradient_list <- list(u_poll_glmer_gradient_1,
                                   u_poll_glmer_gradient_1.1)

# formula(poll_glmer_subtr_list[[2]])
u_formulas_poll <- data.frame(matrix(ncol = 0, nrow = 2))
u_formulas_poll$Model <- NA
u_formulas_poll$Formula <- NA
u_formulas_poll$r.squaredGLMM_R2m <- NA
u_formulas_poll$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_poll_glmer_gradient_list)) {
  u_formulas_poll[i, 1] <- toString(i)
  u_formulas_poll[i, 2] <- toString(formula(u_poll_glmer_gradient_list[[i]]))
  u_formulas_poll[i, 3] <- r.squaredGLMM(u_poll_glmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  u_formulas_poll[i, 4] <- r.squaredGLMM(u_poll_glmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

u_glance_poll <- do.call(rbind,
                       lapply(u_poll_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

u_bound_poll <- bind_cols(u_formulas_poll,
                        u_glance_poll %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC

# check residuals
plot(simulateResiduals(u_poll_glmer_gradient_1)) # looks good


summary(u_poll_glmer_gradient_1)
u_poll_glmer_gradient_1_anova <- car::Anova(u_poll_glmer_gradient_1) %T>%
  print()

```

######## Urban sites
```{r}

# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
u_poll_glmer_subtr_01 <- glmer(Pollinia_removed ~ (1|Patch_ID/Plant_Num/Inflor) +
                               
                               Year:Transect_ID:Urb_score + 
                               
                               Year:Transect_ID + 
                               Urb_score:Transect_ID +
                               Urb_score:Year +
                               
                               Urb_score +
                               Year +
                               Transect_ID,
                             
                             long_Transect_Data_18_19 %>%
                               filter(Transect_ID != 'Rural'),
                             family = "poisson",
                             glmerControl(optimizer="bobyqa",
                                          optCtrl = list(maxfun = 100000)))

# all main effects and secondary interactions
u_poll_glmer_subtr_02 <- update(u_poll_glmer_subtr_01,
                              . ~ . -Year:Transect_ID:Urb_score)

# all main effects and 2/3 secondary interactions
u_poll_glmer_subtr_03 <- update(u_poll_glmer_subtr_02,
                              . ~ . -Transect_ID:Urb_score)
u_poll_glmer_subtr_04 <- update(u_poll_glmer_subtr_02,
                              . ~ . -Urb_score:Year)
u_poll_glmer_subtr_05 <- update(u_poll_glmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_poll_glmer_subtr_06 <- update(u_poll_glmer_subtr_03,
                              . ~ . -Urb_score:Year)
u_poll_glmer_subtr_07 <- update(u_poll_glmer_subtr_04,
                              . ~ . -Year:Transect_ID)
u_poll_glmer_subtr_08 <- update(u_poll_glmer_subtr_05,
                              . ~ . -Transect_ID:Urb_score)

# all main effects
u_poll_glmer_subtr_09 <- update(u_poll_glmer_subtr_08,
                              . ~ . -Urb_score:Year)

u_poll_glmer_subtr_list <- list(u_poll_glmer_subtr_01,
                               u_poll_glmer_subtr_02,
                               u_poll_glmer_subtr_03,
                               u_poll_glmer_subtr_04,
                               u_poll_glmer_subtr_05,
                               u_poll_glmer_subtr_06,
                               u_poll_glmer_subtr_07,
                               u_poll_glmer_subtr_08,
                               u_poll_glmer_subtr_09)

# formula(u_poll_glmer_subtr_list[[2]])
usc_formulas_poll <- data.frame(matrix(ncol = 0, nrow = 9))
usc_formulas_poll$Model <- NA
usc_formulas_poll$Formula <- NA
usc_formulas_poll$r.squaredGLMM_R2m <- NA
usc_formulas_poll$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_poll_glmer_subtr_list)) {
  usc_formulas_poll[i, 1] <- toString(i)
  usc_formulas_poll[i, 2] <- toString(formula(u_poll_glmer_subtr_list[[i]]))
  usc_formulas_poll[i, 3] <- r.squaredGLMM(u_poll_glmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  usc_formulas_poll[i, 4] <- r.squaredGLMM(u_poll_glmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

usc_glance_poll <- do.call(rbind,
                       lapply(u_poll_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

usc_bound_poll <- bind_cols(usc_formulas_poll,
                        usc_glance_poll %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC

# check residuals
plot(simulateResiduals(u_poll_glmer_subtr_01)) # looks good


summary(u_poll_glmer_subtr_01)
u_poll_glmer_subtr_01_anova <- car::Anova(u_poll_glmer_subtr_01) %T>%
  print()


```


##### Pods
###### GLMER
####### City-dist
######## All sites- SQUARING TRANSFORMATION
```{r}
# pods_glmer_gradient_01 <- glmer(Viable_Pods ~ (1|Patch_ID) +
#                                   
                                  # City_dist:Year +
                                  # City_dist +
                                  # Year,
#                                 
#                                 fertile,
#                                 family = "poisson",
#                                 glmerControl(optimizer="bobyqa",
#                                              optCtrl = list(maxfun = 100000))) # not converging
# plot(simulateResiduals(pods_glmer_gradient_01)) # not ok... try hurdle model

fertile$Viable_Pods_minus1 <- fertile$Viable_Pods - 1

## Hurdle Poisson model
pods_glmer_gradient_01 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                  City_dist:Year +
                                  City_dist +
                                  Year,
                               
                                fertile,
              zi = ~City_dist:Year +
                                  City_dist +
                                  Year,
              family = truncated_poisson)
plot(simulateResiduals(pods_glmer_gradient_01)) # much better. Will go with this
# CODE DETAILING WHAT i TRIED TO DO BEFORE SETTLING ON SQUARING TRANSFORMATION WITH HURDLE MODEL BELOW
## After trying hurdle model WITHOUT Squaring transformation, I looked at dispersion and saw it was overdispersed, then tried a few other things...
# testDispersion(pods_glmer_gradient_01) # but it's overdispersed... try adding value which gives each row an ID
# 
# fertile$ID <- seq.int(nrow(fertile))
# 
# pods_glmer_gradient_01 <- glmmTMB(Viable_Pods_minus1 ~ (1|Patch_ID) + (1|ID) +
#                  City_dist:Year +
#                     City_dist +
#                     Year,
# 
#                   fertile,
# zi = ~City_dist:Year +
#                     City_dist +
#                     Year,
#               family = truncated_poisson)
# plot(simulateResiduals(pods_glmer_gradient_01)) # didn't help... try neg bin
# 
# pods_glmer_gradient_01 <- glmmTMB(Viable_Pods_minus1 ~ (1|Patch_ID) +
#                                City_dist:Year +
#                     City_dist +
#                     Year,
# 
#                                 fertile,
#               family = nbinom1())
# plot(simulateResiduals(pods_glmer_gradient_01)) # didn't help either
# hist(AvgVars_byPatch$Viable_Pods, breaks = 20)




# all main effects and secondary interactions
pods_glmer_gradient_02 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                  # City_dist:Year +
                                  City_dist +
                                  Year,
                               
                                fertile,
              zi = ~          City_dist +
                                  Year,
              family = truncated_poisson)

pods_glmer_gradient_list <- list(pods_glmer_gradient_01,
                                 pods_glmer_gradient_02)

formulas_pods <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_pods$Model <- NA
formulas_pods$Formula <- NA
# formulas_pods$r.squaredGLMM_R2m <- NA
# formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(pods_glmer_gradient_list)) {
  formulas_pods[i, 1] <- toString(i)
  formulas_pods[i, 2] <- toString(formula(pods_glmer_gradient_list[[i]]))
  # formulas_pods[i, 3] <- r.squaredGLMM(pods_glmer_gradient_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_pods[i, 4] <- r.squaredGLMM(pods_glmer_gradient_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_pods <- do.call(rbind,
                       lapply(pods_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_pods <- bind_cols(formulas_pods,
                        glance_pods %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC

# check residuals
plot(simulateResiduals(pods_glmer_gradient_01)) # looks good


summary(pods_glmer_gradient_01)
pods_glmer_gradient_01_anova <- car::Anova(pods_glmer_gradient_01) %T>%
  print() # year and interaxn sig


```

######## Urban sites- SQUARING TRANSFORMATION
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
# pods_glmer_subtr_01 <- glmer(Viable_Pods ~ (1|Patch_ID) +
#                                
#                                City_dist:Year:Transect_ID + 
#                                
#                                Year:Transect_ID + 
#                                City_dist:Transect_ID +
#                                City_dist:Year +
#                                
#                                City_dist +
#                                Year +
#                                Transect_ID,
#                              
#                              fertile %>%
#                                filter(Transect_ID != 'Rural'),
#                              family = "poisson",
#                              glmerControl(optimizer="bobyqa",
#                                           optCtrl = list(maxfun = 100000))) # diagnostic plot is not normal. Trying a hurdle model like for Q1 above

# GOING TO SUBTRACT 1 AND THEN USE ZERO-INFLATED MODEL OR HURDLE MODEL TO DEAL WITH ONE-INFLATION-----

## Hurdle Poisson model
pods_glmer_subtr_01 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                               City_dist:Year:Transect_ID + 
                                 
                               Year:Transect_ID + 
                               City_dist:Transect_ID +
                               City_dist:Year +
                               
                               City_dist +
                               Year +
                               Transect_ID,
                               
                                fertile,
              zi = ~Year*Transect_ID*City_dist,
              family = truncated_poisson)

# check residuals
plot(simulateResiduals(pods_glmer_subtr_01)) # BETTER! going with this
testDispersion(pods_glmer_subtr_01) # without squaring transf, was overdispersed


# all main effects and secondary interactions
pods_glmer_subtr_02 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 2/3 secondary interactions
pods_glmer_subtr_03 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

pods_glmer_subtr_04 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

pods_glmer_subtr_05 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year ,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID +
                                City_dist:Year ,
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 1/3 secondary interactions
pods_glmer_subtr_06 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                # City_dist:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

pods_glmer_subtr_07 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID ,
                                # City_dist:Year +
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                City_dist:Transect_ID ,
                                # City_dist:Year +
                                # Year:Transect_ID,
                              family = truncated_poisson)

pods_glmer_subtr_08 <-  glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # City_dist:Transect_ID +
                                City_dist:Year, 
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects
pods_glmer_subtr_09 <-  glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID,
                              family = truncated_poisson)


pods_glmer_subtr_list <- list(pods_glmer_subtr_01,
                               pods_glmer_subtr_02,
                               pods_glmer_subtr_03,
                               pods_glmer_subtr_04,
                               pods_glmer_subtr_05,
                               pods_glmer_subtr_06,
                               pods_glmer_subtr_07,
                               pods_glmer_subtr_08,
                               pods_glmer_subtr_09)

formulas_pods <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_pods$Model <- NA
formulas_pods$Formula <- NA
# formulas_pods$r.squaredGLMM_R2m <- NA
# formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(pods_glmer_subtr_list)) {
  formulas_pods[i, 1] <- toString(i)
  formulas_pods[i, 2] <- toString(formula(pods_glmer_subtr_list[[i]]))
  # formulas_pods[i, 3] <- r.squaredGLMM(pods_glmer_subtr_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_pods[i, 4] <- r.squaredGLMM(pods_glmer_subtr_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_pods <- do.call(rbind,
                       lapply(pods_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_pods <- bind_cols(formulas_pods,
                        glance_pods %>%
                          dplyr::select(AIC, BestModels)) # Models 2, 3, 8 lowest AIC (3 is lowest)

summary(pods_glmer_subtr_02)
pods_glmer_subtr_02_anova <- car::Anova(pods_glmer_subtr_02) %T>%
  print()

summary(pods_glmer_subtr_03)
pods_glmer_subtr_03_anova <- car::Anova(pods_glmer_subtr_03) %T>%
  print()

summary(pods_glmer_subtr_08)
pods_glmer_subtr_08_anova <- car::Anova(pods_glmer_subtr_08) %T>%
  print() #year is sig


# check residuals
plot(simulateResiduals(pods_glmer_subtr_02)) # looks fine
plot(simulateResiduals(pods_glmer_subtr_03)) # looks fine
plot(simulateResiduals(pods_glmer_subtr_08)) # looks fine


```

####### urb_score, not dist
######## All sites- CUBING TRANSFORMATION
```{r}
# u_pods_glmer_gradient_1 <- glmer(Viable_Pods ~ (1|Patch_ID) +
#                                    
#                                    Urb_score:Year +
#                                    Urb_score +
#                                    Year,
#                                  
#                                  fertile,
#                                  family = "poisson",
#              glmerControl(optimizer="bobyqa",
#                           optCtrl = list(maxfun = 100000)))
# 
# plot(simulateResiduals(u_pods_glmer_gradient_1)) # not ok... try hurdle model

## Hurdle Poisson model
u_pods_glmer_gradient_1 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                  Urb_score:Year +
                                  Urb_score +
                                  Year,
                               
                                fertile,
              zi = ~Urb_score:Year +
                                  Urb_score +
                                  Year,
              family = truncated_poisson)
plot(simulateResiduals(u_pods_glmer_gradient_1)) # much better. Will go with this


# all main effects and secondary interactions
u_pods_glmer_gradient_1.1 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                  # Urb_score:Year +
                                  Urb_score +
                                  Year,
                               
                                fertile,
              zi = ~Urb_score +
                                  Year,
              family = truncated_poisson)

u_pods_glmer_gradient_list <- list(u_pods_glmer_gradient_1,
                                   u_pods_glmer_gradient_1.1)


u_formulas_pods <- data.frame(matrix(ncol = 0, nrow = 2))
u_formulas_pods$Model <- NA
u_formulas_pods$Formula <- NA
# u_formulas_pods$r.squaredGLMM_R2m <- NA
# u_formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_pods_glmer_gradient_list)) {
  u_formulas_pods[i, 1] <- toString(i)
  u_formulas_pods[i, 2] <- toString(formula(u_pods_glmer_gradient_list[[i]]))
  # u_formulas_pods[i, 3] <- r.squaredGLMM(u_pods_glmer_gradient_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # u_formulas_pods[i, 4] <- r.squaredGLMM(u_pods_glmer_gradient_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

u_glance_pods <- do.call(rbind,
                       lapply(u_pods_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

u_bound_pods <- bind_cols(u_formulas_pods,
                        u_glance_pods %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC

# check residuals
plot(simulateResiduals(u_pods_glmer_gradient_1)) # looks good


summary(u_pods_glmer_gradient_1)
u_pods_glmer_gradient_1_anova <- car::Anova(u_pods_glmer_gradient_1) %T>%
  print() # year and interaxn sig

```


######## Urban sites- CUBING TRANSFORMATION
```{r}

# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
# u_pods_glmer_subtr_01 <- glmer(Viable_Pods ~ (1|Patch_ID) +
#                                
#                                Year:Transect_ID:Urb_score + 
#                                
#                                Year:Transect_ID + 
#                                Urb_score:Transect_ID +
#                                Urb_score:Year +
#                                
#                                Urb_score +
#                                Year +
#                                Transect_ID,
#                              
#                              fertile %>%
#                                filter(Transect_ID != 'Rural'),
#                              family = "poisson",
#                              glmerControl(optimizer="bobyqa",
#                                           optCtrl = list(maxfun = 100000)))
# plot(simulateResiduals(u_pods_glmer_subtr_01)) # not normal... try hurdle model


## Hurdle Poisson model
u_pods_glmer_subtr_01 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                               Year:Transect_ID:Urb_score + 
                                 
                               Year:Transect_ID + 
                               Urb_score:Transect_ID +
                               Urb_score:Year +
                               
                               Urb_score +
                               Year +
                               Transect_ID,
                               
                                fertile,
              zi = ~Year*Transect_ID*Urb_score,
              family = truncated_poisson)

# check residuals
plot(simulateResiduals(u_pods_glmer_subtr_01)) # BETTER! going with this


# all main effects and secondary interactions
u_pods_glmer_subtr_02 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 2/3 secondary interactions
u_pods_glmer_subtr_03 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_pods_glmer_subtr_04 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_pods_glmer_subtr_05 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year ,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year ,
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 1/3 secondary interactions
u_pods_glmer_subtr_06 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_pods_glmer_subtr_07 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score ,
                                # Urb_score:Year +
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score ,
                                # Urb_score:Year +
                                # Year:Transect_ID,
                              family = truncated_poisson)

u_pods_glmer_subtr_08 <-  glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year, 
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects
u_pods_glmer_subtr_09 <-  glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID,
                              family = truncated_poisson)



u_pods_glmer_subtr_list <- list(u_pods_glmer_subtr_01,
                               u_pods_glmer_subtr_02,
                               u_pods_glmer_subtr_03,
                               u_pods_glmer_subtr_04,
                               u_pods_glmer_subtr_05,
                               u_pods_glmer_subtr_06,
                               u_pods_glmer_subtr_07,
                               u_pods_glmer_subtr_08,
                               u_pods_glmer_subtr_09)

# formula(pods_glmer_subtr_list[[2]])
u_formulas_pods <- data.frame(matrix(ncol = 0, nrow = 9))
u_formulas_pods$Model <- NA
u_formulas_pods$Formula <- NA
# u_formulas_pods$r.squaredGLMM_R2m <- NA
# u_formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_pods_glmer_subtr_list)) {
  u_formulas_pods[i, 1] <- toString(i)
  u_formulas_pods[i, 2] <- toString(formula(u_pods_glmer_subtr_list[[i]]))
  # u_formulas_pods[i, 3] <- r.squaredGLMM(u_pods_glmer_subtr_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # u_formulas_pods[i, 4] <- r.squaredGLMM(u_pods_glmer_subtr_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

u_glance_pods <- do.call(rbind,
                       lapply(u_pods_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

u_bound_pods <- bind_cols(u_formulas_pods,
                        u_glance_pods %>%
                          dplyr::select(AIC, BestModels)) # Models 2,3 lowest AIC. Model 3 is the best though.

# check residuals
plot(simulateResiduals(u_pods_glmer_subtr_02)) # looks fine
plot(simulateResiduals(u_pods_glmer_subtr_03)) # looks fine



summary(u_pods_glmer_subtr_02)
u_pods_glmer_subtr_02_anova <- car::Anova(u_pods_glmer_subtr_02) %T>%
  print()

summary(u_pods_glmer_subtr_03)
u_pods_glmer_subtr_03_anova <- car::Anova(u_pods_glmer_subtr_03) %T>%
  print()



```


##### Pods per peduncle (i.e. follicles per inflorescence)
###### LMER
####### City_dist, not urb-score
######## All sites
```{r}
podsperped_lmer_gradient_01 <- lmer(pods_per_ped ~ (1|Patch_ID) +
                                  
                                  City_dist:Year +
                                  City_dist +
                                  Year,
                                
                                fertile,
                                REML = F) 


# all main effects and secondary interactions
podsperped_lmer_gradient_02 <- update(podsperped_lmer_gradient_01,
                                 . ~ . -City_dist:Year)

podsperped_lmer_gradient_list <- list(podsperped_lmer_gradient_01,
                                 podsperped_lmer_gradient_02)

formulas_podsperped <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_podsperped$Model <- NA
formulas_podsperped$Formula <- NA
formulas_podsperped$r.squaredGLMM_R2m <- NA
formulas_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(podsperped_lmer_gradient_list)) {
  formulas_podsperped[i, 1] <- toString(i)
  formulas_podsperped[i, 2] <- toString(formula(podsperped_lmer_gradient_list[[i]]))
  formulas_podsperped[i, 3] <- r.squaredGLMM(podsperped_lmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_podsperped[i, 4] <- r.squaredGLMM(podsperped_lmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_podsperped <- do.call(rbind,
                       lapply(podsperped_lmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_podsperped <- bind_cols(formulas_podsperped,
                        glance_podsperped %>%
                          dplyr::select(AIC, BestModels)) # Models 1 & 2 lowest AIC (2 is best)

# check residuals
library(effects)
library(sjPlot)
plot_model(podsperped_lmer_gradient_01, type='diag') # looks fine
plot_model(podsperped_lmer_gradient_02, type='diag') # looks fine


summary(podsperped_lmer_gradient_01)
podsperped_lmer_gradient_01_anova <- car::Anova(podsperped_lmer_gradient_01) %T>%
  print() # city_dist marg sig

summary(podsperped_lmer_gradient_02)
podsperped_lmer_gradient_02_anova <- car::Anova(podsperped_lmer_gradient_02) %T>%
  print() #  city_dist marg sig

```

######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
podsperped_lmer_subtr_01 <- lmer(pods_per_ped ~ (1|Patch_ID) +
                               
                               City_dist:Year:Transect_ID + 
                               
                               Year:Transect_ID + 
                               City_dist:Transect_ID +
                               City_dist:Year +
                               
                               City_dist +
                               Year +
                               Transect_ID,
                             
                             fertile %>%
                               filter(Transect_ID != 'Rural'),
                           REML = F)

# all main effects and secondary interactions
podsperped_lmer_subtr_02 <- update(podsperped_lmer_subtr_01,
                              . ~ . -City_dist:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
podsperped_lmer_subtr_03 <- update(podsperped_lmer_subtr_02,
                              . ~ . -City_dist:Transect_ID)
podsperped_lmer_subtr_04 <- update(podsperped_lmer_subtr_02,
                              . ~ . -City_dist:Year)
podsperped_lmer_subtr_05 <- update(podsperped_lmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
podsperped_lmer_subtr_06 <- update(podsperped_lmer_subtr_03,
                              . ~ . -City_dist:Year)
podsperped_lmer_subtr_07 <- update(podsperped_lmer_subtr_04,
                              . ~ . -Year:Transect_ID)
podsperped_lmer_subtr_08 <- update(podsperped_lmer_subtr_05,
                              . ~ . -City_dist:Transect_ID)

# all main effects
podsperped_lmer_subtr_09 <- update(podsperped_lmer_subtr_08,
                              . ~ . -City_dist:Year)

podsperped_lmer_subtr_list <- list(podsperped_lmer_subtr_01,
                               podsperped_lmer_subtr_02,
                               podsperped_lmer_subtr_03,
                               podsperped_lmer_subtr_04,
                               podsperped_lmer_subtr_05,
                               podsperped_lmer_subtr_06,
                               podsperped_lmer_subtr_07,
                               podsperped_lmer_subtr_08,
                               podsperped_lmer_subtr_09)

formulas_podsperped <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_podsperped$Model <- NA
formulas_podsperped$Formula <- NA
formulas_podsperped$r.squaredGLMM_R2m <- NA
formulas_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(podsperped_lmer_subtr_list)) {
  formulas_podsperped[i, 1] <- toString(i)
  formulas_podsperped[i, 2] <- toString(formula(podsperped_lmer_subtr_list[[i]]))
  formulas_podsperped[i, 3] <- r.squaredGLMM(podsperped_lmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_podsperped[i, 4] <- r.squaredGLMM(podsperped_lmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_podsperped <- do.call(rbind,
                       lapply(podsperped_lmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_podsperped <- bind_cols(formulas_podsperped,
                        glance_podsperped %>%
                          dplyr::select(AIC, BestModels)) # Models 3,5, 8 lowest AIC (8 is lowest)

# check residuals
library(effects)
library(sjPlot)
plot_model(podsperped_lmer_subtr_03, type='diag') # looks fine
plot_model(podsperped_lmer_subtr_05, type='diag') # looks fine
plot_model(podsperped_lmer_subtr_08, type='diag') # looks fine



summary(podsperped_lmer_subtr_03)
podsperped_lmer_subtr_03_anova <- car::Anova(podsperped_lmer_subtr_03) %T>%
  print()

summary(podsperped_lmer_subtr_05)
podsperped_lmer_subtr_05_anova <- car::Anova(podsperped_lmer_subtr_05) %T>%
  print()

summary(podsperped_lmer_subtr_08)
podsperped_lmer_subtr_08_anova <- car::Anova(podsperped_lmer_subtr_08) %T>%
  print()


```


####### Urb_score, not City_dist
######## All sites
```{r}
u_podsperped_lmer_gradient_01 <- lmer(pods_per_ped ~ (1|Patch_ID) +
                                  
                                  Urb_score:Year +
                                  Urb_score +
                                  Year,
                                
                                fertile,
                                REML = F) 


# all main effects and secondary interactions
u_podsperped_lmer_gradient_02 <- update(u_podsperped_lmer_gradient_01,
                                 . ~ . -Urb_score:Year)

u_podsperped_lmer_gradient_list <- list(u_podsperped_lmer_gradient_01,
                                 u_podsperped_lmer_gradient_02)

formulas_u_podsperped <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_podsperped$Model <- NA
formulas_u_podsperped$Formula <- NA
formulas_u_podsperped$r.squaredGLMM_R2m <- NA
formulas_u_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_podsperped_lmer_gradient_list)) {
  formulas_u_podsperped[i, 1] <- toString(i)
  formulas_u_podsperped[i, 2] <- toString(formula(u_podsperped_lmer_gradient_list[[i]]))
  formulas_u_podsperped[i, 3] <- r.squaredGLMM(u_podsperped_lmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_podsperped[i, 4] <- r.squaredGLMM(u_podsperped_lmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_podsperped <- do.call(rbind,
                       lapply(u_podsperped_lmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_podsperped <- bind_cols(formulas_u_podsperped,
                        glance_u_podsperped %>%
                          dplyr::select(AIC, BestModels)) # Models 1 & 2 lowest AIC (2 is best)

# check residuals
library(effects)
library(sjPlot)
plot_model(u_podsperped_lmer_gradient_01, type='diag') # looks fine
plot_model(u_podsperped_lmer_gradient_02, type='diag') # looks fine


summary(u_podsperped_lmer_gradient_01)
u_podsperped_lmer_gradient_01_anova <- car::Anova(u_podsperped_lmer_gradient_01) %T>%
  print() # Urb_score sig

summary(u_podsperped_lmer_gradient_02)
u_podsperped_lmer_gradient_02_anova <- car::Anova(u_podsperped_lmer_gradient_02) %T>%
  print() #  Urb_score sig

```

######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
u_podsperped_lmer_subtr_01 <- lmer(pods_per_ped ~ (1|Patch_ID) +
                               
                               Year:Transect_ID:Urb_score + 
                               
                               Year:Transect_ID + 
                               Urb_score:Transect_ID +
                               Urb_score:Year +
                               
                               Urb_score +
                               Year +
                               Transect_ID,
                             
                             fertile %>%
                               filter(Transect_ID != 'Rural'),
                           REML = F)

# all main effects and secondary interactions
u_podsperped_lmer_subtr_02 <- update(u_podsperped_lmer_subtr_01,
                              . ~ . -Year:Transect_ID:Urb_score)

# all main effects and 2/3 secondary interactions
u_podsperped_lmer_subtr_03 <- update(u_podsperped_lmer_subtr_02,
                              . ~ . -Transect_ID:Urb_score)
u_podsperped_lmer_subtr_04 <- update(u_podsperped_lmer_subtr_02,
                              . ~ . -Urb_score:Year)
u_podsperped_lmer_subtr_05 <- update(u_podsperped_lmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_podsperped_lmer_subtr_06 <- update(u_podsperped_lmer_subtr_03,
                              . ~ . -Urb_score:Year)
u_podsperped_lmer_subtr_07 <- update(u_podsperped_lmer_subtr_04,
                              . ~ . -Year:Transect_ID)
u_podsperped_lmer_subtr_08 <- update(u_podsperped_lmer_subtr_05,
                              . ~ . -Transect_ID:Urb_score)

# all main effects
u_podsperped_lmer_subtr_09 <- update(u_podsperped_lmer_subtr_08,
                              . ~ . -Urb_score:Year)

u_podsperped_lmer_subtr_list <- list(u_podsperped_lmer_subtr_01,
                               u_podsperped_lmer_subtr_02,
                               u_podsperped_lmer_subtr_03,
                               u_podsperped_lmer_subtr_04,
                               u_podsperped_lmer_subtr_05,
                               u_podsperped_lmer_subtr_06,
                               u_podsperped_lmer_subtr_07,
                               u_podsperped_lmer_subtr_08,
                               u_podsperped_lmer_subtr_09)

formulas_u_podsperped <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_u_podsperped$Model <- NA
formulas_u_podsperped$Formula <- NA
formulas_u_podsperped$r.squaredGLMM_R2m <- NA
formulas_u_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_podsperped_lmer_subtr_list)) {
  formulas_u_podsperped[i, 1] <- toString(i)
  formulas_u_podsperped[i, 2] <- toString(formula(u_podsperped_lmer_subtr_list[[i]]))
  formulas_u_podsperped[i, 3] <- r.squaredGLMM(u_podsperped_lmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_podsperped[i, 4] <- r.squaredGLMM(u_podsperped_lmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_podsperped <- do.call(rbind,
                       lapply(u_podsperped_lmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_podsperped <- bind_cols(formulas_u_podsperped,
                        glance_u_podsperped %>%
                          dplyr::select(AIC, BestModels)) # Models 6,7,8,9 lowest AIC (9 is lowest)

# check residuals
library(effects)
library(sjPlot)
plot_model(u_podsperped_lmer_subtr_06, type='diag') # looks fine
plot_model(u_podsperped_lmer_subtr_07, type='diag') # looks fine
plot_model(u_podsperped_lmer_subtr_08, type='diag') # looks fine
plot_model(u_podsperped_lmer_subtr_09, type='diag') # looks fine

summary(u_podsperped_lmer_subtr_06)
u_podsperped_lmer_subtr_06_anova <- car::Anova(u_podsperped_lmer_subtr_06) %T>%
  print() #nothing sig

summary(u_podsperped_lmer_subtr_07)
u_podsperped_lmer_subtr_07_anova <- car::Anova(u_podsperped_lmer_subtr_07) %T>%
  print()

summary(u_podsperped_lmer_subtr_08)
u_podsperped_lmer_subtr_08_anova <- car::Anova(u_podsperped_lmer_subtr_08) %T>%
  print()

summary(u_podsperped_lmer_subtr_09)
u_podsperped_lmer_subtr_09_anova <- car::Anova(u_podsperped_lmer_subtr_09) %T>%
  print()

```


##### Height (Sept)
###### LMER
####### City_dist
######## All sites
```{r}
height_lmer_gradient_01 <- lmer(Height_Sept ~ (1|Patch_ID) +
                                  
                                  City_dist:Year +
                                  City_dist +
                                  Year,
                                
                                fertile,
                                REML = F) 


# all main effects and secondary interactions
height_lmer_gradient_02 <- update(height_lmer_gradient_01,
                                 . ~ . -City_dist:Year)

height_lmer_gradient_list <- list(height_lmer_gradient_01,
                                 height_lmer_gradient_02)

formulas_height <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_height$Model <- NA
formulas_height$Formula <- NA
formulas_height$r.squaredGLMM_R2m <- NA
formulas_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(height_lmer_gradient_list)) {
  formulas_height[i, 1] <- toString(i)
  formulas_height[i, 2] <- toString(formula(height_lmer_gradient_list[[i]]))
  formulas_height[i, 3] <- r.squaredGLMM(height_lmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_height[i, 4] <- r.squaredGLMM(height_lmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_height <- do.call(rbind,
                       lapply(height_lmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_height <- bind_cols(formulas_height,
                        glance_height %>%
                          dplyr::select(AIC, BestModels)) # Models 1 & 2 lowest AIC (2 is best)

# check residuals
library(effects)
library(sjPlot)
plot_model(height_lmer_gradient_01, type='diag') # looks fine
plot_model(height_lmer_gradient_02, type='diag') # looks fine


summary(height_lmer_gradient_01)
height_lmer_gradient_01_anova <- car::Anova(height_lmer_gradient_01) %T>%
  print() # year sig

summary(height_lmer_gradient_02)
height_lmer_gradient_02_anova <- car::Anova(height_lmer_gradient_02) %T>%
  print() # year sig

```

######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
height_lmer_subtr_01 <- lmer(Height_Sept ~ (1|Patch_ID) +
                               
                               City_dist:Year:Transect_ID + 
                               
                               Year:Transect_ID + 
                               City_dist:Transect_ID +
                               City_dist:Year +
                               
                               City_dist +
                               Year +
                               Transect_ID,
                             
                             fertile %>%
                               filter(Transect_ID != 'Rural'),
                           REML = F)

# all main effects and secondary interactions
height_lmer_subtr_02 <- update(height_lmer_subtr_01,
                              . ~ . -City_dist:Year:Transect_ID)

# all main effects and 2/3 secondary interactions
height_lmer_subtr_03 <- update(height_lmer_subtr_02,
                              . ~ . -City_dist:Transect_ID)
height_lmer_subtr_04 <- update(height_lmer_subtr_02,
                              . ~ . -City_dist:Year)
height_lmer_subtr_05 <- update(height_lmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
height_lmer_subtr_06 <- update(height_lmer_subtr_03,
                              . ~ . -City_dist:Year)
height_lmer_subtr_07 <- update(height_lmer_subtr_04,
                              . ~ . -Year:Transect_ID)
height_lmer_subtr_08 <- update(height_lmer_subtr_05,
                              . ~ . -City_dist:Transect_ID)

# all main effects
height_lmer_subtr_09 <- update(height_lmer_subtr_08,
                              . ~ . -City_dist:Year)

height_lmer_subtr_list <- list(height_lmer_subtr_01,
                               height_lmer_subtr_02,
                               height_lmer_subtr_03,
                               height_lmer_subtr_04,
                               height_lmer_subtr_05,
                               height_lmer_subtr_06,
                               height_lmer_subtr_07,
                               height_lmer_subtr_08,
                               height_lmer_subtr_09)

formulas_height <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_height$Model <- NA
formulas_height$Formula <- NA
formulas_height$r.squaredGLMM_R2m <- NA
formulas_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(height_lmer_subtr_list)) {
  formulas_height[i, 1] <- toString(i)
  formulas_height[i, 2] <- toString(formula(height_lmer_subtr_list[[i]]))
  formulas_height[i, 3] <- r.squaredGLMM(height_lmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_height[i, 4] <- r.squaredGLMM(height_lmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_height <- do.call(rbind,
                       lapply(height_lmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_height <- bind_cols(formulas_height,
                        glance_height %>%
                          dplyr::select(AIC, BestModels)) # Models 1, 8 lowest AIC (1 is lowest)

# check residuals
library(effects)
library(sjPlot)
plot_model(height_lmer_subtr_01, type='diag') # looks fine
plot_model(height_lmer_subtr_08, type='diag') # looks fine


summary(height_lmer_subtr_01)
height_lmer_subtr_01_anova <- car::Anova(height_lmer_subtr_01) %T>%
  print()

summary(height_lmer_subtr_08)
height_lmer_subtr_08_anova <- car::Anova(height_lmer_subtr_08) %T>%
  print()


```

####### urb-score
######## All sites
```{r}
u_height_lmer_gradient_01 <- lmer(Height_Sept ~ (1|Patch_ID) +
                                  
                                  Urb_score:Year +
                                  Urb_score +
                                  Year,
                                
                                fertile,
                                REML = F) 


# all main effects and secondary interactions
u_height_lmer_gradient_02 <- update(u_height_lmer_gradient_01,
                                 . ~ . -Urb_score:Year)

u_height_lmer_gradient_list <- list(u_height_lmer_gradient_01,
                                 u_height_lmer_gradient_02)

formulas_height <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_height$Model <- NA
formulas_height$Formula <- NA
formulas_height$r.squaredGLMM_R2m <- NA
formulas_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_height_lmer_gradient_list)) {
  formulas_height[i, 1] <- toString(i)
  formulas_height[i, 2] <- toString(formula(u_height_lmer_gradient_list[[i]]))
  formulas_height[i, 3] <- r.squaredGLMM(u_height_lmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_height[i, 4] <- r.squaredGLMM(u_height_lmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_height <- do.call(rbind,
                       lapply(u_height_lmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_height <- bind_cols(formulas_height,
                        glance_height %>%
                          dplyr::select(AIC, BestModels)) # Models 1 & 2 lowest AIC (1 best)

# check residuals
plot(simulateResiduals(u_height_lmer_gradient_01)) # looks good
plot(simulateResiduals(u_height_lmer_gradient_02)) # looks good


summary(u_height_lmer_gradient_01)
u_height_lmer_gradient_01_anova <- car::Anova(u_height_lmer_gradient_01) %T>%
  print() # year sig, interaxn marg sig

summary(u_height_lmer_gradient_02)
u_height_lmer_gradient_02_anova <- car::Anova(u_height_lmer_gradient_02) %T>%
  print() # year sig

```


######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
u_height_lmer_subtr_01 <- lmer(Height_Sept ~ (1|Patch_ID) +
                               
                               Year:Transect_ID:Urb_score + 
                               
                               Year:Transect_ID + 
                               Urb_score:Transect_ID +
                               Urb_score:Year +
                               
                               Urb_score +
                               Year +
                               Transect_ID,
                             
                             fertile %>%
                               filter(Transect_ID != 'Rural'),
                           REML = F)

# all main effects and secondary interactions
u_height_lmer_subtr_02 <- update(u_height_lmer_subtr_01,
                              . ~ . -Year:Transect_ID:Urb_score)

# all main effects and 2/3 secondary interactions
u_height_lmer_subtr_03 <- update(u_height_lmer_subtr_02,
                              . ~ . -Transect_ID:Urb_score)
u_height_lmer_subtr_04 <- update(u_height_lmer_subtr_02,
                              . ~ . -Urb_score:Year)
u_height_lmer_subtr_05 <- update(u_height_lmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_height_lmer_subtr_06 <- update(u_height_lmer_subtr_03,
                              . ~ . -Urb_score:Year)
u_height_lmer_subtr_07 <- update(u_height_lmer_subtr_04,
                              . ~ . -Year:Transect_ID)
u_height_lmer_subtr_08 <- update(u_height_lmer_subtr_05,
                              . ~ . -Transect_ID:Urb_score)

# all main effects
u_height_lmer_subtr_09 <- update(u_height_lmer_subtr_08,
                              . ~ . -Urb_score:Year)

u_height_lmer_subtr_list <- list(u_height_lmer_subtr_01,
                               u_height_lmer_subtr_02,
                               u_height_lmer_subtr_03,
                               u_height_lmer_subtr_04,
                               u_height_lmer_subtr_05,
                               u_height_lmer_subtr_06,
                               u_height_lmer_subtr_07,
                               u_height_lmer_subtr_08,
                               u_height_lmer_subtr_09)

formulas_height <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_height$Model <- NA
formulas_height$Formula <- NA
formulas_height$r.squaredGLMM_R2m <- NA
formulas_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_height_lmer_subtr_list)) {
  formulas_height[i, 1] <- toString(i)
  formulas_height[i, 2] <- toString(formula(u_height_lmer_subtr_list[[i]]))
  formulas_height[i, 3] <- r.squaredGLMM(u_height_lmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_height[i, 4] <- r.squaredGLMM(u_height_lmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_height <- do.call(rbind,
                       lapply(u_height_lmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_height <- bind_cols(formulas_height,
                        glance_height %>%
                          dplyr::select(AIC, BestModels)) # Models 1, 9 lowest AIC (1 is lowest)

# check residuals
plot(simulateResiduals(u_height_lmer_subtr_01)) # looks good
plot(simulateResiduals(u_height_lmer_subtr_09)) # looks good


summary(u_height_lmer_subtr_01)
u_height_lmer_subtr_01_anova <- car::Anova(u_height_lmer_subtr_01) %T>%
  print()

summary(u_height_lmer_subtr_09)
u_height_lmer_subtr_09_anova <- car::Anova(u_height_lmer_subtr_09) %T>%
  print()


```


#### Combine models into one df
##### Best models: Inflors, pollen, pods, pods/inflor
```{r}
# tidy anovas
tidy_sb <- function(model){
  
  return(
    car::Anova(model) %>%
      broom.mixed::tidy() %>%
      # as.data.frame() %>%
      dplyr::mutate(Response = as.character(formula(model)[2]),
                    .before = term) %>%
      # dplyr::mutate(Model = paste(n(model)),
      #               .before = term) %>%
      dplyr::mutate(Sites = case_when(
        str_detect(as.character(formula(model)[3]), "Transect_ID") == TRUE ~ "Urban Only",
        str_detect(as.character(formula(model)[3]), "Transect_ID") == FALSE ~ "All"),
                    .before = term) %>%
      dplyr::mutate(Significance = case_when(p.value < 0.001 ~ "***",
                                             p.value < 0.01 ~ "**",
                                             p.value <= 0.05 ~ "*")) %>%
      dplyr::mutate(., AIC = as.numeric(AIC(model))) %>%
      mutate_if(is.numeric, round, 3))      %>%
      dplyr::mutate(p.value = replace(p.value, Significance == "***", "<0.001"))  %>%
      dplyr::select(., -df) %>%
      dplyr::rename(., Chi_sq = statistic,
                    Predictor = term,
                    p = p.value) %>%
      unite("p", p:Significance, sep = "", na.rm = TRUE) %>%
      dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("City_dist"),
                replacement = c("Distance to City Center")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Urb_score"),
                replacement = c("Urbanization Score")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Transect_ID"),
                replacement = c("Subtransect")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c(":"),
                replacement = c(" x ")) %>%
    dplyr::mutate_if(.,
          is.character,
          str_replace_all,
          pattern = c("Year x Urbanization Score"),
          replacement = c("Urbanization Score x Year")) # %>%
        # dplyr::mutate_if(.,
        #         is.character,
        #         str_replace_all,
        #         pattern = c("Year x Distance to City Center"),
        #         replacement = c("Distance to City Center x Year")) %>%
        # dplyr::mutate_if(.,
        #         is.character,
        #         str_replace_all,
        #         pattern = c("Subtransect x Distance to City Center"),
        #         replacement = c("Distance to City Center x Subtransect")) %>%
        # dplyr::mutate_if(.,
        #         is.character,
        #         str_replace_all,
        #         pattern = c("Distance to City Center x Year x Subtransect"),
        #         replacement = c("Year x Subtransect x Distance to City Center"))
}

# combine anovas into publication-quality tables
make_Q1Q2_Anova <- function(anova_list){
  return(
    lapply(anova_list, tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", "AIC", "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('X2' = 2,
                  'p' = 3,
                  'X2 ' = 4,
                  'p ' = 5,
                  'X2  ' = 6,
                  'p  ' = 7,
                  'X2   ' = 8,
                  'p   ' = 9) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Inflorescences",
                 "Pollinaria Removed",
                 "Follicles",
                 "Follicles per Inflorescence"),
      colwidths = c(1, 2, 2, 2, 2)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:9, align = "center", part = "body") %>%
    align(j = 2:9, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2  ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2   ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body")
    )
  }



# CITY_DIST-----
## ALL SITES

best_mods_Q1.dist_list <- list(
### Peduncles
  peds_glmer_gradient_01,  
### Pollinia
  poll_glmer_gradient_01.v2,
### Pods
  pods_glmer_gradient_01,
### Pods/Peduncle
  podsperped_lmer_gradient_02

)

make_Q1Q2_Anova(best_mods_Q1.dist_list) %>%
  width(j = 1, width = 2.7) %>%
  width(j = 2:9, width = 0.8) %>%
  italic(i = 2, j = 2:9, part = "header") %>%
  add_footer_lines("Table X: Results from general and generalized linear mixed models examining the effects of urbanization on 4 traits: inflorescences, pollinaria removed, follicles, and mean no. follicles per inflorescence. Urbanization was quantified via distance to city center and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC, Inflorescences: ",
                          AIC(peds_glmer_gradient_01) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Pollinaria Removed: ",
                          AIC(poll_glmer_gradient_01.v2) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Follicles: ",
                          AIC(pods_glmer_gradient_01) %>% round(., 3))) %>%  
  add_footer_lines(paste0("AIC, Follicles per Inflorescence: ",
                          AIC(podsperped_lmer_gradient_02) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Q1_Dist_ANOVA.png"))




## URBAN SITES
best_mods_Q2.dist_list <- list(
### Peduncles
  peds_glmer_subtr_01,  
### Pollinia
  poll_glmer_subtr_01,
### Pods
  pods_glmer_subtr_03,
### Pods/Peduncle
  podsperped_lmer_subtr_08

)


make_Q1Q2_Anova(best_mods_Q2.dist_list) %>%
  width(j = 1, width = 3.7) %>%
  width(j = 2:9, width = 0.9) %>%
  italic(i = 2, j = 2:9, part = "header") %>%
  add_footer_lines("Table X: Results from general and generalized linear mixed models examining the effects of urbanization and proximity to an urban corridor on 4 traits: pollinaria removed, follicles, inflorescences, and mean no. follicles per inflorescence. Urbanization was quantified via urbanization score. Urbanization was quantified via distance to city center and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC, Inflorescences: ",
                          AIC(peds_glmer_subtr_01) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Pollinaria Removed: ",
                          AIC(poll_glmer_subtr_01) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Follicles: ",
                          AIC(pods_glmer_subtr_03) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Follicles per Inflorescence: ",
                          AIC(podsperped_lmer_subtr_08) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Q2_Dist_ANOVA.png"))


# URB_SCORE-----
## ALL SITES

best_mods_Q1.urbscore_list <- list(
### Peduncles
  u_peds_glmer_gradient_01,  
### Pollinia
  u_poll_glmer_gradient_1,
### Pods
  u_pods_glmer_gradient_1,
### Pods/Peduncle
  u_podsperped_lmer_gradient_02

)


make_Q1Q2_Anova(best_mods_Q1.urbscore_list) %>%
  width(j = 1, width = 2.4) %>%
  width(j = 2:9, width = 0.8) %>%
  italic(i = 2, j = 2:9, part = "header") %>%
  add_footer_lines("Table X: Results from general and generalized linear mixed models examining the effects of urbanization on 4 traits: pollinaria removed, follicles, inflorescences, and mean no. follicles per inflorescence. Urbanization was quantified via urbanization score and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC, Inflorescences: ",
                          AIC(u_peds_glmer_gradient_01) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Pollinaria Removed: ",
                          AIC(u_poll_glmer_gradient_1) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Follicles: ",
                          AIC(u_pods_glmer_gradient_1) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Follicles per Inflorescence: ",
                          AIC(u_podsperped_lmer_gradient_02) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Q1_Urbscore_ANOVA.png"))







## URBAN SITES

best_mods_Q2.urbscore_list <- list(
### Peduncles
  u_peds_glmer_subtr_06,  
### Pollinia
  u_poll_glmer_subtr_01,
### Pods
  u_pods_glmer_subtr_03,
### Pods/Peduncle
  u_podsperped_lmer_subtr_09

)


make_Q1Q2_Anova(best_mods_Q2.urbscore_list) %>%
  width(j = 1, width = 3.3) %>%
  width(j = 2:9, width = 0.9) %>%
  italic(i = 2, j = 2:9, part = "header") %>%
  add_footer_lines("Table X: Results from general and generalized linear mixed models examining the effects of urbanization and proximity to an urban corridor on 4 traits: inflorescences, pollinaria removed, follicles, and mean no. follicles per inflorescence. Urbanization was quantified via urbanization score. Urbanization was quantified via urbanization score and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC, Inflorescences: ",
                          AIC(u_peds_glmer_subtr_06) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Pollinaria Removed: ",
                          AIC(u_poll_glmer_subtr_01) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Follicles: ",
                          AIC(u_pods_glmer_subtr_03) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Follicles per Inflorescence: ",
                          AIC(u_podsperped_lmer_subtr_09) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Q2_Urbscore_ANOVA.png"))

```
##### Best models: height
```{r}
# make_anova function tweaked to handle one model- height- instead of a list
make_Q1Q2_Anova.height <- function(anova){
  return(
    tidy_sb(anova) %>%
    as.data.frame() %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", "AIC", "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('X2' = 2,
                  'p' = 3) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Height"),
      colwidths = c(1, 2)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:3, align = "center", part = "body") %>%
    align(j = 2:3, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) 
    )
}


# CITY_DIST-----
## ALL SITES
# Height: height_lmer_gradient_02


make_Q1Q2_Anova.height(height_lmer_gradient_02) %>%
  width(j = 1, width = 1.8) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from general linear mixed models examining the effects of urbanization on plant height. Urbanization was quantified via distance to city center and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%  add_footer_lines(paste0("AIC, Height: ",
                          AIC(height_lmer_gradient_02) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Best_models_Height/Q1_Dist_ANOVA_HEIGHT.png"))





## URBAN SITES
# Height: height_lmer_subtr_01

make_Q1Q2_Anova.height(height_lmer_subtr_01) %>%
  width(j = 1, width = 3.3) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from general linear mixed models examining the effects of urbanization and proximity to an urban corridor on plant height. Urbanization was quantified via distance to city center and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC, Height: ",
                          AIC(height_lmer_subtr_01) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Best_models_Height/Q2_Dist_ANOVA_HEIGHT.png"))




# URB_SCORE-----
## ALL SITES
# Height: u_height_lmer_gradient_01

make_Q1Q2_Anova.height(u_height_lmer_gradient_01) %>%
  width(j = 1, width = 2) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from general linear mixed models examining the effects of urbanization on plant height. Urbanization was quantified via urbanization score and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
    add_footer_lines(paste0("AIC, Height: ",
                          AIC(u_height_lmer_gradient_01) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Best_models_Height/Q1_Urbscore_ANOVA_HEIGHT.png"))






## URBAN SITES
# Height: u_height_lmer_subtr_01

make_Q1Q2_Anova.height(u_height_lmer_subtr_01) %>%
  width(j = 1, width = 3.2) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from general linear mixed models examining the effects of urbanization and proximity to an urban corridor on plant height. Urbanization was quantified via urbanization score and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
    add_footer_lines(paste0("AIC, Height: ",
                          AIC(u_height_lmer_subtr_01) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Best_models_Height/Q2_Urbscore_ANOVA_HEIGHT.png"))

```

##### Alternative (AIC<2 from best) models: Inflors, pollen, pods, pods/inflor
```{r}

# CITY_DIST-----
## ALL SITES-----
### Peduncles- NONE- only one best model
### Pollinia-  NONE because each model analyzed year separately
### Pods-      NONE- only one best model
### ****Pods/Peduncle:  podsperped_lmer_gradient_01


podsperped_lmer_gradient_01 %>%
  tidy_sb() %>%
    as.data.frame() %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance",
                                 "AIC",
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('X2' = 2,
                  'p' = 3) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Follicles per Inflorescence"),
      colwidths = c(1, 2)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:3, align = "center", part = "body") %>%
    align(j = 2:3, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
  width(j = 1, width = 2.3) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  # merge_at(i = 1:2, j = 4 ) %>%
  # fix_border_issues() %>%
  add_footer_lines("Table X: Results from an alternative general linear mixed model within 2 AIC from the best model examining the effects of urbanization on mean no. follicles per inflorescence. Alternative models of other estimates of reproductive success were >2 AIC of the best models and are not shown. Urbanization was quantified via distance to city center and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC: ",
                          AIC(podsperped_lmer_gradient_01) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Q1_Dist_ANOVA_altmodels.png"))




## URBAN SITES-----
alt_best_mods_Q2.dist_list <- list(
### Peduncles
  peds_glmer_subtr_03,
  peds_glmer_subtr_06,  
### Pollinia
  poll_glmer_subtr_03,
### Pods
  pods_glmer_subtr_02,
  pods_glmer_subtr_08,
### Pods/Peduncle
  podsperped_lmer_subtr_03,
  podsperped_lmer_subtr_05

)



lapply(alt_best_mods_Q2.dist_list, tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('X2' = 2,
                  'p' = 3,
                  'X2 ' = 4,
                  'p ' = 5,
                  'X2  ' = 6,
                  'p  ' = 7,
                  'X2   ' = 8,
                  'p   ' = 9,
                  'X2    ' = 10,
                  'p    ' = 11,
                  'X2     ' = 12,
                  'p     ' = 13,
                  'X2      ' = 14,
                  'p      ' = 15) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Inflorescences, Alt. Model 1",
                 "Inflorescences, Alt. Model 2",
                 "Pollinaria Removed, Alt. Model 1",
                 "Follicles, Alt. Model 1",
                 "Follicles, Alt. Model 2",
                 "Follicles per Inflorescence, Alt. Model 1",
                 "Follicles per Inflorescence, Alt. Model 2"),
      colwidths = c(1, 2, 2, 2, 2, 2, 2, 2)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:15, align = "center", part = "body") %>%
    align(j = 2:15, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2  ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2   ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2    ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2    ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2     ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2     ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2      ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2      ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 1.8) %>%
  width(j = 2:15, width = 1) %>%
  italic(i = 2, j = 2:15, part = "header") %>%
  # merge_at(i = 1:6, j = 4 ) %>%
  # merge_at(i = 1:6, j = 7 ) %>%
  # merge_at(i = 1:6, j = 10 ) %>%
  # merge_at(i = 1:6, j = 13 ) %>%
  # merge_at(i = 1:6, j = 16) %>%
  # merge_at(i = 1:6, j = 19) %>%
  # merge_at(i = 1:6, j = 22) %>%
  # fix_border_issues() %>%
  add_footer_lines("Table X: Results from alternative general linear mixed models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on 4 traits: inflorescences, pollinaria removed, follicles, and mean no. follicles per inflorescence. Urbanization was quantified via distance to city center and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 1: ",
                          AIC(peds_glmer_subtr_03) %>% round(., 3))) %>%  add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 2: ",
                          AIC(peds_glmer_subtr_06) %>% round(., 3))) %>%  add_footer_lines(paste0("AIC, Pollinaria Removed, Alt. Model 1: ",
                          AIC(poll_glmer_subtr_03) %>% round(., 3))) %>%  add_footer_lines(paste0("AIC, Follicles, Alt. Model 1: ",
                          AIC(pods_glmer_subtr_02) %>% round(., 3))) %>%  add_footer_lines(paste0("AIC, Follicles, Alt. Model 2: ",
                          AIC(pods_glmer_subtr_08) %>% round(., 3))) %>%  add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 1: ",
                          AIC(podsperped_lmer_subtr_03) %>% round(., 3))) %>%  add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 2: ",
                          AIC(podsperped_lmer_subtr_05) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Q2_Dist_ANOVA_altmodels.png"))


  


# URB_SCORE-----
## ALL SITES

alt_best_mods_Q1.urbscore_list <- list(
### Peduncles- NONE- only 1 best model
### Pollinia- NONE- only 1 best model
### Pods-      NONE- only 1 best model
### Pods/Peduncle
  u_podsperped_lmer_gradient_01

)


lapply(alt_best_mods_Q1.urbscore_list, tidy_sb) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join, by = "Predictor") %>%
    arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('X2' = 2,
                  'p' = 3,
                  'X2 ' = 4,
                  'p ' = 5) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Pollinaria Removed, Alt. Model 1",
                 "Follicles per Inflorescence, Alt. Model 1"),
      colwidths = c(1, 2, 2)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:5, align = "center", part = "body") %>%
    align(j = 2:5, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 2.5) %>%
  width(j = 2:5, width = 1) %>%
  italic(i = 2, j = 2:5, part = "header") %>%
  # merge_at(i = 1:6, j = 4 ) %>%
  # merge_at(i = 1:6, j = 7 ) %>%
  # merge_at(i = 1:6, j = 10 ) %>%
  # merge_at(i = 1:6, j = 13 ) %>%
  # merge_at(i = 1:6, j = 16) %>%
  # merge_at(i = 1:6, j = 19) %>%
  # merge_at(i = 1:6, j = 22) %>%
  # fix_border_issues() %>%
  add_footer_lines("Table X: Results from alternative general linear mixed models within 2 AIC from the best models examining the effects of urbanization on 2 traits: pollinaria removed and mean no. follicles per inflorescence. Alternative models of other estimates of reproductive success were >2 AIC of the best models and are not shown. Urbanization was quantified via urbanization score and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
  add_footer_lines(paste0("AIC, Pollinaria Removed, Alt. Model 1: ",
                          AIC(u_poll_glmer_gradient_1.1) %>% round(., 3))) %>%
  add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 1: ",
                          AIC(u_podsperped_lmer_gradient_01) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Q1_Urbscore_ANOVA_altmodels.png"))



## URBAN SITES

alt_best_mods_Q2.urbscore_list <- list(
### Peduncles
  u_peds_glmer_subtr_03,
  u_peds_glmer_subtr_04,  
### Pollinia- NONE- only one best model
### Pods
  u_pods_glmer_subtr_02,
### Pods/Peduncle
  u_podsperped_lmer_subtr_06,
  u_podsperped_lmer_subtr_07,
  u_podsperped_lmer_subtr_08

)



lapply(alt_best_mods_Q2.urbscore_list, tidy_sb) %>%
  lapply(., as.data.frame) %>%
  purrr::reduce(full_join, by = "Predictor") %>%
  arrange(factor(Predictor, levels = c("Distance to City Center",
                                         "Urbanization Score",
                                         "Year",
                                         "Subtransect",
                                         "Distance to City Center x Subtransect",
                                         "Urbanization Score x Subtransect",
                                         "Distance to City Center x Year",
                                         "Urbanization Score x Year",
                                         "Year x Subtransect",
                                         "Urbanization Score x Year x Subtransect",
                                         "Distance to City Center x Year x Subtransect"
                                         ))) %>%
    dplyr::select(-starts_with(c("Sites", "Significance", 
                                 "AIC", 
                                 "Response"))) %>%
    replace(., is.na(.), "-") %>%
    dplyr::rename('X2' = 2,
                  'p' = 3,
                  'X2 ' = 4,
                  'p ' = 5,
                  'X2  ' = 6,
                  'p  ' = 7,
                  'X2   ' = 8,
                  'p   ' = 9,
                  'X2    ' = 10,
                  'p    ' = 11,
                  'X2     ' = 12,
                  'p     ' = 13) %>%
    flextable::flextable() %>%
    add_header_row(
      values = c(" ",
                 "Inflorescences, Alt. Model 1",
                 "Inflorescences, Alt. Model 2",
                 "Follicles, Alt. Model 1",
                 "Follicles per Inflorescence, Alt. Model 1",
                 "Follicles per Inflorescence, Alt. Model 2",
                 "Follicles per Inflorescence, Alt. Model 3"),
      colwidths = c(1, 2, 2, 2, 2, 2, 2)) %>%
    align(j = 1, align = "left", part = "all") %>%
    align(j = 2:13, align = "center", part = "body") %>%
    align(j = 2:13, align = "center", part = "header") %>%
    display(i = 2, col_key = "X2", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2 ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2  ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2   ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2    ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2    ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
    display(i = 2, col_key = "X2     ", 
      pattern = "{{val}}{{pow}}", part = "header",
      formatters = list(val ~ as.character("X"), pow ~ as.character("2     ") ),
      fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
  width(j = 1, width = 1.8) %>%
  width(j = 2:13, width = 1) %>%
  italic(i = 2, j = 2:13, part = "header") %>%
  # merge_at(i = 1:6, j = 4 ) %>%
  # merge_at(i = 1:6, j = 7 ) %>%
  # merge_at(i = 1:6, j = 10 ) %>%
  # merge_at(i = 1:6, j = 13 ) %>%
  # merge_at(i = 1:6, j = 16) %>%
  # merge_at(i = 1:6, j = 19) %>%
  # merge_at(i = 1:6, j = 22) %>%
  # fix_border_issues() %>%
  add_footer_lines("Table X: Results from alternative general linear mixed models within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on 4 traits: inflorescences, follicles, and mean no. follicles per inflorescence. Alternative models of pollinaria removed were >2 AIC of the best models and are not shown. Urbanization was quantified via urbanization score and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
    add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 1: ",
                          AIC(u_peds_glmer_subtr_03) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Inflorescences, Alt. Model 2: ",
                          AIC(u_peds_glmer_subtr_04) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Follicles, Alt. Model 1: ",
                          AIC(u_pods_glmer_subtr_02) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 1: ",
                          AIC(u_podsperped_lmer_subtr_06) %>% round(., 3))) %>% 
    add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 2: ",
                          AIC(u_podsperped_lmer_subtr_07) %>% round(., 3))) %>%
    add_footer_lines(paste0("AIC, Follicles per Inflorescence, Alt. Model 3: ",
                          AIC(u_podsperped_lmer_subtr_08) %>% round(., 3))) %>%
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Q2_Urbscore_ANOVA_altmodels.png"))


```

##### Alternative (AIC<2 from best) models: height
```{r}
# City_dist x all sites: height_lmer_gradient_01
make_Q1Q2_Anova.height(height_lmer_gradient_01) %>%
  width(j = 1, width = 2.4) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from an alternative general linear mixed model within 2 AIC from the best model examining the effects of urbanization on plant height. Urbanization was quantified via distance to city center and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
    add_footer_lines(paste0("AIC, Height, Alt. Model 1: ",
                          AIC(height_lmer_gradient_01) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Alt_models_Height/Q1_Dist_ANOVA_altmodels_HEIGHT.png"))


# City_dist x urban sites: height_lmer_subtr_08
make_Q1Q2_Anova.height(height_lmer_subtr_08) %>%
  width(j = 1, width = 2.4) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from an alternative general linear mixed model within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on plant height. Urbanization was quantified via distance to city center and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
      add_footer_lines(paste0("AIC, Height, Alt. Model 1: ",
                          AIC(height_lmer_subtr_08) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Alt_models_Height/Q2_Dist_ANOVA_altmodels_HEIGHT.png"))


# Urb_score x all sites: u_height_lmer_gradient_02
make_Q1Q2_Anova.height(u_height_lmer_gradient_02) %>%
  width(j = 1, width = 2.4) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from an alternative general linear mixed model within 2 AIC from the best model examining the effects of urbanization on plant height. Urbanization was quantified via urbanization score and all populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
        add_footer_lines(paste0("AIC, Height, Alt. Model 1: ",
                          AIC(u_height_lmer_gradient_02) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Alt_models_Height/Q1_Urbscore_ANOVA_altmodels_HEIGHT.png"))


# Urb_score x urban sites: u_height_lmer_subtr_09
make_Q1Q2_Anova.height(u_height_lmer_subtr_09) %>%
  width(j = 1, width = 2.4) %>%
  width(j = 2:3, width = 1) %>%
  italic(i = 2, j = 2:3, part = "header") %>%
  add_footer_lines("Table X: Results from an alternative general linear mixed model within 2 AIC from the best model examining the effects of urbanization and proximity to an urban corridor on plant height. Urbanization was quantified via urbanization score and only urban populations were included. Shown are maximum likelihood chi-square (X2) and p-values (p) obtained from a type II ANOVA.") %>%
        add_footer_lines(paste0("AIC, Height, Alt. Model 1: ",
                          AIC(u_height_lmer_subtr_09) %>% round(., 3))) %>% 
  add_footer_lines("*: p-value <= 0.05") %>%
  add_footer_lines("**: p-value <= 0.01") %>%
  add_footer_lines("***: p-value <= 0.001") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Supplement/lmer/Alternative_Models/Alt_models_Height/Q2_Urbscore_ANOVA_altmodels_HEIGHT.png"))
```


##### Creating table with AIC scores
###### Question 1
```{r}
# Lists of models

# BEST MODELS
## Q1/Dist: best_mods_Q1.dist_list
### HEIGHT: height_lmer_gradient_02

## Q1/Urb score: best_mods_Q1.urbscore_list
### HEIGHT: u_height_lmer_gradient_01

# ALTERNATIVE MODELS
## Q1/Dist: ONLY podsperped_lmer_gradient_01 (1)
### HEIGHT: height_lmer_gradient_01

## Q1/Urb score: ONLY u_podsperped_lmer_gradient_01 (1)
### HEIGHT: u_height_lmer_gradient_02


AIC_df.Q1 <- data.frame(matrix(nrow = 14,
                            ncol = 6))

colnames(AIC_df.Q1) <- c("Model", "Urbanization_Metric", "Best_or_Alt_Model", "Variable", "AIC", "Delta_AIC_from_Best_Model")
AIC_df.Q1$Model <- seq.int(nrow(AIC_df.Q1))
AIC_df.Q1[c(1:5, 11:12),  2] <- "Distance from City Center"
AIC_df.Q1[c(6:10, 13:14), 2] <- "Urbanization Score"
AIC_df.Q1[1:10,  3] <- "Best Model"
AIC_df.Q1[11:14, 3] <- "Alternative Model"
AIC_df.Q1 %<>%
  mutate(Delta_AIC_from_Best_Model = case_when(
    Best_or_Alt_Model == "Best Model" ~ "-"))

# Q1/Dist- BEST- main vars
for (i in 1:length(best_mods_Q1.dist_list)){
  AIC_df.Q1[i, 4] <- as.character(formula(best_mods_Q1.dist_list[[i]])[2])
  AIC_df.Q1[i, 5] <- as.double(AIC(best_mods_Q1.dist_list[[i]])) %>%
    round(., 3)
}
# Q1/Dist- BEST- height
AIC_df.Q1[5, 4] <- as.character(formula(height_lmer_gradient_02)[2])
AIC_df.Q1[5, 5] <- as.double(AIC(height_lmer_gradient_02)) %>%
  round(., 3)



# Q1/Urb score- BEST- main vars
for (i in 1:length(best_mods_Q1.urbscore_list)){
  AIC_df.Q1[(i + 5), 4] <- as.character(formula(best_mods_Q1.urbscore_list[[i]])[2])
  AIC_df.Q1[(i + 5), 5] <- as.double(AIC(best_mods_Q1.urbscore_list[[i]])) %>%
    round(., 3)
}

# Q1/Urb score- BEST- height
AIC_df.Q1[10, 4] <- as.character(formula(u_height_lmer_gradient_01)[2])
AIC_df.Q1[10, 5] <- as.double(AIC(u_height_lmer_gradient_01)) %>%
  round(., 3)

# ----

# Q1/Dist- ALTERNATIVE- main vars
AIC_df.Q1[11, 4] <- as.character(formula(podsperped_lmer_gradient_01)[2])
AIC_df.Q1[11, 5] <- as.double(AIC(podsperped_lmer_gradient_01)) %>%
  round(., 3)
## now calculate Delta AIC
AIC_df.Q1[11, 6] <- as.numeric(AIC_df.Q1[11, 5] - AIC_df.Q1[4, 5]) %>% 
  round(3)

# Q1/Dist- ALTERNATIVE- height
AIC_df.Q1[12, 4] <- as.character(formula(height_lmer_gradient_01)[2])
AIC_df.Q1[12, 5] <- as.double(AIC(height_lmer_gradient_01)) %>%
  round(., 3)
## now calculate Delta AIC
AIC_df.Q1[12, 6] <- as.numeric(AIC_df.Q1[12, 5] - AIC_df.Q1[5, 5]) %>% 
  round(3)




# Q1/Urb score- ALTERNATIVE- main vars
AIC_df.Q1[13, 4] <- as.character(formula(u_podsperped_lmer_gradient_01)[2])
AIC_df.Q1[13, 5] <- as.double(AIC(u_podsperped_lmer_gradient_01)) %>%
    round(., 3)
## now calculate Delta AIC
AIC_df.Q1[13, 6] <- as.numeric(AIC_df.Q1[13, 5] - AIC_df.Q1[9, 5]) %>% 
  round(3)

# Q1/Urb score- ALTERNATIVE- height
AIC_df.Q1[14, 4] <- as.character(formula(u_height_lmer_gradient_02)[2])
AIC_df.Q1[14, 5] <- as.double(AIC(u_height_lmer_gradient_02)) %>%
  round(., 3)
## now calculate Delta AIC
AIC_df.Q1[14, 6] <- as.numeric(AIC_df.Q1[14, 5] - AIC_df.Q1[10, 5]) %>% 
  round(3)



# Now make variable names nice
AIC_df.Q1 %<>%
  mutate(Variable = case_when(
    str_detect(Variable, "Peduncles") ~ "Inflorescences",
    str_detect(Variable, "Pollinia")  ~ "Pollinaria Removed",
    str_detect(Variable, "Viable_Pods") ~ "Follicles",
    str_detect(Variable, "pods_per")  ~ "Follicles per Inflorescence",
    str_detect(Variable, "Sept")  ~ "Height"
    )
  )


write.table(AIC_df.Q1, file = here::here("./Figures_Tables/AIC_df_Q1.txt"), sep = ",", quote = FALSE, row.names = F)

```


###### Question 2
```{r}
# Lists of models

# BEST MODELS
## Q2/Dist: best_mods_Q2.dist_list
### HEIGHT: height_lmer_subtr_01
## Q2/Urb score: best_mods_Q2.urbscore_list
### HEIGHT: u_height_lmer_subtr_01

# ALTERNATIVE MODELS
## Q2/Dist: alt_best_mods_Q2.dist_list (7)- 1 pollinia, 2 everything else
### HEIGHT: height_lmer_subtr_08
## Q2/Urb score: alt_best_mods_Q2.urbscore_list (6)- 2 ped, 1 pod, 3 pod/ped
### HEIGHT: u_height_lmer_subtr_09

AIC_df.Q2 <- data.frame(matrix(nrow = 25, 
                            ncol = 6))

colnames(AIC_df.Q2) <- c("Model", "Urbanization_Metric", "Best_or_Alt_Model", "Variable", "AIC", "Delta_AIC_from_Best_Model")
AIC_df.Q2$Model <- seq.int(nrow(AIC_df.Q2))
AIC_df.Q2[c(1:5, 11:18),  2] <- "Distance from City Center"
AIC_df.Q2[c(6:10, 19:25), 2] <- "Urbanization Score"
AIC_df.Q2[1:10,  3] <- "Best Model"
AIC_df.Q2[11:25, 3] <- "Alternative Model"
AIC_df.Q2 %<>%
  mutate(Delta_AIC_from_Best_Model = case_when(
    Best_or_Alt_Model == "Best Model" ~ "-"))

# Q2/Dist- BEST- main vars
for (i in 1:length(best_mods_Q2.dist_list)){
  AIC_df.Q2[i, 4] <- as.character(formula(best_mods_Q2.dist_list[[i]])[2])
  AIC_df.Q2[i, 5] <- as.double(AIC(best_mods_Q2.dist_list[[i]])) %>%
    round(., 3)
}
# Q2/Dist- BEST- height
AIC_df.Q2[5, 4] <- as.character(formula(height_lmer_subtr_01)[2])
AIC_df.Q2[5, 5] <- as.double(AIC(height_lmer_subtr_01)) %>%
  round(., 3)
  

# Q2/Urb score- BEST
for (i in 1:length(best_mods_Q2.urbscore_list)){
  AIC_df.Q2[(i + 5), 4] <- as.character(formula(best_mods_Q2.urbscore_list[[i]])[2])
  AIC_df.Q2[(i + 5), 5] <- as.double(AIC(best_mods_Q2.urbscore_list[[i]])) %>%
    round(., 3)
}
# Q2/Urb score- BEST- height
AIC_df.Q2[10, 4] <- as.character(formula(u_height_lmer_subtr_01)[2])
AIC_df.Q2[10, 5] <- as.double(AIC(u_height_lmer_subtr_01)) %>%
  round(., 3)
  


# Q2/Dist- ALTERNATIVE
for (i in 1:length(alt_best_mods_Q2.dist_list)){
  AIC_df.Q2[(i + 10), 4] <- as.character(formula(alt_best_mods_Q2.dist_list[[i]])[2])
  AIC_df.Q2[(i + 10), 5] <- as.double(AIC(alt_best_mods_Q2.dist_list[[i]])) %>%
    round(., 3)
}
## now calculate Delta AIC
AIC_df.Q2[11, 6] <- as.numeric(AIC_df.Q2[11, 5] - AIC_df.Q2[1, 5]) %>% 
  round(3)
AIC_df.Q2[12, 6] <- as.numeric(AIC_df.Q2[12, 5] - AIC_df.Q2[1, 5]) %>% 
  round(3)
AIC_df.Q2[13, 6] <- as.numeric(AIC_df.Q2[13, 5] - AIC_df.Q2[2, 5]) %>% 
  round(3)
AIC_df.Q2[14, 6] <- as.numeric(AIC_df.Q2[14, 5] - AIC_df.Q2[3, 5]) %>% 
  round(3)
AIC_df.Q2[15, 6] <- as.numeric(AIC_df.Q2[15, 5] - AIC_df.Q2[3, 5]) %>% 
  round(3)
AIC_df.Q2[16, 6] <- as.numeric(AIC_df.Q2[16, 5] - AIC_df.Q2[4, 5]) %>% 
  round(3)
AIC_df.Q2[17, 6] <- as.numeric(AIC_df.Q2[17, 5] - AIC_df.Q2[4, 5]) %>% 
  round(3)
# Q2/Dist- ALTERNATIVE- height
AIC_df.Q2[18, 4] <- as.character(formula(height_lmer_subtr_08)[2])
AIC_df.Q2[18, 5] <- as.double(AIC(height_lmer_subtr_08)) %>%
  round(., 3)
## now calculate Delta AIC
AIC_df.Q2[18, 6] <- as.numeric(AIC_df.Q2[18, 5] - AIC_df.Q2[5, 5]) %>% 
  round(3)

# Q2/Urb score- ALTERNATIVE
for (i in 1:length(alt_best_mods_Q2.urbscore_list)){
  AIC_df.Q2[(i + 18), 4] <- as.character(formula(alt_best_mods_Q2.urbscore_list[[i]])[2])
  AIC_df.Q2[(i + 18), 5] <- as.double(AIC(alt_best_mods_Q2.urbscore_list[[i]])) %>%
    round(., 3)
}
## now calculate Delta AIC
AIC_df.Q2[19, 6] <- as.numeric(AIC_df.Q2[19, 5] - AIC_df.Q2[6, 5]) %>% 
  round(3)
AIC_df.Q2[20, 6] <- as.numeric(AIC_df.Q2[20, 5] - AIC_df.Q2[6, 5]) %>% 
  round(3)
AIC_df.Q2[21, 6] <- as.numeric(AIC_df.Q2[21, 5] - AIC_df.Q2[8, 5]) %>% 
  round(3)
AIC_df.Q2[22, 6] <- as.numeric(AIC_df.Q2[22, 5] - AIC_df.Q2[9, 5]) %>% 
  round(3)
AIC_df.Q2[23, 6] <- as.numeric(AIC_df.Q2[23, 5] - AIC_df.Q2[9, 5]) %>% 
  round(3)
AIC_df.Q2[24, 6] <- as.numeric(AIC_df.Q2[24, 5] - AIC_df.Q2[9, 5]) %>% 
  round(3)
# Q2/Dist- ALTERNATIVE- height
AIC_df.Q2[25, 4] <- as.character(formula(u_height_lmer_subtr_09)[2])
AIC_df.Q2[25, 5] <- as.double(AIC(u_height_lmer_subtr_09)) %>%
  round(., 3)
## now calculate Delta AIC
AIC_df.Q2[25, 6] <- as.numeric(AIC_df.Q2[25, 5] - AIC_df.Q2[10, 5]) %>% 
  round(3)



# Now make variable names nice
AIC_df.Q2 %<>%
  mutate(Variable = case_when(
    str_detect(Variable, "Peduncles") ~ "Inflorescences",
    str_detect(Variable, "Pollinia")  ~ "Pollinaria Removed",
    str_detect(Variable, "Viable_Pods") ~ "Follicles",
    str_detect(Variable, "pods_per")  ~ "Follicles per Inflorescence",
    str_detect(Variable, "Sept")  ~ "Height"
    )
  )



write.table(AIC_df.Q2, file = here::here("./Figures_Tables/AIC_df_Q2.txt"), sep = ",", quote = FALSE, row.names = F)
```



### Figures- NOT USING THESE- THESE USE POP MEANS. LOOK TO GGPREDICT_FIGURES.R SCRIPT INSTEAD FOR GGPREDICT-GENERATED PLOTS.
#### Main text
##### Gradient regressions
```{r}
## CITY_DIST -----------------------
# POLLINIA --------
Q1_reg_poll <- ggplot(AvgVars_notNA_Poll_18_19,
                      aes(x = City_dist, y = Average_Pollinia,
                          shape=Year)) + 
  labs(x = "Distance to city center (km)", 
    y = "Pollinaria Removed") +
  geom_point(aes(shape=Year, color=Year),  size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape=Year, color=Year, fill=Year), size=0.75, method = lm, alpha=.15, se = T) +
  scale_y_continuous(breaks=c(0,1,2,3,4,5), limits=c(0,5)) +
  labs( color="Year", shape="Year") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
Q1_reg_poll


# PODS --------
Q1_reg_pod <- ggplot(fertile_pops_all,
                     aes(x = City_dist, y = Viable_Pods^2, shape=Year)) +
  labs(x = "Distance to city center (km)",
       y = expression(Follicles^{2})) +
  geom_point(aes(shape=Year, color=Year),  size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape=Year, color=Year, fill=Year), size=0.75, method = lm, alpha=0.15, se = T) +
  scale_y_continuous(limits=c(0,350)) +
  labs(color="Year", size = "Year") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
Q1_reg_pod



# PEDUNCLES --------
Q1_reg_ped <- ggplot(fertile_pops_all,
                     aes(x = City_dist, y = Peduncles, shape=Year)) +
  labs(x = "Distance to city center (km)",
       y = "Inflorescences") +
  geom_point(aes(shape=Year, color=Year),  size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape=Year, color=Year, fill=Year), size=0.75, method = lm, alpha=0.15, se = T) +
  scale_y_continuous(limits=c(0,15)) +
  labs(color="Year", size = "Year") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
     text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
Q1_reg_ped

# FOLLICLES PER INFLOR --------
Q1_reg_follperinflor <- ggplot(fertile_pops_all,
                               aes(x = City_dist, y = pods_per_ped, shape=Year)) +
  labs(x = "Distance to city center (km)",
    y = "Follicles/Inflorescence") +
  geom_point(aes(color = Year, shape = Year), size=2) +
  scale_shape(solid = F)+
  scale_y_continuous(limits=c(0,1.5)) +
  geom_smooth(aes(colour=Year, shape=Year, fill=Year),size=0.75, method = lm, alpha=0.15, se = T) +
  labs(color="Year", size="Year") +
  labs(linetype="Year", shape = "Year") +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
Q1_reg_follperinflor

# PLANT DENSITY AT SITE (not included in composite figure, below) --------
# Q1_reg_density <- ggplot(density_18, aes(x = City_dist, y = density_sqm_18)) +
#   labs( x = "Distance to city center (km)", y = "Plant density") +
#   geom_point(size=2) +
#   scale_shape(solid = F)+
#   geom_smooth(size=0.75, method = lm, alpha=0.15, se = T) +
#   theme(legend.position = c(.99, .99),
#     legend.justification = c("right", "top"),
#     legend.box.just = "right",
#     legend.box = 'horizontal',
#     legend.margin = margin(5,5,5,5),
#     text = element_text(size=14),
#     axis.title.x = element_blank(),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black"),
#     legend.key = element_rect(fill = NA) )
# Q1_reg_density


## URB_SCORE -------------------------
# POLLINIA --------
Q1_reg_poll_u <- ggplot(AvgVars_notNA_Poll_18_19, 
                        aes(x = Urb_score, y = Average_Pollinia, shape=Year)) +
  labs(
    # x = "Urbanization Score",
    y = "Pollinaria Removed") +
  scale_x_reverse() +
  geom_point(aes(shape=Year, color=Year),  size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape=Year, color=Year, fill=Year), size=0.75, method = lm, alpha=.15, se = T) +
  scale_y_continuous(breaks=c(0,1,2,3,4,5), limits=c(0,5)) +
  labs( color="Year", shape="Year") +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    # legend.position = c(.99, .99),
    # legend.justification = c("right", "top"),
    # legend.box = 'horizontal',
    # legend.box.just = "right",
    # legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
    # legend.key = element_rect(fill = NA)
    )
Q1_reg_poll_u


# PODS --------
Q1_reg_pod_u <- ggplot(fertile_pops_all,
                       aes(x = Urb_score, y = Viable_Pods^3, shape=Year)) +
  labs(
  # x = "Urbanization Score",
    y = expression(Follicles^{3})) +
  scale_x_reverse() +
  geom_point(aes(shape=Year, color=Year),  size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape=Year, color=Year, fill=Year), size=0.75, method = lm, alpha=0.15, se = T) +
  # scale_y_continuous(limits=c(0,5)) +
  labs(color="Year", size = "Year") +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
 #    legend.position = c(.99, .99),
 #    legend.justification = c("right", "top"),
 #    legend.box = 'horizontal',
 #    legend.box.just = "right",
 #    legend.margin = margin(5,5,5,5),
     text = element_text(size=14),
 #    axis.title.x = element_blank(),
     panel.background = element_blank(),
     axis.line = element_line(colour = "black")
 #    legend.key = element_rect(fill = NA)
 )
Q1_reg_pod_u



# PEDUNCLES --------
Q1_reg_ped_u <- ggplot(fertile_pops_all,
                       aes(x = Urb_score, y = (Peduncles), shape=Year)) + 
  labs(
    # x = "Urbanization Score",
       y = "Inflorescences") +
  scale_x_reverse() +
  geom_point(aes(shape=Year, color=Year),  size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape=Year, color=Year, fill=Year), size=0.75, method = lm, alpha=0.15, se = T) +
  scale_y_continuous(limits=c(0,15)) +
  labs(color="Year", size = "Year") +
  theme(
    legend.position = "none",
        axis.title.x = element_blank(),
    # legend.position = c(.99, .99),
    # legend.justification = c("right", "top"),
    # legend.box = 'horizontal',
    # legend.box.just = "right",
    # legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
    # legend.key = element_rect(fill = NA)
    )
Q1_reg_ped_u

# FOLLICLES PER INFLOR --------
Q1_reg_follperinflor_u <- ggplot(fertile_pops_all, 
                                 aes(x = Urb_score, y = pods_per_ped, shape=Year)) +
  labs(
  # x = "Urbanization Score",
       y = "Follicles/Inflorescence") +
  scale_x_reverse() +
  geom_point(aes(color = Year, shape = Year), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(colour=Year, shape=Year, fill=Year),size=0.75, method = lm, alpha=0.15, se = T) +
  labs(color="Year", size="Year") +
  labs(linetype="Year",  shape = "Year") +
  theme(legend.position = "none",
            axis.title.x = element_blank(),
    # legend.position = c(.99, .99),
    # legend.justification = c("right", "top"),
    # legend.box.just = "right",
    # legend.box = 'horizontal',
    # legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
    # legend.key = element_rect(fill = NA)
    )
Q1_reg_follperinflor_u



## PLOTS ------
library(ggpubr)
Q1_regressions_citydist <- ggarrange(Q1_reg_ped , Q1_reg_poll, Q1_reg_pod,  Q1_reg_follperinflor +
                            font("x.text"),
                            ncol = 4,
                            nrow = 1,
                            align = "hv",
                            labels = list("A", "B", "C", "D"),
                            font.label = (size =16),
                            common.legend = T,
                            legend = "top") %T>%
  plot

Q1_regressions_urbscore <- ggarrange(Q1_reg_ped_u, Q1_reg_poll_u, Q1_reg_pod_u,  Q1_reg_follperinflor_u +
                            font("x.text"),
                            ncol = 4,
                            nrow = 1,
                            align = "hv",
                            labels = list("E", "F", "G", "H"),
                            font.label = (size =16),
                            common.legend = F) %T>%
  plot

city_plots <- annotate_figure(Q1_regressions_citydist, bottom = text_grob("Distance to Urban Center (km)", size=14))
urbscore_plots <- annotate_figure(Q1_regressions_urbscore, bottom = text_grob("Urbanization Score", size=14))

city_plots/urbscore_plots

dev.copy2pdf(file="~/R_Projects/chapter_one/Figures_Tables/Q1_Gradient/Gradient_regressions.pdf", width = 12, height = 8)
```


##### Urban subtransect regressions
```{r}
## CITY_DIST -----------------------
# POLLINIA-----
Q2_reg_poll_subtr <- ggplot(AvgVars_notNA_Poll_18_19 %>%
                              filter(Transect_ID != "Rural"),
                            aes(x = City_dist, y = Average_Pollinia,
                                group = interaction(Year,Transect_ID),
                                color=interaction(Year,Transect_ID),
                                linetype=interaction(Year,Transect_ID),
                                shape=interaction(Year,Transect_ID))) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_y_continuous(breaks=c(0,1,2,3), limits=c(0,3)) +
  labs(x = "Distance to City Center (km)",
       y = "Pollinaria Removed",
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") )

Q2_reg_poll_subtr

# PODS-----
Q2_reg_pod_subtr <- ggplot(fertile_pops_all %>%
                              filter(Transect_ID != "Rural"),
                           aes(x = City_dist, y = (Viable_Pods)^2,
                               group=interaction(Year,Transect_ID),
                               color=interaction(Year,Transect_ID),
                               linetype=interaction(Year,Transect_ID),
                               shape=interaction(Year,Transect_ID))) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  labs(x = "Distance to City Center (km)",
       y = expression(Follicles^{2}) ,
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
 text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") )

Q2_reg_pod_subtr


# PEDUNCLES----
Q2_reg_ped_subtr <- ggplot(fertile_pops_all %>%
                             filter(Transect_ID != "Rural"),
                           aes(x = City_dist,
                               y = Peduncles,
                               group=interaction(Year,Transect_ID),
                               color=interaction(Year,Transect_ID),
                               linetype=interaction(Year,Transect_ID),
                               shape=interaction(Year,Transect_ID)
                                 )) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_y_continuous(limits=c(0,15)) +
  labs(x = "Distance to City Center (km)",
       y = "Inflorescences",
    color = "Year, Subtransect",
    shape = "Year, Subtransect",
    linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
     text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") )

Q2_reg_ped_subtr

# FOLLICLES PER INFLORESCENCE----
Q2_reg_follperinfl_subtr <-  ggplot(fertile_pops_all %>%
                                      filter(Transect_ID != 'Rural'),
                                   aes(x = City_dist,
                                       y = pods_per_ped, 
                                       group=interaction(Year,Transect_ID),
                                       color=interaction(Year,Transect_ID),
                                       linetype=interaction(Year,Transect_ID),
                                       shape=interaction(Year,Transect_ID))) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_y_continuous(limits=c(0,3)) +
  labs(x = "Distance to City Center (km)",
    y = "Follicles/Inflorescence",
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line"))
# +  guides(colour = guide_legend(override.aes = list(size=7)))
Q2_reg_follperinfl_subtr


## URB_SCORE -------------------------
# POLLINIA-----
Q2_reg_poll_subtr_u <- ggplot(AvgVars_notNA_Poll_18_19 %>%
                                filter(Transect_ID != "Rural"),
                              aes(Urb_score, Average_Pollinia,
                                 group=interaction(Year,Transect_ID),
                                 color=interaction(Year,Transect_ID),
                                 linetype=interaction(Year,Transect_ID),
                                 shape=interaction(Year,Transect_ID)
                                 )) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_x_reverse() +
  scale_y_continuous(breaks=c(0,1,2,3), limits=c(0,3)) +
  labs(x = "Urbanization Score",
       y = "Pollinaria Removed",
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size=14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
Q2_reg_poll_subtr_u

# PODS-----
Q2_reg_pod_subtr_u <- ggplot(data = fertile_pops_all %>%
                               filter(Transect_ID != "Rural"),
                             aes(Urb_score, Viable_Pods^2,
                                 group=interaction(Year,Transect_ID),
                                 color=interaction(Year,Transect_ID),
                                 linetype=interaction(Year,Transect_ID),
                                 shape=interaction(Year,Transect_ID)
                                 )) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_x_reverse() +
  scale_y_continuous(limits = c(0,400)) +
  labs(x = "Urbanization Score",
       y = expression(Follicles^{2}) ,
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size=14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
Q2_reg_pod_subtr_u


# PEDUNCLES----
Q2_reg_ped_subtr_u <- ggplot(fertile_pops_all %>%
                               filter(Transect_ID != "Rural"),
                             aes(Urb_score, Peduncles,
                                 group=interaction(Year,Transect_ID),
                                 color=interaction(Year,Transect_ID),
                                 linetype=interaction(Year,Transect_ID),
                                 shape=interaction(Year,Transect_ID)
                                 )) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_x_reverse() +
  scale_y_continuous(limits=c(0,15)) +
  labs(x = "Urbanization Score",
       y = "Inflorescences",
    color = "Year, Subtransect",
    shape = "Year, Subtransect",
    linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size=14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
Q2_reg_ped_subtr_u

# FOLLICLES PER INFLORESCENCE----
Q2_reg_follperinfl_subtr_u <- ggplot(fertile_pops_all %>%
                               filter(Transect_ID != "Rural"),
                                     aes(Urb_score, pods_per_ped,
                                 group=interaction(Year,Transect_ID),
                                 color=interaction(Year,Transect_ID),
                                 linetype=interaction(Year,Transect_ID),
                                 shape=interaction(Year,Transect_ID)
                                 )) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_x_reverse() +
  scale_y_continuous(limits=c(0,3)) +
  labs(x = "Urbanization Score",
       y = "Follicles/Inflorescence",
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size=14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))

Q2_reg_follperinfl_subtr_u





## PLOTS ------
library(ggpubr)
Q2_regressions_citydist <- ggarrange(Q2_reg_ped_subtr,Q2_reg_poll_subtr, Q2_reg_pod_subtr,  Q2_reg_follperinfl_subtr +
                            font("x.text"),
                            ncol = 4,
                            nrow = 1,
                            align = "hv",
                            labels = list("A", "B", "C", "D"),
                            font.label = (size =16),
                            common.legend = T,
                            legend = "top") %T>%
  plot

Q2_regressions_urbscore <- ggarrange(Q2_reg_ped_subtr_u,Q2_reg_poll_subtr_u, Q2_reg_pod_subtr_u,  Q2_reg_follperinfl_subtr_u +
                            font("x.text"),
                            ncol = 4,
                            nrow = 1,
                            align = "hv",
                            labels = list("E", "F", "G", "H"),
                            font.label = (size =16),
                            common.legend = F) %T>%
  plot

city_plots_subtr <- annotate_figure(Q2_regressions_citydist, bottom = text_grob("Distance to Urban Center (km)", size=14))
urbscore_plots_subtr <- annotate_figure(Q2_regressions_urbscore, bottom = text_grob("Urbanization Score", size=14))

city_plots_subtr/urbscore_plots_subtr

dev.copy2pdf(file="~/R_Projects/chapter_one/Figures_Tables/Q2_UrbanSubtransects/Subtransect_regressions.pdf", width = 12, height = 8)
```


#### Supplement
##### Height, Gradient regressions
```{r}
### CITY_DIST --------
Q1_reg_height <- ggplot(fertile_pops_all,
                        aes(x = City_dist, y = Height_Sept, shape=Year, color = Year)) +
  labs(x = "Distance to Urban Center (km)", 
    y = "Height (cm)") +
  geom_point(aes(color = Year, shape = Year), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(colour=Year, shape=Year, fill=Year),size=0.75, method = lm, alpha=0.15, se = T) +
  labs(color="Year", size="Year") +
  scale_y_continuous(limits=c(0,200)) +
  labs(linetype="Year", color="Year", shape = "Year") +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
Q1_reg_height

### URB_SCORE--------
Q1_reg_height_u <- ggplot(fertile_pops_all,
                          aes(x = Urb_score, y = Height_Sept, shape=Year)) +
  labs(x = "Urbanization Score", 
    y = "Height (cm)") +
  geom_point(aes(color = Year, shape = Year), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(colour=Year, shape=Year, fill=Year),size=0.75, method = lm, alpha=0.15, se = T) +
  labs(color="Year", size="Year") +
  scale_y_continuous(limits=c(0,200)) +
  labs(linetype="Year", color="Year", shape = "Year") +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
Q1_reg_height_u


library(ggpubr)
Q1_regressions_supp <- ggarrange(Q1_reg_height, Q1_reg_height_u + font("x.text"), ncol = 2, nrow = 1, align = "h", labels = list("A", "B"), font.label = (size =16), common.legend = TRUE, legend = "right")
Q1_regressions_supp

dev.copy2pdf(file="~/R_Projects/chapter_one/Figures_Tables/Q1_Gradient/Supplement/Gradient_regression_height.pdf", width = 8, height = 4)
```

##### Height, Subtransect regressions
```{r}
## CITY_DIST-----
Q2_reg_height <- ggplot(fertile_pops_all %>%
                          filter(Transect_ID != "Rural"),
                        aes(x = City_dist, y = Height_Sept,
                            group=interaction(Year,Transect_ID),
                            color=interaction(Year,Transect_ID),
                            linetype=interaction(Year,Transect_ID),
                            shape=interaction(Year,Transect_ID))) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_y_continuous(limits = c(0, 160)) +
  labs(x = "Distance to Urban Center (km)",
    y = "Height (cm)",
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line"))+
  guides(shape = guide_legend(nrow = 2),
         color = guide_legend(nrow = 2),
         linetype = guide_legend(nrow = 2))
Q2_reg_height


## URB_SCORE-----
Q2_reg_height_u <- ggplot(fertile_pops_all %>%
                            filter(Transect_ID != "Rural"),
                        aes(x = Urb_score,
                            y = Height_Sept,
                            group=interaction(Year,Transect_ID),
                            color=interaction(Year,Transect_ID),
                            linetype=interaction(Year,Transect_ID),
                            shape=interaction(Year,Transect_ID))) + 
  geom_point(size=2.5)  +
  scale_x_reverse() +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  labs(x = "Urbanization Score",
    y = "Height (cm)",
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
    scale_y_continuous(limits = c(0, 160)) +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") ) +
  guides(shape = guide_legend(nrow = 2),
         color = guide_legend(nrow = 2),
         linetype = guide_legend(nrow = 2))
Q2_reg_height_u

## PLOTS-----
library(ggpubr)
Q2_regressions_supp <- ggarrange(Q2_reg_height, Q2_reg_height_u + font("x.text"), ncol = 2, nrow = 1, align = "h", labels = list("A", "B"), font.label = (size =16), common.legend = TRUE, legend = "bottom")
Q2_regressions_supp

dev.copy2pdf(file="~/R_Projects/chapter_one/Figures_Tables/Q2_UrbanSubtransects/Supplement/Subtransect_regression_height.pdf", width = 7, height = 4)
```
