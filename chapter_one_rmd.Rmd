---
title: "Chapter One- Observational Study of Milkweed Reproductive Success along Toronto Urban-Rural Gradient."
author: "Sophie Breitbart"
date: "12/22/2020"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console

WHEN TOTALLY DONE, type this:
renv::activate()
renv::snapshot()
---

# Set up notebook
## Install, load packages
```{r message=FALSE, warning=FALSE}
# devtools::install_github("cardiomoon/ggiraphExtra")
# devtools::install_github("dkahle/ggmap")
# devtools::install_github("hadley/devtools")
# install.packages("agricolae")
# install.packages("BH")
# install.packages("car")
# install.packages("cowplot")
# install.packages("digest", type="source")
# install.packages("dplyr")
# install.packages("factoextra")
# install.packages("flextable")
# install.packages("geosphere")
# install.packages("ggiraphExtra")
# install.packages("ggpubr")
# install.packages("ggsn")
# install.packages("ggspatial")
# install.packages("GISTools")
# install.packages("ISLR")
# install.packages("janitor")
# install.packages("lindia")
# install.packages("lme4")
# install.packages("lmerTest")
# install.packages("mnormt")
# install.packages("patchwork")
# install.packages("plogr")
# install.packages("psych")
# install.packages("RcppEigen")
# install.packages("rpart")
# install.packages('sjPlot')
# install.packages('stargazer')
# install.packages("swirl")
# install.packages("tibble")
# install.packages("tidyverse")
# install.packages("vegan")
# install.packages("XLConnect")
# install.packages('backports')
# install.packages(c("slidify", "ggplot2", "devtools"))
# install.packages('maps')
# install.packages('rmarkdown')
# install_github("vqv/ggbiplot")
library("FactoMineR")
library("tibble", lib.loc="~/R/win-library/3.5")
library(agricolae)
library(apaTables)
library(car)
library(data.table)
library(devtools)
library(DHARMa)
library(dplyr)
library(e1071)
library(factoextra)
library(flextable)
library(forcats)
library(geosphere)
library(ggbiplot)
library(ggmap)
library(ggpubr)
library(ggsn)
library(ggspatial)
library(GISTools)
library(glmmTMB)
library(gridExtra)
library(here)
library(Hmisc)
library(hrbrthemes)
library(ISLR)
library(janitor)
library(lindia)
library(lme4)
library(lmerTest)
library(lsmeans)
library(MASS)
library(multcomp)
library(MuMIn)
library(nlme)
library(patchwork)
library(plyr)
library(reshape)
library(reshape2)
library(rpart)
library(sjPlot)
library(stargazer)
library(tibble)
library(tidyr)
library(tidyverse)
library(vegan)
library(viridis)
require(ggiraph)
require(ggiraphExtra)
require(ggplot2)
require(MASS)
require(scales)

```

## Import data
```{r, import}
long_Transect_Data_18_19 <-
  read.csv(here::here("./clean_data/long_Transect_Data_18_19.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)


AvgVars_notNA_Poll_18_19 <-
  read.csv(here::here("./clean_data/AvgVars_notNA_Poll_18_19.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)

fertile_long <-
  read.csv(here::here("./clean_data/fertile_long.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)


fertile <-
  read.csv(here::here("./clean_data/fertile.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)

fertile_pops_all <-
  read.csv(here::here("./clean_data/fertile_pops_all.csv"),
           header=T,
           na.strings=c("","NA")) %>%
  dplyr::select(-1)
```
## Make sure classes are correct
```{r}
# long_Transect_Data_18_19-----

str(long_Transect_Data_18_19)

# Make columns numeric
long_Transect_Data_18_19$Inflor <- as.numeric(as.character(long_Transect_Data_18_19$Inflor))
long_Transect_Data_18_19$Pollinia_removed <- as.numeric(as.character(long_Transect_Data_18_19$Pollinia_removed))
long_Transect_Data_18_19$Flower <- as.numeric(as.character(long_Transect_Data_18_19$Flower))

# make patch ID, plant, year, and inflor cols factors
long_Transect_Data_18_19$Patch_ID <- as.factor(as.character(long_Transect_Data_18_19$Patch_ID))
long_Transect_Data_18_19$Plant_Num <- as.factor(as.character(long_Transect_Data_18_19$Plant_Num))
long_Transect_Data_18_19$Inflor <- as.factor(as.character(long_Transect_Data_18_19$Inflor))
long_Transect_Data_18_19$Year <- as.factor(as.character(long_Transect_Data_18_19$Year))

# make pollinia removed an integer
long_Transect_Data_18_19$Pollinia_removed <- as.integer(as.character(long_Transect_Data_18_19$Pollinia_removed))


# AvgVars_notNA_Poll_18_19------

str(AvgVars_notNA_Poll_18_19)

# make cols factors
AvgVars_notNA_Poll_18_19$Patch_ID <- as.factor(as.character(AvgVars_notNA_Poll_18_19$Patch_ID))
AvgVars_notNA_Poll_18_19$Year <- as.factor(as.character(AvgVars_notNA_Poll_18_19$Year))


# fertile_long-----

str(fertile_long)

# Make columns numeric
fertile_long$Inflor <- as.numeric(as.character(fertile_long$Inflor))
fertile_long$Pollinia_removed <- as.numeric(as.character(fertile_long$Pollinia_removed))
fertile_long$Flower <- as.numeric(as.character(fertile_long$Flower))

# make patch ID, plant, year, and inflor cols factors
fertile_long$Patch_ID <- as.factor(as.character(fertile_long$Patch_ID))
fertile_long$Plant_Num <- as.factor(as.character(fertile_long$Plant_Num))
fertile_long$Inflor <- as.factor(as.character(fertile_long$Inflor))
fertile_long$Year <- as.factor(as.character(fertile_long$Year))

str(fertile_long)


# fertile-----

str(fertile)

# make patch ID, plant, year, and inflor cols factors
fertile$Patch_ID <- as.factor(as.character(fertile$Patch_ID))
fertile$Plant_Num <- as.factor(as.character(fertile$Plant_Num))
fertile$Year <- as.factor(as.character(fertile$Year))

str(fertile)


# fertile_pops_all-----

str(fertile_pops_all)

fertile_pops_all$Year <- as.factor(as.character(fertile_pops_all$Year))

str(fertile_pops_all)

```

## Variable key

* Average_Pollinia
: Average number of pollinia removed per flower, per plant, per population (0-5). Was measured in July of 2018 and 2019.

* City_dist
: Population's distance from urban center (Yonge & Dundas in Toronto), in kilometers.

* Transect_ID
: + Northern urban transect,
: + Southern urban transect (which follows green corridors including railroad tracks, trails, hydro lines, etc.), or
: + Rural transect.

    See [link](https://www.google.com/maps/d/u/0/edit?hl=en&mid=1T6o02xqdFY49LpaV5fgpNYcgUNfy6hWJ&ll=43.54856560494681%2C-79.7330821595105&z=10) for a map of the 3 transects.  
  
* Peduncles
: Average number of peduncles per plant per population

* Height_July
: Average height of sampled plants in July (when performing pollinia removal survey), in centimeters

* Plants_present_2018
: Number of plants present at the sampling site in 2018. Populations were spaced at least 500 meters apart to ensure population distinction.

* Height_Sept
: Average height of sampled plants in September (when performing follicle, peduncle survey), in centimeters

* Viable_Pods
: Average number of viable follciles per plant per population. These follicles were usually around 6-10 cm long, compared to aborted follicles, which were usually about 1 cm long and seemed to have stopped growing based on size and color (oftentimes brown/dried up).

* Total_Pods
: Average number of *combined* viable and aborted follciles per plant per population. In 2018, we did not distinguish between aborted and viable follicles, so this variable is used to compare follicle production over both years. Viable follicle production can only be measured for 2019 alone.

* nPlants
: Number of plants sampled per population.

* Average_pod_length
: Average length of all pods measured on surveyed plants in 2019, in centimeters. This data was not collected in 2018. In 2019, it was collected to understand whether there is a relationship between pod dimensions and seed number and/or seed mass. (As of October 2019, it seems there is a surprisingly weak relationship.)

# Methods
## Sampling design stats
### How many plants are within transects?
```{r}
# For the southern urban (green corridor) subtransect, these sites are within the green corridor: MW032, MW014, MW013, MW003, MW004, MW069, MW050
# **MW013 isn't technically within the green corridor itself but it's perpendicular and connected through a different green corridor, so I'm counting it. It's ~100m from the corridor.

# 29 southern urban sites total, 7 within the corridor itself (<25%)
```

### Histograms of green corridor site proximities
```{r}
library(ggplot2)
library(dplyr)

corridor_data <- read.csv(here("./Corridor_Analysis/SouthernUrbanSites_ProximitytoCorridor.csv"),  header=T, na.strings=c("","NA"))


corridor_data %>%
  ggplot( aes(x=Distance, fill = Corr_or_greenspace)) +
    geom_histogram( alpha=0.5, position = 'identity', binwidth = 50) +
  facet_wrap(~Corr_or_greenspace) +
  scale_x_continuous(name="Site Distance to...",
                     breaks = seq(0,2800,500),
                     labels = seq(0,2800,500)) +
  theme(legend.position = 'none')

corr_dist <- (corridor_data$Distance)
bins <- seq(0,2700,by=50)
corr_table <- cut(corr_dist,bins)
# transform(table(corr_table))

corr_table1<- with(corridor_data, table(Corr_or_greenspace, cut(Distance, bins, include.lowest = TRUE)))
# transform(corr_table1)
library(data.table)
corr_df <- setDT(corridor_data)[, .N, by = .(Corr_or_greenspace, Bin = cut(Distance, bins, include.lowest = TRUE))] 

corr_df_spread <- tidyr::spread(corr_df, Corr_or_greenspace, N)

corr_df_spread$Percent_Corridor <- as.numeric(corr_df_spread$Corridor) / .34
corr_df_spread$Percent_Greenspace <- as.numeric(corr_df_spread$Greenspace) / .34
corr_df_spread[is.na(corr_df_spread)] <- 0
corr_df_spread$Perc_Corr_Cumulative <- cumsum(corr_df_spread[, 4])
corr_df_spread$Perc_Greensp_Cumulative <- cumsum(corr_df_spread[, 5])

write.csv(corr_df_spread,"corr_df_spread.csv", row.names = FALSE)

```



# Results
## Questions 1-2 (Traits along urb-rural gradient and urban subtransects)
### Model Selection
#### Linear Models
##### Pollinia
###### GLMER- no transformations needed
####### City_dist, not Urb_score
######## All sites
```{r}

# ## NOT CONVERGING- ERROR
# glmer(as.numeric(Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) + City_dist * Year,
#       long_Transect_Data_18_19,
#       family = "poisson",
#       glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))



# SEPARATE BY YEAR
## do this for only 2018-----
# no error
poll_glmer_gradient_01 <- glmer((Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) + City_dist,
                                long_Transect_Data_18_19 %>%
                                  filter(., Year == '2018'),
                                family = "poisson") %T>%
  simulateResiduals() %T>%
  plot() # looks good



## do this for only 2019-----
# no error
poll_glmer_gradient_02 <- glmer((Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) + City_dist,
                                long_Transect_Data_18_19 %>%
                                  filter(., Year == '2019'),
                                family = "poisson") %T>%
  simulateResiduals() %T>%
  plot() # looks good



# 2018 DATA
summary(poll_glmer_gradient_01)
poll_glmer_gradient_01_anova <- car::Anova(poll_glmer_gradient_01) %T>%
  print()
# city_dist sig


# 2019 DATA
summary(poll_glmer_gradient_02)
poll_glmer_gradient_02_anova <- car::Anova(poll_glmer_gradient_02) %T>%
  print()
# city_dist sig



poll_glmer_gradient_list <- list(poll_glmer_gradient_01,
                                 poll_glmer_gradient_02)

```

######## Just urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
poll_glmer_subtr_01 <- glmer((Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) +
                               
                               Year:Transect_ID:City_dist + 
                               
                               Year:Transect_ID + 
                               City_dist:Transect_ID +
                               City_dist:Year +
                               
                               City_dist +
                               Year +
                               Transect_ID,
                             
                             long_Transect_Data_18_19 %>%
                               filter(Transect_ID != 'Rural'),
                             family = "poisson",
                             glmerControl(optimizer="bobyqa",
                                          optCtrl = list(maxfun = 100000)))

# all main effects and secondary interactions
poll_glmer_subtr_02 <- update(poll_glmer_subtr_01,
                              . ~ . -Year:Transect_ID:City_dist)

# all main effects and 2/3 secondary interactions
poll_glmer_subtr_03 <- update(poll_glmer_subtr_02,
                              . ~ . -Transect_ID:City_dist)
poll_glmer_subtr_04 <- update(poll_glmer_subtr_02,
                              . ~ . -Year:City_dist)
poll_glmer_subtr_05 <- update(poll_glmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
poll_glmer_subtr_06 <- update(poll_glmer_subtr_03,
                              . ~ . -Year:City_dist)
poll_glmer_subtr_07 <- update(poll_glmer_subtr_04,
                              . ~ . -Year:Transect_ID)
poll_glmer_subtr_08 <- update(poll_glmer_subtr_05,
                              . ~ . -Transect_ID:City_dist)

# all main effects
poll_glmer_subtr_09 <- update(poll_glmer_subtr_08,
                              . ~ . -Year:City_dist)

poll_glmer_subtr_list <- list(poll_glmer_subtr_01,
                               poll_glmer_subtr_02,
                               poll_glmer_subtr_03,
                               poll_glmer_subtr_04,
                               poll_glmer_subtr_05,
                               poll_glmer_subtr_06,
                               poll_glmer_subtr_07,
                               poll_glmer_subtr_08,
                               poll_glmer_subtr_09)

# formula(poll_glmer_subtr_list[[2]])
formulas_poll <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_poll$Model <- NA
formulas_poll$Formula <- NA
formulas_poll$r.squaredGLMM_R2m <- NA
formulas_poll$r.squaredGLMM_R2c <- NA

for (i in 1:length(poll_glmer_subtr_list)) {
  formulas_poll[i, 1] <- toString(i)
  formulas_poll[i, 2] <- toString(formula(poll_glmer_subtr_list[[i]]))
  formulas_poll[i, 3] <- r.squaredGLMM(poll_glmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_poll[i, 4] <- r.squaredGLMM(poll_glmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_poll <- do.call(rbind,
                       lapply(poll_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_poll <- bind_cols(formulas_poll,
                        glance_poll %>%
                          dplyr::select(AIC, BestModels)) # Models 1, 3 lowest AIC (1 best)

# check residuals
plot(simulateResiduals(poll_glmer_subtr_01)) # looks good
plot(simulateResiduals(poll_glmer_subtr_03)) # looks good


summary(poll_glmer_subtr_01)
summary(poll_glmer_subtr_03)
poll_glmer_subtr_01_anova <- car::Anova(poll_glmer_subtr_01) %T>%
  print()
poll_glmer_subtr_03_anova <- car::Anova(poll_glmer_subtr_03) %T>%
  print()

```

####### Urb_score, not city_dist
######## All sites
```{r}
u_poll_glmer_gradient_1 <- glmer(Pollinia_removed ~ (1|Patch_ID/Plant_Num/Inflor) +
                                   
                                   Urb_score:Year +
                                   Urb_score +
                                   Year,
                                 
                                 long_Transect_Data_18_19,
                                 family = "poisson",
             glmerControl(optimizer="bobyqa",
                          optCtrl = list(maxfun = 100000)))

# all main effects and secondary interactions
u_poll_glmer_gradient_1.1 <- update(u_poll_glmer_gradient_1,
                              . ~ . -Urb_score:Year)

u_poll_glmer_gradient_list <- list(u_poll_glmer_gradient_1,
                                   u_poll_glmer_gradient_1.1)

# formula(poll_glmer_subtr_list[[2]])
u_formulas_poll <- data.frame(matrix(ncol = 0, nrow = 2))
u_formulas_poll$Model <- NA
u_formulas_poll$Formula <- NA
u_formulas_poll$r.squaredGLMM_R2m <- NA
u_formulas_poll$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_poll_glmer_gradient_list)) {
  u_formulas_poll[i, 1] <- toString(i)
  u_formulas_poll[i, 2] <- toString(formula(u_poll_glmer_gradient_list[[i]]))
  u_formulas_poll[i, 3] <- r.squaredGLMM(u_poll_glmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  u_formulas_poll[i, 4] <- r.squaredGLMM(u_poll_glmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

u_glance_poll <- do.call(rbind,
                       lapply(u_poll_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

u_bound_poll <- bind_cols(u_formulas_poll,
                        u_glance_poll %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC

# check residuals
plot(simulateResiduals(u_poll_glmer_gradient_1)) # looks good


summary(u_poll_glmer_gradient_1)
u_poll_glmer_gradient_1_anova <- car::Anova(u_poll_glmer_gradient_1) %T>%
  print()

```

######## Urban sites
```{r}

# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
u_poll_glmer_subtr_01 <- glmer((Pollinia_removed) ~ (1|Patch_ID/Plant_Num/Inflor) +
                               
                               Year:Transect_ID:Urb_score + 
                               
                               Year:Transect_ID + 
                               Urb_score:Transect_ID +
                               Urb_score:Year +
                               
                               Urb_score +
                               Year +
                               Transect_ID,
                             
                             long_Transect_Data_18_19 %>%
                               filter(Transect_ID != 'Rural'),
                             family = "poisson",
                             glmerControl(optimizer="bobyqa",
                                          optCtrl = list(maxfun = 100000)))

# all main effects and secondary interactions
u_poll_glmer_subtr_02 <- update(u_poll_glmer_subtr_01,
                              . ~ . -Year:Transect_ID:Urb_score)

# all main effects and 2/3 secondary interactions
u_poll_glmer_subtr_03 <- update(u_poll_glmer_subtr_02,
                              . ~ . -Transect_ID:Urb_score)
u_poll_glmer_subtr_04 <- update(u_poll_glmer_subtr_02,
                              . ~ . -Urb_score:Year)
u_poll_glmer_subtr_05 <- update(u_poll_glmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_poll_glmer_subtr_06 <- update(u_poll_glmer_subtr_03,
                              . ~ . -Urb_score:Year)
u_poll_glmer_subtr_07 <- update(u_poll_glmer_subtr_04,
                              . ~ . -Year:Transect_ID)
u_poll_glmer_subtr_08 <- update(u_poll_glmer_subtr_05,
                              . ~ . -Transect_ID:Urb_score)

# all main effects
u_poll_glmer_subtr_09 <- update(u_poll_glmer_subtr_08,
                              . ~ . -Urb_score:Year)

u_poll_glmer_subtr_list <- list(u_poll_glmer_subtr_01,
                               u_poll_glmer_subtr_02,
                               u_poll_glmer_subtr_03,
                               u_poll_glmer_subtr_04,
                               u_poll_glmer_subtr_05,
                               u_poll_glmer_subtr_06,
                               u_poll_glmer_subtr_07,
                               u_poll_glmer_subtr_08,
                               u_poll_glmer_subtr_09)

# formula(u_poll_glmer_subtr_list[[2]])
usc_formulas_poll <- data.frame(matrix(ncol = 0, nrow = 9))
usc_formulas_poll$Model <- NA
usc_formulas_poll$Formula <- NA
usc_formulas_poll$r.squaredGLMM_R2m <- NA
usc_formulas_poll$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_poll_glmer_subtr_list)) {
  usc_formulas_poll[i, 1] <- toString(i)
  usc_formulas_poll[i, 2] <- toString(formula(u_poll_glmer_subtr_list[[i]]))
  usc_formulas_poll[i, 3] <- r.squaredGLMM(u_poll_glmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  usc_formulas_poll[i, 4] <- r.squaredGLMM(u_poll_glmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

usc_glance_poll <- do.call(rbind,
                       lapply(u_poll_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

usc_bound_poll <- bind_cols(usc_formulas_poll,
                        usc_glance_poll %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC

# check residuals
plot(simulateResiduals(u_poll_glmer_subtr_01)) # looks good


summary(u_poll_glmer_subtr_01)
u_poll_glmer_subtr_01_anova <- car::Anova(u_poll_glmer_subtr_01) %T>%
  print()


```


##### Pods
###### GLMER
####### City-dist, not urb_score
######## All sites
```{r}
# pods_glmer_gradient_01 <- glmer(Viable_Pods ~ (1|Patch_ID) +
#                                   
                                  # City_dist:Year +
                                  # City_dist +
                                  # Year,
#                                 
#                                 fertile,
#                                 family = "poisson",
#                                 glmerControl(optimizer="bobyqa",
#                                              optCtrl = list(maxfun = 100000))) # not converging
# plot(simulateResiduals(pods_glmer_gradient_01)) # not ok... try hurdle model

fertile$Viable_Pods_minus1 <- fertile$Viable_Pods - 1

## Hurdle Poisson model
pods_glmer_gradient_01 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                  City_dist:Year +
                                  City_dist +
                                  Year,
                               
                                fertile,
              zi = ~City_dist:Year +
                                  City_dist +
                                  Year,
              family = truncated_poisson)
plot(simulateResiduals(pods_glmer_gradient_01)) # much better. Will go with this
# CODE DETAILING WHAT i TRIED TO DO BEFORE SETTLING ON SQUARING TRANSFORMATION WITH HURDLE MODEL BELOW
## After trying hurdle model WITHOUT Squaring transformation, I looked at dispersion and saw it was overdispersed, then tried a few other things...
# testDispersion(pods_glmer_gradient_01) # but it's overdispersed... try adding value which gives each row an ID
# 
# fertile$ID <- seq.int(nrow(fertile))
# 
# pods_glmer_gradient_01 <- glmmTMB(Viable_Pods_minus1 ~ (1|Patch_ID) + (1|ID) +
#                  City_dist:Year +
#                     City_dist +
#                     Year,
# 
#                   fertile,
# zi = ~City_dist:Year +
#                     City_dist +
#                     Year,
#               family = truncated_poisson)
# plot(simulateResiduals(pods_glmer_gradient_01)) # didn't help... try neg bin
# 
# pods_glmer_gradient_01 <- glmmTMB(Viable_Pods_minus1 ~ (1|Patch_ID) +
#                                City_dist:Year +
#                     City_dist +
#                     Year,
# 
#                                 fertile,
#               family = nbinom1())
# plot(simulateResiduals(pods_glmer_gradient_01)) # didn't help either
# hist(AvgVars_byPatch$Viable_Pods, breaks = 20)




# all main effects and secondary interactions
pods_glmer_gradient_02 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                  # City_dist:Year +
                                  City_dist +
                                  Year,
                               
                                fertile,
              zi = ~          City_dist +
                                  Year,
              family = truncated_poisson)

pods_glmer_gradient_list <- list(pods_glmer_gradient_01,
                                 pods_glmer_gradient_02)

formulas_pods <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_pods$Model <- NA
formulas_pods$Formula <- NA
# formulas_pods$r.squaredGLMM_R2m <- NA
# formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(pods_glmer_gradient_list)) {
  formulas_pods[i, 1] <- toString(i)
  formulas_pods[i, 2] <- toString(formula(pods_glmer_gradient_list[[i]]))
  # formulas_pods[i, 3] <- r.squaredGLMM(pods_glmer_gradient_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_pods[i, 4] <- r.squaredGLMM(pods_glmer_gradient_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_pods <- do.call(rbind,
                       lapply(pods_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_pods <- bind_cols(formulas_pods,
                        glance_pods %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC

# check residuals
plot(simulateResiduals(pods_glmer_gradient_01)) # looks good


summary(pods_glmer_gradient_01)
pods_glmer_gradient_01_anova <- car::Anova(pods_glmer_gradient_01) %T>%
  print() # year and interaxn sig


```

######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
pods_glmer_subtr_01 <- glmer(Viable_Pods ~ (1|Patch_ID) +
                               
                               Year:Transect_ID:City_dist + 
                               
                               Year:Transect_ID + 
                               City_dist:Transect_ID +
                               City_dist:Year +
                               
                               City_dist +
                               Year +
                               Transect_ID,
                             
                             fertile %>%
                               filter(Transect_ID != 'Rural'),
                             family = "poisson",
                             glmerControl(optimizer="bobyqa",
                                          optCtrl = list(maxfun = 100000))) # diagnostic plot is not normal. Trying a hurdle model like for Q1 above

# GOING TO SUBTRACT 1 AND THEN USE ZERO-INFLATED MODEL OR HURDLE MODEL TO DEAL WITH ONE-INFLATION-----

## Hurdle Poisson model
pods_glmer_subtr_01 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                               Year:Transect_ID:City_dist + 
                                 
                               Year:Transect_ID + 
                               City_dist:Transect_ID +
                               City_dist:Year +
                               
                               City_dist +
                               Year +
                               Transect_ID,
                               
                                fertile,
              zi = ~Year*Transect_ID*City_dist,
              family = truncated_poisson)

# check residuals
plot(simulateResiduals(pods_glmer_subtr_01)) # BETTER! going with this
testDispersion(pods_glmer_subtr_01) # without squaring transf, was overdispersed


# all main effects and secondary interactions
pods_glmer_subtr_02 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                Year:City_dist +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                Year:City_dist +
                                Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 2/3 secondary interactions
pods_glmer_subtr_03 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # Transect_ID:City_dist +
                                Year:City_dist +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # Transect_ID:City_dist +
                                Year:City_dist +
                                Year:Transect_ID,
                              family = truncated_poisson)

pods_glmer_subtr_04 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                # Year:City_dist +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                # Year:City_dist +
                                Year:Transect_ID,
                              family = truncated_poisson)

pods_glmer_subtr_05 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                Year:City_dist ,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                Year:City_dist ,
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 1/3 secondary interactions
pods_glmer_subtr_06 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # Transect_ID:City_dist +
                                # Year:City_dist +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # Transect_ID:City_dist +
                                # Year:City_dist +
                                Year:Transect_ID,
                              family = truncated_poisson)

pods_glmer_subtr_07 <- glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist ,
                                # Year:City_dist +
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist ,
                                # Year:City_dist +
                                # Year:Transect_ID,
                              family = truncated_poisson)

pods_glmer_subtr_08 <-  glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # Transect_ID:City_dist +
                                Year:City_dist,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # Transect_ID:City_dist +
                                Year:City_dist, 
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects
pods_glmer_subtr_09 <-  glmmTMB(Viable_Pods_minus1^2 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID,
                              family = truncated_poisson)


pods_glmer_subtr_list <- list(pods_glmer_subtr_01,
                               pods_glmer_subtr_02,
                               pods_glmer_subtr_03,
                               pods_glmer_subtr_04,
                               pods_glmer_subtr_05,
                               pods_glmer_subtr_06,
                               pods_glmer_subtr_07,
                               pods_glmer_subtr_08,
                               pods_glmer_subtr_09)

formulas_pods <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_pods$Model <- NA
formulas_pods$Formula <- NA
# formulas_pods$r.squaredGLMM_R2m <- NA
# formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(pods_glmer_subtr_list)) {
  formulas_pods[i, 1] <- toString(i)
  formulas_pods[i, 2] <- toString(formula(pods_glmer_subtr_list[[i]]))
  # formulas_pods[i, 3] <- r.squaredGLMM(pods_glmer_subtr_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_pods[i, 4] <- r.squaredGLMM(pods_glmer_subtr_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_pods <- do.call(rbind,
                       lapply(pods_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_pods <- bind_cols(formulas_pods,
                        glance_pods %>%
                          dplyr::select(AIC, BestModels)) # Models 2, 3, 8 lowest AIC (3 is lowest)

summary(pods_glmer_subtr_02)
pods_glmer_subtr_02_anova <- car::Anova(pods_glmer_subtr_02) %T>%
  print()

summary(pods_glmer_subtr_03)
pods_glmer_subtr_03_anova <- car::Anova(pods_glmer_subtr_03) %T>%
  print()

summary(pods_glmer_subtr_08)
pods_glmer_subtr_08_anova <- car::Anova(pods_glmer_subtr_08) %T>%
  print() #year is sig


# check residuals
plot(simulateResiduals(pods_glmer_subtr_02)) # looks fine
plot(simulateResiduals(pods_glmer_subtr_03)) # looks fine
plot(simulateResiduals(pods_glmer_subtr_08)) # looks fine


```

####### urb_score, not dist
######## All sites
```{r}
# u_pods_glmer_gradient_1 <- glmer(Viable_Pods ~ (1|Patch_ID) +
#                                    
#                                    Urb_score:Year +
#                                    Urb_score +
#                                    Year,
#                                  
#                                  fertile,
#                                  family = "poisson",
#              glmerControl(optimizer="bobyqa",
#                           optCtrl = list(maxfun = 100000)))
# 
# plot(simulateResiduals(u_pods_glmer_gradient_1)) # not ok... try hurdle model

## Hurdle Poisson model
u_pods_glmer_gradient_1 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                  Urb_score:Year +
                                  Urb_score +
                                  Year,
                               
                                fertile,
              zi = ~Urb_score:Year +
                                  Urb_score +
                                  Year,
              family = truncated_poisson)
plot(simulateResiduals(u_pods_glmer_gradient_1)) # much better. Will go with this


# all main effects and secondary interactions
u_pods_glmer_gradient_1.1 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                  # Urb_score:Year +
                                  Urb_score +
                                  Year,
                               
                                fertile,
              zi = ~Urb_score +
                                  Year,
              family = truncated_poisson)

u_pods_glmer_gradient_list <- list(u_pods_glmer_gradient_1,
                                   u_pods_glmer_gradient_1.1)


u_formulas_pods <- data.frame(matrix(ncol = 0, nrow = 2))
u_formulas_pods$Model <- NA
u_formulas_pods$Formula <- NA
# u_formulas_pods$r.squaredGLMM_R2m <- NA
# u_formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_pods_glmer_gradient_list)) {
  u_formulas_pods[i, 1] <- toString(i)
  u_formulas_pods[i, 2] <- toString(formula(u_pods_glmer_gradient_list[[i]]))
  # u_formulas_pods[i, 3] <- r.squaredGLMM(u_pods_glmer_gradient_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # u_formulas_pods[i, 4] <- r.squaredGLMM(u_pods_glmer_gradient_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

u_glance_pods <- do.call(rbind,
                       lapply(u_pods_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

u_bound_pods <- bind_cols(u_formulas_pods,
                        u_glance_pods %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC

# check residuals
plot(simulateResiduals(u_pods_glmer_gradient_1)) # looks good


summary(u_pods_glmer_gradient_1)
u_pods_glmer_gradient_1_anova <- car::Anova(u_pods_glmer_gradient_1) %T>%
  print() # year and interaxn sig

```


######## Urban sites
```{r}

# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
# u_pods_glmer_subtr_01 <- glmer(Viable_Pods ~ (1|Patch_ID) +
#                                
#                                Year:Transect_ID:Urb_score + 
#                                
#                                Year:Transect_ID + 
#                                Urb_score:Transect_ID +
#                                Urb_score:Year +
#                                
#                                Urb_score +
#                                Year +
#                                Transect_ID,
#                              
#                              fertile %>%
#                                filter(Transect_ID != 'Rural'),
#                              family = "poisson",
#                              glmerControl(optimizer="bobyqa",
#                                           optCtrl = list(maxfun = 100000)))
# plot(simulateResiduals(u_pods_glmer_subtr_01)) # not normal... try hurdle model


## Hurdle Poisson model
u_pods_glmer_subtr_01 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                               Year:Transect_ID:Urb_score + 
                                 
                               Year:Transect_ID + 
                               Urb_score:Transect_ID +
                               Urb_score:Year +
                               
                               Urb_score +
                               Year +
                               Transect_ID,
                               
                                fertile,
              zi = ~Year*Transect_ID*Urb_score,
              family = truncated_poisson)

# check residuals
plot(simulateResiduals(u_pods_glmer_subtr_01)) # BETTER! going with this


# all main effects and secondary interactions
u_pods_glmer_subtr_02 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 2/3 secondary interactions
u_pods_glmer_subtr_03 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_pods_glmer_subtr_04 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_pods_glmer_subtr_05 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year ,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year ,
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 1/3 secondary interactions
u_pods_glmer_subtr_06 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_pods_glmer_subtr_07 <- glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score ,
                                # Urb_score:Year +
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score ,
                                # Urb_score:Year +
                                # Year:Transect_ID,
                              family = truncated_poisson)

u_pods_glmer_subtr_08 <-  glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year, 
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects
u_pods_glmer_subtr_09 <-  glmmTMB(Viable_Pods_minus1^3 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID,
                              family = truncated_poisson)



u_pods_glmer_subtr_list <- list(u_pods_glmer_subtr_01,
                               u_pods_glmer_subtr_02,
                               u_pods_glmer_subtr_03,
                               u_pods_glmer_subtr_04,
                               u_pods_glmer_subtr_05,
                               u_pods_glmer_subtr_06,
                               u_pods_glmer_subtr_07,
                               u_pods_glmer_subtr_08,
                               u_pods_glmer_subtr_09)

# formula(pods_glmer_subtr_list[[2]])
u_formulas_pods <- data.frame(matrix(ncol = 0, nrow = 9))
u_formulas_pods$Model <- NA
u_formulas_pods$Formula <- NA
# u_formulas_pods$r.squaredGLMM_R2m <- NA
# u_formulas_pods$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_pods_glmer_subtr_list)) {
  u_formulas_pods[i, 1] <- toString(i)
  u_formulas_pods[i, 2] <- toString(formula(u_pods_glmer_subtr_list[[i]]))
  # u_formulas_pods[i, 3] <- r.squaredGLMM(u_pods_glmer_subtr_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # u_formulas_pods[i, 4] <- r.squaredGLMM(u_pods_glmer_subtr_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

u_glance_pods <- do.call(rbind,
                       lapply(u_pods_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

u_bound_pods <- bind_cols(u_formulas_pods,
                        u_glance_pods %>%
                          dplyr::select(AIC, BestModels)) # Models 2,3 lowest AIC. Model 3 is the best though.

# check residuals
plot(simulateResiduals(u_pods_glmer_subtr_02)) # looks fine
plot(simulateResiduals(u_pods_glmer_subtr_03)) # looks fine



summary(u_pods_glmer_subtr_02)
u_pods_glmer_subtr_02_anova <- car::Anova(u_pods_glmer_subtr_02) %T>%
  print()

summary(u_pods_glmer_subtr_03)
u_pods_glmer_subtr_03_anova <- car::Anova(u_pods_glmer_subtr_03) %T>%
  print()



```


##### Peduncles
###### GLMER (be sure to indicate that model is zero-inflated and minus 1, so results need to be explained with that in mind!!)
####### City_dist, not urb_score
######## All sites 
```{r}
# OLD- BEFORE ZERO-INFLATED MODEL -----
# peds_glmer_gradient_01 <- glmer(Peduncles ~ (1|Patch_ID) +
#                                   
#                                   City_dist:Year +
#                                   City_dist +
#                                   Year,
#                                 
#                                 fertile,
#                                 family = "poisson",
#                                 glmerControl(optimizer="bobyqa",
#                                              optCtrl = list(maxfun = 100000))) # not converging, but I don't get error messages when I use glmmTMB yet I get nearly identical ANOVA results, so I'll stick with this
# 
# # # the glmmTMB anova, for reference:
# # glmmTMB::Anova.glmmTMB(glmmTMB::glmmTMB(Peduncles ~ (1|Patch_ID) + City_dist:Year +
# #                                   City_dist +
# #                                   Year,
# #                                 data = fertile,
# #                                 family = "poisson"), type = "II")
# 
# 
# # all main effects and secondary interactions
# peds_glmer_gradient_02 <- update(peds_glmer_gradient_01,
#                                  . ~ . -City_dist:Year)
# 
# peds_glmer_gradient_list <- list(peds_glmer_gradient_01,
#                                  peds_glmer_gradient_02)
# 
# formulas_peds <- data.frame(matrix(ncol = 0, nrow = 2))
# formulas_peds$Model <- NA
# formulas_peds$Formula <- NA
# formulas_peds$r.squaredGLMM_R2m <- NA
# formulas_peds$r.squaredGLMM_R2c <- NA
# 
# for (i in 1:length(peds_glmer_gradient_list)) {
#   formulas_peds[i, 1] <- toString(i)
#   formulas_peds[i, 2] <- toString(formula(peds_glmer_gradient_list[[i]]))
#   formulas_peds[i, 3] <- r.squaredGLMM(peds_glmer_gradient_list[[i]])[1,1] %>%
#     round(digits = 3)
#   formulas_peds[i, 4] <- r.squaredGLMM(peds_glmer_gradient_list[[i]])[1,2] %>%
#     round(digits = 3)
# }
# 
# glance_peds <- do.call(rbind,
#                        lapply(peds_glmer_gradient_list,
#                               broom.mixed::glance)) %>%
#   as.data.frame() %>%
#   mutate(BestModels = case_when(
#     AIC == min(AIC, na.rm=T) ~ "*",
#     AIC <= 2 + min(AIC, na.rm=T) ~ "*",
#     TRUE ~ "")) 
# 
# bound_peds <- bind_cols(formulas_peds,
#                         glance_peds %>%
#                           dplyr::select(AIC, BestModels)) # Model 1 lowest AIC
# 
# 
# summary(peds_glmer_gradient_01)
# peds_glmer_gradient_01_anova <- car::Anova(peds_glmer_gradient_01) %T>%
#   print() # interaction sig
# 
# # check residuals
# plot(simulateResiduals(peds_glmer_gradient_01)) # not normal... looks underdispersed
# testDispersion(simulateResiduals(peds_glmer_gradient_01)) # yup
# 
# # try generalized Poisson distribution w/glmmTMB
# peds_glmer_gradient_01.1 <- glmmTMB(Peduncles ~ (1|Patch_ID) +
#                                   
#                                   City_dist:Year +
#                                   City_dist +
#                                   Year,
#                                 
#                                 fertile,
#                                 family = "genpois")
# 
# # check residuals
# plot(simulateResiduals(peds_glmer_gradient_01.1)) # didn't help. try negbin
# 
# 
# peds_glmer_gradient_01.2 <- glmmTMB(Peduncles ~ (1|Patch_ID) +
#                                   City_dist:Year +
#                                   City_dist +
#                                   Year,
#                                 fertile,
#                                 family = nbinom1())
# # check residuals
# plot(simulateResiduals(peds_glmer_gradient_01.2)) # didn't help. tried 'compois' (Conway-Maxwell Poisson distribution) which didn't help either.
# 
# ## Hurdle Poisson model
# m1 <- glmmTMB(Peduncles ~ (1|Patch_ID) +
#                                   City_dist:Year +
#                                   City_dist +
#                                   Year,
#                                 fertile,
#               zi = ~City_dist:Year + City_dist + Year,
#               family = truncated_poisson)
# 
# # check residuals
# plot(simulateResiduals(m1)) # didn't help

# hist(AvgVars_byPatch$Peduncles, breaks = 16)

# GOING TO SUBTRACT 1 AND THEN USE ZERO-INFLATED MODEL OR HURDLE MODEL TO DEAL WITH ONE-INFLATION-----

fertile$Peduncles_minus1 <- fertile$Peduncles - 1

## Hurdle Poisson model
peds_glmer_gradient_01 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                  City_dist:Year +
                                  City_dist +
                                  Year,
                                fertile,
              zi = ~City_dist:Year + City_dist + Year,
              family = truncated_poisson)

# check residuals
plot(simulateResiduals(peds_glmer_gradient_01)) # BETTER! will stick with this one


# all main effects and secondary interactions
peds_glmer_gradient_02 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                  City_dist +
                                  Year,
                                fertile,
              zi = ~City_dist + Year,
              family = truncated_poisson)

peds_glmer_gradient_list <- list(peds_glmer_gradient_01,
                                 peds_glmer_gradient_02)

formulas_peds <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_peds$Model <- NA
formulas_peds$Formula <- NA
# formulas_peds$r.squaredGLMM_R2m <- NA
# formulas_peds$r.squaredGLMM_R2c <- NA

# COMMENTING OUT R-SQ BC r.squaredGLMM cannot (yet) handle 'glmmTMB' object with zero-inflation

for (i in 1:length(peds_glmer_gradient_list)) {
  formulas_peds[i, 1] <- toString(i)
  formulas_peds[i, 2] <- toString(formula(peds_glmer_gradient_list[[i]]))
  # formulas_peds[i, 3] <- r.squaredGLMM(peds_glmer_gradient_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_peds[i, 4] <- r.squaredGLMM(peds_glmer_gradient_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_peds <- do.call(rbind,
                       lapply(peds_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ ""))

bound_peds <- bind_cols(formulas_peds,
                        glance_peds %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC


summary(peds_glmer_gradient_01)
peds_glmer_gradient_01_anova <- car::Anova(peds_glmer_gradient_01) %T>%
  print() # year marg sig

# check residuals
plot(simulateResiduals(peds_glmer_gradient_01)) # again, fine


```

######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
# peds_glmer_subtr_01 <- glmer(Peduncles ~ (1|Patch_ID) +
#                                
#                                Year:Transect_ID:City_dist + 
#                                
#                                Year:Transect_ID + 
#                                City_dist:Transect_ID +
#                                City_dist:Year +
#                                
#                                City_dist +
#                                Year +
#                                Transect_ID,
#                              
#                              fertile %>%
#                                filter(Transect_ID != 'Rural'),
#                              family = "poisson",
#                              glmerControl(optimizer="bobyqa",
#                                           optCtrl = list(maxfun = 100000)))
# THIS MODEL IS ALSO ONE-INFLATED AND NEEDS THE SAME TREATMENT AS THE MODELS ABOVE

# Full model
peds_glmer_subtr_01 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                Year:City_dist +
                                Year:Transect_ID +
                                Year:Transect_ID:City_dist,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                Year:City_dist +
                                Year:Transect_ID +
                                Year:Transect_ID:City_dist,
                              family = truncated_poisson)

# all main effects and secondary interactions
peds_glmer_subtr_02 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                Year:City_dist +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                Year:City_dist +
                                Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 2/3 secondary interactions
peds_glmer_subtr_03 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # Transect_ID:City_dist +
                                Year:City_dist +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # Transect_ID:City_dist +
                                Year:City_dist +
                                Year:Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_04 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                # Year:City_dist +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                # Year:City_dist +
                                Year:Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_05 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                Year:City_dist ,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist +
                                Year:City_dist ,
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 1/3 secondary interactions
peds_glmer_subtr_06 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # Transect_ID:City_dist +
                                # Year:City_dist +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # Transect_ID:City_dist +
                                # Year:City_dist +
                                Year:Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_07 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist ,
                                # Year:City_dist +
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                Transect_ID:City_dist ,
                                # Year:City_dist +
                                # Year:Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_08 <-  glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID +
                                # Transect_ID:City_dist +
                                Year:City_dist,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID +
                                # Transect_ID:City_dist +
                                Year:City_dist, 
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects
peds_glmer_subtr_09 <-  glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                City_dist +
                                Year +
                                Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~City_dist +
                                Year +
                                Transect_ID,
                              family = truncated_poisson)

peds_glmer_subtr_list <- list(peds_glmer_subtr_01,
                               peds_glmer_subtr_02,
                               peds_glmer_subtr_03,
                               peds_glmer_subtr_04,
                               peds_glmer_subtr_05,
                               peds_glmer_subtr_06,
                               peds_glmer_subtr_07,
                               peds_glmer_subtr_08,
                               peds_glmer_subtr_09)

formulas_peds <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_peds$Model <- NA
formulas_peds$Formula <- NA
# formulas_peds$r.squaredGLMM_R2m <- NA
# formulas_peds$r.squaredGLMM_R2c <- NA

for (i in 1:length(peds_glmer_subtr_list)) {
  formulas_peds[i, 1] <- toString(i)
  formulas_peds[i, 2] <- toString(formula(peds_glmer_subtr_list[[i]]))
  # formulas_peds[i, 3] <- r.squaredGLMM(peds_glmer_subtr_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_peds[i, 4] <- r.squaredGLMM(peds_glmer_subtr_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_peds <- do.call(rbind,
                       lapply(peds_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_peds <- bind_cols(formulas_peds,
                        glance_peds %>%
                          dplyr::select(AIC, BestModels)) # Models 1, 3, 6 lowest AIC but best is 1

# check residuals
plot(simulateResiduals(peds_glmer_subtr_01)) # looks good
plot(simulateResiduals(peds_glmer_subtr_03)) # looks good
plot(simulateResiduals(peds_glmer_subtr_06)) # looks good


summary(peds_glmer_subtr_01)
peds_glmer_subtr_01_anova <- car::Anova(peds_glmer_subtr_01) %T>%
  print()

summary(peds_glmer_subtr_03)
peds_glmer_subtr_03_anova <- car::Anova(peds_glmer_subtr_03) %T>%
  print()

summary(peds_glmer_subtr_06)
peds_glmer_subtr_06_anova <- car::Anova(peds_glmer_subtr_06) %T>%
  print()


```


####### urb_score, not City_dist
######## All sites
```{r}
# u_peds_glmer_gradient_1 <- glmer(as.numeric(Peduncles) ~ (1|Patch_ID) + Urb_score * Year,
#                                  fertile,
#                                  family = "poisson",
#                                  glmerControl(optimizer="bobyqa",
#                                               optCtrl = list(maxfun = 100000)))
# plot(simulateResiduals(u_peds_glmer_gradient_1)) # trying zero-inflated model like for city_dist models


## Hurdle Poisson model
u_peds_glmer_gradient_01 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                  Urb_score:Year +
                                  Urb_score +
                                  Year,
                                fertile,
              zi = ~City_dist:Year + City_dist + Year,
              family = truncated_poisson)

# check residuals
plot(simulateResiduals(u_peds_glmer_gradient_01)) # BETTER! will stick with this one


# all main effects and secondary interactions
u_peds_glmer_gradient_02 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                  Urb_score +
                                  Year,
                                fertile,
              zi = ~Urb_score + Year,
              family = truncated_poisson)

u_peds_glmer_gradient_list <- list(u_peds_glmer_gradient_01,
                                 u_peds_glmer_gradient_02)

formulas_u_peds <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_peds$Model <- NA
formulas_u_peds$Formula <- NA
# formulas_u_peds$r.squaredGLMM_R2m <- NA
# formulas_u_peds$r.squaredGLMM_R2c <- NA

# COMMENTING OUT R-SQ BC r.squaredGLMM cannot (yet) handle 'glmmTMB' object with zero-inflation

for (i in 1:length(u_peds_glmer_gradient_list)) {
  formulas_u_peds[i, 1] <- toString(i)
  formulas_u_peds[i, 2] <- toString(formula(u_peds_glmer_gradient_list[[i]]))
  # formulas_u_peds[i, 3] <- r.squaredGLMM(u_peds_glmer_gradient_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_u_peds[i, 4] <- r.squaredGLMM(u_peds_glmer_gradient_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_u_peds <- do.call(rbind,
                       lapply(u_peds_glmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ ""))

bound_u_peds <- bind_cols(formulas_u_peds,
                        glance_u_peds %>%
                          dplyr::select(AIC, BestModels)) # Model 1 lowest AIC


summary(u_peds_glmer_gradient_01)
u_peds_glmer_gradient_01_anova <- car::Anova(u_peds_glmer_gradient_01) %T>%
  print() # year marg sig

# check residuals
plot(simulateResiduals(u_peds_glmer_gradient_01)) # again, fine


```

######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
# u_peds_glmer_subtr_01 <- glmer(Peduncles ~ (1|Patch_ID) +
#                                
#                                Year:Transect_ID:Urb_score + 
#                                
#                                Year:Transect_ID + 
#                                Urb_score:Transect_ID +
#                                Urb_score:Year +
#                                
#                                Urb_score +
#                                Year +
#                                Transect_ID,
#                              
#                              fertile %>%
#                                filter(Transect_ID != 'Rural'),
#                              family = "poisson",
#                              glmerControl(optimizer="bobyqa",
#                                           optCtrl = list(maxfun = 100000)))
# THIS MODEL IS ALSO ONE-INFLATED AND NEEDS THE SAME TREATMENT AS THE MODELS ABOVE

# Full model
u_peds_glmer_subtr_01 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID +
                                Year:Transect_ID:Urb_score,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID +
                                Year:Transect_ID:Urb_score,
                              family = truncated_poisson)

# all main effects and secondary interactions
u_peds_glmer_subtr_02 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 2/3 secondary interactions
u_peds_glmer_subtr_03 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_04 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_05 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year ,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score +
                                Urb_score:Year ,
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects and 1/3 secondary interactions
u_peds_glmer_subtr_06 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                # Urb_score:Year +
                                Year:Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_07 <- glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score ,
                                # Urb_score:Year +
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                Transect_ID:Urb_score ,
                                # Urb_score:Year +
                                # Year:Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_08 <-  glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year,
                                # Year:Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID +
                                # Transect_ID:Urb_score +
                                Urb_score:Year, 
                                # Year:Transect_ID,
                              family = truncated_poisson)

# all main effects
u_peds_glmer_subtr_09 <-  glmmTMB(Peduncles_minus1 ~ (1|Patch_ID) +
                                Urb_score +
                                Year +
                                Transect_ID,
                              fertile %>%
                                  filter(Transect_ID != 'Rural'),
                              zi = ~Urb_score +
                                Year +
                                Transect_ID,
                              family = truncated_poisson)

u_peds_glmer_subtr_list <- list(u_peds_glmer_subtr_01,
                               u_peds_glmer_subtr_02,
                               u_peds_glmer_subtr_03,
                               u_peds_glmer_subtr_04,
                               u_peds_glmer_subtr_05,
                               u_peds_glmer_subtr_06,
                               u_peds_glmer_subtr_07,
                               u_peds_glmer_subtr_08,
                               u_peds_glmer_subtr_09)

formulas_u_peds <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_u_peds$Model <- NA
formulas_u_peds$Formula <- NA
# formulas_u_peds$r.squaredGLMM_R2m <- NA
# formulas_u_peds$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_peds_glmer_subtr_list)) {
  formulas_u_peds[i, 1] <- toString(i)
  formulas_u_peds[i, 2] <- toString(formula(u_peds_glmer_subtr_list[[i]]))
  # formulas_u_peds[i, 3] <- r.squaredGLMM(u_peds_glmer_subtr_list[[i]])[1,1] %>%
  #   round(digits = 3)
  # formulas_u_peds[i, 4] <- r.squaredGLMM(u_peds_glmer_subtr_list[[i]])[1,2] %>%
  #   round(digits = 3)
}

glance_u_peds <- do.call(rbind,
                       lapply(u_peds_glmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_peds <- bind_cols(formulas_u_peds,
                        glance_u_peds %>%
                          dplyr::select(AIC, BestModels)) # Models 3,4,6 lowest AIC but best is 6

# check residuals
plot(simulateResiduals(u_peds_glmer_subtr_03)) # looks good
plot(simulateResiduals(u_peds_glmer_subtr_04)) # looks good
plot(simulateResiduals(u_peds_glmer_subtr_06)) # looks good


summary(u_peds_glmer_subtr_03)
u_peds_glmer_subtr_03_anova <- car::Anova(u_peds_glmer_subtr_03) %T>%
  print()

summary(u_peds_glmer_subtr_04)
u_peds_glmer_subtr_04_anova <- car::Anova(u_peds_glmer_subtr_04) %T>%
  print()

summary(u_peds_glmer_subtr_06)
u_peds_glmer_subtr_06_anova <- car::Anova(u_peds_glmer_subtr_06) %T>%
  print()


```

##### Height (Sept)
###### LMER
####### City_dist, not urb-score
######## All sites
```{r}
height_lmer_gradient_01 <- lmer(Height_Sept ~ (1|Patch_ID) +
                                  
                                  City_dist:Year +
                                  City_dist +
                                  Year,
                                
                                fertile,
                                REML = F) 


# all main effects and secondary interactions
height_lmer_gradient_02 <- update(height_lmer_gradient_01,
                                 . ~ . -City_dist:Year)

height_lmer_gradient_list <- list(height_lmer_gradient_01,
                                 height_lmer_gradient_02)

formulas_height <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_height$Model <- NA
formulas_height$Formula <- NA
formulas_height$r.squaredGLMM_R2m <- NA
formulas_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(height_lmer_gradient_list)) {
  formulas_height[i, 1] <- toString(i)
  formulas_height[i, 2] <- toString(formula(height_lmer_gradient_list[[i]]))
  formulas_height[i, 3] <- r.squaredGLMM(height_lmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_height[i, 4] <- r.squaredGLMM(height_lmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_height <- do.call(rbind,
                       lapply(height_lmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_height <- bind_cols(formulas_height,
                        glance_height %>%
                          dplyr::select(AIC, BestModels)) # Models 1 & 2 lowest AIC

# check residuals
library(effects)
library(sjPlot)
plot_model(height_lmer_gradient_01, type='diag') # looks fine
plot_model(height_lmer_gradient_02, type='diag') # looks fine


summary(height_lmer_gradient_01)
height_lmer_gradient_01_anova <- car::Anova(height_lmer_gradient_01) %T>%
  print() # year sig

summary(height_lmer_gradient_02)
height_lmer_gradient_02_anova <- car::Anova(height_lmer_gradient_02) %T>%
  print() # year sig

```

######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
height_lmer_subtr_01 <- lmer(Height_Sept ~ (1|Patch_ID) +
                               
                               Year:Transect_ID:City_dist + 
                               
                               Year:Transect_ID + 
                               City_dist:Transect_ID +
                               City_dist:Year +
                               
                               City_dist +
                               Year +
                               Transect_ID,
                             
                             fertile %>%
                               filter(Transect_ID != 'Rural'),
                           REML = F)

# all main effects and secondary interactions
height_lmer_subtr_02 <- update(height_lmer_subtr_01,
                              . ~ . -Year:Transect_ID:City_dist)

# all main effects and 2/3 secondary interactions
height_lmer_subtr_03 <- update(height_lmer_subtr_02,
                              . ~ . -Transect_ID:City_dist)
height_lmer_subtr_04 <- update(height_lmer_subtr_02,
                              . ~ . -Year:City_dist)
height_lmer_subtr_05 <- update(height_lmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
height_lmer_subtr_06 <- update(height_lmer_subtr_03,
                              . ~ . -Year:City_dist)
height_lmer_subtr_07 <- update(height_lmer_subtr_04,
                              . ~ . -Year:Transect_ID)
height_lmer_subtr_08 <- update(height_lmer_subtr_05,
                              . ~ . -Transect_ID:City_dist)

# all main effects
height_lmer_subtr_09 <- update(height_lmer_subtr_08,
                              . ~ . -Year:City_dist)

height_lmer_subtr_list <- list(height_lmer_subtr_01,
                               height_lmer_subtr_02,
                               height_lmer_subtr_03,
                               height_lmer_subtr_04,
                               height_lmer_subtr_05,
                               height_lmer_subtr_06,
                               height_lmer_subtr_07,
                               height_lmer_subtr_08,
                               height_lmer_subtr_09)

formulas_height <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_height$Model <- NA
formulas_height$Formula <- NA
formulas_height$r.squaredGLMM_R2m <- NA
formulas_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(height_lmer_subtr_list)) {
  formulas_height[i, 1] <- toString(i)
  formulas_height[i, 2] <- toString(formula(height_lmer_subtr_list[[i]]))
  formulas_height[i, 3] <- r.squaredGLMM(height_lmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_height[i, 4] <- r.squaredGLMM(height_lmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_height <- do.call(rbind,
                       lapply(height_lmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_height <- bind_cols(formulas_height,
                        glance_height %>%
                          dplyr::select(AIC, BestModels)) # Models 1, 8 lowest AIC (1 is lowest)

# check residuals
library(effects)
library(sjPlot)
plot_model(height_lmer_subtr_01, type='diag') # looks fine
plot_model(height_lmer_subtr_08, type='diag') # looks fine


summary(height_lmer_subtr_01)
height_lmer_subtr_01_anova <- car::Anova(height_lmer_subtr_01) %T>%
  print()

summary(height_lmer_subtr_08)
height_lmer_subtr_08_anova <- car::Anova(height_lmer_subtr_08) %T>%
  print()


```

####### urb-score, not City_dist
######## All sites
```{r}
u_height_lmer_gradient_01 <- lmer(Height_Sept ~ (1|Patch_ID) +
                                  
                                  Urb_score:Year +
                                  Urb_score +
                                  Year,
                                
                                fertile,
                                REML = F) 


# all main effects and secondary interactions
u_height_lmer_gradient_02 <- update(u_height_lmer_gradient_01,
                                 . ~ . -Urb_score:Year)

u_height_lmer_gradient_list <- list(u_height_lmer_gradient_01,
                                 u_height_lmer_gradient_02)

formulas_height <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_height$Model <- NA
formulas_height$Formula <- NA
formulas_height$r.squaredGLMM_R2m <- NA
formulas_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_height_lmer_gradient_list)) {
  formulas_height[i, 1] <- toString(i)
  formulas_height[i, 2] <- toString(formula(u_height_lmer_gradient_list[[i]]))
  formulas_height[i, 3] <- r.squaredGLMM(u_height_lmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_height[i, 4] <- r.squaredGLMM(u_height_lmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_height <- do.call(rbind,
                       lapply(u_height_lmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_height <- bind_cols(formulas_height,
                        glance_height %>%
                          dplyr::select(AIC, BestModels)) # Models 1 & 2 lowest AIC (1 best)

# check residuals
plot(simulateResiduals(u_height_lmer_gradient_01)) # looks good
plot(simulateResiduals(u_height_lmer_gradient_02)) # looks good


summary(u_height_lmer_gradient_01)
u_height_lmer_gradient_01_anova <- car::Anova(u_height_lmer_gradient_01) %T>%
  print() # year sig, interaxn marg sig

summary(u_height_lmer_gradient_02)
u_height_lmer_gradient_02_anova <- car::Anova(u_height_lmer_gradient_02) %T>%
  print() # year sig

```


######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
u_height_lmer_subtr_01 <- lmer(Height_Sept ~ (1|Patch_ID) +
                               
                               Year:Transect_ID:Urb_score + 
                               
                               Year:Transect_ID + 
                               Urb_score:Transect_ID +
                               Urb_score:Year +
                               
                               Urb_score +
                               Year +
                               Transect_ID,
                             
                             fertile %>%
                               filter(Transect_ID != 'Rural'),
                           REML = F)

# all main effects and secondary interactions
u_height_lmer_subtr_02 <- update(u_height_lmer_subtr_01,
                              . ~ . -Year:Transect_ID:Urb_score)

# all main effects and 2/3 secondary interactions
u_height_lmer_subtr_03 <- update(u_height_lmer_subtr_02,
                              . ~ . -Transect_ID:Urb_score)
u_height_lmer_subtr_04 <- update(u_height_lmer_subtr_02,
                              . ~ . -Urb_score:Year)
u_height_lmer_subtr_05 <- update(u_height_lmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_height_lmer_subtr_06 <- update(u_height_lmer_subtr_03,
                              . ~ . -Urb_score:Year)
u_height_lmer_subtr_07 <- update(u_height_lmer_subtr_04,
                              . ~ . -Year:Transect_ID)
u_height_lmer_subtr_08 <- update(u_height_lmer_subtr_05,
                              . ~ . -Transect_ID:Urb_score)

# all main effects
u_height_lmer_subtr_09 <- update(u_height_lmer_subtr_08,
                              . ~ . -Urb_score:Year)

u_height_lmer_subtr_list <- list(u_height_lmer_subtr_01,
                               u_height_lmer_subtr_02,
                               u_height_lmer_subtr_03,
                               u_height_lmer_subtr_04,
                               u_height_lmer_subtr_05,
                               u_height_lmer_subtr_06,
                               u_height_lmer_subtr_07,
                               u_height_lmer_subtr_08,
                               u_height_lmer_subtr_09)

formulas_height <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_height$Model <- NA
formulas_height$Formula <- NA
formulas_height$r.squaredGLMM_R2m <- NA
formulas_height$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_height_lmer_subtr_list)) {
  formulas_height[i, 1] <- toString(i)
  formulas_height[i, 2] <- toString(formula(u_height_lmer_subtr_list[[i]]))
  formulas_height[i, 3] <- r.squaredGLMM(u_height_lmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_height[i, 4] <- r.squaredGLMM(u_height_lmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_height <- do.call(rbind,
                       lapply(u_height_lmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_height <- bind_cols(formulas_height,
                        glance_height %>%
                          dplyr::select(AIC, BestModels)) # Models 1, 9 lowest AIC (1 is lowest)

# check residuals
plot(simulateResiduals(u_height_lmer_subtr_01)) # looks good
plot(simulateResiduals(u_height_lmer_subtr_09)) # looks good


summary(u_height_lmer_subtr_01)
u_height_lmer_subtr_01_anova <- car::Anova(u_height_lmer_subtr_01) %T>%
  print()

summary(u_height_lmer_subtr_09)
u_height_lmer_subtr_09_anova <- car::Anova(u_height_lmer_subtr_09) %T>%
  print()


```


##### Pods per peduncle (i.e. follicles per inflorescence)
###### LMER
####### City_dist, not urb-score
######## All sites
```{r}
podsperped_lmer_gradient_01 <- lmer(pods_per_ped ~ (1|Patch_ID) +
                                  
                                  City_dist:Year +
                                  City_dist +
                                  Year,
                                
                                fertile,
                                REML = F) 


# all main effects and secondary interactions
podsperped_lmer_gradient_02 <- update(podsperped_lmer_gradient_01,
                                 . ~ . -City_dist:Year)

podsperped_lmer_gradient_list <- list(podsperped_lmer_gradient_01,
                                 podsperped_lmer_gradient_02)

formulas_podsperped <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_podsperped$Model <- NA
formulas_podsperped$Formula <- NA
formulas_podsperped$r.squaredGLMM_R2m <- NA
formulas_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(podsperped_lmer_gradient_list)) {
  formulas_podsperped[i, 1] <- toString(i)
  formulas_podsperped[i, 2] <- toString(formula(podsperped_lmer_gradient_list[[i]]))
  formulas_podsperped[i, 3] <- r.squaredGLMM(podsperped_lmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_podsperped[i, 4] <- r.squaredGLMM(podsperped_lmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_podsperped <- do.call(rbind,
                       lapply(podsperped_lmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_podsperped <- bind_cols(formulas_podsperped,
                        glance_podsperped %>%
                          dplyr::select(AIC, BestModels)) # Models 1 & 2 lowest AIC (2 is best)

# check residuals
library(effects)
library(sjPlot)
plot_model(podsperped_lmer_gradient_01, type='diag') # looks fine
plot_model(podsperped_lmer_gradient_02, type='diag') # looks fine


summary(podsperped_lmer_gradient_01)
podsperped_lmer_gradient_01_anova <- car::Anova(podsperped_lmer_gradient_01) %T>%
  print() # city_dist marg sig

summary(podsperped_lmer_gradient_02)
podsperped_lmer_gradient_02_anova <- car::Anova(podsperped_lmer_gradient_02) %T>%
  print() #  city_dist marg sig

```

######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
podsperped_lmer_subtr_01 <- lmer(pods_per_ped ~ (1|Patch_ID) +
                               
                               Year:Transect_ID:City_dist + 
                               
                               Year:Transect_ID + 
                               City_dist:Transect_ID +
                               City_dist:Year +
                               
                               City_dist +
                               Year +
                               Transect_ID,
                             
                             fertile %>%
                               filter(Transect_ID != 'Rural'),
                           REML = F)

# all main effects and secondary interactions
podsperped_lmer_subtr_02 <- update(podsperped_lmer_subtr_01,
                              . ~ . -Year:Transect_ID:City_dist)

# all main effects and 2/3 secondary interactions
podsperped_lmer_subtr_03 <- update(podsperped_lmer_subtr_02,
                              . ~ . -Transect_ID:City_dist)
podsperped_lmer_subtr_04 <- update(podsperped_lmer_subtr_02,
                              . ~ . -Year:City_dist)
podsperped_lmer_subtr_05 <- update(podsperped_lmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
podsperped_lmer_subtr_06 <- update(podsperped_lmer_subtr_03,
                              . ~ . -Year:City_dist)
podsperped_lmer_subtr_07 <- update(podsperped_lmer_subtr_04,
                              . ~ . -Year:Transect_ID)
podsperped_lmer_subtr_08 <- update(podsperped_lmer_subtr_05,
                              . ~ . -Transect_ID:City_dist)

# all main effects
podsperped_lmer_subtr_09 <- update(podsperped_lmer_subtr_08,
                              . ~ . -Year:City_dist)

podsperped_lmer_subtr_list <- list(podsperped_lmer_subtr_01,
                               podsperped_lmer_subtr_02,
                               podsperped_lmer_subtr_03,
                               podsperped_lmer_subtr_04,
                               podsperped_lmer_subtr_05,
                               podsperped_lmer_subtr_06,
                               podsperped_lmer_subtr_07,
                               podsperped_lmer_subtr_08,
                               podsperped_lmer_subtr_09)

formulas_podsperped <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_podsperped$Model <- NA
formulas_podsperped$Formula <- NA
formulas_podsperped$r.squaredGLMM_R2m <- NA
formulas_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(podsperped_lmer_subtr_list)) {
  formulas_podsperped[i, 1] <- toString(i)
  formulas_podsperped[i, 2] <- toString(formula(podsperped_lmer_subtr_list[[i]]))
  formulas_podsperped[i, 3] <- r.squaredGLMM(podsperped_lmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_podsperped[i, 4] <- r.squaredGLMM(podsperped_lmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_podsperped <- do.call(rbind,
                       lapply(podsperped_lmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_podsperped <- bind_cols(formulas_podsperped,
                        glance_podsperped %>%
                          dplyr::select(AIC, BestModels)) # Models 3,5, 8 lowest AIC (8 is lowest)

# check residuals
library(effects)
library(sjPlot)
plot_model(podsperped_lmer_subtr_03, type='diag') # looks fine
plot_model(podsperped_lmer_subtr_05, type='diag') # looks fine
plot_model(podsperped_lmer_subtr_08, type='diag') # looks fine



summary(podsperped_lmer_subtr_03)
podsperped_lmer_subtr_03_anova <- car::Anova(podsperped_lmer_subtr_03) %T>%
  print()

summary(podsperped_lmer_subtr_05)
podsperped_lmer_subtr_05_anova <- car::Anova(podsperped_lmer_subtr_05) %T>%
  print()

summary(podsperped_lmer_subtr_08)
podsperped_lmer_subtr_08_anova <- car::Anova(podsperped_lmer_subtr_08) %T>%
  print()


```


####### Urb_score, not City_dist
######## All sites
```{r}
u_podsperped_lmer_gradient_01 <- lmer(pods_per_ped ~ (1|Patch_ID) +
                                  
                                  Urb_score:Year +
                                  Urb_score +
                                  Year,
                                
                                fertile,
                                REML = F) 


# all main effects and secondary interactions
u_podsperped_lmer_gradient_02 <- update(u_podsperped_lmer_gradient_01,
                                 . ~ . -Urb_score:Year)

u_podsperped_lmer_gradient_list <- list(u_podsperped_lmer_gradient_01,
                                 u_podsperped_lmer_gradient_02)

formulas_u_podsperped <- data.frame(matrix(ncol = 0, nrow = 2))
formulas_u_podsperped$Model <- NA
formulas_u_podsperped$Formula <- NA
formulas_u_podsperped$r.squaredGLMM_R2m <- NA
formulas_u_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_podsperped_lmer_gradient_list)) {
  formulas_u_podsperped[i, 1] <- toString(i)
  formulas_u_podsperped[i, 2] <- toString(formula(u_podsperped_lmer_gradient_list[[i]]))
  formulas_u_podsperped[i, 3] <- r.squaredGLMM(u_podsperped_lmer_gradient_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_podsperped[i, 4] <- r.squaredGLMM(u_podsperped_lmer_gradient_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_podsperped <- do.call(rbind,
                       lapply(u_podsperped_lmer_gradient_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_podsperped <- bind_cols(formulas_u_podsperped,
                        glance_u_podsperped %>%
                          dplyr::select(AIC, BestModels)) # Models 1 & 2 lowest AIC (2 is best)

# check residuals
library(effects)
library(sjPlot)
plot_model(u_podsperped_lmer_gradient_01, type='diag') # looks fine
plot_model(u_podsperped_lmer_gradient_02, type='diag') # looks fine


summary(u_podsperped_lmer_gradient_01)
u_podsperped_lmer_gradient_01_anova <- car::Anova(u_podsperped_lmer_gradient_01) %T>%
  print() # Urb_score sig

summary(u_podsperped_lmer_gradient_02)
u_podsperped_lmer_gradient_02_anova <- car::Anova(u_podsperped_lmer_gradient_02) %T>%
  print() #  Urb_score sig

```

######## Urban sites
```{r}
# GET TABLE OF ALL POSSIBLE AND BEST MODELS -----

## all main effects and secondary and tertiary interactions (full model)
u_podsperped_lmer_subtr_01 <- lmer(pods_per_ped ~ (1|Patch_ID) +
                               
                               Year:Transect_ID:Urb_score + 
                               
                               Year:Transect_ID + 
                               Urb_score:Transect_ID +
                               Urb_score:Year +
                               
                               Urb_score +
                               Year +
                               Transect_ID,
                             
                             fertile %>%
                               filter(Transect_ID != 'Rural'),
                           REML = F)

# all main effects and secondary interactions
u_podsperped_lmer_subtr_02 <- update(u_podsperped_lmer_subtr_01,
                              . ~ . -Year:Transect_ID:Urb_score)

# all main effects and 2/3 secondary interactions
u_podsperped_lmer_subtr_03 <- update(u_podsperped_lmer_subtr_02,
                              . ~ . -Transect_ID:Urb_score)
u_podsperped_lmer_subtr_04 <- update(u_podsperped_lmer_subtr_02,
                              . ~ . -Urb_score:Year)
u_podsperped_lmer_subtr_05 <- update(u_podsperped_lmer_subtr_02,
                              . ~ . -Year:Transect_ID)

# all main effects and 1/3 secondary interactions
u_podsperped_lmer_subtr_06 <- update(u_podsperped_lmer_subtr_03,
                              . ~ . -Urb_score:Year)
u_podsperped_lmer_subtr_07 <- update(u_podsperped_lmer_subtr_04,
                              . ~ . -Year:Transect_ID)
u_podsperped_lmer_subtr_08 <- update(u_podsperped_lmer_subtr_05,
                              . ~ . -Transect_ID:Urb_score)

# all main effects
u_podsperped_lmer_subtr_09 <- update(u_podsperped_lmer_subtr_08,
                              . ~ . -Urb_score:Year)

u_podsperped_lmer_subtr_list <- list(u_podsperped_lmer_subtr_01,
                               u_podsperped_lmer_subtr_02,
                               u_podsperped_lmer_subtr_03,
                               u_podsperped_lmer_subtr_04,
                               u_podsperped_lmer_subtr_05,
                               u_podsperped_lmer_subtr_06,
                               u_podsperped_lmer_subtr_07,
                               u_podsperped_lmer_subtr_08,
                               u_podsperped_lmer_subtr_09)

formulas_u_podsperped <- data.frame(matrix(ncol = 0, nrow = 9))
formulas_u_podsperped$Model <- NA
formulas_u_podsperped$Formula <- NA
formulas_u_podsperped$r.squaredGLMM_R2m <- NA
formulas_u_podsperped$r.squaredGLMM_R2c <- NA

for (i in 1:length(u_podsperped_lmer_subtr_list)) {
  formulas_u_podsperped[i, 1] <- toString(i)
  formulas_u_podsperped[i, 2] <- toString(formula(u_podsperped_lmer_subtr_list[[i]]))
  formulas_u_podsperped[i, 3] <- r.squaredGLMM(u_podsperped_lmer_subtr_list[[i]])[1,1] %>%
    round(digits = 3)
  formulas_u_podsperped[i, 4] <- r.squaredGLMM(u_podsperped_lmer_subtr_list[[i]])[1,2] %>%
    round(digits = 3)
}

glance_u_podsperped <- do.call(rbind,
                       lapply(u_podsperped_lmer_subtr_list,
                              broom.mixed::glance)) %>%
  as.data.frame() %>%
  mutate(BestModels = case_when(
    AIC == min(AIC, na.rm=T) ~ "*",
    AIC <= 2 + min(AIC, na.rm=T) ~ "*",
    TRUE ~ "")) 

bound_u_podsperped <- bind_cols(formulas_u_podsperped,
                        glance_u_podsperped %>%
                          dplyr::select(AIC, BestModels)) # Models 6,7,8,9 lowest AIC (9 is lowest)

# check residuals
library(effects)
library(sjPlot)
plot_model(u_podsperped_lmer_subtr_06, type='diag') # looks fine
plot_model(u_podsperped_lmer_subtr_07, type='diag') # looks fine
plot_model(u_podsperped_lmer_subtr_08, type='diag') # looks fine
plot_model(u_podsperped_lmer_subtr_09, type='diag') # looks fine

summary(u_podsperped_lmer_subtr_06)
u_podsperped_lmer_subtr_06_anova <- car::Anova(u_podsperped_lmer_subtr_06) %T>%
  print() #nothing sig

summary(u_podsperped_lmer_subtr_07)
u_podsperped_lmer_subtr_07_anova <- car::Anova(u_podsperped_lmer_subtr_07) %T>%
  print()

summary(u_podsperped_lmer_subtr_08)
u_podsperped_lmer_subtr_08_anova <- car::Anova(u_podsperped_lmer_subtr_08) %T>%
  print()

summary(u_podsperped_lmer_subtr_09)
u_podsperped_lmer_subtr_09_anova <- car::Anova(u_podsperped_lmer_subtr_09) %T>%
  print()

```


#### Combine best models into one df
```{r}
# CITY_DIST-----
## ALL SITES

best_mods_Q1.dist_list <- list(
  
### Pollinia
  poll_glmer_gradient_01, #2018 data
  poll_glmer_gradient_02,  #2019 data
### Pods
  pods_glmer_gradient_01,
### Peduncles
  peds_glmer_gradient_01,
### Pods/Peduncle
  podsperped_lmer_gradient_02

)



## URBAN SITES
best_mods_Q2.dist_list <- list(
  
### Pollinia
  poll_glmer_subtr_01,
### Pods
  pods_glmer_subtr_03,
### Peduncles
  peds_glmer_subtr_01,
### Pods/Peduncle
  podsperped_lmer_subtr_08

)




# URB_SCORE-----
## ALL SITES

best_mods_Q1.urbscore_list <- list(
  
### Pollinia
  u_poll_glmer_gradient_1,
### Pods
  u_pods_glmer_gradient_1,
### Peduncles
  u_peds_glmer_gradient_01,
### Pods/Peduncle
  u_podsperped_lmer_gradient_02

)



lapply(best_mods_Q1.urbscore_list, tidy_sb) %>%
  lapply(., as.data.frame) %>%
  purrr::reduce(full_join, by = "Predictor") %>%
  dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Year x Urbanization Score"),
                replacement = c("Urbanization Score x Year")) %>%
  arrange(factor(Predictor, levels = c("Urbanization Score",
                                       "Year",
                                       "Subtransect",
                                       "Urbanization Score x Year",
                                       "Subtransect x Urbanization Score",
                                       "Year x Subtransect",
                                       "Year x Subtransect x Urbanization Score"
                                       ))) %>%
  dplyr::select(-starts_with(c("Sites", "Significance", "AIC", "Response"))) %>%
  replace(., is.na(.), "-") %>%
  dplyr::rename('X2' = 2,
                'p' = 3,
                'X2 ' = 4,
                'p ' = 5,
                'X2  ' = 6,
                'p  ' = 7,
                'X2   ' = 8,
                'p   ' = 9) %>%
  flextable::flextable() %>%
  add_header_row(
    values = c(" ",
               "Pollen Removed",
               "Follicles",
               "Inflorescences",
               "Follicles per Inflorescence"),
    colwidths = c(1, 2, 2, 2, 2)) %>%
  align(j = 1, align = "left", part = "all") %>%
  align(j = 2:9, align = "center", part = "body") %>%
  align(j = 2:9, align = "center", part = "header") %>%
  display(i = 2, col_key = "X2", 
    pattern = "{{val}}{{pow}}", part = "header",
    formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
    fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
  display(i = 2, col_key = "X2 ", 
    pattern = "{{val}}{{pow}}", part = "header",
    formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
    fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
  display(i = 2, col_key = "X2  ", 
    pattern = "{{val}}{{pow}}", part = "header",
    formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
    fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
  display(i = 2, col_key = "X2   ", 
    pattern = "{{val}}{{pow}}", part = "header",
    formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
    fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
  width(j = 1, width = 2.2) %>%
  width(j = 2:9, width = 0.8) %>%
  # bold(bold = TRUE, part = "header") %>%
  fontsize(size = 12, part = "header") %>%
  fontsize(size = 12, part = "body") %>%
  italic(i = 2, j = 2:9, part = "header") %>%
  add_footer_lines("QUESTION 1 (All sites)") %>%
  add_footer_lines("Predictor: Urbanization Score") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Q1_Urbscore_ANOVA.png"))







## URBAN SITES

best_mods_Q2.urbscore_list <- list(
  
### Pollinia
  u_poll_glmer_subtr_01,
### Pods
  u_pods_glmer_subtr_03,
### Peduncles
  u_peds_glmer_subtr_06,
### Pods/Peduncle
  u_podsperped_lmer_subtr_09

)

tidy_sb <- function(model){
  
  return(
    car::Anova(model) %>%
      broom.mixed::tidy() %>%
      # as.data.frame() %>%
      dplyr::mutate(Response = as.character(formula(model)[2]),
                    .before = term) %>%
      # dplyr::mutate(Model = paste(n(model)),
      #               .before = term) %>%
      dplyr::mutate(Sites = case_when(
        str_detect(as.character(formula(model)[3]), "Transect_ID") == TRUE ~ "Urban Only",
        str_detect(as.character(formula(model)[3]), "Transect_ID") == FALSE ~ "All"),
                    .before = term) %>%
      dplyr::mutate(Significance = case_when(p.value < 0.001 ~ "***",
                                             p.value < 0.01 ~ "**",
                                             p.value <= 0.05 ~ "*", 
                                             p.value <= 0.1 ~ "Marginal")) %>%
      mutate_if(is.numeric, round, 3))      %>%
      dplyr::mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>%
      dplyr::mutate(., AIC = AIC(model)) %>%
      dplyr::select(., -df) %>%
      dplyr::rename(., Chi_sq = statistic,
                    Predictor = term,
                    p = p.value) %>%
      dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("City_dist"),
                replacement = c("Distance to City Center")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Urb_score"),
                replacement = c("Urbanization Score")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Transect_ID"),
                replacement = c("Subtransect")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c(":"),
                replacement = c(" x ")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Year x Urbanization Score"),
                replacement = c("Urbanization Score x Year"))
}

lapply(best_mods_Q2.urbscore_list, tidy_sb) %>%
  lapply(., as.data.frame) %>%
  purrr::reduce(full_join, by = "Predictor") %>%
  dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Year x Urbanization Score"),
                replacement = c("Urbanization Score x Year")) %>%
  arrange(factor(Predictor, levels = c("Urbanization Score",
                                       "Year",
                                       "Subtransect",
                                       "Urbanization Score x Year",
                                       "Subtransect x Urbanization Score",
                                       "Year x Subtransect",
                                       "Year x Subtransect x Urbanization Score"
                                       ))) %>%
  dplyr::select(-starts_with(c("Sites", "Significance", "AIC", "Response"))) %>%
  replace(., is.na(.), "-") %>%
  dplyr::rename('X2' = 2,
                'p' = 3,
                'X2 ' = 4,
                'p ' = 5,
                'X2  ' = 6,
                'p  ' = 7,
                'X2   ' = 8,
                'p   ' = 9) %>%
  flextable::flextable() %>%
  add_header_row(
    values = c(" ",
               "Pollen Removed",
               "Follicles",
               "Inflorescences",
               "Follicles per Inflorescence"),
    colwidths = c(1, 2, 2, 2, 2)) %>%
  align(j = 1, align = "left", part = "all") %>%
  align(j = 2:9, align = "center", part = "body") %>%
  align(j = 2:9, align = "center", part = "header") %>%
  display(i = 2, col_key = "X2", 
    pattern = "{{val}}{{pow}}", part = "header",
    formatters = list(val ~ as.character("X"), pow ~ as.character("2") ),
    fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
  display(i = 2, col_key = "X2 ", 
    pattern = "{{val}}{{pow}}", part = "header",
    formatters = list(val ~ as.character("X"), pow ~ as.character("2 ") ),
    fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
  display(i = 2, col_key = "X2  ", 
    pattern = "{{val}}{{pow}}", part = "header",
    formatters = list(val ~ as.character("X"), pow ~ as.character("2  ") ),
    fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
  display(i = 2, col_key = "X2   ", 
    pattern = "{{val}}{{pow}}", part = "header",
    formatters = list(val ~ as.character("X"), pow ~ as.character("2   ") ),
    fprops = list(pow = fp_text(vertical.align = "superscript", font.size = 12))) %>%
  width(j = 1, width = 3.3) %>%
  width(j = 2:9, width = 0.8) %>%
  # bold(bold = TRUE, part = "header") %>%
  fontsize(size = 12, part = "header") %>%
  fontsize(size = 12, part = "body") %>%
  italic(i = 2, j = 2:9, part = "header") %>%
  add_footer_lines("QUESTION 2 (Urban sites only)") %>%
  add_footer_lines("Predictor: Urbanization Score") %>%
  save_as_image(., path = here::here("./Figures_Tables/Q1_Q2_ANOVA/Q2_Urbscore_ANOVA.png"))

# WOULD HAVE TO BOLD AND ITALICIZE VALUES MANUALLY- DO LAST, IF EVER
# %>%
#   bold(j = c(3,5,7,9), ~ p  == "< 0.001" | p <= 0.05, ~ p) 
# 
# %>%
#   italic(., ~ p > 0.05 & p <= 0.1, ~ p, italic = TRUE)
  





```

#### Comparing yearly means for variables
##### Pollinia- yearly differences (lm)
###### All data
```{r}
urban_terminus = 3.5 # km; most urban pop is close to this distance
rural_terminus = 67 # km; most rural pop is close to this distance
midpoint = 35.25 # km; midpoint of urban and rural terminii

# 2018
po.1 <- lm(Average_Pollinia	~ City_dist, data = AvgVars_notNA_Poll_18_19 %>% filter(Year == '2018'))
coeffs.po.1 = coefficients(po.1); coeffs

rural_mean = coeffs.po.1[1] + coeffs.po.1[2]*rural_terminus 
rural_mean # mean no. pollinia removed
rural_mean/5 # percentage of pollinia removed

urban_mean = coeffs.po.1[1] + coeffs.po.1[2]*urban_terminus 
urban_mean # mean no. pollinia removed
urban_mean/5 # percentage of pollinia removed

# AVG DIFFERENCE FROM URBAN TO RURAL TERMINUS:
(urban_mean - rural_mean)/(0.5*(urban_mean + rural_mean))

# FIND MEAN # POLLINIA REMOVED
central_mean_2018 = coeffs.po.1[1] + coeffs.po.1[2]*midpoint 
central_mean_2018


# 2019
po.2 <- lm(Average_Pollinia	~ City_dist, data = AvgVars_notNA_Poll_18_19 %>% filter(Year == '2019'))
coeffs.po.2 = coefficients(po.2); coeffs

rural_mean = coeffs.po.2[1] + coeffs.po.2[2]*rural_terminus 
rural_mean
rural_mean/5

urban_mean = coeffs.po.2[1] + coeffs.po.2[2]*urban_terminus 
urban_mean
urban_mean/5

# AVG DIFFERENCE FROM URBAN TO RURAL TERMINUS:
(urban_mean - rural_mean)/(0.5*(urban_mean + rural_mean))

# FIND MEAN # POLLINIA REMOVED
central_mean_2019 = coeffs.po.2[1] + coeffs.po.2[2]*midpoint 
central_mean_2019


#### COMPARE 2018-2019
# AVG DIFFERENCE:
(central_mean_2018 - central_mean_2019)/(0.5*(central_mean_2018 + central_mean_2019))
# 2018 had 24% more poll removed than 2019


```

###### Transects (urban data)
```{r}
urban_terminus = 3.5 # km; most urban pop is close to this distance
rural_terminus = 67 # km; most rural pop is close to this distance
midpoint = 35.25 # km; midpoint of urban and rural terminii

# 2018
## North
upo.1 <- lm(Average_Pollinia	~ City_dist, data = AvgVars_notNA_Poll_18 %>% filter(Transect_ID == 'North'))
coeffs.upo.1 = coefficients(upo.1)

rural_mean = coeffs.upo.1[1] + coeffs.upo.1[2]*rural_terminus 
rural_mean # mean no. pollinia removed
rural_mean/5 # percentage of pollinia removed

urban_mean = coeffs.upo.1[1] + coeffs.upo.1[2]*urban_terminus 
urban_mean # mean no. pollinia removed
urban_mean/5 # percentage of pollinia removed

# AVG DIFFERENCE FROM URBAN TO RURAL TERMINUS:
(urban_mean - rural_mean)/(0.5*(urban_mean + rural_mean))

# FIND MEAN # POLLINIA REMOVED
central_mean_2018_N = coeffs.upo.1[1] + coeffs.upo.1[2]*midpoint 
central_mean_2018_N


# South
upo.2 <- lm(Average_Pollinia	~ City_dist, data = AvgVars_notNA_Poll_18 %>% filter(Transect_ID == 'South'))
coeffs.upo.2 = coefficients(upo.2)

rural_mean = coeffs.upo.2[1] + coeffs.upo.2[2]*rural_terminus 
rural_mean
rural_mean/5

urban_mean = coeffs.upo.2[1] + coeffs.upo.2[2]*urban_terminus 
urban_mean
urban_mean/5

# AVG DIFFERENCE FROM URBAN TO RURAL TERMINUS:
(urban_mean - rural_mean)/(0.5*(urban_mean + rural_mean))

# FIND MEAN # POLLINIA REMOVED
central_mean_2018_S = coeffs.upo.2[1] + coeffs.upo.2[2]*midpoint 
central_mean_2018_S


#### COMPARE 2018 NORTH-SOUTH
# AVG DIFFERENCE:
(central_mean_2018_N - central_mean_2018_S)/(0.5*(central_mean_2018_N + central_mean_2018_S))
# 2018 North had 76% fewer poll removed than South


# - - - - - - - - - - - - - - - - - - - - - - -


# 2019
## North
upo.3 <- lm(Average_Pollinia	~ City_dist, data = AvgVars_notNA_Poll_19 %>% filter(Transect_ID == 'North'))
coeffs.upo.3 = coefficients(upo.3)

rural_mean = coeffs.upo.3[1] + coeffs.upo.3[2]*rural_terminus 
rural_mean # mean no. pollinia removed
rural_mean/5 # percentage of pollinia removed

urban_mean = coeffs.upo.3[1] + coeffs.upo.3[2]*urban_terminus 
urban_mean # mean no. pollinia removed
urban_mean/5 # percentage of pollinia removed

# AVG DIFFERENCE FROM URBAN TO RURAL TERMINUS:
(urban_mean - rural_mean)/(0.5*(urban_mean + rural_mean))

# FIND MEAN # POLLINIA REMOVED
central_mean_2019_N = coeffs.upo.3[1] + coeffs.upo.3[2]*midpoint 
central_mean_2019_N


# South
upo.4 <- lm(Average_Pollinia	~ City_dist, data = AvgVars_notNA_Poll_19 %>% filter(Transect_ID == 'South'))
coeffs.upo.4 = coefficients(upo.4)

rural_mean = coeffs.upo.4[1] + coeffs.upo.4[2]*rural_terminus 
rural_mean
rural_mean/5

urban_mean = coeffs.upo.4[1] + coeffs.upo.4[2]*urban_terminus 
urban_mean
urban_mean/5

# AVG DIFFERENCE FROM URBAN TO RURAL TERMINUS:
(urban_mean - rural_mean)/(0.5*(urban_mean + rural_mean))

# FIND MEAN # POLLINIA REMOVED
central_mean_2019_S = coeffs.upo.4[1] + coeffs.upo.4[2]*midpoint 
central_mean_2019_S


#### COMPARE 2019 NORTH-SOUTH
# AVG DIFFERENCE:
(central_mean_2019_N - central_mean_2019_S)/(0.5*(central_mean_2019_N + central_mean_2019_S))
# 2019 North had 33% fewer poll removed than South








#### COMPARE 2018-2019
# AVG DIFFERENCE:
(central_mean_2018 - central_mean_2019)/(0.5*(central_mean_2018 + central_mean_2019))
# 2018 had 24% more poll removed than 2019

# NORTH DIFFERENCE:
(central_mean_2018_N - central_mean_2019_N)/(0.5*(central_mean_2018_N + central_mean_2019_N))
# 2018-North had 44% more  poll removed than 2019-north

# South DIFFERENCE:
(central_mean_2018_S - central_mean_2019_S)/(0.5*(central_mean_2018_S + central_mean_2019_S))
# 2018-South had 86% more  poll removed than 2019-south
```


##### Peduncles/Inflors -transects
```{r}

urban_terminus = 3.5 # km; most urban pop is close to this distance
rural_terminus = 67 # km; most rural pop is close to this distance
midpoint = 35.25 # km; midpoint of urban and rural terminii


# 2018
inf.1 <- lm(Peduncles_sq	~ City_dist, data = fertile_pops_all %>% filter(Transect_ID != "Rural") %>% filter(Year == '2018'))
coeffs.inf.1 = coefficients(inf.1)

rural_mean = coeffs.inf.1[1] + coeffs.inf.1[2]*rural_terminus 
rural_mean # mean no. inflors

urban_mean = coeffs.inf.1[1] + coeffs.inf.1[2]*urban_terminus 
urban_mean # mean no. inflors

# AVG DIFFERENCE FROM URBAN TO RURAL TERMINUS:
(urban_mean - rural_mean)/(0.5*(urban_mean + rural_mean))

# FIND MEAN # POLLINIA REMOVED
central_mean_2018 = coeffs.inf.1[1] + coeffs.inf.1[2]*midpoint 
central_mean_2018


# AVG DIFFERENCE FROM URBAN TO MIDPOINT-URBAN TERMINUS:
(urban_mean - central_mean_2018)/(0.5*(urban_mean + central_mean_2018))




# 2019
inf.2 <- lm(Peduncles_sq	~ City_dist, data = fertile_pops_all %>% filter(Transect_ID != "Rural") %>% filter(Year == '2019'))
coeffs.inf.2 = coefficients(inf.2)

rural_mean = coeffs.inf.2[1] + coeffs.inf.2[2]*rural_terminus 
rural_mean # mean no. inflors

urban_mean = coeffs.inf.2[1] + coeffs.inf.2[2]*urban_terminus 
urban_mean # mean no. inflors

# AVG DIFFERENCE FROM URBAN TO RURAL TERMINUS:
(urban_mean - rural_mean)/(0.5*(urban_mean + rural_mean))

# FIND MEAN # POLLINIA REMOVED
central_mean_2019 = coeffs.inf.2[1] + coeffs.inf.2[2]*midpoint 
central_mean_2019


# AVG DIFFERENCE FROM URBAN TO MIDPOINT-URBAN TERMINUS:
(urban_mean - central_mean_2019)/(0.5*(urban_mean + central_mean_2019))


# #### COMPARE 2018-2019
# # AVG DIFFERENCE:
# (central_mean_2018 - central_mean_2019)/(0.5*(central_mean_2018 + central_mean_2019))
# # 2018 had 24% more poll removed than 2019


```

##### Foll per inflor- yearly differences (lm)
```{r}
urban_terminus = 3.5 # km; most urban pop is close to this distance
rural_terminus = 67 # km; most rural pop is close to this distance
midpoint = 35.25 # km; midpoint of urban and rural terminii

# 2018
fi.1 <- lm(pods_per_ped_sqrt	~ City_dist, data = fertile_pops_all %>% filter(Year == '2018'))
coeffs.fi.1 = coefficients(fi.1)

rural_mean = coeffs.fi.1[1] + coeffs.fi.1[2]*rural_terminus 
rural_mean # mean no. follicles/inflor

urban_mean = coeffs.fi.1[1] + coeffs.fi.1[2]*urban_terminus 
urban_mean # mean no. follicles/inflor

# AVG DIFFERENCE FROM URBAN TO RURAL TERMINUS:
(urban_mean - rural_mean)/(0.5*(urban_mean + rural_mean))

# FIND MEAN #  follicles/inflor
central_mean_2018 = coeffs.fi.1[1] + coeffs.fi.1[2]*midpoint 
central_mean_2018


# 2019
fi.2 <- lm(pods_per_ped_sqrt	~ City_dist, data = fertile_pops_all %>% filter(Year == '2019'))
coeffs.fi.2 = coefficients(fi.2)

rural_mean = coeffs.fi.2[1] + coeffs.fi.2[2]*rural_terminus 
rural_mean

urban_mean = coeffs.fi.2[1] + coeffs.fi.2[2]*urban_terminus 
urban_mean

# AVG DIFFERENCE FROM URBAN TO RURAL TERMINUS:
(urban_mean - rural_mean)/(0.5*(urban_mean + rural_mean))

# FIND MEAN #  follicles/inflor
central_mean_2019 = coeffs.fi.2[1] + coeffs.fi.2[2]*midpoint 
central_mean_2019


#### COMPARE 2018-2019
# AVG DIFFERENCE:
(central_mean_2018 - central_mean_2019)/(0.5*(central_mean_2018 + central_mean_2019))
# 2018 had 24% more follicles/inflor than 2019


```


### Figures
#### Main text
##### Gradient regressions
```{r}
## CITY_DIST -----------------------
# POLLINIA --------
Q1_reg_poll <- ggplot(AvgVars_notNA_Poll_18_19, aes(x = City_dist, y = Average_Pollinia, shape=Year)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Pollinaria Removed") +
  geom_point(aes(shape=Year, color=Year),  size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape=Year, color=Year, fill=Year), size=0.75, method = lm, alpha=.15, se = T) +
  scale_y_continuous(breaks=c(0,1,2,3,4,5), limits=c(0,5)) +
  labs( color="Year", shape="Year") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
Q1_reg_poll


# PODS --------
Q1_reg_pod <- ggplot(fertile_pops_all, aes(x = City_dist, y = Viable_Pods_sqrt, shape=Year)) +
  labs(x = "Distance to urban center (km)",
       y = expression(Follicles^{0.5})) +
  geom_point(aes(shape=Year, color=Year),  size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape=Year, color=Year, fill=Year), size=0.75, method = lm, alpha=0.15, se = T) +
  scale_y_continuous(limits=c(0,4)) +
  labs(color="Year", size = "Year") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
 text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
Q1_reg_pod



# PEDUNCLES --------
Q1_reg_ped <- ggplot((fertile_pops_all %>% filter(!is.na(Peduncles))), aes(x = City_dist, y = Peduncles_sq, shape=Year)) +
  labs(x = "Distance to urban center (km)",
       y = expression(Inflorescences^{2})) +
  geom_point(aes(shape=Year, color=Year),  size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape=Year, color=Year, fill=Year), size=0.75, method = lm, alpha=0.15, se = T) +
  scale_y_continuous(limits=c(0,200)) +
  labs(color="Year", size = "Year") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
     text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
Q1_reg_ped

# FOLLICLES PER INFLOR --------
Q1_reg_follperinflor <- ggplot(fertile_pops_all_podsperped, aes(x = City_dist, y = pods_per_ped_sqrt, shape=Year)) +
  labs(x = "Distance to urban center (km)",
    y = expression(Follicles/Inflorescence^{0.5})) +
  geom_point(aes(color = Year, shape = Year), size=2) +
  scale_shape(solid = F)+
  scale_y_continuous(limits=c(0,1.5)) +
  geom_smooth(aes(colour=Year, shape=Year, fill=Year),size=0.75, method = lm, alpha=0.15, se = T) +
  labs(color="Year", size="Year") +
  labs(linetype="Year", shape = "Year") +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
Q1_reg_follperinflor

# PLANT DENSITY AT SITE (not included in composite figure, below) --------
Q1_reg_density <- ggplot(density_18, aes(x = City_dist, y = density_sqm_18)) +
  labs( x = "Distance to urban center (km)", y = "Plant density") +
  geom_point(size=2) +
  scale_shape(solid = F)+
  geom_smooth(size=0.75, method = lm, alpha=0.15, se = T) +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
Q1_reg_density


## URB_SCORE -------------------------
# POLLINIA --------
Q1_reg_poll_u <- ggplot(AvgVars_notNA_Poll_18_19, aes(x = Urb_score, y = Average_Pollinia, shape=Year)) +
  labs(
    # x = "Urbanization Score",
    y = "Pollinaria Removed") +
  scale_x_reverse() +
  geom_point(aes(shape=Year, color=Year),  size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape=Year, color=Year, fill=Year), size=0.75, method = lm, alpha=.15, se = T) +
  scale_y_continuous(breaks=c(0,1,2,3,4,5), limits=c(0,5)) +
  labs( color="Year", shape="Year") +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    # legend.position = c(.99, .99),
    # legend.justification = c("right", "top"),
    # legend.box = 'horizontal',
    # legend.box.just = "right",
    # legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
    # legend.key = element_rect(fill = NA)
    )
Q1_reg_poll_u


# PODS --------
Q1_reg_pod_u <- ggplot(fertile_pops_all, aes(x = Urb_score, y = Viable_Pods_sqrt, shape=Year)) + labs(
  # x = "Urbanization Score",
    y = expression(Follicles^{0.5})) +
  scale_x_reverse() +
  geom_point(aes(shape=Year, color=Year),  size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape=Year, color=Year, fill=Year), size=0.75, method = lm, alpha=0.15, se = T) +
  scale_y_continuous(limits=c(0,4)) +
  labs(color="Year", size = "Year") +
  theme(
    legend.position = "none",
        axis.title.x = element_blank(),
 #    legend.position = c(.99, .99),
 #    legend.justification = c("right", "top"),
 #    legend.box = 'horizontal',
 #    legend.box.just = "right",
 #    legend.margin = margin(5,5,5,5),
     text = element_text(size=14),
 #    axis.title.x = element_blank(),
     panel.background = element_blank(),
     axis.line = element_line(colour = "black")
 #    legend.key = element_rect(fill = NA)
 )
Q1_reg_pod_u



# PEDUNCLES --------
Q1_reg_ped_u <- ggplot(fertile_pops_all, aes(x = Urb_score, y = Peduncles_sq, shape=Year)) + 
  labs(
    # x = "Urbanization Score",
       y = expression(Inflorescences^{2})) +
  scale_x_reverse() +
  geom_point(aes(shape=Year, color=Year),  size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape=Year, color=Year, fill=Year), size=0.75, method = lm, alpha=0.15, se = T) +
  scale_y_continuous(limits=c(0,200)) +
  labs(color="Year", size = "Year") +
  theme(
    legend.position = "none",
        axis.title.x = element_blank(),
    # legend.position = c(.99, .99),
    # legend.justification = c("right", "top"),
    # legend.box = 'horizontal',
    # legend.box.just = "right",
    # legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
    # legend.key = element_rect(fill = NA)
    )
Q1_reg_ped_u

# FOLLICLES PER INFLOR --------
Q1_reg_follperinflor_u <- ggplot(urb_scores_podperped_all, aes(x = Urb_score, y = pods_per_ped, shape=Year)) +
  labs(
  # x = "Urbanization Score",
       y = "Follicles/Inflorescence") +
  scale_x_reverse() +
  geom_point(aes(color = Year, shape = Year), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(colour=Year, shape=Year, fill=Year),size=0.75, method = lm, alpha=0.15, se = T) +
  labs(color="Year", size="Year") +
  labs(linetype="Year",  shape = "Year") +
  theme(legend.position = "none",
            axis.title.x = element_blank(),
    # legend.position = c(.99, .99),
    # legend.justification = c("right", "top"),
    # legend.box.just = "right",
    # legend.box = 'horizontal',
    # legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
    # legend.key = element_rect(fill = NA)
    )
Q1_reg_follperinflor_u



## PLOTS ------
library(ggpubr)
Q1_regressions_citydist <- ggarrange(Q1_reg_ped , Q1_reg_poll, Q1_reg_pod,  Q1_reg_follperinflor +
                            font("x.text"),
                            ncol = 4,
                            nrow = 1,
                            align = "hv",
                            labels = list("A", "B", "C", "D"),
                            font.label = (size =16),
                            common.legend = T,
                            legend = "top") %T>%
  plot

Q1_regressions_urbscore <- ggarrange(Q1_reg_ped_u, Q1_reg_poll_u, Q1_reg_pod_u,  Q1_reg_follperinflor_u +
                            font("x.text"),
                            ncol = 4,
                            nrow = 1,
                            align = "hv",
                            labels = list("E", "F", "G", "H"),
                            font.label = (size =16),
                            common.legend = F) %T>%
  plot

city_plots <- annotate_figure(Q1_regressions_citydist, bottom = text_grob("Distance to Urban Center (km)", size=14))
urbscore_plots <- annotate_figure(Q1_regressions_urbscore, bottom = text_grob("Urbanization Score", size=14))

city_plots/urbscore_plots

dev.copy2pdf(file="~/R_Projects/Chapter1/Figures_Tables/Q1_Gradient/Gradient_regressions.pdf", width = 12, height = 8)
```



##### Urban subtransect regressions
```{r}
## CITY_DIST -----------------------
# POLLINIA-----
Q2_reg_poll_subtr <- ggplot(AvgVars_notNA_Poll_18_19 %>% filter(Transect_ID == "North" | Transect_ID == "South"),
                            aes(x = City_dist, y = Average_Pollinia,
                                group = interaction(Year,Transect_ID),
                                color=interaction(Year,Transect_ID),
                                linetype=interaction(Year,Transect_ID),
                                shape=interaction(Year,Transect_ID))) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_y_continuous(breaks=c(0,1,2,3), limits=c(0,3)) +
  labs(x = "Distance to City Center (km)",
       y = "Pollinaria Removed",
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") )

Q2_reg_poll_subtr

# PODS-----
Q2_reg_pod_subtr <- ggplot((fertile_pops_all %>% filter(Transect_ID == "North" | Transect_ID == "South")),
                           aes(x = City_dist, y = Viable_Pods_sqrt,
                               group=interaction(Year,Transect_ID),
                               color=interaction(Year,Transect_ID),
                               linetype=interaction(Year,Transect_ID),
                               shape=interaction(Year,Transect_ID))) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  labs(x = "Distance to City Center (km)",
       y = expression(Follicles^{0.5}) ,
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
 text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") )

Q2_reg_pod_subtr


# PEDUNCLES----
Q2_reg_ped_subtr <- ggplot(fertile_pops_all %>% filter(Transect_ID != "Rural"),
                           aes(x = City_dist,
                               y = Peduncles_sq,
                               group=interaction(Year,Transect_ID),
                               color=interaction(Year,Transect_ID),
                               linetype=interaction(Year,Transect_ID),
                               shape=interaction(Year,Transect_ID)
                                 )) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_y_continuous(limits=c(0,200)) +
  labs(x = "Distance to City Center (km)",
       y = expression(Inflorescences^{0.5}),
    color = "Year, Subtransect",
    shape = "Year, Subtransect",
    linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
     text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") )

Q2_reg_ped_subtr

# FOLLICLES PER INFLORESCENCE----
Q2_reg_follperinfl_subtr <-  ggplot(fertile_pops_all %>% filter(Transect_ID != 'Rural'),
                                   aes(x = City_dist,
                                       y = pods_per_ped_sqrt, 
                                       group=interaction(Year,Transect_ID),
                                       color=interaction(Year,Transect_ID),
                                       linetype=interaction(Year,Transect_ID),
                                       shape=interaction(Year,Transect_ID))) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  labs(x = "Distance to City Center (km)",
    y = expression(Follicles/Inflorescence^{0.5}),
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line"))
# +  guides(colour = guide_legend(override.aes = list(size=7)))
Q2_reg_follperinfl_subtr


## URB_SCORE -------------------------
# POLLINIA-----
Q2_reg_poll_subtr_u <- ggplot(AvgVars_notNA_Poll_18_19 %>% filter(Transect_ID == "Rural"), aes(Urb_score, Average_Pollinia,
                                 group=interaction(Year,Transect_ID),
                                 color=interaction(Year,Transect_ID),
                                 linetype=interaction(Year,Transect_ID),
                                 shape=interaction(Year,Transect_ID)
                                 )) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_x_reverse() +
  scale_y_continuous(breaks=c(0,1,2,3), limits=c(0,3)) +
  labs(x = "Urbanization Score",
       y = "Pollinaria Removed",
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size=14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
Q2_reg_poll_subtr_u

# PODS-----
Q2_reg_pod_subtr_u <- ggplot(data = fertile_pops_all %>% filter(Transect_ID != "Rural")), aes(Urb_score, Viable_Pods_sqrt,
                                 group=interaction(Year,Transect_ID),
                                 color=interaction(Year,Transect_ID),
                                 linetype=interaction(Year,Transect_ID),
                                 shape=interaction(Year,Transect_ID)
                                 )) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_x_reverse() +
  labs(x = "Urbanization Score",
       y = expression(Follicles^{0.5}) ,
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size=14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
Q2_reg_pod_subtr_u


# PEDUNCLES----
Q2_reg_ped_subtr_u <- ggplot(fertile_pops_all %>% filter(Transect_ID != "Rural"), aes(Urb_score, Peduncles_sq,
                                 group=interaction(Year,Transect_ID),
                                 color=interaction(Year,Transect_ID),
                                 linetype=interaction(Year,Transect_ID),
                                 shape=interaction(Year,Transect_ID)
                                 )) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_x_reverse() +
  scale_y_continuous(limits=c(0,200)) +
  labs(x = "Urbanization Score",
       y =expression(Inflorescences^{0.5}),
    color = "Year, Subtransect",
    shape = "Year, Subtransect",
    linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size=14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
Q2_reg_ped_subtr_u

# FOLLICLES PER INFLORESCENCE----
Q2_reg_follperinfl_subtr_u <- ggplot(urb_scores_podperped, aes(Urb_score, pods_per_ped,
                                 group=interaction(Year,Transect_ID),
                                 color=interaction(Year,Transect_ID),
                                 linetype=interaction(Year,Transect_ID),
                                 shape=interaction(Year,Transect_ID)
                                 )) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  scale_x_reverse() +
  labs(x = "Urbanization Score",
       y = "Follicles/Inflorescence",
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size=14),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))

Q2_reg_follperinfl_subtr_u



# ggplot(urb_scores_podperped, aes(x = Urb_score, y = pods_per_ped,
#                                  color = Year,
#                                  shape = Year,
#                                  linetype = Transect_ID,
#                                  fill = Transect_ID)) +
#   labs(x = "Urbanization Score", 
#     y = "Follicles/Inflorescence",
#     shape = 'Year', linetype = 'Subtransect', color = 'Year', fill = 'Subtransect') +
#   geom_point(size=2) +
#     scale_x_reverse() +
#   geom_smooth(method = lm, alpha=0.15, se = F) +
#    theme( #legend.position = "none",
#     # axis.title.x = element_blank(),
#     legend.box = 'horizontal',
#     text = element_text(size=14),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black")) +
#   scale_linetype_discrete(name  ="Subtransect",
#                            breaks=c("North", "South"),
#                            labels=c("Urban: Non-Corridor", "Urban: Corridor")) +
#   scale_shape_discrete(name  ="Subtransect",
#                            breaks=c("North", "South"),
#                            labels=c("Urban: Non-Corridor", "Urban: Corridor")) +
#   scale_color_discrete(name  ="Year",
#                            breaks=c("2018", "2019"),
#                            labels=c("2018", "2019")) +
#   scale_fill_discrete(name  ="Subtransect",
#                            breaks=c("North", "South"),
#                            labels=c("Urban: Non-Corridor", "Urban: Corridor"))



# ggplot(urb_scores_podperped, aes(x = Urb_score, y = pods_per_ped,
#                                  color = Year,
#                                  shape = Year,
#                                  linetype = Transect_ID,
#                                  fill = Transect_ID)) +
#   labs(x = "Urbanization Score", 
#     y = "Follicles/Inflorescence",
#     shape = 'Year', linetype = 'Subtransect', color = 'Year', fill = 'Subtransect') +
#   geom_point(size=2) +
#     scale_x_reverse() +
#   geom_smooth(method = lm, alpha=0.15, se = F) +
#    theme( #legend.position = "none",
#     # axis.title.x = element_blank(),
#     legend.box = 'horizontal',
#     text = element_text(size=14),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black")) +
#   scale_linetype_discrete(name  ="Subtransect",
#                            breaks=c("North", "South"),
#                            labels=c("Urban: Non-Corridor", "Urban: Corridor")) +
#   scale_shape_discrete(name  ="Subtransect",
#                            breaks=c("North", "South"),
#                            labels=c("Urban: Non-Corridor", "Urban: Corridor")) +
#   scale_color_discrete(name  ="Year",
#                            breaks=c("2018", "2019"),
#                            labels=c("2018", "2019")) 


## PLOTS ------
library(ggpubr)
Q2_regressions_citydist <- ggarrange(Q2_reg_ped_subtr,Q2_reg_poll_subtr, Q2_reg_pod_subtr,  Q2_reg_follperinfl_subtr +
                            font("x.text"),
                            ncol = 4,
                            nrow = 1,
                            align = "hv",
                            labels = list("A", "B", "C", "D"),
                            font.label = (size =16),
                            common.legend = T,
                            legend = "top") %T>%
  plot

Q2_regressions_urbscore <- ggarrange(Q2_reg_ped_subtr_u,Q2_reg_poll_subtr_u, Q2_reg_pod_subtr_u,  Q2_reg_follperinfl_subtr_u +
                            font("x.text"),
                            ncol = 4,
                            nrow = 1,
                            align = "hv",
                            labels = list("E", "F", "G", "H"),
                            font.label = (size =16),
                            common.legend = F) %T>%
  plot

city_plots_subtr <- annotate_figure(Q2_regressions_citydist, bottom = text_grob("Distance to Urban Center (km)", size=14))
urbscore_plots_subtr <- annotate_figure(Q2_regressions_urbscore, bottom = text_grob("Urbanization Score", size=14))

city_plots_subtr/urbscore_plots_subtr

dev.copy2pdf(file="~/R_Projects/Chapter1/Figures_Tables/Q2_UrbanSubtransects/Subtransect_regressions.pdf", width = 12, height = 8)
```


#### Supplement
##### Height, Gradient regressions
```{r}
### CITY_DIST --------
Q1_reg_height <- ggplot((fertile_pops_all %>% filter(!is.na(Height_Sept))), aes(x = City_dist, y = Height_Sept, shape=Year, color = Year)) +
  labs(x = "Distance to Urban Center (km)", 
    y = "Height (cm)") +
  geom_point(aes(color = Year, shape = Year), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(colour=Year, shape=Year, fill=Year),size=0.75, method = lm, alpha=0.15, se = T) +
  labs(color="Year", size="Year") +
  scale_y_continuous(limits=c(0,200)) +
  labs(linetype="Year", color="Year", shape = "Year") +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
Q1_reg_height

### URB_SCORE--------
Q1_reg_height_u <- ggplot((fertile_pops_all %>% filter(!is.na(Height_Sept))), aes(x = Urb_score, y = Height_Sept, shape=Year)) +
  labs(x = "Urbanization Score", 
    y = "Height (cm)") +
  geom_point(aes(color = Year, shape = Year), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(colour=Year, shape=Year, fill=Year),size=0.75, method = lm, alpha=0.15, se = T) +
  labs(color="Year", size="Year") +
  scale_y_continuous(limits=c(0,200)) +
  labs(linetype="Year", color="Year", shape = "Year") +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
Q1_reg_height_u


library(ggpubr)
Q1_regressions_supp <- ggarrange(Q1_reg_height, Q1_reg_height_u + font("x.text"), ncol = 2, nrow = 1, align = "h", labels = list("A", "B"), font.label = (size =16), common.legend = TRUE, legend = "right")
Q1_regressions_supp

dev.copy2pdf(file="~/R_Projects/Chapter1/Figures_Tables/Supplement/Gradient_regression_height.pdf", width = 8, height = 4)
```

##### Height, Subtransect regressions
```{r}
## CITY_DIST-----
Q2_reg_height <- ggplot((fertile_pops_all %>% filter(!is.na(Height_Sept) & Transect_ID != "Rural")),
                        aes(x = City_dist,
                            y = Height_Sept,
                            group=interaction(Year,Transect_ID),
                            color=interaction(Year,Transect_ID),
                            linetype=interaction(Year,Transect_ID),
                            shape=interaction(Year,Transect_ID))) + 
  geom_point(size=2.5)  +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  labs(x = "Distance to City Center (km)",
    y = "Height (cm)",
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line"))+
  guides(shape = guide_legend(nrow = 2),
         color = guide_legend(nrow = 2),
         linetype = guide_legend(nrow = 2))
Q2_reg_height


## URB_SCORE-----
Q2_reg_height_u <- ggplot((fertile_pops_all %>% filter(!is.na(Height_Sept) & Transect_ID != "Rural")),
                        aes(x = Urb_score,
                            y = Height_Sept,
                            group=interaction(Year,Transect_ID),
                            color=interaction(Year,Transect_ID),
                            linetype=interaction(Year,Transect_ID),
                            shape=interaction(Year,Transect_ID))) + 
  geom_point(size=2.5)  +
  scale_x_reverse() +
  geom_smooth(method = lm, alpha=0.15, se = F) +
  labs(x = "Urbanization Score",
    y = "Height (cm)",
       color = "Year, Subtransect",
       shape = "Year, Subtransect",
       linetype = "Year, Subtransect") +
  scale_shape_manual(values = c(1,2,16,17),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_color_manual(values = c("#00BFC4", "#00BFC4", "#F8766D", "#F8766D"),
                     labels = c("2018- Urban: Non-Corridor",
                                "2019- Urban: Non-Corridor",
                                "2018- Urban: Corridor",
                                "2019- Urban: Corridor")) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid', 'dashed'),
                        labels = c("2018- Urban: Non-Corridor",
                                   "2019- Urban: Non-Corridor",
                                   "2018- Urban: Corridor",
                                   "2019- Urban: Corridor")) +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") ) +
  guides(shape = guide_legend(nrow = 2),
         color = guide_legend(nrow = 2),
         linetype = guide_legend(nrow = 2))
Q2_reg_height_u

## PLOTS-----
library(ggpubr)
Q2_regressions_supp <- ggarrange(Q2_reg_height, Q2_reg_height_u + font("x.text"), ncol = 2, nrow = 1, align = "h", labels = list("A", "B"), font.label = (size =16), common.legend = TRUE, legend = "bottom")
Q2_regressions_supp

dev.copy2pdf(file="~/R_Projects/Chapter1/Figures_Tables/Supplement/Subtransect_regression_height.pdf", width = 7, height = 4)
```

## Question 3 (Pollinator data)
### Import data
```{r}
#@ Import Pollinator data-----
pollinators <- read.csv(here("./raw_data/Pollinator_PivotTable_byPop_Coded.csv"),  header=T, na.strings=c("","NA"))

# Neaten first column's name
colnames(pollinators)[1] <- "Patch_ID"

# Delete last, empty column
pollinators <- pollinators[-59,]


### Add City_dist values with Haversine formula
# Ref lat and longs are for Yonge & Dundas intersection in downtown Toronto
pollinators$Ref_Lat <- "43.656327"
pollinators$Ref_Long <- "-79.380904"

# Make lat/long cols numeric
pollinators$Lat <- as.numeric(as.character(pollinators$Lat))
pollinators$Long <- as.numeric(as.character(pollinators$Long))
pollinators$Ref_Lat <- as.numeric(as.character(pollinators$Ref_Lat))
pollinators$Ref_Long <- as.numeric(as.character(pollinators$Ref_Long))

# Find distances from Yonge/Dundas to sample sites (in meters)
pollinators <- pollinators %>% mutate(CTD_m = distHaversine(cbind(Long, Lat), cbind(Ref_Long, Ref_Lat)))

# conver to km
pollinators$Dist_city <- pollinators$CTD / 1000

# drop ref lat, long, and city_dist (in m) cols
pollinators <- pollinators[,-c(50:52)]


## Import taxonomy table-----
tax <- read.csv(here("./raw_data/Taxonomy_transposed.csv"),  header=T, na.strings=c("","NA"), fileEncoding = 'UTF-8-BOM')


```

### Manipulate pollinator, taxonomy tables
##### All data
```{r}
# Create new table with average pollinator sightings per plant
poll_pp <- pollinators %>%
  as_tibble %>%
  mutate_at(vars(starts_with("MS_")), funs(./pollinators$Plants_surveyed)) %>%
  # Drop inaccurate Total column
  dplyr::select(., -49) %>%
  # add new accurate total col
  rowwise() %>% 
  mutate(., Total = sum(c_across(MS_01:MS_42)))
  

# Create new table recoding all sightings to binary (0 = not seen; 1 = seen)
poll_binary <- pollinators[,-49] %>%
  mutate_at(vars(starts_with("MS_")), funs(ifelse(. >0, 1, .))) %>%
  # add new accurate total col
  rowwise() %>% 
  mutate(., Total = sum(c_across(MS_01:MS_42)))


# reshape to create diversity table (combining occurrence data with taxonomy)
melted <- melt(pollinators, id=c("Patch_ID", "Lat", "Long", "Dist_city", "Transect", "Plants_surveyed")) %>%
  # remove rows with no pollinators observed, remove "Total"
  filter(value != 0) %>%
  filter(variable != "Total") %>%
  dplyr::rename(Morphospecies_Code = variable, Count = value)

diversity <- merge(x=melted,y=tax,by="Morphospecies_Code",all.x=TRUE)


 ##################  CALCULATING SPECIES DIVERSITY ##################  
pollinators1 <- pollinators[,c(1,7:48)] %>%
  rowwise() %>% 
  add_column(., shannon = vegan::diversity(pollinators1[-1], index="shannon")) %>%
  add_column(., simpson = vegan::diversity(pollinators1[-1], index="simpson")) %>%
  # remove observations per site to just get site and shannon & simpson indices
  dplyr::select(., c(1,44,45))


# Find number of each taxon level present per population
div_sum <- diversity %>%
  group_by(Patch_ID, Dist_city, Transect) %>%
  dplyr::summarise(
    orders = n_distinct(Order),
    superfams = n_distinct(Superfamily),
    families = n_distinct(Family),
    subfams = n_distinct(Subfamily),
    genera = n_distinct(Genus),
    mspecies = n_distinct(Morphospecies_Code)) %>%
  # Find total number of individuals seen per population & add 
  dplyr::full_join(., diversity %>%
                     group_by(Patch_ID) %>%
                     dplyr::summarise(
                       total_indivs = sum(Count)), by = "Patch_ID") %>%
  # add species richness cols
  ## The mspecies column of div_sum is a simple measure of species richness.
  ## Another measure of species richness, or D (Menhinick's index), = the number of species divided by the square root of the number of individuals in the sample.
  # rowwise() %>% 
  mutate(., Menhinicks_index = mspecies / total_indivs^0.5) %>%

## join all the rows from pollinators1 to div_sum, which doesn't have all sites represented (because those missing sites had no pollinators observed). In this case, those sites had a shannon index of 0 and a simpson's index of 1.
 dplyr::left_join(., pollinators1, by = "Patch_ID")



# get max values in shannon's and simpson's diversity columns
max_shannon <- summarise(div_sum, max(shannon))
max_simpson <- summarise(div_sum, max(simpson))

# add simpson's, shannon's equitabilities to div_sum
div_sum <- div_sum %>%
  rowwise() %>%
 # add Shannon's equitability
  dplyr::mutate(., shannon_equit = shannon / max_shannon) %>%
 # add Simpson's equitability
  dplyr::mutate(., simpson_equit = simpson / max_simpson)



 # Find number of each taxon level present per transect
div_transects <- diversity %>%
  group_by(Transect) %>%
  dplyr::summarise(
    Orders = n_distinct(Order),
    Superfamilies = n_distinct(Superfamily),
    Families = n_distinct(Family),
    Subfamilies = n_distinct(Subfamily),
    Genera = n_distinct(Genus),
    Morphospecies = n_distinct(Morphospecies_Code),
    Total_individuals = n())

```
 
##### Without honeybee data
```{r}
# remove honeybee data
diversity_no_honey <- diversity %>% filter(Morphospecies != "Apis mellifera (Large)")

# - - - - -

# Find number of each taxon level present per population
div_sum_no_honey <- diversity_no_honey %>%
  group_by(Patch_ID, Dist_city, Transect) %>%
  dplyr::summarise(
    orders = n_distinct(Order),
    superfams = n_distinct(Superfamily),
    families = n_distinct(Family),
    subfams = n_distinct(Subfamily),
    genera = n_distinct(Genus),
    mspecies = n_distinct(Morphospecies_Code)) %>%
  # Find total number of individuals seen per population & add 
  dplyr::full_join(., diversity_no_honey %>%
                     group_by(Patch_ID) %>%
                     dplyr::summarise(
                       total_indivs = sum(Count)), by = "Patch_ID") %>%
  # add species richness cols
  ## The mspecies column of div_sum is a simple measure of species richness.
  ## Another measure of species richness, or D (Menhinick's index), = the number of species divided by the square root of the number of individuals in the sample.
  # rowwise() %>% 
  mutate(., Menhinicks_index = mspecies / total_indivs^0.5) %>%

## join all the rows from pollinators1 to div_sum, which doesn't have all sites represented (because those missing sites had no pollinators observed). In this case, those sites had a shannon index of 0 and a simpson's index of 1.
 dplyr::left_join(., pollinators1, by = "Patch_ID")



# get max values in shannon's and simpson's diversity columns
max_shannon_no_honey <- summarise(div_sum_no_honey, max(shannon))
max_simpson_no_honey <- summarise(div_sum_no_honey, max(simpson))

# add simpson's, shannon's equitabilities to div_sum
div_sum_no_honey <- div_sum_no_honey %>%
 # add Shannon's equitability
  dplyr::mutate(., shannon_equit = shannon / max_shannon_no_honey) %>%
 # add Simpson's equitability
  dplyr::mutate(., simpson_equit = simpson / max_simpson_no_honey)



 # Find number of each taxon level present per transect
div_transects_no_honey <- diversity_no_honey %>%
  group_by(Transect) %>%
  dplyr::summarise(
    Orders = n_distinct(Order),
    Superfamilies = n_distinct(Superfamily),
    Families = n_distinct(Family),
    Subfamilies = n_distinct(Subfamily),
    Genera = n_distinct(Genus),
    Morphospecies = n_distinct(Morphospecies_Code),
    Total_individuals = n())

```


### Tables
```{r}
# Total pollinators observed per morphospecies:
ms_table <- colSums(pollinators[,c(7:48)]) %>%
  as.data.frame() %>%
  dplyr::rename(indivs_observed = 1)
# top 4 abundant morphospecies: MW 6, 14, 2, 10.
#   6: Apis mellifera (Large)
#   14: (small) black sweat bee (Halictidae spp.)
#   2: orange beetle (Rhagoycha fulva)
#   10: small black sweat bee (yellow face) (Hylaeus spp.)



####### Table of each family's most common morphospecies vs dist city ctr ------
four_popfams <- dplyr::filter(diversity, Family %in% c( 'Apidae', 'Cantharidae' , 'Halictidae', 'Megachilidae')) %>%
  group_by(Morphospecies, Family) %>%
  summarise(
    "Sites" = n_distinct(Patch_ID),
    "Individuals_observed" = sum(Count))

# switch order of first 2 cols
four_popfams <- four_popfams[,c(2,1,3,4)]

# break into 4 separate tables, calculate subtotals, then bind together
apidae <- dplyr::filter(four_popfams, Family %in% 'Apidae') %>% adorn_totals("row")
canth <- dplyr::filter(four_popfams, Family %in% 'Cantharidae')%>% adorn_totals("row")
halict <- dplyr::filter(four_popfams, Family %in% 'Halictidae')%>% adorn_totals("row")
megachil <- dplyr::filter(four_popfams, Family %in% 'Megachilidae')%>% adorn_totals("row")

b <- bind_rows(list(apidae, canth, halict, megachil)) %>%
              arrange(Family, Morphospecies, Sites, Individuals_observed)

d <- rbindlist(list(
  four_popfams %>%
    group_by(Family) %>%
    summarise(sum(Sites), sum(Individuals_observed)),
  four_popfams %>%
    group_by(Family, Morphospecies) %>%
    summarise(sum(Sites), sum(Individuals_observed))),fill=TRUE) %>%
  arrange(Family, Morphospecies)

# Make Total rows clear
d$Family <- as.character(d$Family)
d[8,1] <- as.character("Apidae: Total")
d[10,1] <- as.character("Cantharidae: Total")
d[18,1] <- as.character("Halictidae: Total")
d[29,1] <- as.character("Megachilidae: Total")

colnames(d)[2] <- "Sites Observed"
colnames(d)[3] <- "Individuals Observed"
colnames(d)[4] <- "Morphospecies Description "

kable(d, digits = 3, format = "pandoc", caption = "Top 4 Families") # the digits argument controls rounding
d_export <- kable(d, digits = 3, format = "pandoc", caption = "Top 4 Families")
kable(d, "html") %>%
  kable_styling("striped") %>%
  save_kable(file = "table_d.html", self_contained = T)
  as_image(width = 4)
```

### Graphs
#### Abundance
##### Abundance along gradient & subtransects
```{r}
# Total abundance

## try to get standard error to create confidence intervals here? 
# library(Rmisc)
# sum1 <- summarySE(diversity, measurevar="Count", groupvars= c("Order", "Transect"), na.rm = T)
# sum_a <- summarySE(diversity, measurevars = c("Morphospecies_Code", "Count"), groupvar= ("Patch_ID"), na.rm = T)
# ggplot(sum1, aes(x=Transect, y=Count, color = Order, shape=Order)) +
#   geom_pointrange(aes(ymin=Count-se, ymax=Count+se), size = 1, position = position_jitterdodge(dodge.width = .5)) +
#   geom_smooth(method=lm, se=F, fullrange = T, size = 0.5) +
#   # scale_color_manual(values=c("gray64", "black", 'grey')) +
#   theme_bw() +
#   labs(title = "Total Pollinator Order Abundance by Transect",
#        caption = "Error bars represent standard error")


abun <- ggplot(pollinators, aes(x = Dist_city, y = Total)) +
  labs(x = "Distance to urban center (km)", y = "Average Pollinators Observed") +
  geom_point() +
  scale_shape(solid = F)+
  geom_smooth(color="black", method = lm, alpha=0.15,  se = T) +
  labs(title = 'Pollinator Abundance Along Urban-Rural Gradient') +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    )+
  theme_bw()

# Total abundance, split by transect
abun_transect <- ggplot(pollinators, aes(x = Dist_city, y = Total, shape=Transect, color = Transect)) +
  labs(x = "Distance to urban center (km)", y = "Average Pollinators Observed") +
  geom_point(aes(shape=Transect, color=Transect)) +
  scale_shape(solid = F)+
  geom_smooth(aes(color=Transect, linetype = Transect, fill = Transect), method = lm, alpha=0.15,  se = T) +
  labs(title = 'Pollinator Abundance Among Sub-transects', linetype="Transect", color="Transect", linetype = "Transect") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    ) +
  theme_bw()



# Average abundance per plant
abun_perplant <- ggplot(poll_pp, aes(x = Dist_city, y = Total)) +
  labs(x = "Distance to urban center (km)", y = "Average Pollinators Observed (per plant)") +
  geom_point() +
  scale_shape(solid = F)+
  geom_smooth(color="black", method = lm, alpha=0.15,  se = T) +
  labs(title = 'Pollinator Abundance Along Urban-Rural Gradient', subtitle = "per plant") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    ) +
  theme_bw()

# Average abundance per plant, split by transect
abun_perplant_transect <- ggplot(poll_pp, aes(x = Dist_city, y = Total, shape=Transect, color = Transect)) +
  labs(x = "Distance to urban center (km)", y = "Average Pollinators Observed (per plant)") +
  geom_point(aes(shape=Transect, color=Transect)) +
  scale_shape(solid = F)+
  geom_smooth(aes(color=Transect, linetype = Transect, fill = Transect), method = lm, alpha=0.15,  se = T) +
    labs(title = 'Pollinator Abundance Among Sub-transects', subtitle = "per plant", linetype="Transect", color="Transect", linetype = "Transect") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    ) +
  theme_bw()



library(cowplot)

# plot_grid(
#   plot_grid(
#     abun + theme(legend.position = "none")
#     , abun_transect + theme(legend.position = "none")
#     , abun_perplant+ theme(legend.position = "none")
#     , abun_perplant_transect + theme(legend.position = "none")
#     , ncol = 2
#     , align = "hv")
#   , plot_grid(
#     get_legend(abun_transect)
#     , ggplot()
#     , ncol =1)
#   , rel_widths = c(8,1)
#   )

```

##### Abundance of 4 most populous families
```{r}
#### wrapped regressions per family vs dist city ctr ####
ggplot(subset(diversity, Family %in% c('Apidae', 'Cantharidae', 'Halictidae', 'Megachilidae')), aes(x = Dist_city, y = Count, colour = Family)) +
  labs(x = "Distance to urban center (km)", y = "Individuals Observed by Family (per population)") +
  geom_point(aes( color = Family)) +
  scale_shape(solid = F)+
  geom_smooth(aes(color = Family), method = lm, alpha=0.15,  se = T) +
  labs() +
  facet_wrap(~Family) +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    ) +
  theme_bw()


####### regressions of each family's most common morphospecies vs dist city ctr #######
top_4ms <- dplyr::filter(diversity, Morphospecies_Code %in% c( 'MS_06', 'MS_14' , 'MS_02', 'MS_21')) 
ggplot(top_4ms, aes(x = Dist_city, y = Count, colour = Morphospecies)) +
  labs(x = "Distance to urban center (km)", y = "Individuals Observed") +
  geom_point(aes( color = Morphospecies)) +
  scale_shape(solid = F)+
  geom_smooth(aes(color = Morphospecies), method = lm, alpha=0.15,  se = T) +
  facet_grid(~Family + Morphospecies,
             labeller = label_context) +
  theme(legend.position = "none") 
  
  
  
###### Bombus abundance re: dist city ctr #######
  ggplot(subset(diversity, Genus %in% 'Bombus'), aes(x = Dist_city, y = Count)) +
  labs(x = "Distance to urban center (km)", y = "Bombus Individuals Observed (per population)") +
  geom_point() +
  scale_shape(solid = F)+
  geom_smooth( method = lm, alpha=0.15,  se = T) +
  labs()
  
# Only 3 data points, so not very interesting/reliable.
  

###### Monarch abundance re: dist city ctr #######
  ggplot(subset(diversity, Genus %in% 'Danaus'), aes(x = Dist_city, y = Count)) +
  labs(x = "Distance to urban center (km)", y = "Monarchs Observed (per population)") +
  geom_point() +
  scale_shape(solid = F)+
  geom_smooth( method = lm, alpha=0.15,  se = T) +
  labs()
  
# Only 4 data points, so not very interesting/reliable.
  
  
###### Honeybee abundance re: dist city ctr #######
  ggplot(subset(diversity, Morphospecies %in% 'Apis mellifera (Large)'), aes(x = Dist_city, y = Count)) +
  labs(x = "Distance to urban center (km)", y = "Honeybees Observed (per population)") +
  geom_point() +
  scale_shape(solid = F)+
  geom_smooth( method = lm, alpha=0.15,  se = T) +
  labs()
  
```

#### Diversity
##### Total diversity
```{r}
# Total morphospecies diversity
ggplot(poll_binary, aes(x = Dist_city, y = Total)) +
  labs(x = "Distance to urban center (km)", y = "Morphospecies Observed") +
  geom_point() +
  scale_shape(solid = F)+
  geom_smooth(color="black", method = lm, alpha=0.15,  se = T) +
  labs(title = 'Pollinator Morphospecies Present Along Urban-Rural Gradient') +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    ) +
  theme_bw()

 
 
div_sum_melted <- reshape2::melt(div_sum, id.vars= c("Patch_ID", "Transect", "Dist_city"), measure.vars = c('orders', 'superfams', 'families', 'subfams', 'genera', 'mspecies', 'total_indivs', 'Menhinicks_index', 'shannon', 'simpson', 'shannon_equit', 'simpson_equit'))

######################## BY TRANSECT ############################


# Total morphospecies diversity, split by transect
ggplot(poll_binary, aes(x = Dist_city, y = Total, shape=Transect, color = Transect)) +
  labs(x = "Distance to urban center (km)", y = "Morphospecies Observed (per population)") +
  geom_point(aes(shape=Transect, color=Transect)) +
  scale_shape(solid = F)+
  geom_smooth(aes(color=Transect, linetype = Transect), method = lm, alpha=0.15,  se = T) +
  labs(linetype="Transect", color="Transect", linetype = "Transect") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    )  +
  theme_bw()



# Orders per transect
ord_trsct <- ggplot(div_sum, aes(x = Dist_city, y = orders, shape = Transect, colour = Transect)) +
  labs(x = "Distance to urban center (km)", y = "Orders") +
  geom_point(aes(shape = Transect, color = Transect)) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape = Transect, color = Transect), method = lm, alpha=0.15,  se = T) +
  labs() +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    ) +
  theme_bw()



# Superfamilies per transect
supfam_trsct <- ggplot(div_sum, aes(x = Dist_city, y = superfams, shape = Transect, colour = Transect)) +
  labs(x = "Distance to urban center (km)", y = "Superfamilies") +
  geom_point(aes(shape = Transect, color = Transect)) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape = Transect, color = Transect), method = lm, alpha=0.15,  se = T) +
  labs() +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    ) +
  theme_bw()

# Morphospecies per transect
mspecies_trsct <- ggplot(div_sum, aes(x = Dist_city, y = mspecies, shape = Transect, colour = Transect)) +
  labs(x = "Distance to urban center (km)", y = "Morphospecies") +
  geom_point(aes(shape = Transect, color = Transect)) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape = Transect, color = Transect), method = lm, alpha=0.15,  se = T) +
  labs() +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    ) +
  theme_bw()

# 
# plot_grid(
#   plot_grid(
#     ord_trsct + theme(legend.position = "none")
#     , supfam_trsct + theme(legend.position = "none")
#     , fams_trsct+ theme(legend.position = "none")
#     , subfams_trsct + theme(legend.position = "none")
#     , mspecies_trsct+ theme(legend.position = "none")
#     , ncol = 2
#     , align = "hv")
#   , plot_grid(
#     get_legend(ord_trsct)
#     , ggplot()
#     , ncol =1)
#   , rel_widths = c(8,1)
#   )
# 

```

##### Diversity, Richness, and Evenness indices
###### Diversity
```{r}
# Major gradient, with cleaned up labels
ggplot(subset(div_sum_melted, variable %in% c( 'shannon', 'simpson')), aes(x = Dist_city, y = value, shape = variable, color = variable)) +
    scale_shape_discrete(name  ="Diversity Index",
                           labels=c("Shannon", "Simpson")) +
    scale_colour_discrete(name  ="Diversity Index",
                            labels=c("Shannon", "Simpson")) +
  scale_linetype_discrete(name  ="Diversity Index",
                            labels=c("Shannon", "Simpson")) +
  labs(x = "Distance to urban center (km)", y = "Diversity") +
  geom_point() +
  geom_smooth(aes(linetype = variable), method = lm, alpha=0.15,  se = T) +
  labs(title = "Shannon's and Simpson's Diversity Indices") +
  theme_bw()

# Major gradient, with cleaned up labels, JUST Simpson
ggplot(div_sum_melted, aes(x = Dist_city, y = value)) +
  labs(x = "Distance to urban center (km)", y = "Diversity Index") +
  geom_point(data=div_sum_melted[div_sum_melted$variable== 'simpson', ]) +
  geom_smooth(data=div_sum_melted[div_sum_melted$variable== 'simpson', ], color = "black", method = lm, alpha=0.15,  se = T) +
  labs(title = "Simpson's Diversity Index") +
  theme_bw()


var.labs <- c("Shannon's Diversity", "Simpson's Diversity")
names(var.labs) <- c("shannon", "simpson")

# Split into transects
div_fig2 <- ggplot(subset(div_sum_melted, variable %in% c( 'shannon', 'simpson')), aes(x = Dist_city, y = value, shape = Transect, color = Transect)) +
  labs(x = "Distance to urban center (km)", y = "Diversity") +
  geom_point() +
  scale_shape(solid = F)+
  geom_smooth(aes(fill = Transect), method = lm, alpha=0.15,  se = T) +
  labs(title = "Shannon's and Simpson's Diversity Indices by Transect") +
  facet_grid(~variable, labeller = labeller(variable = var.labs))

## Just Simpson's
ggplot(div_sum_melted, aes(x = Dist_city, y = value, shape = Transect, color = Transect)) +
  labs(x = "Distance to urban center (km)", y = "Diversity Index") +
    scale_shape(solid = F)+
  geom_point(data=div_sum_melted[div_sum_melted$variable== 'simpson', ]) +
  geom_smooth(data=div_sum_melted[div_sum_melted$variable== 'simpson', ], aes(fill = Transect), method = lm, alpha=0.15,  se = T) +
  labs(title = "Simpson's Diversity Index by Transect")


```


###### Richness
```{r}
# Major gradient
rich_fig1 <- ggplot(subset(div_sum_melted, variable %in% c('Menhinicks_index')), aes(x = Dist_city, y = value), shape = 1, color = "black") +
  labs(x = "Distance to urban center (km)", y = "Species Richness") +
  geom_point(show.legend = FALSE) +
  scale_shape(solid = F)+
  geom_smooth(color = "black", method = lm, alpha=0.15,  se = T, show.legend = FALSE) +
  labs(title = "Menhinick's Species Richness") 


# Split into transects
rich_fig2 <- ggplot(subset(div_sum_melted, variable %in% c('Menhinicks_index')), aes(x = Dist_city, y = value, shape = Transect, color = Transect)) +
  labs(x = "Distance to urban center (km)", y = "Species Richness") +
  geom_point() +
  scale_shape(solid = F)+
  geom_smooth(aes( fill = Transect), method = lm, alpha=0.15,  se = T) +
  labs(title = "Menhinick's Species Richness by Transect") 

```

###### Evenness
```{r}
# Major gradient
even_fig1 <- ggplot(subset(div_sum_melted, variable %in% c( 'shannon_equit', 'simpson_equit')), aes(x = Dist_city, y = value, shape = variable, color = variable)) +
  labs(x = "Distance to urban center (km)", y = "Equitability") +
  geom_point() +
  scale_shape(solid = F)+
  geom_smooth( method = lm, alpha=0.15,  se = T) +
  labs(title = "Shannon's and Simpson's Equitabilities")


# Split into transects
even_fig2 <- ggplot(subset(div_sum_melted, variable %in% c( 'shannon_equit', 'simpson_equit')), aes(x = Dist_city, y = value, shape = Transect, color = Transect)) +
  labs(x = "Distance to urban center (km)", y = "Equitability") +
  geom_point() +
  scale_shape(solid = F)+
  geom_smooth(aes(fill = Transect), method = lm, alpha=0.15,  se = T) +
  labs(title = "Shannon's and Simpson's Equitabilities by Transect") +
  facet_grid(~variable)



```

###### Plot all
```{r}

library(cowplot)

# Total
plot_grid(
  plot_grid(
    div_fig1 + theme(legend.position = "none")
    , even_fig1 + theme(legend.position = "none")
    , rich_fig1 
    , ncol = 1
    , align = "hv")
  , plot_grid(
    get_legend(div_fig1)
    , ggplot()
    , ncol =1)
  , rel_widths = c(7,3)
  )

# By transect
plot_grid(
  plot_grid(
    div_fig2 + theme(legend.position = "none")
    , even_fig2 + theme(legend.position = "none")
    , rich_fig2 + theme(legend.position = "none")
    , ncol = 1
    , align = "h")
  , plot_grid(
    get_legend(even_fig2)
    , ggplot()
    , ncol =1)
  , rel_widths = c(9,1)
  )
```


##### Diversity: by Order
```{r}
# ORDER
ggplot(data=diversity, aes(x=Dist_city, group=Order, fill=Order)) +
    geom_density(adjust=1.5, alpha=.4) 

ggplot(data=diversity, aes(x=Dist_city, group=Order, fill=Order)) +
    geom_density(adjust=1.5) +
    facet_wrap(~Order) +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      axis.ticks.x=element_blank())

ggplot(data=diversity, aes(x=Dist_city, group=Order, fill=Order)) +
    geom_density(adjust=1.5, alpha=.4) +
    facet_wrap(~Transect) +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      axis.ticks.x=element_blank())

#install.packages('ggridges')
library(ggridges)
library(ggplot2)
ggplot(diversity, aes(x = Dist_city, y = Order, fill = Order)) +
  geom_density_ridges(alpha=0.6, stat="binline", bins=30) +
  theme_ridges() + 
  theme(legend.position = "none")

ggplot(diversity, aes(x = Dist_city, y = Order, fill = Order)) +
  geom_density_ridges(alpha=0.6) +
  theme_ridges() + 
  theme(legend.position = "none")

ggplot(diversity, aes(x = Dist_city, y = Count, shape = Order, colour = Order)) +
  labs(x = "Distance to urban center (km)", y = "Morphospecies Observed (per population)") +
  geom_point(aes(shape = Order, color = Order)) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape = Order, color = Order), method = lm, alpha=0.15,  se = T) +
  labs() +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    ) 


ggplot(diversity, aes(x = Dist_city, y = Count, shape = Order, colour = Order)) +
  labs(x = "Distance to urban center (km)", y = "Morphospecies Observed (per population)") +
  geom_point(aes(shape = Order, color = Order)) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape = Order, color = Order), method = loess, alpha=0.15,  se = T) +
  labs() +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    ) 

ggplot(data=diversity, aes(x=Order, y=Count)) +
  geom_bar(aes(fill=Order),stat = "identity")+
  theme_bw()

ggplot(sum1, aes(x=Transect, y=Count, fill=Order)) +
  geom_bar(aes(fill=factor(Order)),stat = "identity", position="dodge") +
  geom_errorbar(aes(ymax = Count + se, ymin = Count - se), position = position_dodge(width = 0.9), width = 0.25) +
  scale_fill_grey(start = 0.8, end = 0.5) +
  theme_bw() +
    labs(title = "Total Pollinator Order Abundance by Transect",
       caption = "Error bars represent standard error")




## using SummarySE
library(Rmisc)
sum1 <- summarySE(diversity, measurevar="Count", groupvars= c("Order", "Transect"), na.rm = T)

ggplot(sum1, aes(x=Transect, y=Count, color = Order, shape=Order)) +
  geom_pointrange(aes(ymin=Count-se, ymax=Count+se), size = 1, position = position_jitterdodge(dodge.width = .5)) +
  geom_smooth(method=lm, se=F, fullrange = T, size = 0.5) +
    scale_color_grey(start = 0.8, end = 0.5) +
  # scale_color_manual(values=c("gray64", "black", 'grey')) +
  theme_bw() +
  labs(title = "Total Pollinator Order Abundance by Transect",
       caption = "Error bars represent standard error")



```

##### Diversity: by Superfamily
```{r}
# SUPERFAMILY
ggplot(data=diversity, aes(x=Dist_city, group=Superfamily, fill=Superfamily)) +
    geom_density(adjust=1.5, alpha=.4) 

ggplot(data=diversity, aes(x=Dist_city, group=Superfamily, fill=Superfamily)) +
    geom_density(adjust=1.5) +
    facet_wrap(~Superfamily) +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      axis.ticks.x=element_blank())

ggplot(diversity, aes(x = Dist_city, y = Count, shape = Superfamily, colour = Superfamily)) +
  labs(x = "Distance to urban center (km)", y = "Morphospecies Observed (per population)") +
  geom_point(aes(shape = Superfamily, color = Superfamily)) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape = Superfamily, color = Superfamily), method = lm, alpha=0.15,  se = T) +
  labs() +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    )

ggplot(data=diversity, aes(x=Superfamily, y=Count)) +
  geom_bar(aes(fill=Superfamily),stat = "identity")+
  theme_bw()




## using SummarySE
library(Rmisc)
sum2 <- summarySE(diversity, measurevar="Count", groupvars= c("Superfamily", "Transect"), na.rm = T)

ggplot(sum2, aes(x=Transect, y=Count, color = Superfamily, shape=Superfamily)) +
  geom_pointrange(aes(ymin=Count-se, ymax=Count+se), size = 1, position = position_jitterdodge(dodge.width = .5)) +
  geom_smooth(method=lm, se=F, fullrange = T, size = 0.5) +
  # scale_color_manual(values=c("gray64", "black", 'grey')) +
  theme_bw() +
  labs(title = "Total Pollinator Superfamily Abundance by Transect",
       caption = "Error bars represent standard error")



```

##### Diversity: by Family
```{r}
# FAMILY
ggplot(data=diversity, aes(x=Dist_city, group=Family, fill=Family)) +
    geom_density(adjust=1.5, alpha=.4) 

ggplot(data=diversity, aes(x=Dist_city, group=Family, fill=Family)) +
    geom_density(adjust=1.5) +
    facet_wrap(~Family) +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      axis.ticks.x=element_blank()
    )

ggplot(diversity, aes(x = Dist_city, y = Count, shape = Family, colour = Family)) +
  labs(x = "Distance to urban center (km)", y = "Morphospecies Observed (per population)") +
  geom_point(aes(shape = Family, color = Family)) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape = Family, color = Family), method = lm, alpha=0.15,  se = T) +
  labs() +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=18),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) 
    )


ggplot(data=diversity, aes(x=Family, y=Count)) +
  geom_bar(aes(fill=Family),stat = "identity")+
  theme_bw() +
  labs(title = "Total Individuals Observed per Family")




# Sankey diagram

sank1 <- diversity[,c(6,8,9,11:13)]
sank1[sank1=="Unidentified"]<- "Unknown"
sank1 <- sank1 %>% ddply( .(Transect, Order, Family, Genus), summarise, sum_counts = sum(Count))

# install.packages("wesanderson")
# library(wesanderson)
# install.packages("flipPlots")
# install_github("Displayr/flipPlots")
# install.packages("RColorBrewer")
library("RColorBrewer")
library(flipPlots)
SankeyDiagram(sank1[, -5],
              link.color = "Target",
              variables.share.values = T,
              label.show.varname = F,
              label.show.counts = T,
              weights = sank1$Count,
              font.size = 20,
              colors =  topo.colors(25),
              # colors =  terrain.colors(25),
              # colors =  grey.colors(25),
              sinks.right = F,
              max.categories = 12,
              hovertext.show.percentages = T) 
# it helps to move around the nodes to make them flow more simply


## using SummarySE
library(Rmisc)
sum3 <- summarySE(diversity, measurevar="Count", groupvars= c("Family", "Transect"), na.rm = T)

ggplot(sum3, aes(x=Transect, y=Count, color = Family, shape=Family)) +
  geom_pointrange(aes(ymin=Count-se, ymax=Count+se), size = 1, position = position_jitterdodge(dodge.width = .5)) +
  geom_smooth(method=lm, se=F, fullrange = T, size = 0.5) +
  # scale_color_manual(values=c("gray64", "black", 'grey')) +
  theme_bw() +
  labs(title = "Total Pollinator Family Abundance by Transect",
       caption = "Error bars represent standard error")




```

#### Composite figure
```{r}
# TOTAL ABUNDANCE
abun_all <- ggplot(div_sum, aes(x = Dist_city, y = total_indivs^(1/2))) +
  labs(   # x = "Distance to urban center (km)",
    y = expression(Pollinators~Observed^{0.5})) +
  geom_point(size=2) +
  scale_shape(solid = F)+
  geom_smooth(color = "black", size=0.75, method = lm, alpha=0.15, se = T) +
  # scale_y_continuous(limits=c(0,200)) +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
abun_all


# urban transects- abundance
abun_transects <- ggplot(div_sum_urban, aes(x = Dist_city, y = total_indivs, shape=Transect, color = Transect)) + 
  labs(   # x = "Distance to urban center (km)", 
    y = "Pollinators Observed") +
  geom_point(aes(shape=Transect, color=Transect),  size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(shape=Transect, color=Transect, linetype = Transect, fill = Transect), size=0.75, method = lm, alpha=.15, se = T) +
  # scale_y_continuous(breaks=c(0,1,2,3), limits=c(0,3)) +
  labs(linetype="Transect", color="Transect", shape="Transect") +
  theme(legend.position = "none",
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) ) 
abun_transects


# Simpson's Diversity
simp_all <- ggplot(div_sum, aes(x = Dist_city, y = log(1-simpson))) +
  labs(   # x = "Distance to urban center (km)", 
    y = "log(1-Simpson's Index)") +
  geom_point(size=2) +
  scale_shape(solid = F)+
  geom_smooth(color = "black", size=0.75, method = lm, alpha=0.15, se = T) +
  # scale_y_continuous(limits=c(0,200)) +
  theme(legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.box = 'horizontal',
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) )
simp_all


# Simpson's Diversity- urban subtransects
simp_transects <- ggplot(div_sum_urban, aes(x = Dist_city, y = log(1-simpson), shape=Transect, color = Transect)) + 
  labs(   # x = "Distance to urban center (km)", 
    y = "log(1-Simpson's Index)") +
  geom_point(aes(shape=Transect, color=Transect),  size=2) +
  # scale_shape(solid = F)+
  geom_smooth(aes(color=Transect, linetype = Transect, fill = Transect), size=0.75, method = lm, alpha=.15, se = T) +
  # scale_y_continuous(breaks=c(0,1,2,3), limits=c(0,3)) +
  # labs(linetype="Transect", color="Transect", shape="Transect") +
  theme(legend.position = "bottom",
    legend.justification = c("center", "top"),
    legend.box = 'horizontal',
    legend.box.just = "center",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    legend.text=element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) ) +
   scale_color_manual(values = c('#F8766D', '#00BFC4'),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Subtransect") +
   scale_shape_manual(values = c(1,2),
                      breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Subtransect") +
   scale_linetype_manual(values = c("solid", "dashed"),
                      breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Subtransect") +
   scale_fill_manual(values = c('#F8766D', '#00BFC4'),
                      breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Subtransect")
  
simp_transects


library(ggpubr)
Q2_regressions <- ggarrange(abun_all,  abun_transects, simp_all, simp_transects, ncol = 2, nrow = 2, align = "v", labels = list("A", "B", "C", "D"), font.label = (size =16), common.legend = FALSE)
Q2_regressions

annotate_figure(Q2_regressions, bottom = text_grob("Distance to Urban Center (km)", size=14))

dev.copy2pdf(file="~/R_Projects/Chapter1/Figures_Tables/Pollinator_regressions.pdf", width = 10, height = 7)
```
### Statistical Analysis
#### Linear Models
##### Abundance
####### Without transects- SQUARE ROOT TRANSFORMATION
```{r}

# Linear model 1

lm1 <- lm(total_indivs ~ Dist_city, data = div_sum )

par(mfrow=c(2,2))
plot(lm1)
plot(total_indivs ~ Dist_city, div_sum)
lm1_sum <- summary(lm1)

lm1_sum$coefficients[1,1] # this is the intercept (or, in y=mx + b, it's the b)
lm1_sum$coefficients[2,1] # this is the slope (or, in y=mx + b, it's the m)
lm1_sum$coefficients[2,4] # p-value
lm1_sum$fstatistic[1] # F statistic
lm1_sum$r.squared # R-squared value
nobs(lm1_sum) # number of observations



######### Diagnostics ##########
lm1_df <- div_sum[,c(1:3,10)]
lm1_df$predicted <- predict(lm1)   # Save the predicted values
lm1_df$residuals <- residuals(lm1) # Save the residual values

ggplot(lm1_df, aes(x = Dist_city, y = total_indivs)) +
  geom_smooth(method = "lm", se = FALSE, color = "lightgrey") +
  geom_segment(aes(xend = Dist_city, yend = predicted), alpha = .2) +
  geom_point(aes(color = abs(residuals), size = abs(residuals))) + # size also mapped
  scale_color_continuous(low = "black", high = "red") +
  guides(color = FALSE, size = FALSE) +  # Size legend also removed
  geom_point(aes(y = predicted), shape = 1) +
  theme_bw()

# residuals vs predicted values look ok... some potential outliers

## Histogram
gg_reshist(lm1, bins=20)


diagnostic<-function(x){
  plot(x)
  abline(mean(x),0)
  hist(x)
  qqnorm(x)
  qqline(x,lty=2, col="Red")
  skewness(x)
  kurtosis(x)
  print(paste("Kurtosis=", kurtosis(x), sep=""))
  print(paste("Skew=", skewness(x), sep=""))}

diagnostic(lm1$residuals)
# right-skewed

# get t-value
lm1_tval <- skewness(lm1_df$residuals)/sqrt(6/length(lm1_df$residuals))

# What's the chance of getting a t-value of 0.304 by chance alone, when the skew value really is zero?
1-pt(lm1_tval,length(lm1_df$residuals))

# 0.001 is way less than 0.05, so it looks like the data is NOT normal.
# Conclusion: look into transformation or alternative models. Try square root transformation first.

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Option 1: square root transformation

lm1_df$sqrt <- sqrt(lm1_df$total_indivs)

lm1_sqrt <- lm(sqrt ~ Dist_city, data = lm1_df)

lm1_df$predicted_sqrt <- predict(lm1_sqrt)   # Save the predicted values
lm1_df$residuals_sqrt <- residuals(lm1_sqrt) # Save the residual values

ggplot(lm1_df, aes(x = Dist_city, y = sqrt)) +
  geom_smooth(method = "lm", se = FALSE, color = "lightgrey") +
  geom_segment(aes(xend = Dist_city, yend = predicted_sqrt), alpha = .2) +
  geom_point(aes(color = abs(residuals_sqrt), size = abs(residuals_sqrt))) + # size also mapped
  scale_color_continuous(low = "black", high = "red") +
  guides(color = FALSE, size = FALSE) +  # Size legend also removed
  geom_point(aes(y = predicted_sqrt), shape = 1) +
  theme_bw()

# residuals vs predicted values look more balanced than first diagnostics

diagnostic(lm1_df$residuals_sqrt)
plot(lm1_sqrt)

# get t-value
lm1_sqrt_tval <- skewness(lm1_df$residuals_sqrt)/sqrt(6/length(lm1_df$residuals_sqrt))

# What's the chance of getting a t-value of -1.097 by chance alone, when the skew value really is zero?
1-pt(lm1_sqrt_tval,length(lm1_df$residuals_sqrt))

# 0.1 is higher than 0.05 and it looks a lot better now.
# Conclusion: Stick with the square root transformation.

# Linear model 2: sq rt

par(mfrow=c(2,2))
plot(lm1_sqrt)
lm1_sqrt_sum <- summary(lm1_sqrt)

lm1_sqrt_sum$coefficients[1,1] # this is the intercept (or, in y=mx + b, it's the b)
lm1_sqrt_sum$coefficients[2,1] # this is the slope (or, in y=mx + b, it's the m)
lm1_sqrt_sum$coefficients[2,4] # p-value
lm1_sqrt_sum$fstatistic[1] # F statistic
lm1_sqrt_sum$r.squared # R-squared value
nobs(lm1_sqrt_sum) # number of observations
gg_reshist(lm1_sqrt, bins=20)

```


####### With transects- NO TRANSFORMATION
```{r}

# ## USE URBAN SUBSET
div_sum_urban <- div_sum %>% filter(Transect != 'Rural')


lm1 <- lm(total_indivs ~ Dist_city * Transect, data = div_sum_urban )

par(mfrow=c(2,2))
plot(lm1)
plot(total_indivs ~ Dist_city, div_sum_urban)
lm1_sum <- summary(lm1)

## Histogram
gg_reshist(lm1, bins=20)


diagnostic<-function(x){
  plot(x)
  abline(mean(x),0)
  hist(x)
  qqnorm(x)
  qqline(x,lty=2, col="Red")
  skewness(x)
  kurtosis(x)
  print(paste("Kurtosis=", kurtosis(x), sep=""))
  print(paste("Skew=", skewness(x), sep=""))}

diagnostic(lm1$residuals)
# right-skewed

# I think it looks normal enough, especially because it's not a huge sample size (n = 31 pops)
```


##### Diversity
###### Shannon Diversity
####### Without transects- NO TRANSFORMATION NEEDED
```{r}

# Linear model 2: Shannon's Diversity Index

lm2 <- lm(shannon ~ Dist_city, data = div_sum )

par(mfrow=c(2,2))
plot(lm2)
lm2_sum <- summary(lm2)

# lm2_sum$coefficients[1,1] # this is the intercept (or, in y=mx + b, it's the b)
# lm2_sum$coefficients[2,1] # this is the slope (or, in y=mx + b, it's the m)
# lm2_sum$coefficients[2,4] # p-value
# lm2_sum$fstatistic[1] # F statistic
# lm2_sum$r.squared # R-squared value
# nobs(lm2_sum) # number of observations
# 
# 
# 
# ######### Diagnostics ##########
# lm2_df <- div_sum[,c(1:3,12)]
# lm2_df$predicted <- predict(lm2)   # Save the predicted values
# lm2_df$residuals <- residuals(lm2) # Save the residual values
# 
# ggplot(lm2_df, aes(x = Dist_city, y = shannon)) +
#   geom_smooth(method = "lm", se = FALSE, color = "lightgrey") +
#   geom_segment(aes(xend = Dist_city, yend = predicted), alpha = .2) +
#   geom_point(aes(color = abs(residuals), size = abs(residuals))) + # size also mapped
#   scale_color_continuous(low = "black", high = "red") +
#   guides(color = FALSE, size = FALSE) +  # Size legend also removed
#   geom_point(aes(y = predicted), shape = 1) +
#   theme_bw()

# residuals vs predicted values look ok... somewhat balanced

## Histogram
gg_reshist(lm2, bins=20)
# gg_reshist(lm(shannon^(1/2) ~ Dist_city, data = div_sum ), bins=20 ) + labs(title = "Histogram of Sqrt(residuals)")
# gg_reshist(lm(log(shannon + 1) ~ Dist_city, data = div_sum ), bins=20)+ labs(title = "Histogram of log(residuals)")

diagnostic(lm2$residuals)
# very high kurtosis

# get t-value
lm2_tval <- skewness(lm2_df$residuals)/sqrt(6/length(lm2_df$residuals))

# What's the chance of getting a t-value of -0.1801351 by chance alone, when the skew value really is zero?
1-pt(lm2_tval,length(lm2_df$residuals))

# 0.57 is way higher than 0.05, so it looks like the data is somewhat normal.
# Conclusion: It's fine.


```

####### With transects- SQUARE ROOT TRANSFORMATION
```{r}

lm2 <- lm(shannon ~ Dist_city * Transect, data = div_sum_urban )

par(mfrow=c(2,2))
plot(lm2)
lm2_sum <- summary(lm2)

## Histogram
gg_reshist(lm2, bins=20)

diagnostic(lm2$residuals)
# seems fine

# May be left-skewed... try a transformation
par(mfrow=c(2,2))
plot(lm(shannon^(2) ~ Dist_city * Transect, data = div_sum_urban ))
# Looks much better!


# Conclusion: Go with squaring transformation.


```

###### Simpson Diversity
####### Without transects- log(1-x) TRANSFORMATION
```{r}

# Linear model 3: Simpson's Diversity Index

lm3 <- lm(simpson.y ~ Dist_city, data = div_sum )

par(mfrow=c(2,2))
plot(lm3)
lm3_sum <- summary(lm3)

## Histogram
gg_reshist(lm3, bins=20)

diagnostic(lm3$residuals)
# some left skew

# get t-value
lm3_tval <- skewness(lm3_df$residuals)/sqrt(6/length(lm3_df$residuals))
lm3_tval

# What's the chance of getting a t-value of -3.312497 by chance alone, when the skew value really is zero?
1-pt(lm3_tval,length(lm3_df$residuals))

# 0.999 is way higher than 0.05, but the data doesn't look normal.

# Conclusion: Try a transformation: 
gg_reshist(lm(simpson.y ~ Dist_city, data = div_sum ), bins=30 ) 
gg_reshist(lm(simpson.y^(3) ~ Dist_city, data = div_sum ), bins=10 )
gg_reshist(lm(log(1-simpson.y) ~ Dist_city, data = div_sum ), bins=10) # going to try this first.


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Option 1: log(1-simpson) transformation

lm3_df$log_inv <- log(1-lm3_df$simpson)

lm3_log_inv <- lm(log_inv ~ Dist_city, data = lm3_df)

lm3_df$predicted_log_inv <- predict(lm3_log_inv)   # Save the predicted values
lm3_df$residuals_log_inv <- residuals(lm3_log_inv) # Save the residual values

ggplot(lm3_df, aes(x = Dist_city, y = log_inv)) +
  geom_smooth(method = "lm", se = FALSE, color = "lightgrey") +
  geom_segment(aes(xend = Dist_city, yend = predicted_log_inv), alpha = .2) +
  geom_point(aes(color = abs(residuals_log_inv), size = abs(residuals_log_inv))) + # size also mapped
  scale_color_continuous(low = "black", high = "red") +
  guides(color = FALSE, size = FALSE) +  # Size legend also removed
  geom_point(aes(y = predicted_log_inv), shape = 1) +
  theme_bw()

# residuals vs predicted values look more balanced than first diagnostics

diagnostic(lm3_df$residuals_log_inv)

# get t-value
lm3_log_inv_tval <- skewness(lm3_df$residuals_log_inv)/sqrt(6/length(lm3_df$residuals_log_inv))

# What's the chance of getting a t-value of 1.304685 by chance alone, when the skew value really is zero?
1-pt(lm3_log_inv_tval,length(lm3_df$residuals_log_inv))

# 0.106 is higher than 0.05 and it looks a lot better now.
# Conclusion: Stick with the log(constant - simpson) transformation.

```


####### With transects- log(1-x) TRANSFORMATION
```{r}



# Linear model 3: Simpson's Diversity Index

lm3 <- lm(simpson ~ Dist_city * Transect, data = div_sum_urban )

par(mfrow=c(2,2))
plot(lm3)
lm3_sum <- summary(lm3)

## Histogram
gg_reshist(lm3, bins=20)

diagnostic(lm3$residuals)
# extreme left skew!

# Conclusion: Try a transformation: 
gg_reshist(lm(simpson ~ Dist_city* Transect, data = div_sum_urban ), bins=30 ) 
gg_reshist(lm(simpson^(3) ~ Dist_city* Transect, data = div_sum_urban ), bins=10 )
gg_reshist(lm(log(1-simpson) ~ Dist_city* Transect, data = div_sum_urban ), bins=10) # going to try this first.


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Option 1: log(1-simpson) transformation

lm3_df$log_inv <- log(1-lm3_df$simpson)

lm3_log_inv <- lm(log_inv ~ Dist_city, data = lm3_df)

lm3_df$predicted_log_inv <- predict(lm3_log_inv)   # Save the predicted values
lm3_df$residuals_log_inv <- residuals(lm3_log_inv) # Save the residual values

ggplot(lm3_df, aes(x = Dist_city, y = log_inv)) +
  geom_smooth(method = "lm", se = FALSE, color = "lightgrey") +
  geom_segment(aes(xend = Dist_city, yend = predicted_log_inv), alpha = .2) +
  geom_point(aes(color = abs(residuals_log_inv), size = abs(residuals_log_inv))) + # size also mapped
  scale_color_continuous(low = "black", high = "red") +
  guides(color = FALSE, size = FALSE) +  # Size legend also removed
  geom_point(aes(y = predicted_log_inv), shape = 1) +
  theme_bw()

# residuals vs predicted values look more balanced than first diagnostics

diagnostic(lm3_df$residuals_log_inv)

# Conclusion: Looks much better! Stick with the log(constant - simpson) transformation.

```
###### Simpson Diversity- without honeybees
####### Without transects- SQUARE TRANSFORMATION
```{r}

# Linear model 3: Simpson's Diversity Index

lm3 <- lm(simpson ~ Dist_city, data = div_sum_no_honey )

par(mfrow=c(2,2))
plot(lm3)
lm3_sum <- summary(lm3)

## Histogram
gg_reshist(lm3, bins=10)

diagnostic(lm3$residuals)
# some left skew

# The data doesn't look normal.

# Conclusion: Try a transformation: 
gg_reshist(lm(simpson ~ Dist_city, data = div_sum_no_honey ), bins=10 )
gg_reshist(lm(simpson^(2) ~ Dist_city, data = div_sum_no_honey ), bins=10 )
gg_reshist(lm(simpson^(3) ~ Dist_city, data = div_sum_no_honey ), bins=10 )

par(mfrow=c(2,2))
plot(lm(simpson^(2) ~ Dist_city, data = div_sum_no_honey ))
# Looks MUCH better. With only 48 observations, it's a small dataset too.

# Conclusion: use square transformation.

div_sum_no_honey$simpson_sq <- div_sum_no_honey$simpson^2

```


####### With transects- CUBE TRANSFORMATION
```{r}
# ## USE URBAN SUBSET
div_sum_urban_no_honey <- div_sum_no_honey %>% filter(Transect != 'Rural')


# Linear model 3: Simpson's Diversity Index

lm3 <- lm(simpson ~ Dist_city * Transect, data = div_sum_urban_no_honey )

par(mfrow=c(2,2))
plot(lm3)
lm3_sum <- summary(lm3)

## Histogram
gg_reshist(lm3, bins=10)

diagnostic(lm3$residuals)
# extreme left skew!

# Conclusion: Try a transformation: 
gg_reshist(lm(simpson ~ Dist_city* Transect, data = div_sum_urban_no_honey ), bins=10 )
gg_reshist(lm(simpson^(2) ~ Dist_city* Transect, data = div_sum_urban_no_honey ), bins=10 )
gg_reshist(lm(simpson^(3) ~ Dist_city* Transect, data = div_sum_urban_no_honey ), bins=10 )
# cube transformation looks very good, especially since this is a small dataset again (31 entries)

par(mfrow=c(2,2))
plot(lm(simpson^(3) ~ Dist_city* Transect, data = div_sum_urban_no_honey ))

# Conclusion: Stick with the cube transformation.

div_sum_urban_no_honey$simpson_cube <- div_sum_urban_no_honey$simpson^3

```
###### Species Richness
####### Without transects- NO TRANSFORMATION NEEDED
```{r}
lm3 <- lm(Menhinicks_index ~ Dist_city, data = div_sum )

par(mfrow=c(2,2))
plot(lm3)
lm3_sum <- summary(lm3)

## Histogram
gg_reshist(lm3, bins=20)

diagnostic(lm3$residuals)
# Very normal!



# Conclusion: No transformation needed.
```
####### With transects- NO TRANSFORMATION NEEDED
```{r}

lm3 <- lm(Menhinicks_index ~ Dist_city * Transect, data = div_sum_urban )

par(mfrow=c(2,2))
plot(lm3)
lm3_sum <- summary(lm3)

## Histogram
gg_reshist(lm3, bins=20)

diagnostic(lm3$residuals)
# SLIGHT left skew

# Conclusion: Try a transformation: 
gg_reshist(lm(Menhinicks_index ~ Dist_city* Transect, data = div_sum_urban ), bins=10 ) 
gg_reshist(lm(Menhinicks_index^(2) ~ Dist_city* Transect, data = div_sum_urban ), bins=10 )

par(mfrow=c(2,2))
plot(lm(Menhinicks_index^2 ~ Dist_city * Transect, data = div_sum_urban ))

# Squaring makes it look a tiny bit better but I think keeping it normal is fine.
```
###### Equitability (Evenness)
####### Without transects- NO TRANSFORMATION NEEDED
```{r}
lm3 <- lm(shannon_equit ~ Dist_city, data = div_sum )

par(mfrow=c(2,2))
plot(lm3)
lm3_sum <- summary(lm3)

## Histogram
gg_reshist(lm3, bins=20)

diagnostic(lm3$residuals)
# Looks pretty normal

# Conclusion: No transformation needed.
```
####### With transects- SQUARING TRANSFORMATION 
```{r}

lm3 <- lm(shannon_equit ~ Dist_city * Transect, data = div_sum_urban )

par(mfrow=c(2,2))
plot(lm3)
lm3_sum <- summary(lm3)

## Histogram
gg_reshist(lm3, bins=20)

diagnostic(lm3$residuals)
# left skew

# Conclusion: Try a transformation: 
gg_reshist(lm(shannon_equit ~ Dist_city* Transect, data = div_sum_urban ), bins=10 ) 
gg_reshist(lm(shannon_equit^(2) ~ Dist_city* Transect, data = div_sum_urban ), bins=10 )

par(mfrow=c(2,2))
plot(lm(Menhinicks_index^2 ~ Dist_city * Transect, data = div_sum_urban ))

# Squaring makes it look much better.
```

#### ANOVA
##### Export to one csv- lm/glm
```{r}

# Start a sink file with a CSV extension
sink('pollinators_ANOVA.csv')

#### Abundance ####
## table 1
cat('Abundance- Q1')
cat('\n')
cat('P ~ dist_city')
cat('\n')
cat('Main Effect')
write.csv(ab.q1)
cat('\n')

## table 2
cat('Abundance- Q3')
cat('\n')
cat('P ~ dist_city + Transect_ID')
cat('\n')
cat('Main Effect')
write.csv(ab.q2)
cat('\n')
cat('\n')

#### Diversity ####
## table 1
cat('Simpsons Diversity- Q1')
cat('\n')
cat('p ~ City_dist')
cat('\n')
cat('Main Effect')
write.csv(di.q1)
cat('\n')

## table 2
cat('Simpsons Diversity- Q3')
cat('\n')
cat('P ~ City_dist + Transect')
cat('\n')
cat('Main Effect')
write.csv(di.q2)
cat('\n')
cat('\n')

##### Close the sink ####
sink()

```

##### Abundance
###### **Poisson-distributed glm data
####### All data
```{r}
# Total individuals ~ dist city ctr 
summary(glm(total_indivs ~ Dist_city, data = div_sum , family = "poisson"))
ab.q1 <- car::Anova(glm(total_indivs ~ Dist_city , data = div_sum, family = "poisson" ))
# Dist_city is sig


# pairs(lsmeans(abun_m1, "Transect"), adjust = "mvt")
# # The Rural and Southern Urban transects are significantly different from one another.
# # The Rural and Northern urban transects are significantly different from one another.
# # The 2 urban transects are not sig diff from e.o.
# 
# marginal = lsmeans(abun_m1, ~ Transect)
# 
# CLD = cld(marginal, alpha=0.05, Letters=letters, adjust="tukey")
# 
# ggplot(CLD, aes(x = Transect, y = lsmean, label = .group)) +
#     geom_point(shape  = 15,
#                size   = 4,
#              position = position_dodge(0.2) ) +
#     geom_errorbar(aes(ymin  =  lower.CL,
#                       ymax  =  upper.CL),
#                       width =  0.2,
#                       size  =  0.7,
#                    position = position_dodge(0.2) ) +
#     theme_bw() +
#     theme(axis.title   = element_text(face = "bold"),
#           axis.text    = element_text(face = "bold"),
#           plot.caption = element_text(hjust = 0)) +
#     ylab("Least square mean") +
#     ggtitle ("Pollinator Individuals per Site",
#              subtitle = "Least Square Mean")

```

####### Transects
```{r}
# Total individuals ~ dist city ctr *  Transect
summary(glm(total_indivs ~ Dist_city*Transect, data = div_sum_urban , family = "poisson"))
car::Anova(glm(total_indivs ~ Dist_city*Transect , data = div_sum_urban, family = "poisson" ))
# Nothing sig


# Total individuals ~ dist city ctr + Transect
summary(glm(total_indivs ~ Dist_city + Transect, data = div_sum_urban , family = "poisson"))
ab.q2 <- car::Anova(glm(total_indivs ~ Dist_city + Transect , data = div_sum_urban, family = "poisson" ))
# Nothing sig

```



####### Find abundance means at urban and rural terminii
```{r}
urban_terminus = 3.5 # km; most urban pop is close to this distance
rural_terminus = 67 # km; most rural pop is close to this distance
midpoint = 35.25 # km; midpoint of urban and rural terminii


q.1 <- glm(total_indivs	~ Dist_city, data = div_sum, family = "poisson")
coeffs.q.1 = coefficients(q.1)

rural_mean = coeffs.q.1[1] + coeffs.q.1[2]*rural_terminus 
rural_mean # mean abundance

urban_mean = coeffs.q.1[1] + coeffs.q.1[2]*urban_terminus 
urban_mean # mean abundance

# AVG DIFFERENCE FROM URBAN TO RURAL TERMINUS:
(urban_mean - rural_mean)/(0.5*(urban_mean + rural_mean))

# FIND MEAN abundance
central_mean_q.1 = coeffs.q.1[1] + coeffs.q.1[2]*midpoint 
central_mean_q.1


# AVG DIFFERENCE FROM URBAN TO RURAL TERMINUS:
(urban_mean - rural_mean)/(0.5*(urban_mean + rural_mean))


```

##### Diversity
###### Shannon's Diversity Index
####### All data
```{r}
# Shannon diversity  ~ dist city ctr
summary(lm(shannon ~ Dist_city , data = div_sum ))
car::Anova(lm(shannon ~ Dist_city , data = div_sum ))
## city_dist nto sig

# pairs(lsmeans(sh_div_lm, "Transect"), adjust = "mvt")
# # No transects are signifcantly different from one another.
# # This is more trustworthy than the ANOVA because it accounts for the unbalanced design.
# 
# marginal1 = lsmeans(sh_div_lm, ~ Transect)
# CLD1 = cld(marginal1, alpha=0.05, Letters=letters, adjust="tukey")
# ggplot(CLD1, aes(x = Transect, y = lsmean, label = .group)) +
#     geom_point(shape  = 15,
#                size   = 4,
#              position = position_dodge(0.2) ) +
#     geom_errorbar(aes(ymin  =  lower.CL,
#                       ymax  =  upper.CL),
#                       width =  0.2,
#                       size  =  0.7,
#                    position = position_dodge(0.2) ) +
#     theme_bw() +
#     theme(axis.title   = element_text(face = "bold"),
#           axis.text    = element_text(face = "bold"),
#           plot.caption = element_text(hjust = 0)) +
#     ylab("Least square mean") +
#     ggtitle ("Shannon Diversity per Site",
#              subtitle = "Least Square Mean")
```


####### Transects
```{r}
# Shannon diversity  ~ dist city ctr *  Transect
summary(lm(shannon^(1/2) ~ Dist_city * Transect, data = div_sum_urban))
car::Anova(lm(shannon^(1/2) ~ Dist_city * Transect, data = div_sum_urban))
## A:B not significant, so let's try these main factors separately.

summary(lm(shannon^(1/2) ~ Dist_city+ Transect, data = div_sum_urban))
car::Anova(lm(shannon^(1/2) ~ Dist_city + Transect, data = div_sum_urban))
# nothing sig


# pairs(lsmeans(lm(shannon ~ Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]), "Transect"), adjust = "mvt")
# # Marginally significant: p = 0.066
# 
# 
# 
# 
# marginal2 = lsmeans(lm(shannon ~ Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]), ~ Transect)
# 
# CLD2 = cld(marginal2, alpha=0.05, Letters=letters, adjust="tukey")
# 
# ggplot(CLD2, aes(x = Transect, y = lsmean, label = .group)) +
#     geom_point(shape  = 15,
#                size   = 4,
#              position = position_dodge(0.2) ) +
#     geom_errorbar(aes(ymin  =  lower.CL,
#                       ymax  =  upper.CL),
#                       width =  0.2,
#                       size  =  0.7,
#                    position = position_dodge(0.2) ) +
#     theme_bw() +
#     theme(axis.title   = element_text(face = "bold"),
#           axis.text    = element_text(face = "bold"),
#           plot.caption = element_text(hjust = 0)) +
#     ylab("Least square mean") +
#     ggtitle ("Shannon Diversity per Site",
#              subtitle = "Least Square Mean")
# 

```

###### Simpson's Diversity Index
####### Transformed data (log(1-simpson) transformation. Was left-skewed)
######## All data
```{r}
# Simpson's diversity  ~ dist city ctr
summary(lm(log(1-simpson) ~ Dist_city , data = div_sum ))
di.q1 <- car::Anova(lm(log(1-simpson) ~ Dist_city , data = div_sum ))
## Nothing sig

```

######## Transects
```{r}
# Simpson's diversity  ~ dist city ctr * Transect
summary(lm(log(1-simpson) ~ Dist_city * Transect, data = div_sum_urban))
car::Anova(lm(log(1-simpson) ~ Dist_city * Transect, data = div_sum_urban))
## A:B not significant, so let's try these main factors separately.

di.q2 <- car::Anova(lm(log(1-simpson) ~ Dist_city + Transect, data = div_sum_urban))
# not sig
```

######## Removing honeybees (use sq transf w/o transects, cube with transects)
######### All data
```{r}
# Simpson's diversity  ~ dist city ctr
summary(lm(simpson_sq ~ Dist_city , data = div_sum_no_honey ))
car::Anova(lm(simpson_sq ~ Dist_city , data = div_sum_no_honey ))
## Nothing sig
 
```

######### Transects
```{r}
# Simpson's diversity  ~ dist city ctr * Transect
summary(lm(simpson_cube ~ Dist_city * Transect, data = div_sum_urban_no_honey))
car::Anova(lm(simpson_cube ~ Dist_city * Transect, data = div_sum_urban_no_honey))
## A:B not significant, so let's try these main factors separately.

car::Anova(lm(simpson_cube ~ Dist_city + Transect, data = div_sum_urban_no_honey))
# not sig
```

##### Richness
Main takeaway: Menhinick's Richness index does vary along the gradient and by transect- both when involving all 3 and only 2 urban transects. Their interaction is not significant.
```{r}

# Menhinick's Index ~ dist city ctr * Transect
summary(lm(Menhinicks_index ~ Dist_city * Transect, data = div_sum ))
car::Anova(lm(Menhinicks_index ~ Dist_city * Transect, data = div_sum ))
## A:B not significant but B (transect) is... so let's try these main factors separately.

# Menhinick's Index ~ dist city ctr
summary(lm(Menhinicks_index ~ Dist_city, data = div_sum ))
car::Anova(lm(Menhinicks_index ~ Dist_city, data = div_sum ))
## p < 0.01*
## Richness does change along the gradient!

# Menhinick's Index ~ transect
summary(lm(Menhinicks_index ~ Transect, data = div_sum ))
car::Anova(lm(Menhinicks_index ~ Transect, data = div_sum ))
## p < 0.001***
## Richness does vary among transects!


### URBAN TRANSECTS ONLY ###
# Menhinick's Index ~ dist city ctr * URBAN Transect
summary(lm(Menhinicks_index ~ Dist_city * Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]))
car::Anova(lm(Menhinicks_index ~ Dist_city * Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]))
## A:B not significant but B (transect) is... so let's try these main factors separately.

# Menhinick's Index ~ URBAN transect
summary(lm(Menhinicks_index ~ Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]))
car::Anova(lm(Menhinicks_index ~ Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]))
## p < 0.03*
## Richness does vary among urban transects!

```
 *** STILL NEED TO DO 4/3/2020- SET UP LM'S CORRECTLY & REDO
##### Equitability (Evenness)*** STILL NEED TO DO 4/3/2020- SET UP LM'S CORRECTLY & REDO
###### Shannon's Equitability
Main takeaway: Shannon's Equitability does not differ by position along gradient. It marginally differs by transect (when comparing all 3 as well as just the 2 urban). The interaction is not significant.
```{r}
# Shannon equitability  ~ dist city ctr * Transect
summary(lm(shannon_equit ~ Dist_city * Transect, data = div_sum ))
car::Anova(lm(shannon_equit ~ Dist_city * Transect, data = div_sum ))
## A:B not significant, so let's try these main factors separately.

# Shannon equitability ~ dist city ctr
summary(lm(shannon_equit ~ Dist_city, data = div_sum ))
car::Anova(lm(shannon_equit ~ Dist_city, data = div_sum ))
## p >> 0.05
## Shannon's equitability does NOT significantly change along the gradient

# Shannon equitability  ~ transect
summary(lm(shannon_equit ~ Transect, data = div_sum ))
car::Anova(lm(shannon_equit ~ Transect, data = div_sum ))
## p = 0.09
## Shannon's equitability varies among transects (it's marginally significant)


### URBAN TRANSECTS ONLY ###
# Shannon equitability  ~ dist city ctr * URBAN Transect
summary(lm(shannon_equit ~ Dist_city * Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]))
car::Anova(lm(shannon_equit ~ Dist_city * Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]))
## A:B not significant (though B is marginally sig), so let's try these main factors separately.

# Shannon equitability  ~ URBAN transect
summary(lm(shannon_equit ~ Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]))
car::Anova(lm(shannon_equit ~ Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]))
## p = 0.066
## Shannon's equitability does vary among urban transects (it's marginally significant)


```

###### Simpson's Equitability
Main takeaway: Simpson's Equitability does not differ by position along gradient or by transect. Their interaction is also not significant.
```{r}

# Simpson's equitability  ~ dist city ctr * Transect
summary(lm(simpson_equit ~ Dist_city * Transect, data = div_sum ))
car::Anova(lm(simpson_equit ~ Dist_city * Transect, data = div_sum ))
## A:B not significant, so let's try these main factors separately.

# Simpson diversity ~ dist city ctr
summary(lm(simpson_equit ~ Dist_city, data = div_sum ))
car::Anova(lm(simpson_equit ~ Dist_city, data = div_sum ))
## p >> 0.05
## Simpson's equitability does NOT significantly change along the gradient

# Simpson's equitability  ~ transect
summary(lm(simpson_equit ~ Transect, data = div_sum ))
car::Anova(lm(simpson_equit ~ Transect, data = div_sum ))
## p >> 0.05
## simpson_equit's diversity does NOT significantly vary among transects


### URBAN TRANSECTS ONLY ###
# Simpson's equitability  ~ dist city ctr * URBAN Transect
summary(lm(simpson_equit ~ Dist_city * Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]))
car::Anova(lm(simpson_equit ~ Dist_city * Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]))
## A:B not significant, so let's try these main factors separately.

# Simpson's equitability  ~ URBAN transect
summary(lm(simpson_equit ~ Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]))
car::Anova(lm(simpson_equit ~ Transect, data = div_sum[which(div_sum$Transect == "North" | div_sum$Transect == "South"),]))
## p >> 0.05
## simpson_equit's diversity does NOT significantly vary among urban transects

```

## Random Statistical Analysis (double-check these are using correctly transformed data + Anova instead of aov...)
#### Pollen Removal
##### R-sq, p, and n for each subtransect * year
```{r}

# stats for average pollen removal by year AND by sub-transect
## 2018
Poll_Nor_18 <- summary(lm(Average_Pollinia ~ City_dist,
                    data = AvgVars_byPatch_2018[which(AvgVars_byPatch_2018$Transect_ID == "North"), ]))
Poll_Nor_18_n <- lm(Average_Pollinia ~ City_dist, 
                    data = AvgVars_byPatch_2018[which(AvgVars_byPatch_2018$Transect_ID == "North"), ])
Poll_Sou_18 <- summary(lm(Average_Pollinia ~ City_dist,
                    data = AvgVars_byPatch_2018[which(AvgVars_byPatch_2018$Transect_ID == "South"), ]))
Poll_Sou_18_n <- lm(Average_Pollinia ~ City_dist,
                    data = AvgVars_byPatch_2018[which(AvgVars_byPatch_2018$Transect_ID == "South"), ])
Poll_Rur_18 <- summary(lm(Average_Pollinia ~ City_dist,
                    data = AvgVars_byPatch_2018[which(AvgVars_byPatch_2018$Transect_ID == "Rural"), ]))
Poll_Rur_18_n <- lm(Average_Pollinia ~ City_dist,
                    data = AvgVars_byPatch_2018[which(AvgVars_byPatch_2018$Transect_ID == "Rural"), ])

## 2019
Poll_Nor_19 <- summary(lm(Average_Pollinia ~ City_dist,
                    data = AvgVars_byPatch_2019[which(AvgVars_byPatch_2019$Transect_ID == "North"), ]))
Poll_Nor_19_n <- lm(Average_Pollinia ~ City_dist, 
                    data = AvgVars_byPatch_2019[which(AvgVars_byPatch_2019$Transect_ID == "North"), ])
Poll_Sou_19 <- summary(lm(Average_Pollinia ~ City_dist,
                    data = AvgVars_byPatch_2019[which(AvgVars_byPatch_2019$Transect_ID == "South"), ]))
Poll_Sou_19_n <- lm(Average_Pollinia ~ City_dist,
                    data = AvgVars_byPatch_2019[which(AvgVars_byPatch_2019$Transect_ID == "South"), ])
Poll_Rur_19 <- summary(lm(Average_Pollinia ~ City_dist,
                    data = AvgVars_byPatch_2019[which(AvgVars_byPatch_2019$Transect_ID == "Rural"), ]))
Poll_Rur_19_n <- lm(Average_Pollinia ~ City_dist,
                    data = AvgVars_byPatch_2019[which(AvgVars_byPatch_2019$Transect_ID == "Rural"), ])


##### table w/summary stats for each subtransect by year
Pollen_removal_stats_table <-matrix(c(
  "2018",round(Poll_Nor_18$r.squared,3),round(Poll_Nor_18$coefficients[2,4],3),nobs(Poll_Nor_18_n),
  "2018",round(Poll_Sou_18$r.squared,3),round(Poll_Sou_18$coefficients[2,4],3),nobs(Poll_Sou_18_n),
  "2018",round(Poll_Rur_18$r.squared,3),round(Poll_Rur_18$coefficients[2,4],3),nobs(Poll_Rur_18_n),
  "2019",round(Poll_Nor_19$r.squared,3),round(Poll_Nor_19$coefficients[2,4],3),nobs(Poll_Nor_19_n),
  "2019",round(Poll_Sou_19$r.squared,3),round(Poll_Sou_19$coefficients[2,4],3),nobs(Poll_Sou_19_n),
  "2019",round(Poll_Rur_19$r.squared,3),round(Poll_Rur_19$coefficients[2,4],3),nobs(Poll_Rur_19_n))
  ,ncol=4,byrow=TRUE)
colnames(Pollen_removal_stats_table) <- c("Year","R-squared", "p", "n")
rownames(Pollen_removal_stats_table) <- c("Urban: Northern","Urban: Southern (green corridor)","Rural","Urban: Northern","Urban: Southern (green corridor)","Rural")
Pollen_removal_stats_table <- as.table(Pollen_removal_stats_table)
Pollen_removal_stats_table


##### table w/summary stats for each subtransect by subtransect
Pollen_removal_stats_table2 <-matrix(c(
"2018",round(Poll_Nor_18$r.squared,3),round(Poll_Nor_18$coefficients[2,4],3),nobs(Poll_Nor_18_n),
"2019",round(Poll_Nor_19$r.squared,3),round(Poll_Nor_19$coefficients[2,4],3),nobs(Poll_Nor_19_n),
                                      "2018",round(Poll_Sou_18$r.squared,3),round(Poll_Sou_18$coefficients[2,4],3),nobs(Poll_Sou_18_n),         "2019",round(Poll_Sou_19$r.squared,3),round(Poll_Sou_19$coefficients[2,4],3),nobs(Poll_Sou_19_n),
                                      "2018",round(Poll_Rur_18$r.squared,3),round(Poll_Rur_18$coefficients[2,4],3),nobs(Poll_Rur_18_n),        "2019",round(Poll_Rur_19$r.squared,3),round(Poll_Rur_19$coefficients[2,4],3),nobs(Poll_Rur_19_n)),
ncol=4,byrow=TRUE)
colnames(Pollen_removal_stats_table2) <- c("Year","R-squared", "p", "n")
rownames(Pollen_removal_stats_table2) <- c("Urban: Northern","Urban: Northern","Urban: Southern (green corridor)","Urban: Southern (green corridor)","Rural","Rural")
Pollen_removal_stats_table2 <- as.table(Pollen_removal_stats_table)
Pollen_removal_stats_table2
write.csv(Pollen_removal_stats_table2, "Poll_removal_stats2.csv")
```
##### Comparing urban, rural subtransects
```{r}

# ANOVA
## 2018
Poll_18_North <- subset(AvgVars_notNA_Poll_18, Transect_ID == "North", select = c("Average_Pollinia", "City_dist"))
Poll_18_South <- subset(AvgVars_notNA_Poll_18, Transect_ID == "South", select = c("Average_Pollinia", "City_dist"))
Poll_18_Urban <- subset(AvgVars_notNA_Poll_18, Transect_ID == "North" | Transect_ID == "South", select = c("Average_Pollinia", "City_dist", "Transect_ID"))

aov1 <- aov(Average_Pollinia ~ City_dist * Transect_ID, data = Poll_18_Urban)
summary(aov1)
Anova(aov1, type = "II")
lsmeans_poll18 <- lsmeans(aov1, ~Transect_ID)
lsmeans_poll18
## South has (1.6-1.04)/(1.04) = 54% more pollinia removed, on average, than North transect

## 2019
Poll_19_North <- subset(AvgVars_notNA_Poll_19, Transect_ID == "North", select = c("Average_Pollinia", "City_dist"))
Poll_19_South <- subset(AvgVars_notNA_Poll_19, Transect_ID == "South", select = c("Average_Pollinia", "City_dist"))
Poll_19_Urban <- subset(AvgVars_notNA_Poll_19, Transect_ID == "North" | Transect_ID == "South", select = c("Average_Pollinia", "City_dist", "Transect_ID"))

aov2 <- aov(Average_Pollinia ~ City_dist * Transect_ID, data = Poll_19_Urban)
summary(aov2)
Anova(aov2, type = "II")
lsmeans_poll19 <- lsmeans(aov2, ~Transect_ID)
lsmeans_poll19
## South has (0.845-0.801)/(0.801) = 5% more pollinia removed, on average, than North transect

## 2018-2019
Poll_North <- subset(AvgVars_notNA_Poll, Transect_ID == "North", select = c("Average_Pollinia", "City_dist"))
Poll_South <- subset(AvgVars_notNA_Poll, Transect_ID == "South", select = c("Average_Pollinia", "City_dist"))

##### can I do this for 2 years?? Or do I have to use lmer for more than my current 2 variables? (city_dist and transect ID)
aov3 <- aov(Average_Pollinia ~ City_dist * Transect_ID , data = Poll_Urban)
summary(aov3)
Anova(aov3, type = "II")
lsmeans_poll19 <- lsmeans(aov3, ~Transect_ID)
lsmeans_poll19
## South has (1.126-0.876)/(0.876) = 29% more pollen removal, on average, than North transect

```
#### Follicles
##### R-sq, p, and n for each subtransect * year
```{r}

# stats for average follicles by year AND by sub-transect
## 2018
Pod_Nor_18 <- summary(lm(Total_Pods ~ City_dist,
                    data = fertile_pops_18[which(fertile_pops_18$Transect_ID == "North"), ]))
Pod_Nor_18_n <- lm(Total_Pods ~ City_dist, 
                    data = fertile_pops_18[which(fertile_pops_18$Transect_ID == "North"), ])

Pod_Sou_18 <- summary(lm(Total_Pods ~ City_dist,
                    data = fertile_pops_18[which(fertile_pops_18$Transect_ID == "South"), ]))
Pod_Sou_18_n <- lm(Total_Pods ~ City_dist,
                    data = fertile_pops_18[which(fertile_pops_18$Transect_ID == "South"), ])

Pod_Rur_18 <- summary(lm(Total_Pods ~ City_dist,
                    data = fertile_pops_18[which(fertile_pops_18$Transect_ID == "Rural"), ]))
Pod_Rur_18_n <- lm(Total_Pods ~ City_dist,
                    data = fertile_pops_18[which(fertile_pops_18$Transect_ID == "Rural"), ])

## 2019
Pod_Nor_19 <- summary(lm(Total_Pods ~ City_dist,
                    data = fertile_pops_19[which(fertile_pops_19$Transect_ID == "North"), ]))
Pod_Nor_19_n <- lm(Total_Pods ~ City_dist, 
                    data = fertile_pops_19[which(fertile_pops_19$Transect_ID == "North"), ])

Pod_Sou_19 <- summary(lm(Total_Pods ~ City_dist,
                    data = fertile_pops_19[which(fertile_pops_19$Transect_ID == "South"), ]))
Pod_Sou_19_n <- lm(Total_Pods ~ City_dist,
                    data = fertile_pops_19[which(fertile_pops_19$Transect_ID == "South"), ])

Pod_Rur_19 <- summary(lm(Total_Pods ~ City_dist,
                    data = fertile_pops_19[which(fertile_pops_19$Transect_ID == "Rural"), ]))
Pod_Rur_19_n <- lm(Total_Pods ~ City_dist,
                    data = fertile_pops_19[which(fertile_pops_19$Transect_ID == "Rural"), ])


##### table w/summary stats for each subtransect by year
Pods_stats_table <-matrix(c(
  "2018",round(Pod_Nor_18$r.squared,3),round(Pod_Nor_18$coefficients[2,4],3),nobs(Pod_Nor_18_n),
  "2018",round(Pod_Sou_18$r.squared,3),round(Pod_Sou_18$coefficients[2,4],3),nobs(Pod_Sou_18_n),
  "2018",round(Pod_Rur_18$r.squared,3),round(Pod_Rur_18$coefficients[2,4],3),nobs(Pod_Rur_18_n),
  "2019",round(Pod_Nor_19$r.squared,3),round(Pod_Nor_19$coefficients[2,4],3),nobs(Pod_Nor_19_n),
  "2019",round(Pod_Sou_19$r.squared,3),round(Pod_Sou_19$coefficients[2,4],3),nobs(Pod_Sou_19_n),
  "2019",round(Pod_Rur_19$r.squared,3),round(Pod_Rur_19$coefficients[2,4],3),nobs(Pod_Rur_19_n))
  ,ncol=4,byrow=TRUE)
colnames(Pods_stats_table) <- c("Year","R-squared", "p", "n")
rownames(Pods_stats_table) <- c("Urban: Northern","Urban: Southern (green corridor)","Rural","Urban: Northern","Urban: Southern (green corridor)","Rural")
Pods_stats_table <- as.table(Pods_stats_table)
Pods_stats_table


##### table w/summary stats for each subtransect by subtransect
Pods_stats_table2 <-matrix(c(
"2018",round(Pod_Nor_18$r.squared,3),round(Pod_Nor_18$coefficients[2,4],3),nobs(Pod_Nor_18_n),
"2019",round(Pod_Nor_19$r.squared,3),round(Pod_Nor_19$coefficients[2,4],3),nobs(Pod_Nor_19_n),
"2018",round(Pod_Sou_18$r.squared,3),round(Pod_Sou_18$coefficients[2,4],3),nobs(Pod_Sou_18_n),         "2019",round(Pod_Sou_19$r.squared,3),round(Pod_Sou_19$coefficients[2,4],3),nobs(Pod_Sou_19_n),
"2018",round(Pod_Rur_18$r.squared,3),round(Pod_Rur_18$coefficients[2,4],3),nobs(Pod_Rur_18_n),        "2019",round(Pod_Rur_19$r.squared,3),round(Pod_Rur_19$coefficients[2,4],3),nobs(Pod_Rur_19_n)),
ncol=4,byrow=TRUE)
colnames(Pods_stats_table2) <- c("Year","R-squared", "p", "n")
rownames(Pods_stats_table2) <- c("Urban: Northern","Urban: Northern","Urban: Southern (green corridor)","Urban: Southern (green corridor)","Rural","Rural")
Pods_stats_table2 <- as.table(Pods_stats_table2)
Pods_stats_table2
write.csv(Pods_stats_table2, "Pods_stats2.csv")
```
##### Comparing urban, rural subtransects
```{r}

# ANOVA
## 2018

aov1a <- aov(Total_Pods ~ City_dist * Transect_ID, data = Pod_18_Urban)
summary(aov1a)
Anova(aov1a, type = "II")
lsmeans_pod18 <- lsmeans(aov1a, ~Transect_ID)
lsmeans_pod18
## South has (4.99-3.35)/(3.35) = 49% more pods, on average, than North transect

## 2019

aov2a <- aov(Total_Pods ~ City_dist * Transect_ID, data = Pod_19_Urban)
summary(aov2a)
Anova(aov2a, type = "II")
lsmeans_pod19 <- lsmeans(aov2a, ~Transect_ID)
lsmeans_pod19
## South has (3.65-3.4)/(3.4) = 7% more pods, on average, than North transect

```
#### Peduncles
##### R-sq, p, and n for each subtransect * year
```{r}

# stats for average follicles by year AND by sub-transect
## 2018
Ped_Nor_18 <- summary(lm(Peduncles ~ City_dist,
                    data = fertile_pops_18[which(fertile_pops_18$Transect_ID == "North"), ]))
Ped_Nor_18_n <- lm(Peduncles ~ City_dist, 
                    data = fertile_pops_18[which(fertile_pops_18$Transect_ID == "North"), ])

Ped_Sou_18 <- summary(lm(Peduncles ~ City_dist,
                    data = fertile_pops_18[which(fertile_pops_18$Transect_ID == "South"), ]))
Ped_Sou_18_n <- lm(Peduncles ~ City_dist,
                    data = fertile_pops_18[which(fertile_pops_18$Transect_ID == "South"), ])

Ped_Rur_18 <- summary(lm(Peduncles ~ City_dist,
                    data = fertile_pops_18[which(fertile_pops_18$Transect_ID == "Rural"), ]))
Ped_Rur_18_n <- lm(Peduncles ~ City_dist,
                    data = fertile_pops_18[which(fertile_pops_18$Transect_ID == "Rural"), ])

## 2019
Ped_Nor_19 <- summary(lm(Peduncles ~ City_dist,
                    data = fertile_pops_19[which(fertile_pops_19$Transect_ID == "North"), ]))
Ped_Nor_19_n <- lm(Peduncles ~ City_dist, 
                    data = fertile_pops_19[which(fertile_pops_19$Transect_ID == "North"), ])

Ped_Sou_19 <- summary(lm(Peduncles ~ City_dist,
                    data = fertile_pops_19[which(fertile_pops_19$Transect_ID == "South"), ]))
Ped_Sou_19_n <- lm(Peduncles ~ City_dist,
                    data = fertile_pops_19[which(fertile_pops_19$Transect_ID == "South"), ])

Ped_Rur_19 <- summary(lm(Peduncles ~ City_dist,
                    data = fertile_pops_19[which(fertile_pops_19$Transect_ID == "Rural"), ]))
Ped_Rur_19_n <- lm(Peduncles ~ City_dist,
                    data = fertile_pops_19[which(fertile_pops_19$Transect_ID == "Rural"), ])


##### table w/summary stats for each subtransect by year
Peds_stats_table <-matrix(c(
  "2018",round(Ped_Nor_18$r.squared,3),round(Ped_Nor_18$coefficients[2,4],3),nobs(Ped_Nor_18_n),
  "2018",round(Ped_Sou_18$r.squared,3),round(Ped_Sou_18$coefficients[2,4],3),nobs(Ped_Sou_18_n),
  "2018",round(Ped_Rur_18$r.squared,3),round(Ped_Rur_18$coefficients[2,4],3),nobs(Ped_Rur_18_n),
  "2019",round(Ped_Nor_19$r.squared,3),round(Ped_Nor_19$coefficients[2,4],3),nobs(Ped_Nor_19_n),
  "2019",round(Ped_Sou_19$r.squared,3),round(Ped_Sou_19$coefficients[2,4],3),nobs(Ped_Sou_19_n),
  "2019",round(Ped_Rur_19$r.squared,3),round(Ped_Rur_19$coefficients[2,4],3),nobs(Ped_Rur_19_n))
  ,ncol=4,byrow=TRUE)
colnames(Peds_stats_table) <- c("Year","R-squared", "p", "n")
rownames(Peds_stats_table) <- c("Urban: Northern","Urban: Southern (green corridor)","Rural","Urban: Northern","Urban: Southern (green corridor)","Rural")
Peds_stats_table <- as.table(Peds_stats_table)
Peds_stats_table


##### table w/summary stats for each subtransect by subtransect
Peds_stats_table2 <-matrix(c(
"2018",round(Ped_Nor_18$r.squared,3),round(Ped_Nor_18$coefficients[2,4],3),nobs(Ped_Nor_18_n),
"2019",round(Ped_Nor_19$r.squared,3),round(Ped_Nor_19$coefficients[2,4],3),nobs(Ped_Nor_19_n),
"2018",round(Ped_Sou_18$r.squared,3),round(Ped_Sou_18$coefficients[2,4],3),nobs(Ped_Sou_18_n),         "2019",round(Ped_Sou_19$r.squared,3),round(Ped_Sou_19$coefficients[2,4],3),nobs(Ped_Sou_19_n),
"2018",round(Ped_Rur_18$r.squared,3),round(Ped_Rur_18$coefficients[2,4],3),nobs(Ped_Rur_18_n),        "2019",round(Ped_Rur_19$r.squared,3),round(Ped_Rur_19$coefficients[2,4],3),nobs(Ped_Rur_19_n)),
ncol=4,byrow=TRUE)
colnames(Peds_stats_table2) <- c("Year","R-squared", "p", "n")
rownames(Peds_stats_table2) <- c("Urban: Northern","Urban: Northern","Urban: Southern (green corridor)","Urban: Southern (green corridor)","Rural","Rural")
Peds_stats_table2 <- as.table(Peds_stats_table2)
Peds_stats_table2
write.csv(Peds_stats_table2, "Peds_stats2.csv")
```
##### Comparing urban, rural subtransects
```{r}

# ANOVA
## 2018


aov1b <- aov(Peduncles ~ City_dist * Transect_ID, data = Ped_18_Urban)
summary(aov1b)
Anova(aov1b, type = "II")
lsmeans_ped18 <- lsmeans(aov1b, ~Transect_ID)
lsmeans_ped18
## South has (8.67-7.16)/(7.16) = 21% more pods, on average, than North transect

## 2019


aov2b <- aov(Peduncles ~ City_dist * Transect_ID, data = Ped_19_Urban)
summary(aov2b)
Anova(aov2b, type = "II")
lsmeans_ped19 <- lsmeans(aov2b, ~Transect_ID)
lsmeans_ped19
## South has (8.47-7.97)/(7.97) = 6% more pods, on average, than North transect
```
#### Height
##### R-sq, p, and n for each subtransect * year
```{r}
# stats for average height by year AND by sub-transect
## 2018
Height_Nor_18 <- summary(lm(Height_Sept ~ City_dist,
                    data = AvgVars_notNA_Height_18[which(AvgVars_notNA_Height_18$Transect_ID == "North"), ]))
Height_Nor_18_n <- lm(Height_Sept ~ City_dist, 
                    data = AvgVars_notNA_Height_18[which(AvgVars_notNA_Height_18$Transect_ID == "North"), ])

Height_Sou_18 <- summary(lm(Height_Sept ~ City_dist,
                    data = AvgVars_notNA_Height_18[which(AvgVars_notNA_Height_18$Transect_ID == "South"), ]))
Height_Sou_18_n <- lm(Height_Sept ~ City_dist,
                    data = AvgVars_notNA_Height_18[which(AvgVars_notNA_Height_18$Transect_ID == "South"), ])

Height_Rur_18 <- summary(lm(Height_Sept ~ City_dist,
                    data = AvgVars_notNA_Height_18[which(AvgVars_notNA_Height_18$Transect_ID == "Rural"), ]))
Height_Rur_18_n <- lm(Height_Sept ~ City_dist,
                    data = AvgVars_notNA_Height_18[which(AvgVars_notNA_Height_18$Transect_ID == "Rural"), ])

## 2019
Height_Nor_19 <- summary(lm(Height_Sept ~ City_dist,
                    data = AvgVars_notNA_Height_19[which(AvgVars_notNA_Height_19$Transect_ID == "North"), ]))
Height_Nor_19_n <- lm(Height_Sept ~ City_dist, 
                    data = AvgVars_notNA_Height_19[which(AvgVars_notNA_Height_19$Transect_ID == "North"), ])

Height_Sou_19 <- summary(lm(Height_Sept ~ City_dist,
                    data = AvgVars_notNA_Height_19[which(AvgVars_notNA_Height_19$Transect_ID == "South"), ]))
Height_Sou_19_n <- lm(Height_Sept ~ City_dist,
                    data = AvgVars_notNA_Height_19[which(AvgVars_notNA_Height_19$Transect_ID == "South"), ])

Height_Rur_19 <- summary(lm(Height_Sept ~ City_dist,
                    data = AvgVars_notNA_Height_19[which(AvgVars_notNA_Height_19$Transect_ID == "Rural"), ]))
Height_Rur_19_n <- lm(Height_Sept ~ City_dist,
                    data = AvgVars_notNA_Height_19[which(AvgVars_notNA_Height_19$Transect_ID == "Rural"), ])


##### table w/summary stats for each subtransect by year
Height_stats_table <-matrix(c(
  "2018",round(Height_Nor_18$r.squared,3),round(Height_Nor_18$coefficients[2,4],3),nobs(Height_Nor_18_n),
  "2018",round(Height_Sou_18$r.squared,3),round(Height_Sou_18$coefficients[2,4],3),nobs(Height_Sou_18_n),
  "2018",round(Height_Rur_18$r.squared,3),round(Height_Rur_18$coefficients[2,4],3),nobs(Height_Rur_18_n),
  "2019",round(Height_Nor_19$r.squared,3),round(Height_Nor_19$coefficients[2,4],3),nobs(Height_Nor_19_n),
  "2019",round(Height_Sou_19$r.squared,3),round(Height_Sou_19$coefficients[2,4],3),nobs(Height_Sou_19_n),
  "2019",round(Height_Rur_19$r.squared,3),round(Height_Rur_19$coefficients[2,4],3),nobs(Height_Rur_19_n))
  ,ncol=4,byrow=TRUE)
colnames(Height_stats_table) <- c("Year","R-squared", "p", "n")
rownames(Height_stats_table) <- c("Urban: Northern","Urban: Southern (green corridor)","Rural","Urban: Northern","Urban: Southern (green corridor)","Rural")
Height_stats_table <- as.table(Height_stats_table)
Height_stats_table


##### table w/summary stats for each subtransect by subtransect
Height_stats_table2 <-matrix(c(
"2018",round(Height_Nor_18$r.squared,3),round(Height_Nor_18$coefficients[2,4],3),nobs(Height_Nor_18_n),
"2019",round(Height_Nor_19$r.squared,3),round(Height_Nor_19$coefficients[2,4],3),nobs(Height_Nor_19_n),
"2018",round(Height_Sou_18$r.squared,3),round(Height_Sou_18$coefficients[2,4],3),nobs(Height_Sou_18_n),     "2019",round(Height_Sou_19$r.squared,3),round(Height_Sou_19$coefficients[2,4],3),nobs(Height_Sou_19_n),
"2018",round(Height_Rur_18$r.squared,3),round(Height_Rur_18$coefficients[2,4],3),nobs(Height_Rur_18_n),     "2019",round(Height_Rur_19$r.squared,3),round(Height_Rur_19$coefficients[2,4],3),nobs(Height_Rur_19_n)),
ncol=4,byrow=TRUE)
colnames(Height_stats_table2) <- c("Year","R-squared", "p", "n")
rownames(Height_stats_table2) <- c("Urban: Northern","Urban: Northern","Urban: Southern (green corridor)","Urban: Southern (green corridor)","Rural","Rural")
Height_stats_table2 <- as.table(Height_stats_table2)
Height_stats_table2
write.csv(Height_stats_table2, "Height_stats2.csv")
```

##### Comparing urban, rural subtransects
```{r}

# ANOVA
## 2018
aov1c <- aov(Height_Sept ~ City_dist * Transect_ID, data = Height_18_Urban)
summary(aov1c)
Anova(aov1c, type = "II")
lsmeans_Height18 <- lsmeans(aov1c, ~Transect_ID)
lsmeans_Height18
## South plants are (97.7-86.7)/(86.7) = 13% taller, on average, than North transect plants


## 2019
aov2c <- aov(Height_Sept ~ City_dist * Transect_ID, data = Height_19_Urban)
summary(aov2c)
Anova(aov2c, type = "II")
lsmeans_Height19 <- lsmeans(aov2c, ~Transect_ID)
lsmeans_Height19 ()
## South plants are (102.3-95.1)/(95.1) = 8% taller, on average, than North transect plants
```