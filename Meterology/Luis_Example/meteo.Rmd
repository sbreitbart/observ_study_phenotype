---
title: "Climate analysis Las Cruces"
author: "Helene Wagner"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

Code adapted from: https://www.earthdatascience.org/courses/earth-analytics/time-series-data/summarize-time-series-by-month-in-r/

## 1. Preparations

Load packages

```{r}
library(ggplot2)
library(dplyr)
library(lubridate)
library(zoo)
library(tidyr)
```

Set strings as factors to false

```{r}
options(stringsAsFactors = FALSE)
```


 
## 2. Import data

```{r}
Filenames.xlsx <- list.files(paste0(here::here(), "/data"), pattern="xlsx") 
n.complete <- rep(c(24*2, 24*4), times=c(17,15))  # Number of records per complete day
```

List with one table per data file

```{r}
Data <- list()
for(f in 1:length(Filenames.xlsx))
{
  data <- readxl::read_excel(paste0(here::here(), "/data/", Filenames.xlsx[f]),
         skip=3)[,c(1,2,3,5,7,8)]
  names(data) <- c("Date", "Temperature", "TempMax", "TempMin", "Humidity", "Rainfall")
  data$Date <- as.POSIXct(data$Date, format = "%m/%d/%Y %H:%M", tz="America/Costa_Rica")
  data$day <- as.Date(data$Date, format="%Y-%m-%d")
  data$n.complete <- n.complete[f]
  Data[[f]] <- data
}
```

Combine all data into a single table

```{r}
Data <- Reduce(rbind,Data)
head(Data)
```

## 3. Quality control

Check range of variables

```{r}
boxplot(Data[,2:6], las=2)
lines(c(0,15), c(0,0))
```

List unusual values

```{r}
Data %>% filter(TempMax > 40)
Data %>% filter(TempMax < 0)
Data %>% filter(Temperature < 0)
Data %>% filter(TempMin < 0)
Data %>% filter(Humidity < 0)
```

Set unusual values to NA

```{r}
Data <- Data %>% 
  mutate(Temperature = replace(Temperature, which(Temperature<0), NA)) %>%
  mutate(TempMax = replace(TempMax, which(TempMax<0), NA)) %>%
  mutate(TempMin = replace(TempMin, which(TempMin<0), NA)) %>%
  mutate(Humidity = replace(Humidity, which(Humidity<1), NA)) %>%
  mutate(TempMax = replace(TempMax, which(TempMax>40), NA)) 
Data <- Data %>%
  mutate(Temperature = replace(Temperature, which(is.na(TempMin)), NA)) %>%
  mutate(TempMax = replace(TempMax, which(is.na(TempMin)), NA)) %>%
  mutate(Humidity = replace(Humidity, which(is.na(TempMin)), NA))
```

```{r}
boxplot(Data[,2:6], las=2)
lines(c(0,15), c(0,0))
```

Indicate records with NA values

```{r}
Data$complete <- apply(is.na(Data), 1, sum) == 0
```

## 4. Assemble daily data

### a) Aggregate by day

Notes:

- n: number of records per day
- mising: number of records with missing values per day
- n.complete: expected number of records per day (depends on recording interval: 30 min or 15 min)
- incomplete: indicator whether daily records are complete (TRUE/FALSE)

```{r}
daily_data <- Data %>%
  group_by(day) %>% # group by the day column
  summarise(n=n(),
            missing=sum(complete==FALSE),
            n.complete=mean(n.complete),
            total_precip=sum(Rainfall, na.rm=TRUE), 
            mean_temp=mean(Temperature, na.rm=TRUE),
            max_temp = max(TempMax, na.rm=TRUE),
            min_temp = min(TempMin, na.rm=TRUE),
            mean_humid=mean(Humidity, na.rm=TRUE),
            min_humid=min(Humidity, na.rm=TRUE)) 
# %>%  na.omit()  #This would drip rows with incomplete records!

daily_data <- daily_data %>%
  mutate(month = month(day), year=year(day), quarter=zoo::as.yearqtr(day)) 

daily_data = daily_data %>% mutate(incomplete = ((n - missing) < n.complete))

head(daily_data)
```

### b) Filter for Oct 2008 - Sept 2020

```{r}
daily_data = daily_data %>% filter(quarter > "2008 Q3" & quarter < "2020 Q4")
```

### c) Check range of variables

```{r}
boxplot(daily_data[,5:10], las=2)
lines(c(0,15), c(0,0))
```

## 5. Aggregate by month or quarter

Notes:

- n: number of days with records
- n.incomplete: number of days with incomplete records

### a) Aggregate by month

```{r}
monthly_data <- daily_data %>% 
  group_by(year, month) %>% # group by the month column
  summarise(n=n(),n.incomplete = sum(incomplete), 
            total_precip=sum(total_precip), 
            mean_temp=mean(mean_temp),
            mean_max_temp = mean(max_temp),
            mean_min_temp = mean(min_temp),
            mean_humid=mean(mean_humid),
            mean_min_humid=min(min_humid)) 

head(monthly_data)
```

### b) Aggregate by quarter (season)

```{r}
quarterly_data <- daily_data %>% 
  group_by(quarter) %>% # group by the quarter column
  summarise(n=n(),n.incomplete = sum(incomplete), 
            total_precip=sum(total_precip), 
            mean_temp=mean(mean_temp),
            mean_max_temp = mean(max_temp),
            mean_min_temp = mean(min_temp),
            mean_humid=mean(mean_humid),
            mean_min_humid=min(min_humid)) 

quarterly_data <- quarterly_data %>% mutate(quarter_noYear = substr(quarter, 6,7))

quarterly_data
```

### c) Check for missing days



Missing full days:

- 8 days in March - May 2018
- This will affect total precipitation data more than other data where means are used

```{r}
matrix(monthly_data$n, 12, byrow=TRUE, dimnames=list(paste(c(2008:2019),c(2009:2020), sep="-"), c(10:12,1:9)))
```

Days with some or all records missing

- 2 days in Oct 2008
- 1 day in June 2014
- 2 days in Nov 2014
- 1 day in Sept 2015
- 1 day in March 2016
- 7 days in Jan - Sept 2017
- 37 days in Oct 2017 - Sept 2018
- 15 days in Oct 2018 - May 2019
- 18 days in Oct 2019 - Sept 2020

```{r}
matrix(monthly_data$n - monthly_data$n.incomplete, 12, byrow=TRUE,
       dimnames=list(paste(c(2008:2019),c(2009:2020), sep="-"), c(10:12,1:9)))
```




### d) Data coverage

How many days in each 12-month period?

```{r}
Start <- paste0(c(2008:2019), "1001")
End <- paste0(c(2009:2020), "1001")

Days <- sapply(c(1:length(Start)), function(i) interval(Start[i], End[i]) %/% days(1))
```

Coverage results:

- Until 2016-2017, all days recorded, with at least 98% of daily records being complete
- Use all years for temperature, humidity etc. (where means are used)
- Use only years 2008 - 2017 for precipitation data (where sum is used)

```{r}
Coverage <- data.frame(n=apply(matrix(monthly_data$n, 12, byrow=TRUE, dimnames=list(paste(c(2008:2019),c(2009:2020), sep="-"), c(10:12,1:9))), 1, sum),
           n.complete=apply(matrix(monthly_data$n - monthly_data$n.incomplete, 12, byrow=TRUE,
       dimnames=list(paste(c(2008:2019),c(2009:2020), sep="-"), c(10:12,1:9))), 1, sum))
Coverage$prop.records <- Coverage$n / Days
Coverage$prop.complete <- Coverage$n.complete / Days
round(Coverage, 3) 
```


## 6. Analyze by experimental period

### a) Quarterly mean precipitation data

```{r}
tmp <- quarterly_data %>% filter(quarter < "2017 Q4") %>% group_by(quarter_noYear) %>% summarize(mean_precip=mean(total_precip))
tmp <- tmp[c(4,1,2,3),]
Precipitation <- data.frame(
  rep(tmp$quarter_noYear, 2),
  unlist(rep(tmp[,2], 2)),
  quarterly_data %>% filter(quarter > "2011 Q3", quarter < "2013 Q4") %>% select(total_precip),
  quarterly_data %>% filter(quarter > "2013 Q3", quarter < "2015 Q4") %>% select(total_precip),
  quarterly_data %>% filter(quarter > "2015 Q3", quarter < "2017 Q4") %>% select(total_precip))

names(Precipitation) <- c("Quarter", "2008-2017","2011-2013","2013-2015", "2015-2017")
Precipitation$Season <- paste(c("Fall", "Winter", "Spring", "Summer"), rep(1:2, each=4), sep=" ")
```

```{r}
ts.plot(Precipitation[,-c(1,3)], ylim=c(0,1750), col=c(1,2,4), lwd=c(3,1,1))
```
```{r fig.height=3.5, fig.width=9}
library(dplyr)

Precipitation_long <- gather(Precipitation, key = "Period", value = "Precipitation",
        '2008-2017', '2013-2015', '2015-2017')
Precipitation_long$Season <- factor(Precipitation_long$Season, levels=paste(c("Fall", "Winter", "Spring", "Summer"), rep(1:2, each=4), sep=" "))

P.plot <- Precipitation_long %>%
  ggplot(aes(fill=Period, x = Season, y = Precipitation)) +
      geom_bar(position="dodge", stat = "identity") +
      scale_fill_manual(values=c("gray", "red", "blue")) +
      ylab("Total precipitation (mm)") +
      theme_light()

P.plot
```



### b) Quarterly mean temperature data

```{r}
tmp <- quarterly_data %>% group_by(quarter_noYear) %>% summarize(mean_temp=mean(mean_temp))
tmp <- tmp[c(4,1,2,3),]
Temperature <- data.frame(
  rep(tmp$quarter_noYear, 2),
  unlist(rep(tmp[,2], 2)),
  quarterly_data %>% filter(quarter > "2011 Q3", quarter < "2013 Q4") %>% select(mean_temp),
  quarterly_data %>% filter(quarter > "2013 Q3", quarter < "2015 Q4") %>% select(mean_temp),
  quarterly_data %>% filter(quarter > "2015 Q3", quarter < "2017 Q4") %>% select(mean_temp))

names(Temperature) <- c("Quarter", "2008-2020","2011-2013","2013-2015", "2015-2017")
Temperature$Season <- paste(c("Fall", "Winter", "Spring", "Summer"), rep(1:2, each=4), sep=" ")
```

```{r}
ts.plot(Temperature[,-1], ylim=c(15,25), col=c(1:4), lwd=c(3,1,1,1))
```

```{r fig.height=3.5, fig.width=9}
library(dplyr)

Temperature_long <- gather(Temperature, key = "Period", value = "Temperature",
        '2008-2020', '2013-2015', '2015-2017')
Temperature_long$Season <- factor(Temperature_long$Season, levels=paste(c("Fall", "Winter", "Spring", "Summer"), rep(1:2, each=4), sep=" "))

T.plot <- Temperature_long %>%
  ggplot(aes(fill=Period, x = Season, y = Temperature)) +
      geom_bar(position="dodge", stat = "identity") +
      scale_fill_manual(values=c("gray", "red", "blue")) +
      ylab("Mean temperature (C)") +
      theme_light()

T.plot
```

### c) Relative to reference period

- Oct 2008 - Sept 2017 for precipitation
- Oct 2008 - Sept 2020 for temperature

```{r}
Relative <- data.frame(Season=c(Temperature$Season, "Total"), 
                  P_2013_2015=c(Precipitation[,4]/Precipitation[,2], 
                                sum(Precipitation[,4]) / sum(Precipitation[,2])),
                  P_2015_2017=c(Precipitation[,5]/Precipitation[,2], 
                                sum(Precipitation[,5]) / sum(Precipitation[,2])),
                  T_2013_2015=c(Temperature[,4]/Temperature[,2], 
                                mean(Temperature[,4]) / mean(Temperature[,2])),
                  T_2015_2017=c(Temperature[,5]/Temperature[,2], 
                                mean(Temperature[,5]) / mean(Temperature[,2])))

                  
names(Relative) <- c("Season", "Prec (2013-2015)", "Prec (2015-2017)", "Temp (2013-2015)", "Temp (2015-2017)")

for(i in 2:5) {Relative[,i] = round(Relative[,i],3)}

Relative
```

### d) Export table and figures

Export table with relative values

```{r}
write.table(Relative, "Relative.txt", sep="\t", row.names=FALSE)
```


Export barcharts

```{r}
pdf(paste0(here::here(), "/Temperature.pdf"), width=8, height=4)
T.plot
dev.off()

pdf(paste0(here::here(), "/Precipitation.pdf"), width=8, height=4)
P.plot
dev.off()
```

