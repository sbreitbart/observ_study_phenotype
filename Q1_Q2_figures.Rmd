# Q1 / Gradient
## Distance from City Center
### Create ggpredict objects
```{r}

### Peduncles
peds_glmer_gradient_01
peds_gradient_01_pred <- ggeffects::ggpredict(peds_glmer_gradient_01,
                                   terms = c("City_dist", "Year"),
                                   type = "zero_inflated")

### Pollinia
poll_glmer_gradient_01.v2
poll_gradient_01_pred <- ggpredict(poll_glmer_gradient_01.v2,
                                   terms = c("City_dist", "Year"),
                                   type = "fe")

### Pods
pods_glmer_gradient_01
pods_gradient_01_pred <- ggpredict(pods_glmer_gradient_01,
                                   terms = c("City_dist", "Year"),
                                   type = "zero_inflated")

### Pods/Peduncle
podsperped_lmer_gradient_02
podsperped_gradient_01_pred <- ggpredict(podsperped_lmer_gradient_02,
                                         terms = c("City_dist", "Year"),
                                         type = "zero_inflated")


# Height
height_lmer_gradient_02
height_gradient_01_pred <- ggpredict(height_lmer_gradient_02,
                                     terms = c("City_dist", "Year"),
                                     type = "fe")
```

### Create plots
#### Include points, no stats (not included in paper)
```{r}
# 
# ### Peduncles
# ggpred_Q1.citydist_peds <- (ggplot(peds_gradient_01_pred) + 
#     geom_smooth(aes(x = x, y = predicted, color = group),
#                 se = F) +
#     geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) + 
#     geom_point(data = fertile_pops_all, 
#                aes(x = City_dist, y = Peduncles, colour = Year, shape = Year), size = 2)
# )+
#   scale_shape(solid = F)+
#   labs( color="Year", shape="Year", fill = "Year") +
#   ylim(0, 15) +
#   theme(
#     legend.position = c(.99, .99),
#     legend.justification = c("right", "top"),
#     legend.box = 'horizontal',
#     legend.box.just = "right",
#     legend.margin = margin(5,5,5,5),
#     text = element_text(size=14),
#     axis.title.x = element_blank(),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black"),
#     legend.key = element_rect(fill = NA) ) + 
#   labs(x = "Distance to city center (km)", 
#        y = "Inflorescences") 
# 
# 
# 
# 
# ### Pollen Removal
# ggpred_Q1.citydist_poll <- (ggplot(poll_gradient_01_pred) + 
#   geom_smooth(aes(x = x, y = predicted, color = group),
#               se = F) +
#   geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) + 
#   geom_point(data = AvgVars_notNA_Poll_18_19, 
#              aes(x = City_dist, y = Average_Pollinia, colour = Year, shape = Year), size = 2)
# )+
#   scale_shape(solid = F)+
#   scale_y_continuous(breaks=c(0,1,2,3,4,5), limits=c(0,5)) +
#   labs( color="Year", shape="Year", fill = "Year") +
#   theme(
#     legend.position = c(.99, .99),
#     legend.justification = c("right", "top"),
#     legend.box = 'horizontal',
#     legend.box.just = "right",
#     legend.margin = margin(5,5,5,5),
#     text = element_text(size=14),
#     axis.title.x = element_blank(),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black"),
#     legend.key = element_rect(fill = NA) ) + 
#   labs(x = "Distance to city center (km)", 
#        y = "Pollinaria Removed")
# 
# 
# 
# # Pods
# ggpred_Q1.citydist_pods <- (ggplot(pods_gradient_01_pred) + 
#     geom_smooth(aes(x = x, y = predicted, color = group),
#                 se = F) +
#     geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) + 
#     geom_point(data = fertile_pops_all, 
#                aes(x = City_dist, y = Viable_Pods^2, colour = Year, shape = Year), size = 2)
# )+
#   labs( color="Year", shape="Year", fill = "Year") +
#   ylim(0, 350) +
#   scale_shape(solid = F)+
#   theme(
#     legend.position = c(.99, .99),
#     legend.justification = c("right", "top"),
#     legend.box = 'horizontal',
#     legend.box.just = "right",
#     legend.margin = margin(5,5,5,5),
#     text = element_text(size=14),
#     axis.title.x = element_blank(),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black"),
#     legend.key = element_rect(fill = NA) ) + 
#   labs(x = "Distance to city center (km)", 
#        y = expression(Follicles^{2}))
# 
# 
# 
# 
# # Pods per Peduncle
# ggpred_Q1.citydist_podsperped <- (ggplot(podsperped_gradient_01_pred) + 
#     geom_smooth(aes(x = x, y = predicted, color = group),
#                 se = F) +
#     geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) + 
#     geom_point(data = fertile_pops_all, 
#                aes(x = City_dist, y = pods_per_ped, colour = Year, shape = Year), size = 2)
# )+
#   scale_shape(solid = F)+
#   labs( color="Year", shape="Year", fill = "Year") +
#   ylim(0, 3) +
#   theme(
#     legend.position = c(.99, .99),
#     legend.justification = c("right", "top"),
#     legend.box = 'horizontal',
#     legend.box.just = "right",
#     legend.margin = margin(5,5,5,5),
#     text = element_text(size=14),
#     axis.title.x = element_blank(),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black"),
#     legend.key = element_rect(fill = NA) ) + 
#   labs(x = "Distance to city center (km)", 
#        y = "Follicles per Inflorescence") 
# 
# 
# 
# # HEIGHT- DISTANCE
# ggpred_Q1.citydist_height <- (ggplot(height_gradient_01_pred) + 
#                                 geom_smooth(aes(x = x, y = predicted, color = group),
#                                             se = F) +
#                                 geom_ribbon(aes(x = x, ymin = predicted - std.error,
#                                                 ymax = predicted + std.error, fill = group),
#                                             alpha = 0.3) + 
#                                 geom_point(data = fertile_pops_all, 
#                                            aes(x = City_dist, y = Height_Sept,
#                                                colour = Year, shape = Year), size = 2)
# )+
#   labs(x = "Distance to Urban Center (km)", 
#        y = "Height (cm)") +
#   scale_shape(solid = F)+
#   labs(color="Year", size="Year", fill = "Year") +
#   scale_y_continuous(limits=c(0,200)) +
#   labs(linetype="Year", color="Year", shape = "Year") +
#   theme(legend.position = c(.99, .99),
#         legend.justification = c("right", "top"),
#         legend.box.just = "right",
#         legend.box = 'horizontal',
#         legend.margin = margin(5,5,5,5),
#         text = element_text(size=14),
#         panel.background = element_blank(),
#         axis.line = element_line(colour = "black"),
#         legend.key = element_rect(fill = NA) )
# ggpred_Q1.citydist_height

```

#### Exclude points and ADD STATS (as in paper)
```{r}

### Peduncles
ggpred_Q1.citydist_peds <- ggplot(peds_gradient_01_pred) +
    geom_smooth(aes(x = x, y = predicted, color = group),
                se = F) +
    geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) +
  labs( color="Year", shape="Year", fill = "Year") +
  ylim(0, 10) +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) ) +
  labs(x = "Distance to city center (km)",
       y = "Inflorescences") +
  # adding stats from ANOVA
           geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = " Distance: p = 0.226\n Year: p = 0.085\n Distance x Year: p = 0.791"),
                size = 4.5)
  # geom_text(size = 4.25, x=0, y=2.5, label = "Distance: p = 0.226", hjust = 0) +
  # geom_text(size = 4.25, x=0, y=1.6, label = "Year: p = 0.085", hjust = 0) +
  # geom_text(size = 4.25, x=0, y=0.7, label = "Distance x Year: p = 0.791", hjust = 0) 

ggpred_Q1.citydist_peds



### Pollen Removal
ggpred_Q1.citydist_poll <- ggplot(poll_gradient_01_pred) + 
  geom_smooth(aes(x = x, y = predicted, color = group),
              se = F) +
  geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) + 
  scale_y_continuous(
    # breaks=c(0,1,2,3,4,5),
    limits=c(0,2.5)) +
  labs( color="Year", shape="Year", fill = "Year") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) ) + 
  labs(x = "Distance to city center (km)", 
       y = "Pollinaria Removed") +
  # adding stats from ANOVA
           geom_text_npc(aes(npcx = 0.05, npcy = 0.01,
                    label = " Distance: p <0.001\n Year: p <0.001\n Distance x Year: p = 0.002"),
                size = 4.5)
# geom_text(size = 4.25, x=5, y=0.4, label = "Distance: p <0.001", hjust = 0) +
#   geom_text(size = 4.25, x=5, y=0.25, label = "Year: p <0.001", hjust = 0) +
#   geom_text(size = 4.25, x=5, y=0.1, label = "Distance x Year: p = 0.002", hjust = 0) 

ggpred_Q1.citydist_poll



# Pods
ggpred_Q1.citydist_pods <- ggplot(pods_gradient_01_pred) + 
    geom_smooth(aes(x = x, y = predicted, color = group),
                se = F) +
    geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) + 
  labs( color="Year", shape="Year", fill = "Year") +
  ylim(0, 200) +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) ) + 
  labs(x = "Distance to city center (km)", 
       y = expression(Follicles^{2})) +
  # adding stats from ANOVA
           geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = " Distance: p = 0.851\n Year: p <0.001\n Distance x Year: p <0.001"),
                size = 4.5)
# geom_text(size = 4.25, x=0, y=50, label = "Distance: p = 0.851", hjust = 0) +
  # geom_text(size = 4.25, x=0, y=30, label = "Year: p <0.001", hjust = 0) +
  # geom_text(size = 4.25, x=0, y=10, label = "Distance x Year: p <0.001", hjust = 0) 

ggpred_Q1.citydist_pods



# Pods per Peduncle
ggpred_Q1.citydist_podsperped <- ggplot(podsperped_gradient_01_pred) + 
    geom_smooth(aes(x = x, y = predicted, color = group),
                se = F) +
    geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) + 
  labs( color="Year", shape="Year", fill = "Year") +
  ylim(0, 2) +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) ) + 
  labs(x = "Distance to city center (km)", 
       y = "Follicles per Inflorescence") +
  # adding stats from ANOVA
           geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = " Distance: p = 0.065\n Year: p = 0.438\n   "),
                size = 4.5)
# geom_text(size = 4.25, x=0, y=.5, label = "Distance: p = 0.065", hjust = 0) +
#   geom_text(size = 4.25, x=0, y=.3, label = "Year: p = 0.438", hjust = 0)

ggpred_Q1.citydist_podsperped


# HEIGHT- DISTANCE
ggpred_Q1.citydist_height <- ggplot(height_gradient_01_pred) + 
    geom_smooth(aes(x = x, y = predicted, color = group),
                se = F) +
    geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) + 
  labs( color="Year", shape="Year", fill = "Year") +
    labs(x = "Distance to Urban Center (km)", 
       y = "Height (cm)") +
  ylim(70, 120) +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) ) + 
  # adding stats from ANOVA
          geom_text_npc(aes(npcx = 0.05, npcy = 0.06,
                    label = " Distance: p = 0.677\n Year: p = 0.032\n            "),
                size = 4.5)

# geom_text(size = 4.25, x=0, y=79, label = "Distance: p = 0.677", hjust = 0) +
#   geom_text(size = 4.25, x=0, y=75, label = "Year: p = 0.032", hjust = 0)

ggpred_Q1.citydist_height

```

### Combine plots into one figure
```{r}
Q1_regressions_citydist_ggpred <- ggarrange(ggpred_Q1.citydist_poll,
          ggpred_Q1.citydist_pods,
          ggpred_Q1.citydist_podsperped,
          ggpred_Q1.citydist_peds+
            font("x.text"),
          ncol = 4,
          nrow = 1,
          align = "hv",
          labels = list("A", "B", "C", "D"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot
```

### Find estimated marginal means at terminii
#### Peduncles
```{r}
# MEAN PEDUNCLES BY YEAR
mean_peds_q1 <- peds_gradient_01_pred %>%
  dplyr::group_by(group) %>%
  dplyr::summarise(mean_ped = mean(predicted)) %T>%
  view()

## PERCENT CHANGE, non-corr to corr subtransect:
perc_chg_peds_q1 <- mean_peds_q1 %>%
  as.data.frame() %>%
  dplyr::mutate(perc_chg_year = NA)

### percent change for 2018-2019
perc_chg_peds_q1[2,3] <- (perc_chg_peds_q1[2,2]-perc_chg_peds_q1[1,2])/perc_chg_peds_q1[1,2]



## PERCENT CHANGE, rural to urban terminii:
mean_peds_q1_2 <- peds_gradient_01_pred %>%
  dplyr::filter(., x == 0 | x == 70) %>%
  as.data.frame() %>%
  dplyr::mutate(perc_chg_urbrur = NA) %T>%
  view()

### percent change for 2018
mean_peds_q1_2[1,7] <- (mean_peds_q1_2[1,2]-mean_peds_q1_2[3,2])/mean_peds_q1_2[3,2]

### percent change for 2019
mean_peds_q1_2[2,7] <- (mean_peds_q1_2[2,2]-mean_peds_q1_2[4,2])/mean_peds_q1_2[4,2]

```

#### Pollinia
```{r}
# POLLINIA: along gradient & by year-----

# MEAN POLLINIA BY YEAR
mean_poll_q1 <- poll_gradient_01_pred %>%
  mutate(poll_per_flower = predicted / 5) %>%
  dplyr::group_by(group) %>%
  dplyr::summarise(mean_poll = mean(poll_per_flower)) %>%
  as.data.frame() %>%
  dplyr::mutate(perc_chg_year = NA) %T>%
  view()

### percent change for 2018-2019
mean_poll_q1[2,3] <- (mean_poll_q1[2,2]-mean_poll_q1[1,2])/mean_poll_q1[1,2]



## PERCENT CHANGE, rural to urban terminii:
mean_poll2_q1 <- poll_gradient_01_pred %>%
  mutate(poll_per_flower = predicted / 5) %>%
  dplyr::filter(., x == 0 | x == 70) %>%
  dplyr::group_by(group) %>%
  as.data.frame() %>%
  dplyr::mutate(perc_chg_urbrur = NA) %T>%
  view()

### percent change for 2018
mean_poll2_q1[1,8] <- (mean_poll2_q1[1,7]-mean_poll2_q1[3,7])/mean_poll2_q1[3,7]

### percent change for 2019
mean_poll2_q1[2,8] <- (mean_poll2_q1[2,7]-mean_poll2_q1[4,7])/mean_poll2_q1[4,7]

```

#### Pods
```{r}
# PODS: along gradient & by year-----
# MEAN PODS BY YEAR
mean_pods_q1 <- pods_gradient_01_pred %>%
  dplyr::group_by(group) %>%
  dplyr::mutate(mean_pod_sqrt = sqrt(predicted)) %>%
  dplyr::summarise(mean_pod_sqrt = mean(mean_pod_sqrt)) %T>%
  view()

## PERCENT CHANGE, non-corr to corr subtransect:
perc_chg_pods_q1 <- mean_pods_q1 %>%
  as.data.frame() %>%
  dplyr::mutate(perc_chg_year = NA)

### percent change for 2018-2019
perc_chg_pods_q1[2,3] <- (perc_chg_pods_q1[2,2]-perc_chg_pods_q1[1,2])/perc_chg_pods_q1[1,2]



## PERCENT CHANGE, rural to urban terminii:
mean_pods_q1_2 <- pods_gradient_01_pred %>%
  dplyr::filter(., x == 0 | x == 70) %>%
  dplyr::mutate(mean_pod_sqrt = sqrt(predicted)) %>%
  as.data.frame() %>%
  dplyr::mutate(perc_chg_urbrur = NA) %T>%
  view()

### percent change for 2018
mean_pods_q1_2[1,8] <- (mean_pods_q1_2[1,7]-mean_pods_q1_2[3,7])/mean_pods_q1_2[3,7]

### percent change for 2019
mean_pods_q1_2[2,8] <- (mean_pods_q1_2[2,7]-mean_pods_q1_2[4,7])/mean_pods_q1_2[4,7]

```

#### Pods per peduncle
```{r}
# PODS PER PED: along gradient-----
## PERCENT CHANGE, rural to urban terminii:
mean_ppp_q1_2 <- podsperped_gradient_01_pred %>%
  dplyr::filter(., x == 0 | x == 70) %>%
  as.data.frame() %>%
  dplyr::mutate(perc_chg_urbrur = NA) %T>%
  view()

### percent change for 2018
mean_ppp_q1_2[1,7] <- (mean_ppp_q1_2[1,2]-mean_ppp_q1_2[3,2])/mean_ppp_q1_2[3,2]

### percent change for 2019
mean_ppp_q1_2[2,7] <- (mean_ppp_q1_2[2,2]-mean_ppp_q1_2[4,2])/mean_ppp_q1_2[4,2]

```

## Urbanization Score
### Create ggpredict objects
```{r}

### Peduncles
u_peds_glmer_gradient_01
peds_gradient_01_pred.u <- ggpredict(u_peds_glmer_gradient_01,
                                     terms = c("Urb_score", "Year"),
                                     type = "zero_inflated")

### Pollinia
u_poll_glmer_gradient_1
poll_gradient_01_pred.u <- ggpredict(u_poll_glmer_gradient_1,
                                     terms = c("Urb_score", "Year"),
                                     type = "fe")

### Pods
u_pods_glmer_gradient_1
pods_gradient_01_pred.u <- ggpredict(u_pods_glmer_gradient_1,
                                     terms = c("Urb_score", "Year"),
                                     type = "zero_inflated")

### Pods/Peduncle
u_podsperped_lmer_gradient_02
podsperped_gradient_01_pred.u <- ggpredict(u_podsperped_lmer_gradient_02,
                                           terms = c("Urb_score", "Year"),
                                           type = "fe")



# HEIGHT- URB SCORE
u_height_lmer_gradient_01
height_gradient_01_pred.u <- ggpredict(u_height_lmer_gradient_01,
                                       terms = c("Urb_score", "Year"),
                                       type = "fe")


```

### Create plots
#### Include points, no stats (not included in paper)
```{r}
# 
# ### Peduncles
# ggpred_Q1.urbscore_peds <- (ggplot(peds_gradient_01_pred.u) + 
#                               geom_smooth(aes(x = x, y = predicted, color = group),
#                                           se = F) +
#                               geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) + 
#                               geom_point(data = fertile_pops_all, 
#                                          aes(x = Urb_score, y = Peduncles, colour = Year, shape = Year), size = 2)
# )+
#   scale_shape(solid = F)+
#   xlim(-4, 4) +
#   scale_x_reverse() +
#   labs( color="Year", shape="Year", fill = "Year") +
#   ylim(0, 15) +
#   theme(
#     legend.position = c(.99, .99),
#     legend.justification = c("right", "top"),
#     legend.box = 'horizontal',
#     legend.box.just = "right",
#     legend.margin = margin(5,5,5,5),
#     text = element_text(size=14),
#     # axis.title.x = element_blank(),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black"),
#     legend.key = element_rect(fill = NA) ) + 
#   labs(x = "Urbanization Score", 
#        y = "Inflorescences") 
# 
# 
# 
# 
# ### Pollen Removal
# ggpred_Q1.urbscore_poll <- (ggplot(poll_gradient_01_pred.u) + 
#                               geom_smooth(aes(x = x, y = predicted, color = group),
#                                           se = F) +
#                               geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) + 
#                               geom_point(data = AvgVars_notNA_Poll_18_19, 
#                                          aes(x = Urb_score, y = Average_Pollinia, colour = Year, shape = Year), size = 2)
# )+
#   scale_shape(solid = F)+
#   xlim(-4, 4) +
#   scale_x_reverse() +
#   scale_y_continuous(breaks=c(0,1,2,3,4,5), limits=c(0,5)) +
#   labs( color="Year", shape="Year", fill = "Year") +
#   theme(
#     legend.position = c(.99, .99),
#     legend.justification = c("right", "top"),
#     legend.box = 'horizontal',
#     legend.box.just = "right",
#     legend.margin = margin(5,5,5,5),
#     text = element_text(size=14),
#     # axis.title.x = element_blank(),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black"),
#     legend.key = element_rect(fill = NA) ) + 
#   labs(x = "Urbanization Score", 
#        y = "Pollinaria Removed")
# 
# 
# 
# 
# # Pods
# ggpred_Q1.urbscore_pods <- (ggplot(pods_gradient_01_pred.u) + 
#                               geom_smooth(aes(x = x, y = predicted, color = group),
#                                           se = F) +
#                               geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) + 
#                               geom_point(data = fertile_pops_all, 
#                                          aes(x = Urb_score, y = Viable_Pods^3, colour = Year, shape = Year), size = 2)
# )+
#   labs( color="Year", shape="Year", fill = "Year") +
#   # ylim(0, 350) +
#   xlim(-4, 4) +
#   scale_x_reverse() +
#   scale_shape(solid = F)+
#   theme(
#     legend.position = c(.99, .99),
#     legend.justification = c("right", "top"),
#     legend.box = 'horizontal',
#     legend.box.just = "right",
#     legend.margin = margin(5,5,5,5),
#     text = element_text(size=14),
#     # axis.title.x = element_blank(),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black"),
#     legend.key = element_rect(fill = NA) ) + 
#   labs(x = "Urbanization Score", 
#        y = expression(Follicles^{3}))
# 
# 
# 
# 
# # Pods per Peduncle
# ggpred_Q1.urbscore_podsperped <- (ggplot(podsperped_gradient_01_pred.u) + 
#                                     geom_smooth(aes(x = x, y = predicted, color = group),
#                                                 se = F) +
#                                     geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) + 
#                                     geom_point(data = fertile_pops_all, 
#                                                aes(x = Urb_score, y = pods_per_ped, colour = Year, shape = Year), size = 2)
# )+
#   scale_shape(solid = F)+
#   xlim(-4, 4) +
#   scale_x_reverse() +
#   labs( color="Year", shape="Year", fill = "Year") +
#   ylim(0, 3) +
#   theme(
#     legend.position = c(.99, .99),
#     legend.justification = c("right", "top"),
#     legend.box = 'horizontal',
#     legend.box.just = "right",
#     legend.margin = margin(5,5,5,5),
#     text = element_text(size=14),
#     # axis.title.x = element_blank(),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black"),
#     legend.key = element_rect(fill = NA) ) + 
#   labs(x = "Urbanization Score", 
#        y = "Follicles per Inflorescence") 
# 
# 
# 
# 
# ggpred_Q1.citydist_height.u <- (ggplot(height_gradient_01_pred.u) + 
#                                   geom_smooth(aes(x = x, y = predicted, color = group),
#                                               se = F) +
#                                   geom_ribbon(aes(x = x, ymin = predicted - std.error,
#                                                   ymax = predicted + std.error, fill = group),
#                                               alpha = 0.3) + 
#                                   geom_point(data = fertile_pops_all, 
#                                              aes(x = Urb_score, y = Height_Sept,
#                                                  colour = Year, shape = Year), size = 2)
# )+
#   labs(x = "Urbanization Score", 
#        y = "Height (cm)") +
#   scale_shape(solid = F)+
#   labs(color="Year", size="Year", fill = "Year") +
#   scale_x_reverse() +
#   xlim(3.5, -4) +
#   scale_y_continuous(limits=c(0,200)) +
#   labs(linetype="Year", color="Year", shape = "Year") +
#   theme(legend.position = c(.99, .99),
#         legend.justification = c("right", "top"),
#         legend.box.just = "right",
#         legend.box = 'horizontal',
#         legend.margin = margin(5,5,5,5),
#         text = element_text(size=14),
#         panel.background = element_blank(),
#         axis.line = element_line(colour = "black"),
#         legend.key = element_rect(fill = NA) )
# ggpred_Q1.citydist_height.u
```

#### Exclude points, ADD stats (as in paper)
```{r}

### Peduncles
ggpred_Q1.urbscore_peds <- ggplot(peds_gradient_01_pred.u) +
    geom_smooth(aes(x = x, y = predicted, color = group),
                se = F) +
    geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) +
  xlim(-4, 4) +
  scale_x_reverse() +
  scale_shape(solid = F)+
  labs( color="Year", shape="Year", fill = "Year") +
  ylim(5, NA) +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) ) +
  labs(x = "Urbanization Score",
       y = "Inflorescences") +
  # adding stats from ANOVA
        geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = " Urb. Score: p = 0.545\n Year: p = 0.081\n Urb. Score x Year: p = 0.876"),
                size = 4.5)
# geom_text(size = 4.25, x=-3, y=5.75, label = "Urb. Score: p = 0.545", hjust = 0) +
#   geom_text(size = 4.25, x=-3, y=5.5, label = "Year: p = 0.081", hjust = 0)  +
#   geom_text(size = 4.25, x=-3, y=5.25, label = "Urb. Score x Year: p = 0.876", hjust = 0) 
ggpred_Q1.urbscore_peds




### Pollen Removal
ggpred_Q1.urbscore_poll <- ggplot(poll_gradient_01_pred.u) +
                                 geom_smooth(aes(x = x,
                                                 y = predicted,
                                                 color = group),
                                             se = F) +
    geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error, fill = group),  alpha = 0.3) +
  xlim(-4, 4) +
  ylim(0, NA) +
  scale_x_reverse() +
  scale_shape(solid = F)+
  labs( color="Year", shape="Year", fill = "Year") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) ) +
  labs(x = "Urbanization Score",
       y = "Pollinaria Removed")+
  # adding stats from ANOVA
      geom_text_npc(aes(npcx = 0.1, npcy = 0.04,
                    label = " Urb. Score: p = 0.015\n Year: p<0.001\n Urb. Score x Year: p<0.001"),
                size = 4.5)
# geom_text(size = 4.25, x=-3, y=0.4, label = "Urb. Score: p = 0.015", hjust = 0) +
#   geom_text(size = 4.25, x=-3, y=0.25, label = "Year: p<0.001", hjust = 0) +
#   geom_text(size = 4.25, x=-3, y=0.1, label = "Urb. Score x Year: p<0.001", hjust = 0)
ggpred_Q1.urbscore_poll



# Pods
ggpred_Q1.urbscore_pods <- ggplot(pods_gradient_01_pred.u) +
                                 geom_smooth(aes(x = x,
                                                 y = predicted,
                                                 color = group),
                                             se = F) +
    geom_ribbon(aes(x = x, ymin = predicted - std.error,
                    ymax = predicted + std.error, fill = group),
                alpha = 0.3) +
  xlim(-4, 4) +
  ylim(1000, NA) +
  scale_x_reverse() +
  scale_shape(solid = F)+
  labs( color="Year", shape="Year", fill = "Year") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) ) +
  labs(x = "Urbanization Score",
       y = expression(Follicles^{3}))+
  # adding stats from ANOVA
    geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = " Urb. Score: p = 0.62\n Year: p<0.001\n Urb. Score x Year: p<0.001"),
                size = 4.5)
  # geom_text(size = 4.25, x=-3, y=1450, label = "Urb. Score: p = 0.62", hjust = 0) +
  # geom_text(size = 4.25, x=-3, y=1250, label = "Year: p<0.001", hjust = 0) +
  # geom_text(size = 4.25, x=-3, y=1050, label = "Urb. Score x Year: p<0.001", hjust = 0)
ggpred_Q1.urbscore_pods



# Pods per Peduncle
ggpred_Q1.urbscore_podsperped <- ggplot(podsperped_gradient_01_pred.u) +
                                 geom_smooth(aes(x = x,
                                                 y = predicted,
                                                 color = group),
                                             se = F) +
    geom_ribbon(aes(x = x, ymin = predicted - std.error,
                    ymax = predicted + std.error, fill = group),
                alpha = 0.3) +
  xlim(-4, 4) +
  ylim(0, 2) +
  scale_x_reverse() +
  scale_shape(solid = F)+
  labs( color="Year", shape="Year", fill = "Year") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) ) +
  labs(x = "Urbanization Score",
       y = "Follicles per Inflorescence")+
  # adding stats from ANOVA
  geom_text_npc(aes(npcx = 0.05, npcy = 0.06,
                    label = " Urb. Score: p = 0.032\n Year: p = 0.347\n      "),
                size = 4.5)
  # geom_text(size = 4.25, x=-3, y=0.45, label = "Urb. Score: p = 0.032", hjust = 0) +
  # geom_text(size = 4.25, x=-3, y=0.25, label = "Year: p = 0.347", hjust = 0)

ggpred_Q1.urbscore_podsperped




ggpred_Q1.citydist_height.u <- ggplot(height_gradient_01_pred.u) +
                                  geom_smooth(aes(x = x,
                                                 y = predicted,
                                                 color = group),
                                             se = F) +
    geom_ribbon(aes(x = x, ymin = predicted - std.error,
                    ymax = predicted + std.error, fill = group),
                alpha = 0.3) +
  xlim(-4, 4) +
  ylim(70, 110) +
  scale_x_reverse() +
  scale_shape(solid = F)+
  labs( color="Year", shape="Year", fill = "Year") +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box = 'horizontal',
    legend.box.just = "right",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA) ) +
  labs(x = "Urbanization Score",
       y = "Height (cm)") +
  # adding stats from ANOVA
  # geom_text(size = 4.25, x=-3, y=78, label = "Urb. Score: p = 0.453", hjust = 0) +
  # geom_text(size = 4.25, x=-3, y=75, label = "Year: p = 0.085", hjust = 0) +
  # geom_text(size = 4.25, x=-3, y=72, label = "Urb. Score x Year: p = 0.088", hjust = 0) +
  geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = " Urb. Score: p = 0.453\n Year: p = 0.085\n Urb. Score x Year: p = 0.088"),
                size = 4.5)

ggpred_Q1.citydist_height.u
```

### Combine plots into one figure
## Final Figure: Main text
```{r}

city_plots.ggpred <- annotate_figure(Q1_regressions_citydist_ggpred,
                                     bottom = text_grob("Distance to Urban Center (km)",
                                                        size=14))

dev.copy2pdf(file="~/R_Projects/chapter_one/Figures_Tables/Q1_Gradient/DISTGradient_regressions_nopoints.pdf",
             width = 12.5, height = 3.75)

```

## Final Figure: Supplement
```{r}
Q1_regressions_urbscore_ggpred <- ggarrange(ggpred_Q1.citydist_height, # city_dist
                                            ggpred_Q1.urbscore_poll, # urb_score
                                            ggpred_Q1.urbscore_pods, # urb_score
                                            ggpred_Q1.urbscore_podsperped, # urb_score
                                            ggpred_Q1.urbscore_peds , # urb_score
                                            ggpred_Q1.citydist_height.u + # urb_score
                                              font("x.text"),
                                            ncol = 3,
                                            nrow = 2,
                                            align = "hv",
                                            labels = list("A", "B", "C",
                                                          "D", "E", "F"),
                                            font.label = (size =16),
                                            common.legend = T,
                                            legend = "right") %T>%
  plot

dev.copy2pdf(file="~/R_Projects/chapter_one/Figures_Tables/Q1_Gradient/URBSCOREGradient_regressions_nopoints.pdf",
             width = 12, height = 7)


```


# Q2 / Subtransects
## Distance from City Center
### Create ggpredict objects
```{r}

### Peduncles
peds_glmer_subtr_01
peds_subtr_01_pred <- ggpredict(peds_glmer_subtr_01,
                                   terms = c("City_dist", "Year", "Transect_ID"),
                                   type = "zero_inflated")

### Pollinia
poll_glmer_subtr_01
poll_subtr_01_pred <- ggpredict(poll_glmer_subtr_01,
                                   terms = c("City_dist", "Year", "Transect_ID"),
                                   type = "fe")

### Pods
pods_glmer_subtr_03
pods_subtr_01_pred <- ggpredict(pods_glmer_subtr_03,
                                   terms = c("City_dist", "Year", "Transect_ID"),
                                   type = "zero_inflated")

### Pods/Peduncle
podsperped_lmer_subtr_08
podsperped_subtr_01_pred <- ggpredict(podsperped_lmer_subtr_08,
                                         terms = c("City_dist", "Year", "Transect_ID"),
                                         type = "fe") %T>% view()

### Height- DISTANCE
height_lmer_subtr_01
height_subtr_01_pred <- ggpredict(height_lmer_subtr_01,
                                  terms = c("City_dist", "Year", "Transect_ID"),
                                  type = "fe")
```

### Create plots
#### Include points, no stats (not included in paper)
```{r}
ggpred_Q2.citydist_peds <- (ggplot(peds_subtr_01_pred) +
                              geom_smooth(aes(x = x,
                                              y = predicted,
                                              color = facet,
                                              linetype = group),
                                          method = "loess",
                                          se = F) +
                              geom_ribbon(aes(x = x,
                                              ymin = predicted - std.error,
                                              ymax = predicted + std.error,
                                              fill = facet,
                                              linetype = group),
                                          alpha = 0.2)) + 
  geom_point(data = fertile_pops_all %>%
               filter(Transect_ID != "Rural"),
             aes(x = City_dist, y = Peduncles,
                 colour = Transect_ID,
                 shape = interaction(Year, Transect_ID)),
             size = 3) +
  scale_y_continuous(limits=c(0,15)) +
  labs(x = "Distance to Urban Center (km)",
       y = "Inflorescences") +
  scale_shape_manual(values = c(16,2,17,1)) +
  theme(legend.position = c(.99, .99),
        legend.justification = c("right", "top"),
        legend.box = 'horizontal',
        legend.box.just = "right",
        legend.margin = margin(5,5,5,5),
        text = element_text(size=14),
        axis.title.x = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_rect(fill = NA),
        legend.key.size = unit(2, "line") )



## factors (transects) for this object are North, then South
## for some reason (peduncles and at least one more is South, North)
## so to keep legend consistent, have to reorder levels first
poll_subtr_01_pred$facet <- factor(poll_subtr_01_pred$facet,
                                   levels(poll_subtr_01_pred$facet)[c(2,1)])
levels(poll_subtr_01_pred$facet)

ggpred_Q2.citydist_poll <- (ggplot(poll_subtr_01_pred) +
                              geom_smooth(aes(x = x,
                                              y = predicted,
                                              color = facet,
                                              linetype = group),
                                          method = "loess",
                                          se = F) +
                              geom_ribbon(aes(x = x,
                                              ymin = predicted - std.error,
                                              ymax = predicted + std.error,
                                              fill = facet,
                                              linetype = group),
                                          alpha = 0.2)) + 
  geom_point(data = AvgVars_notNA_Poll_18_19 %>%
               filter(Transect_ID != "Rural"),
             aes(x = City_dist, y = Average_Pollinia,
                 colour = Transect_ID,
                 shape = interaction(Year, Transect_ID)),
             size = 3) +
  scale_y_continuous(breaks=c(0,1,2,3), limits=c(0,3)) +
  labs(x = "Distance to Urban Center (km)",
       y = "Pollinaria Removed") +
  scale_shape_manual(values = c(16,2,17,1)) +
  theme(legend.position = c(.99, .99),
        legend.justification = c("right", "top"),
        legend.box = 'horizontal',
        legend.box.just = "right",
        legend.margin = margin(5,5,5,5),
        text = element_text(size=14),
        axis.title.x = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_rect(fill = NA),
        legend.key.size = unit(2, "line") ) 




ggpred_Q2.citydist_pods <- (ggplot(pods_subtr_01_pred) +
                              geom_smooth(aes(x = x,
                                              y = predicted,
                                              color = facet,
                                              linetype = group),
                                          method = "loess",
                                          se = F) +
                              geom_ribbon(aes(x = x,
                                              ymin = predicted - std.error,
                                              ymax = predicted + std.error,
                                              fill = facet,
                                              linetype = group),
                                          alpha = 0.2)) + 
  geom_point(data = fertile_pops_all %>%
               filter(Transect_ID != "Rural"),
             aes(x = City_dist, y = Viable_Pods^2,
                 colour = Transect_ID,
                 shape = interaction(Year, Transect_ID)),
             size = 3) +
  scale_y_continuous(limits=c(0,350)) +
  labs(x = "Distance to Urban Center (km)",
       y = expression(Follicles^{2})) +
  scale_shape_manual(values = c(16,2,17,1)) +
  theme(legend.position = c(.99, .99),
        legend.justification = c("right", "top"),
        legend.box = 'horizontal',
        legend.box.just = "right",
        legend.margin = margin(5,5,5,5),
        text = element_text(size=14),
        axis.title.x = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_rect(fill = NA),
        legend.key.size = unit(2, "line") )


## factors (transects) for this object are North, then South
## so to keep legend consistent, have to reorder levels first
podsperped_subtr_01_pred$facet <- factor(podsperped_subtr_01_pred$facet,
                                         levels(podsperped_subtr_01_pred$facet)[c(2,1)])
levels(podsperped_subtr_01_pred$facet)

ggpred_Q2.citydist_podsperped <- (ggplot(podsperped_subtr_01_pred) +
                                    geom_smooth(aes(x = x,
                                                    y = predicted,
                                                    color = facet,
                                                    linetype = group),
                                                method = "loess",
                                                se = F) +
                                    geom_ribbon(aes(x = x,
                                                    ymin = predicted - std.error,
                                                    ymax = predicted + std.error,
                                                    fill = facet,
                                                    linetype = group),
                                                alpha = 0.2)) + 
  geom_point(data = fertile_pops_all %>%
               filter(Transect_ID != "Rural"),
             aes(x = City_dist, y = pods_per_ped,
                 colour = Transect_ID,
                 shape = interaction(Year, Transect_ID)),
             size = 3) +
  scale_y_continuous(limits=c(0,3)) +
  labs(x = "Distance to Urban Center (km)",
       y = "Follicles per Inflorescence") +
  scale_shape_manual(values = c(16,2,17,1)) +
  theme(legend.position = c(.99, .99),
        legend.justification = c("right", "top"),
        legend.box = 'horizontal',
        legend.box.just = "right",
        legend.margin = margin(5,5,5,5),
        text = element_text(size=14),
        axis.title.x = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_rect(fill = NA),
        legend.key.size = unit(2, "line") )



## factors (transects) for this object are North, then South
## so to keep legend consistent, have to reorder levels first
height_subtr_01_pred$facet <- factor(height_subtr_01_pred$facet,
                                     levels(height_subtr_01_pred$facet)[c(2,1)])
levels(height_subtr_01_pred$facet)

ggpred_Q2.citydist_height <- (ggplot(height_subtr_01_pred) +
                                geom_smooth(aes(x = x,
                                                y = predicted,
                                                color = facet,
                                                linetype = group),
                                            method = "loess",
                                            se = F) +
                                geom_ribbon(aes(x = x,
                                                ymin = predicted - std.error,
                                                ymax = predicted + std.error,
                                                fill = facet,
                                                linetype = group),
                                            alpha = 0.2)) + 
  geom_point(data = fertile_pops_all %>%
               filter(Transect_ID != "Rural"),
             aes(x = City_dist, y = Height_Sept,
                 colour = Transect_ID,
                 shape = interaction(Year, Transect_ID)),
             size = 3) +
  scale_y_continuous(limits=c(0,200)) +
  labs(x = "Distance to Urban Center (km)",
       y = "Height (cm)") +
  scale_shape_manual(values = c(16,2,17,1)) +
  theme( #legend.position = c(.97, .99),
    legend.justification = c("center"),
    legend.box = 'horizontal',
    legend.box.just = "center",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") )

```



#### Exclude points, and ADD stats (as in paper)
```{r}
ggpred_Q2.citydist_peds <- (ggplot(peds_subtr_01_pred) +
                              geom_smooth(aes(x = x,
                                              y = predicted,
                                              color = group,
                                              linetype = facet),
                                          method = "loess",
                                          se = F) +
                              geom_ribbon(aes(x = x,
                                              ymin = predicted - std.error,
                                              ymax = predicted + std.error,
                                              fill = group,
                                              linetype = facet),
                                          alpha = 0.2)) + 
  # geom_point(data = fertile_pops_all %>%
  #              filter(Transect_ID != "Rural"),
  #            aes(x = City_dist, y = Peduncles,
  #                colour = Transect_ID,
  #                shape = interaction(Year, Transect_ID)),
  #            size = 3) +
  scale_y_continuous(limits=c(0,10), breaks = c(0,2,4,6,8,10)) +
  labs(x = "Distance to Urban Center (km)",
       y = "Inflorescences") +
  # scale_shape_manual(values = c(16,2,17,1)) +
  theme(legend.position = c(.99, .99),
        legend.justification = c("right", "top"),
        legend.box = 'horizontal',
        legend.box.just = "right",
        legend.margin = margin(5,5,5,5),
        text = element_text(size=14),
        axis.title.x = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_rect(fill = NA),
        legend.key.size = unit(2, "line") ) 
  
ggpred_Q2.citydist_peds




## factors (transects) for this object are North, then South
## for some reason (peduncles and at least one more is South, North)
## so to keep legend consistent, have to reorder levels first
poll_subtr_01_pred$facet <- factor(poll_subtr_01_pred$facet,
                                   levels(poll_subtr_01_pred$facet)[c(2,1)])
levels(poll_subtr_01_pred$facet)

ggpred_Q2.citydist_poll <- (ggplot(poll_subtr_01_pred) +
                              geom_smooth(aes(x = x,
                                              y = predicted,
                                              color = group,
                                              linetype = facet),
                                          method = "loess",
                                          se = F) +
                              geom_ribbon(aes(x = x,
                                              ymin = predicted - std.error,
                                              ymax = predicted + std.error,
                                              fill = group,
                                              linetype = facet),
                                          alpha = 0.2)) + 
  # geom_point(data = AvgVars_notNA_Poll_18_19 %>%
  #              filter(Transect_ID != "Rural"),
  #            aes(x = City_dist, y = Average_Pollinia,
  #                colour = Transect_ID,
  #                shape = interaction(Year, Transect_ID)),
  #            size = 3) +
  scale_y_continuous(
    # breaks=c(0,1,2,3),
    limits=c(0,2.5)) +
  labs(x = "Distance to Urban Center (km)",
       y = "Pollinaria Removed") +
  # scale_shape_manual(values = c(16,2,17,1)) +
  theme(legend.position = c(.99, .99),
        legend.justification = c("right", "top"),
        legend.box = 'horizontal',
        legend.box.just = "right",
        legend.margin = margin(5,5,5,5),
        text = element_text(size=14),
        axis.title.x = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_rect(fill = NA),
        legend.key.size = unit(2, "line") ) 
ggpred_Q2.citydist_poll



ggpred_Q2.citydist_pods <- (ggplot(pods_subtr_01_pred) +
                              geom_smooth(aes(x = x,
                                              y = predicted,
                                              color = group,
                                              linetype = facet),
                                          method = "loess",
                                          se = F) +
                              geom_ribbon(aes(x = x,
                                              ymin = predicted - std.error,
                                              ymax = predicted + std.error,
                                              fill = group,
                                              linetype = facet),
                                          alpha = 0.2)) + 
  # geom_point(data = fertile_pops_all %>%
  #              filter(Transect_ID != "Rural"),
  #            aes(x = City_dist, y = Viable_Pods^2,
  #                colour = Transect_ID,
  #                shape = interaction(Year, Transect_ID)),
  #            size = 3) +
  # scale_y_continuous(limits=c(0,350)) +
  labs(x = "Distance to Urban Center (km)",
       y = expression(Follicles^{2})) +
  # scale_shape_manual(values = c(16,2,17,1)) +
  theme(legend.position = c(.99, .99),
        legend.justification = c("right", "top"),
        legend.box = 'horizontal',
        legend.box.just = "right",
        legend.margin = margin(5,5,5,5),
        text = element_text(size=14),
        axis.title.x = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_rect(fill = NA),
        legend.key.size = unit(2, "line") )
ggpred_Q2.citydist_pods



## factors (transects) for this object are North, then South
## so to keep legend consistent, have to reorder levels first
podsperped_subtr_01_pred$facet <- factor(podsperped_subtr_01_pred$facet,
                                         levels(podsperped_subtr_01_pred$facet)[c(2,1)])
levels(podsperped_subtr_01_pred$facet)

ggpred_Q2.citydist_podsperped <- (ggplot(podsperped_subtr_01_pred) +
                                    geom_smooth(aes(x = x,
                                                    y = predicted,
                                                   color = group, 
                                                   linetype = facet),
                                                method = "loess",
                                                se = F) +
                                    geom_ribbon(aes(x = x,
                                                    ymin = predicted - std.error,
                                                    ymax = predicted + std.error,
                                                    fill = group,
                                                    linetype = facet),
                                                alpha = 0.2)) + 
  # geom_point(data = fertile_pops_all %>%
  #              filter(Transect_ID != "Rural"),
  #            aes(x = City_dist, y = pods_per_ped,
  #                colour = Transect_ID,
  #                shape = interaction(Year, Transect_ID)),
  #            size = 3) +
  scale_y_continuous(limits=c(0,2.5)) +
  labs(x = "Distance to Urban Center (km)",
       y = "Follicles per Inflorescence") +
  # scale_shape_manual(values = c(16,2,17,1)) +
  theme(legend.position = c(.99, .99),
        legend.justification = c("right", "top"),
        legend.box = 'horizontal',
        legend.box.just = "right",
        legend.margin = margin(5,5,5,5),
        text = element_text(size=14),
        axis.title.x = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key = element_rect(fill = NA),
        legend.key.size = unit(2, "line") )
ggpred_Q2.citydist_podsperped




## factors (transects) for this object are North, then South
## so to keep legend consistent, have to reorder levels first
height_subtr_01_pred$facet <- factor(height_subtr_01_pred$facet,
                                     levels(height_subtr_01_pred$facet)[c(2,1)])
levels(height_subtr_01_pred$facet)

ggpred_Q2.citydist_height <- ggplot(height_subtr_01_pred) +
                              geom_smooth(aes(x = x,
                                              y = predicted,
                                              color = group,
                                              linetype = facet),
                                          method = "loess",
                                          se = F) +
                              geom_ribbon(aes(x = x,
                                              ymin = predicted - std.error,
                                              ymax = predicted + std.error,
                                              fill = group,
                                              linetype = facet),
                                          alpha = 0.2) + 
  ylim(40,130) +
  scale_x_continuous(limits = c(0, 35)) +
  theme( #legend.position = c(.97, .99),
    legend.justification = c("center"),
    legend.box = 'horizontal',
    legend.box.just = "center",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") ) +
  labs(x = "Distance to Urban Center (km)",
       y = "Height (cm)") 
ggpred_Q2.citydist_height
```


### Find estimated marginal means at terminii
#### PEDUNCLES
```{r}

# MEAN PEDUNCLES BY YEAR AND TRANSECT
mean_peds <- peds_subtr_01_pred %>%
  dplyr::group_by(group, facet) %>%
  dplyr::summarise(mean_ped = mean(predicted)) %T>%
  view()

## PERCENT CHANGE, non-corr to corr subtransect:
perc_chg_peds <- mean_peds %>%
  as.data.frame() %>%
  dplyr::mutate(perc_chg_year = NA)

### percent change for 2018
perc_chg_peds[1,4] <- (perc_chg_peds[1,3]-perc_chg_peds[2,3])/perc_chg_peds[2,3]

### percent change for 2019
perc_chg_peds[3,4] <- (perc_chg_peds[3,3]-perc_chg_peds[4,3])/perc_chg_peds[4,3]





## PERCENT CHANGE, rural to urban terminii:
mean_peds2 <- peds_subtr_01_pred %>%
  dplyr::filter(., x == 2 | x == 34) %>%
  dplyr::group_by(x, group) %>%
  dplyr::summarise(terminus_mean = mean(predicted)) %T>%
  view()

perc_chg_peds2 <- mean_peds2 %>%
  as.data.frame() %>%
  dplyr::mutate(perc_chg_urbrur = NA)

### percent change for 2018
perc_chg_peds2[1,4] <- (perc_chg_peds2[1,3]-perc_chg_peds2[3,3])/perc_chg_peds2[3,3]

### percent change for 2019
perc_chg_peds2[2,4] <- (perc_chg_peds2[2,3]-perc_chg_peds2[4,3])/perc_chg_peds2[4,3]

```

#### Pollinia
```{r}

# MEAN POLLINIA REMOVED BY YEAR AND TRANSECT
mean_poll <- poll_subtr_01_pred %>%
  mutate(poll_per_flower = predicted / 5) %>%
  dplyr::group_by(group, facet) %>%
  dplyr::summarise(mean_poll = mean(poll_per_flower)) %T>%
  view()

## PERCENT CHANGE, non-corr to corr subtransect:
perc_chg_poll <- mean_poll %>%
  as.data.frame() %>%
  dplyr::mutate(perc_chg_year = NA)

### percent change for 2018
perc_chg_poll[2,4] <- (perc_chg_poll[2,3]-perc_chg_poll[1,3])/perc_chg_poll[1,3]

### percent change for 2019
perc_chg_poll[4,4] <- (perc_chg_poll[4,3]-perc_chg_poll[3,3])/perc_chg_poll[3,3]




## PERCENT CHANGE, rural to urban terminii:
mean_poll2 <- poll_subtr_01_pred %>%
  mutate(poll_per_flower = predicted / 5) %>%
  dplyr::filter(., x == 2 | x == 34) %>%
  as.data.frame() %>%
  dplyr::mutate(perc_chg_urbrur = NA) %>%
  # dplyr::group_by(x, group, facet) %>%
  # dplyr::summarise(terminus_mean = mean(poll_per_flower))  %T>%
  view()

### percent change for 2018: rural to urban terminus, NON-CORRIDOR
mean_poll2[1,9] <- (mean_poll2[1,8]-mean_poll2[5,8])/mean_poll2[5,8]

### percent change for 2018: rural to urban terminus, CORRIDOR
mean_poll2[2,9] <- (mean_poll2[2,8]-mean_poll2[6,8])/mean_poll2[6,8]


### percent change for 2019: rural to urban terminus, NON-CORRIDOR
mean_poll2[3,9] <- (mean_poll2[3,8]-mean_poll2[7,8])/mean_poll2[7,8]

### percent change for 2019: rural to urban terminus, CORRIDOR
mean_poll2[4,9] <- (mean_poll2[4,8]-mean_poll2[8,8])/mean_poll2[8,8]

```

#### Pods
```{r}

# MEAN PODS BY YEAR AND TRANSECT
mean_pods <- pods_subtr_01_pred %>%
  dplyr::mutate(sqrt_pods = sqrt(predicted)) %>%
  dplyr::group_by(x, group) %>%
  dplyr::summarise(mean_sqrt_pods = mean(sqrt_pods)) %>%
  dplyr::group_by(group) %>%
  dplyr::summarise(mean_sqrt_pods = mean(mean_sqrt_pods)) %>%
  dplyr::mutate(perc_chg_year = NA) %T>%
  view()

### percent change from 2018-2019
mean_pods[1,3] <- (mean_pods[2,2]-mean_pods[1,2])/mean_pods[1,2]


```

#### Pods per Peduncle
```{r}

## PERCENT CHANGE, rural to urban terminii:
mean_ppp2 <- podsperped_subtr_01_pred %>%
  dplyr::filter(., x == 2 | x == 34) %>%
  dplyr::group_by(x, group) %>%
  dplyr::summarise(terminus_mean = mean(predicted)) %T>%
  view()

perc_chg_ppp2 <- mean_ppp2 %>%
  as.data.frame() %>%
  dplyr::mutate(perc_chg_urbrur = NA)

### percent change for 2018
perc_chg_ppp2[1,4] <- (perc_chg_ppp2[1,3]-perc_chg_ppp2[3,3])/perc_chg_ppp2[3,3]

### percent change for 2019
perc_chg_ppp2[2,4] <- (perc_chg_ppp2[2,3]-perc_chg_ppp2[4,3])/perc_chg_ppp2[4,3]


```

## Urbanization Score
### Create ggpredict objects
```{r}

### Peduncles
u_peds_glmer_subtr_06
peds_subtr_01_pred.u <- ggpredict(u_peds_glmer_subtr_06,
                                terms = c("Urb_score", "Year", "Transect_ID"),
                                type = "zero_inflated")

### Pollinia
u_poll_glmer_subtr_01
poll_subtr_01_pred.u <- ggpredict(u_poll_glmer_subtr_01,
                                terms = c("Urb_score", "Year", "Transect_ID"),
                                type = "fe")

### Pods
u_pods_glmer_subtr_03
pods_subtr_01_pred.u <- ggpredict(u_pods_glmer_subtr_03,
                                terms = c("Urb_score", "Year", "Transect_ID"),
                                type = "zero_inflated")

### Pods/Peduncle
u_podsperped_lmer_subtr_09
podsperped_subtr_01_pred.u <- ggpredict(u_podsperped_lmer_subtr_09,
                                      terms = c("Urb_score", "Year", "Transect_ID"),
                                      type = "fe") 


### Height- URB SCORE
u_height_lmer_subtr_01
height_subtr_01_pred.u <- ggpredict(u_height_lmer_subtr_01,
                                    terms = c("Urb_score", "Year", "Transect_ID"),
                                    type = "fe")
```

### Create plots
#### Include points, no stats (not included in paper)
```{r}
# 
# ggpred_Q2.urbscore_peds <- (ggplot(peds_subtr_01_pred.u) +
#                               geom_smooth(aes(x = x,
#                                               y = predicted,
#                                               color = facet,
#                                               linetype = group),
#                                           method = "loess",
#                                           se = F) +
#                               geom_ribbon(aes(x = x,
#                                               ymin = predicted - std.error,
#                                               ymax = predicted + std.error,
#                                               fill = facet,
#                                               linetype = group),
#                                           alpha = 0.2)) + 
#   geom_point(data = fertile_pops_all %>%
#                filter(Transect_ID != "Rural"),
#              aes(x = Urb_score, y = Peduncles,
#                  colour = Transect_ID,
#                  shape = interaction(Year, Transect_ID)),
#              size = 3) +
#   xlim(4, -4) +
#   scale_x_reverse() +
#   scale_y_continuous(limits=c(0,15)) +
#   labs(x = "Urbanization Score",
#        y = "Inflorescences") +
#   scale_shape_manual(values = c(16,2,17,1)) +
#   theme(legend.position = c(.99, .99),
#         legend.justification = c("right", "top"),
#         legend.box = 'horizontal',
#         legend.box.just = "right",
#         legend.margin = margin(5,5,5,5),
#         text = element_text(size=14),
#         # axis.title.x = element_blank(),
#         panel.background = element_blank(),
#         axis.line = element_line(colour = "black"),
#         legend.key = element_rect(fill = NA),
#         legend.key.size = unit(2, "line") )
# 
# 
# ## factors (transects) for this object are North, then South
# ## for some reason (peduncles and at least one more is South, North)
# ## so to keep legend consistent, have to reorder levels first
# poll_subtr_01_pred.u$facet <- factor(poll_subtr_01_pred.u$facet,
#                                      levels(poll_subtr_01_pred.u$facet)[c(2,1)])
# levels(poll_subtr_01_pred.u$facet)
# 
# ggpred_Q2.urbscore_poll <- (ggplot(poll_subtr_01_pred.u) +
#     geom_smooth(aes(x = x,
#                     y = predicted,
#                     color = facet,
#                     linetype = group),
#                 method = "loess",
#                 se = F) +
#     geom_ribbon(aes(x = x,
#                     ymin = predicted - std.error,
#                     ymax = predicted + std.error,
#                     fill = facet,
#                     linetype = group),
#                 alpha = 0.2)) + 
#   geom_point(data = AvgVars_notNA_Poll_18_19 %>%
#                filter(Transect_ID != "Rural"),
#              aes(x = Urb_score, y = Average_Pollinia,
#                  colour = Transect_ID,
#                  shape = interaction(Year, Transect_ID)),
#              size = 3) +
#   xlim(4, -4) +
#   scale_x_reverse() +
#   scale_y_continuous(breaks=c(0,1,2,3), limits=c(0,3)) +
#   labs(x = "Urbanization Score",
#        y = "Pollinaria Removed") +
#   scale_shape_manual(values = c(16,2,17,1)) +
#   theme(legend.position = c(.99, .99),
#         legend.justification = c("right", "top"),
#         legend.box = 'horizontal',
#         legend.box.just = "right",
#         legend.margin = margin(5,5,5,5),
#         text = element_text(size=14),
#         # axis.title.x = element_blank(),
#         panel.background = element_blank(),
#         axis.line = element_line(colour = "black"),
#         legend.key = element_rect(fill = NA),
#         legend.key.size = unit(2, "line") )
# 
# 
# 
# ggpred_Q2.urbscore_pods <- (ggplot(pods_subtr_01_pred.u) +
#                               geom_smooth(aes(x = x,
#                                               y = predicted,
#                                               color = facet,
#                                               linetype = group),
#                                           method = "loess",
#                                           se = F) +
#                               geom_ribbon(aes(x = x,
#                                               ymin = predicted - std.error,
#                                               ymax = predicted + std.error,
#                                               fill = facet,
#                                               linetype = group),
#                                           alpha = 0.2)) + 
#   geom_point(data = fertile_pops_all %>%
#                filter(Transect_ID != "Rural"),
#              aes(x = Urb_score, y = Viable_Pods^3,
#                  colour = Transect_ID,
#                  shape = interaction(Year, Transect_ID)),
#              size = 3) +
#   xlim(4, -4) +
#   scale_x_reverse() +
#   labs(x = "Urbanization Score",
#        y = expression(Follicles^{3})) +
#   scale_shape_manual(values = c(16,2,17,1)) +
#   theme(legend.position = c(.99, .99),
#         legend.justification = c("right", "top"),
#         legend.box = 'horizontal',
#         legend.box.just = "right",
#         legend.margin = margin(5,5,5,5),
#         text = element_text(size=14),
#         # axis.title.x = element_blank(),
#         panel.background = element_blank(),
#         axis.line = element_line(colour = "black"),
#         legend.key = element_rect(fill = NA),
#         legend.key.size = unit(2, "line") )
# 
# 
# 
# 
# ggpred_Q2.urbscore_podsperped <- (ggplot(podsperped_subtr_01_pred.u) +
#                                     geom_smooth(aes(x = x,
#                                                     y = predicted,
#                                                     color = facet,
#                                                     linetype = group),
#                                                 method = "loess",
#                                                 se = F) +
#                                     geom_ribbon(aes(x = x,
#                                                     ymin = predicted - std.error,
#                                                     ymax = predicted + std.error,
#                                                     fill = facet,
#                                                     linetype = group),
#                                                 alpha = 0.2)) + 
#   geom_point(data = fertile_pops_all %>%
#                filter(Transect_ID != "Rural"),
#              aes(x = Urb_score, y = pods_per_ped,
#                  colour = Transect_ID,
#                  shape = interaction(Year, Transect_ID)),
#              size = 3) +
#   xlim(4, -4) +
#   scale_x_reverse() +
#   scale_y_continuous(limits=c(0,3)) +
#   labs(x = "Urbanization Score",
#        y = "Follicles per Inflorescence") +
#   scale_shape_manual(values = c(16,2,17,1)) +
#   theme(legend.position = c(.99, .99),
#         legend.justification = c("right", "top"),
#         legend.box = 'horizontal',
#         legend.box.just = "right",
#         legend.margin = margin(5,5,5,5),
#         text = element_text(size=14),
#         # axis.title.x = element_blank(),
#         panel.background = element_blank(),
#         axis.line = element_line(colour = "black"),
#         legend.key = element_rect(fill = NA),
#         legend.key.size = unit(2, "line") )
# 
# 
# 
# 
# ## factors (transects) for this object are North, then South
# ## so to keep legend consistent, have to reorder levels first
# height_subtr_01_pred.u$facet <- factor(height_subtr_01_pred.u$facet,
#                                        levels(height_subtr_01_pred.u$facet)[c(2,1)])
# levels(height_subtr_01_pred.u$facet)
# 
# ggpred_Q2.citydist_height.u <- (ggplot(height_subtr_01_pred.u) +
#                                   geom_smooth(aes(x = x,
#                                                   y = predicted,
#                                                   color = facet,
#                                                   linetype = group),
#                                               method = "loess",
#                                               se = F) +
#                                   geom_ribbon(aes(x = x,
#                                                   ymin = predicted - std.error,
#                                                   ymax = predicted + std.error,
#                                                   fill = facet,
#                                                   linetype = group),
#                                               alpha = 0.2)) + 
#   geom_point(data = fertile_pops_all %>%
#                filter(Transect_ID != "Rural"),
#              aes(x = Urb_score, y = Height_Sept,
#                  colour = Transect_ID,
#                  shape = interaction(Year, Transect_ID)),
#              size = 3) +
#   scale_x_reverse() +
#   xlim(3.5, -2) +
#   scale_y_continuous(limits=c(0,200)) +
#   labs(x = "Urbanization Score",
#        y = "Height (cm)") +
#   scale_shape_manual(values = c(16,2,17,1)) +
#   theme(# legend.position = c(.97, .99),
#     legend.justification = c("center"),
#     legend.box = 'horizontal',
#     legend.box.just = "center",
#     legend.margin = margin(5,5,5,5),
#     text = element_text(size=14),
#     # axis.title.x = element_blank(),
#     panel.background = element_blank(),
#     axis.line = element_line(colour = "black"),
#     legend.key = element_rect(fill = NA),
#     legend.key.size = unit(2, "line") )

```


#### Exclude points, no stats (as in paper)
```{r}

ggpred_Q2.urbscore_peds <- ggplot(peds_subtr_01_pred.u) +
                              geom_smooth(aes(x = x,
                                              y = predicted,
                                              color = group,
                                              linetype = facet),
                                          method = "loess",
                                          se = F) +
                              geom_ribbon(aes(x = x,
                                              ymin = predicted - std.error,
                                              ymax = predicted + std.error,
                                              fill = group,
                                              linetype = facet),
                                          alpha = 0.2) + 
  xlim(4, -4) +
  scale_x_reverse() +
  scale_y_continuous(limits=c(0,10)) +
  labs(x = "Urbanization Score",
       y = "Inflorescences") +
  theme( #legend.position = c(.97, .99),
    legend.justification = c("center"),
    legend.box = 'horizontal',
    legend.box.just = "center",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") )
ggpred_Q2.urbscore_peds



## factors (transects) for this object are North, then South
## for some reason (peduncles and at least one more is South, North)
## so to keep legend consistent, have to reorder levels first
poll_subtr_01_pred.u$facet <- factor(poll_subtr_01_pred.u$facet,
                                     levels(poll_subtr_01_pred.u$facet)[c(2,1)])
levels(poll_subtr_01_pred.u$facet)

ggpred_Q2.urbscore_poll <- ggplot(poll_subtr_01_pred.u) +
                              geom_smooth(aes(x = x,
                                              y = predicted,
                                              color = group,
                                              linetype = facet),
                                          method = "loess",
                                          se = F) +
                              geom_ribbon(aes(x = x,
                                              ymin = predicted - std.error,
                                              ymax = predicted + std.error,
                                              fill = group,
                                              linetype = facet),
                                          alpha = 0.2) + 
  xlim(4, -4) +
  scale_x_reverse() +
  # scale_y_continuous(breaks=c(0,1,2,3), limits=c(0,3)) +
  labs(x = "Urbanization Score",
       y = "Pollinaria Removed") +
  theme( #legend.position = c(.97, .99),
    legend.justification = c("center"),
    legend.box = 'horizontal',
    legend.box.just = "center",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") )
ggpred_Q2.urbscore_poll


ggpred_Q2.urbscore_pods <- ggplot(pods_subtr_01_pred.u) +
                              geom_smooth(aes(x = x,
                                              y = predicted,
                                              color = group,
                                              linetype = facet),
                                          method = "loess",
                                          se = F) +
                              geom_ribbon(aes(x = x,
                                              ymin = predicted - std.error,
                                              ymax = predicted + std.error,
                                              fill = group,
                                              linetype = facet),
                                          alpha = 0.2) + 
  xlim(4, -4) +
  ylim(0, 8000) +
  scale_x_reverse() +
  labs(x = "Urbanization Score",
       y = expression(Follicles^{3})) +
  theme( #legend.position = c(.97, .99),
    legend.justification = c("center"),
    legend.box = 'horizontal',
    legend.box.just = "center",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") )
ggpred_Q2.urbscore_pods


## factors (transects) for this object are North, then South
## for some reason (peduncles and at least one more is South, North)
## so to keep legend consistent, have to reorder levels first
podsperped_subtr_01_pred.u$facet <- factor(podsperped_subtr_01_pred.u$facet,
                                     levels(podsperped_subtr_01_pred.u$facet)[c(2,1)])
levels(podsperped_subtr_01_pred.u$facet)

ggpred_Q2.urbscore_podsperped <- ggplot(podsperped_subtr_01_pred.u) +
                              geom_smooth(aes(x = x,
                                              y = predicted,
                                              color = group,
                                              linetype = facet),
                                          method = "loess",
                                          se = F) +
                              geom_ribbon(aes(x = x,
                                              ymin = predicted - std.error,
                                              ymax = predicted + std.error,
                                              fill = group,
                                              linetype = facet),
                                          alpha = 0.2) + 
  xlim(4, -4) +
  scale_x_reverse() +
  scale_y_continuous(limits=c(1,2)) +
  labs(x = "Urbanization Score",
       y = "Inflorescences") +
  theme( #legend.position = c(.97, .99),
    legend.justification = c("center"),
    legend.box = 'horizontal',
    legend.box.just = "center",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") ) +
  labs(x = "Urbanization Score",
       y = "Follicles per Inflorescence") 
ggpred_Q2.urbscore_podsperped


## factors (transects) for this object are North, then South
## so to keep legend consistent, have to reorder levels first
height_subtr_01_pred.u$facet <- factor(height_subtr_01_pred.u$facet,
                                       levels(height_subtr_01_pred.u$facet)[c(2,1)])
levels(height_subtr_01_pred.u$facet)

ggpred_Q2.citydist_height.u <- ggplot(height_subtr_01_pred.u) +
                              geom_smooth(aes(x = x,
                                              y = predicted,
                                              color = group,
                                              linetype = facet),
                                          method = "loess",
                                          se = F) +
                              geom_ribbon(aes(x = x,
                                              ymin = predicted - std.error,
                                              ymax = predicted + std.error,
                                              fill = group,
                                              linetype = facet),
                                          alpha = 0.2) + 
  xlim(4, -4) +
  scale_x_reverse() +
  scale_y_continuous(limits=c(50,200)) +
  labs(x = "Urbanization Score",
       y = "Inflorescences") +
  theme( #legend.position = c(.97, .99),
    legend.justification = c("center"),
    legend.box = 'horizontal',
    legend.box.just = "center",
    legend.margin = margin(5,5,5,5),
    text = element_text(size=14),
    # axis.title.x = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.key = element_rect(fill = NA),
    legend.key.size = unit(2, "line") ) +
  labs(x = "Urbanization Score",
       y = "Height (cm)") 
ggpred_Q2.citydist_height.u
```


## Final Figure: Main text (Combine plots into one figure)
```{r}
Q2_regressions_citydist_ggpred <- ggarrange( ggpred_Q2.citydist_poll,
                                             ggpred_Q2.citydist_pods,
                                             ggpred_Q2.citydist_podsperped,
                                             ggpred_Q2.citydist_peds +
                                              font("x.text"),
                                            ncol = 4,
                                            nrow = 1,
                                            align = "hv",
                                            labels = list("A", "B", "C", "D"),
                                            font.label = (size =16),
                                            common.legend = T,
                                            legend = "none") %T>%
  plot

library(patchwork)
library(png)
Q2_legend <- readPNG(here::here("./Figures_Tables/Q2_UrbanSubtransects/Q2_legend_nopoints_updated.png"),
                    native = TRUE)


city_plots.ggpred2 <- annotate_figure(Q2_regressions_citydist_ggpred,
                bottom = text_grob("Distance to Urban Center (km)",
                                   size=14)) +                  # Combine plot & image
  Q2_legend +
  patchwork::plot_layout(design =
 "#######BB
  AAAAAAAAA
  AAAAAAAAA
  AAAAAAAAA
  AAAAAAAAA")

# annotate_figure(Q2_regressions_citydist_ggpred,
#                                       bottom = text_grob("Distance to Urban Center (km)",
#                                                          size=14)) +                  # Combine plot & image
#   Q2_legend +
#   patchwork::plot_layout(design = "AAAAAAAB
#                          AAAAAAA#
#                          AAAAAAA#")

# export to PDF
dev.copy2pdf(file="~/R_Projects/chapter_one/Figures_Tables/Q2_UrbanSubtransects/DISTSubtransect_regressions_nopoints.pdf",
             width = 12, height = 4.5)
```

## Final Figure: Supplement (Combine plots into one figure)
```{r}
# reordering for main text
# Q2_regressions_urbscore_ggpred <- ggarrange(ggpred_Q2.urbscore_poll,
#                                             ggpred_Q2.urbscore_pods,
#                                             ggpred_Q2.urbscore_podsperped, 
#                                             ggpred_Q2.urbscore_peds  +
#                                               font("x.text"),
#                                             ncol = 4,
#                                             nrow = 1,
#                                             align = "hv",
#                                             labels = list("E", "F", "G", "H"),
#                                             font.label = (size =16),
#                                             common.legend = T,
#                                             legend = "none") %T>%
#   plot

# library(patchwork)
# Q2_legend <- readPNG(here::here("./Figures_Tables/Q2_UrbanSubtransects/Q2_legend.png"),
#                      native = TRUE)
# 
# 
# urbscore_plots.ggpred2 <- annotate_figure(Q2_regressions_urbscore_ggpred,
#                                           bottom = text_grob("Urbanization Score",
#                                                              size=14)) +                  # Combine plot & image
#   Q2_legend +
#   patchwork::plot_layout(design =
#                            "#######B
#                             AAAAAAAA
#                             AAAAAAAA
#                             AAAAAAAA
#                             AAAAAAAA")
# 
# 
# # export to PDF
# dev.copy2pdf(file="~/R_Projects/chapter_one/Figures_Tables/Q2_UrbanSubtransects/URBSCORESubtransect_regressions_ggpredict.pdf",
#              width = 12, height = 4.5)



# this is now going into supplement. Going to add height
Q2_regressions_urbscore_ggpred <- ggarrange(ggpred_Q2.citydist_height, # city_dist
                                            ggpred_Q2.urbscore_poll, # urb_score
                                            ggpred_Q2.urbscore_pods, # urb_score
                                            ggpred_Q2.urbscore_podsperped, # urb_score
                                            ggpred_Q2.urbscore_peds , # urb_score
                                            ggpred_Q2.citydist_height.u + # urb_score
                                              font("x.text"),
                                            ncol = 3,
                                            nrow = 2,
                                            align = "hv",
                                            labels = list("A", "B", "C",
                                                          "D", "E", "F"),
                                            font.label = (size =16),
                                            common.legend = T,
                                            legend = "none") %T>%
  plot


library(patchwork)
library(png)
Q2_legend <- png::readPNG(here::here("./Figures_Tables/Q2_UrbanSubtransects/Q2_legend.png"),
                     native = TRUE)


urbscore_plots.ggpred2 <- Q2_regressions_urbscore_ggpred +    # Combine plot & image
  Q2_legend +
  patchwork::plot_layout(design =
                           "#######B
                            AAAAAAAA
                            AAAAAAAA
                            AAAAAAAA
                            AAAAAAAA")
urbscore_plots.ggpred2

# export to PDF
dev.copy2pdf(file="~/R_Projects/chapter_one/Figures_Tables/Q2_UrbanSubtransects/URBSCORESubtransect_regressions_ggpredict_nopoints.pdf",
             width = 12, height = 8.5)
```


